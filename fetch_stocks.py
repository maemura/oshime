#!/usr/bin/env python3
"""
ã‹ã¶ã®ã™ã‘ â€” æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ å…¨éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆJPXå…¬å¼ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
=============================================
å®Ÿè¡Œ: python3 fetch_stocks.py
æ‰€è¦æ™‚é–“: ç´„15ã€œ30åˆ†ï¼ˆå…¨ç´„1,700éŠ˜æŸ„ï¼‰
å‡ºåŠ›: stocks_data.json

éŠ˜æŸ„ãƒªã‚¹ãƒˆã¯ JPX ã®å…¬å¼CSVã‹ã‚‰è‡ªå‹•å–å¾—ã—ã¾ã™ã€‚
å–å¾—å¤±æ•—æ™‚ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
"""

import json, sys, time, os, io, shutil
from datetime import datetime

# â”€â”€ é€£ç¶šå¢—é…ãƒ»ç´¯é€²é…å½“éŠ˜æŸ„ãƒªã‚¹ãƒˆï¼ˆå…¬é–‹æƒ…å ±ãƒ™ãƒ¼ã‚¹ï¼‰â”€â”€
# å¢—é…å¹´æ•°ã¯ãŠãŠã‚ˆãã€‚ã‚¹ã‚³ã‚¢ã§ãƒœãƒ¼ãƒŠã‚¹åŠ ç‚¹ã«ä½¿ç”¨ã€‚
DIVIDEND_GROWERS = {
    # 10å¹´ä»¥ä¸Šé€£ç¶šå¢—é…
    "4452": 15, "8566": 26, "9433": 23, "8591": 26, "4732": 14,
    "9432": 14, "8316": 14, "8593": 15, "7466": 14, "2914": 21,
    "9434": 10, "8001": 11, "8053": 11, "8058": 10, "8031": 12,
    "4502": 12, "8766": 13, "8309": 11, "6098": 11, "2124": 14,
    "9783": 14, "4967": 12, "7164": 11, "2413": 13, "9142": 12,
    "6301": 14, "7974": 12, "8795": 11, "1925": 12, "2802": 13,
    "6869": 11, "4684": 14, "7741": 10, "4543": 13, "6367": 12,
    "9020": 10, "6902": 11, "7269": 10, "4063": 10, "6273": 12,
    "4519": 10, "8697": 10, "6645": 12, "9436": 10, "3659": 11,
    "1928": 10, "2503": 10, "9303": 10, "7272": 10,
    # 5ã€œ9å¹´é€£ç¶šå¢—é…
    "8306": 7, "8411": 7, "7267": 6, "7203": 6, "5108": 6,
    "6752": 5, "6758": 5, "4661": 8, "4689": 5, "6501": 6,
    "6503": 5, "7751": 7, "9984": 5, "6861": 8, "4307": 7,
    "2801": 6, "8750": 8, "9843": 5, "8354": 6, "1605": 7,
    "5401": 5, "3405": 5, "5020": 6, "5019": 6, "2502": 7,
    "7201": 5, "9613": 5, "3382": 5, "8801": 6, "8802": 6,
    "4901": 6, "3088": 5, "2768": 5, "6954": 6, "3099": 5,
    "8252": 5, "9101": 5, "9104": 5, "9107": 5,
}
from concurrent.futures import ThreadPoolExecutor, as_completed

# â”€â”€ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯ â”€â”€
def check_lib(name, install):
    try:
        return __import__(name)
    except ImportError:
        print(f"âŒ {name} ãŒå¿…è¦ã§ã™: pip3 install {install}")
        sys.exit(1)

yf  = check_lib("yfinance",         "yfinance")
pd  = check_lib("pandas",           "pandas")
np  = check_lib("numpy",            "numpy")
req = check_lib("requests",         "requests")

# =============================================
# éŠ˜æŸ„ãƒªã‚¹ãƒˆå–å¾—: JPXå…¬å¼CSVã‹ã‚‰è‡ªå‹•å–å¾—
# =============================================
JPX_CSV_URL = (
    "https://www.jpx.co.jp/markets/statistics-equities/misc/tvdivq0000001vg2-att/"
    "data_j.xls"
)
# â†‘ æ—¥æœ¬èªãƒšãƒ¼ã‚¸ã®Excelã€‚requests ã§å–å¾—ã—ã¦ pandas ã§èª­ã‚€ã€‚
# å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã€‚

FALLBACK_CODES = [
    1301,1332,1333,1375,1376,1377,1379,1380,1381,1382,1383,1384,
    1385,1386,1387,1388,1389,1390,1391,1392,1393,1394,1395,1396,
    1801,1802,1803,1808,1812,1820,1821,1824,1825,1826,1827,1828,
    1829,1830,1833,1835,1837,1838,1840,1841,1844,1845,1846,1847,
    1848,1850,1852,1853,1854,1855,1856,1857,1858,1860,1861,1862,
    1925,1928,1929,1942,1944,1945,1948,1949,1951,1952,1954,1961,
    1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1975,
    1976,1979,1980,1982,1983,1984,1985,1986,1987,1988,1989,1990,
    2002,2003,2004,2009,2010,2020,2035,2036,2060,2108,2112,2117,
    2119,2121,2124,2127,2130,2131,2132,2133,2134,2135,2148,2160,
    2168,2180,2181,2183,2185,2186,2193,2195,2201,2202,2204,2206,
    2207,2208,2209,2211,2212,2215,2220,2221,2226,2229,2231,2264,
    2266,2267,2269,2270,2271,2272,2276,2281,2282,2284,2286,2287,
    2288,2291,2292,2293,2294,2296,2297,2300,2301,2303,2305,2315,
    2317,2321,2326,2327,2330,2331,2334,2335,2337,2338,2340,2353,
    2354,2356,2359,2370,2372,2375,2376,2378,2379,2380,2381,2384,
    2388,2389,2392,2393,2395,2396,2397,2398,2401,2404,2408,2412,
    2413,2414,2415,2417,2418,2419,2425,2427,2428,2432,2433,2437,
    2440,2445,2449,2461,2462,2464,2468,2471,2472,2475,2477,2479,
    2484,2489,2491,2492,2497,2501,2502,2503,2531,2533,2587,2590,
    2593,2594,2597,2651,2654,2659,2660,2664,2681,2695,2702,2706,
    2712,2715,2720,2726,2730,2733,2734,2735,2736,2737,2750,2752,
    2753,2754,2760,2762,2764,2768,2784,2789,2791,2792,2795,2796,
    2801,2802,2803,2804,2805,2806,2809,2810,2812,2813,2815,2819,
    2820,2822,2823,2824,2826,2871,2875,2876,2882,2883,2884,2899,
    2901,2904,2910,2911,2914,2915,2916,2918,2919,2929,2930,2931,
    3001,3002,3004,3005,3011,3012,3013,3015,3016,3017,3018,3019,
    3020,3021,3023,3024,3025,3028,3030,3031,3032,3033,3034,3036,
    3038,3039,3041,3042,3044,3046,3048,3050,3053,3054,3055,3057,
    3059,3060,3061,3064,3065,3066,3067,3068,3069,3070,3071,3073,
    3075,3076,3077,3079,3080,3081,3082,3083,3086,3087,3088,3089,
    3091,3093,3094,3097,3099,3101,3102,3103,3107,3109,3110,3116,
    3121,3122,3132,3134,3135,3137,3139,3141,3143,3144,3146,3148,
    3151,3153,3154,3155,3157,3159,3161,3162,3163,3167,3168,3169,
    3170,3172,3175,3176,3178,3179,3183,3185,3189,3193,3195,3197,
    3198,3200,3201,3202,3203,3204,3205,3207,3209,3212,3213,3215,
    3216,3220,3222,3228,3231,3232,3236,3237,3238,3239,3240,3241,
    3244,3245,3246,3247,3250,3252,3254,3255,3258,3260,3261,3262,
    3264,3267,3268,3269,3271,3275,3276,3277,3278,3279,3280,3282,
    3284,3285,3286,3287,3289,3290,3291,3292,3293,3294,3295,3297,
    3299,3302,3303,3305,3306,3308,3309,3311,3313,3315,3318,3319,
    3321,3322,3323,3324,3325,3326,3328,3329,3330,3331,3333,3334,
    3335,3337,3338,3339,3341,3342,3344,3345,3346,3347,3348,3349,
    3350,3351,3352,3353,3354,3355,3356,3357,3358,3359,3360,3361,
    3362,3363,3364,3365,3366,3367,3368,3369,3370,3371,3372,3374,
    3375,3376,3377,3378,3379,3380,3381,3382,3383,3384,3385,3386,
    3387,3388,3389,3390,3392,3393,3394,3396,3397,3398,3399,3401,
    3402,3404,3405,3407,3408,3409,3411,3412,3413,3414,3415,3416,
    3418,3419,3420,3421,3422,3423,3424,3425,3426,3427,3428,3429,
    3431,3432,3433,3434,3435,3436,3437,3438,3439,3440,3441,3442,
    3443,3444,3445,3446,3447,3448,3449,3450,3451,3452,3453,3454,
    3455,3456,3457,3458,3459,3460,3461,3462,3463,3464,3465,3466,
    3467,3468,3469,3470,3471,3472,3473,3474,3475,3476,3477,3478,
    3479,3480,3481,3482,3483,3484,3485,3486,3487,3488,3489,3490,
    3491,3492,3493,3494,3495,3496,3497,3498,3499,3500,3501,3502,
    3503,3504,3505,3506,3507,3508,3509,3510,3511,3512,3513,3514,
    3515,3516,3517,3518,3519,3520,3521,3522,3523,3524,3525,3526,
    3527,3528,3529,3530,3531,3532,3533,3534,3535,3536,3537,3538,
    3539,3540,3541,3542,3543,3544,3545,3546,3547,3548,3549,3550,
    3551,3552,3553,3554,3555,3556,3557,3558,3559,3560,3561,3562,
    3563,3564,3565,3566,3567,3568,3569,3570,3571,3572,3573,3574,
    3575,3576,3577,3578,3579,3580,3581,3582,3583,3584,3585,3586,
    3587,3588,3589,3590,3591,3592,3593,3594,3595,3596,3597,3598,
    3599,3600,3601,3602,3603,3604,3605,3606,3607,3608,3609,3610,
    3611,3612,3613,3614,3615,3616,3617,3618,3619,3620,3621,3622,
    3623,3624,3625,3626,3627,3628,3629,3630,3631,3632,3633,3634,
    3635,3636,3637,3638,3639,3640,3641,3642,3643,3644,3645,3646,
    3647,3648,3649,3650,3651,3652,3653,3654,3655,3656,3657,3658,
    3659,3660,3661,3662,3663,3664,3665,3666,3667,3668,3669,3670,
    3671,3672,3673,3674,3675,3676,3677,3678,3679,3680,3681,3682,
    3683,3684,3685,3686,3687,3688,3689,3690,3691,3692,3693,3694,
    3695,3696,3697,3698,3699,3700,3701,3702,3703,3704,3705,3706,
    3707,3708,3709,3710,3711,3712,3713,3714,3715,3716,3717,3718,
    3719,3720,3721,3722,3723,3724,3725,3726,3727,3728,3729,3730,
    3731,3732,3733,3734,3735,3736,3737,3738,3739,3740,3741,3742,
    3743,3744,3745,3746,3747,3748,3749,3750,3751,3752,3753,3754,
    3755,3756,3757,3758,3759,3760,3761,3762,3763,3764,3765,3766,
    3767,3768,3769,3770,3771,3772,3773,3774,3775,3776,3777,3778,
    3779,3780,3781,3782,3783,3784,3785,3786,3787,3788,3789,3790,
    3791,3792,3793,3794,3795,3796,3797,3798,3799,3800,3801,3802,
    3803,3804,3805,3806,3807,3808,3809,3810,3811,3812,3813,3814,
    3815,3816,3817,3818,3819,3820,3821,3822,3823,3824,3825,3826,
    3827,3828,3829,3830,3831,3832,3833,3834,3835,3836,3837,3838,
    3839,3840,3841,3842,3843,3844,3845,3846,3847,3848,3849,3850,
    3851,3852,3853,3854,3855,3856,3857,3858,3859,3860,3861,3862,
    3863,3864,3865,3866,3867,3868,3869,3870,3871,3872,3873,3874,
    3875,3876,3877,3878,3879,3880,3881,3882,3883,3884,3885,3886,
    3887,3888,3889,3890,3891,3892,3893,3894,3895,3896,3897,3898,
    3899,3900,3901,3902,3903,3904,3905,3906,3907,3908,3909,3910,
    3911,3912,3913,3914,3915,3916,3917,3918,3919,3920,3921,3922,
    3923,3924,3925,3926,3927,3928,3929,3930,3931,3932,3933,3934,
    3935,3936,3937,3938,3939,3940,3941,3942,3943,3944,3945,3946,
    3947,3948,3949,3950,3951,3952,3953,3954,3955,3956,3957,3958,
    3959,3960,3961,3962,3963,3964,3965,3966,3967,3968,3969,3970,
    3971,3972,3973,3974,3975,3976,3977,3978,3979,3980,3981,3982,
    3983,3984,3985,3986,3987,3988,3989,3990,3991,3992,3993,3994,
    3995,3996,3997,3998,3999,4001,4002,4004,4005,4006,4007,4009,
    4010,4011,4012,4013,4014,4015,4016,4017,4018,4019,4020,4021,
    4023,4024,4025,4026,4028,4029,4041,4042,4043,4044,4046,4047,
    4048,4049,4050,4051,4052,4053,4054,4055,4056,4057,4058,4059,
    4060,4061,4062,4063,4064,4065,4066,4067,4068,4069,4070,4071,
    4072,4073,4074,4075,4076,4077,4078,4079,4080,4082,4083,4084,
    4088,4091,4092,4093,4094,4095,4096,4097,4098,4099,4100,4101,
    4102,4103,4104,4105,4107,4109,4116,4118,4119,4120,4121,4122,
    4123,4124,4125,4126,4127,4128,4129,4130,4131,4132,4133,4134,
    4135,4136,4137,4138,4139,4140,4141,4142,4143,4144,4145,4146,
    4147,4148,4149,4150,4151,4152,4153,4154,4155,4156,4157,4158,
    4159,4160,4161,4162,4163,4164,4165,4166,4167,4168,4169,4170,
    4171,4172,4173,4174,4175,4176,4177,4178,4179,4180,4181,4182,
    4183,4185,4186,4187,4188,4189,4190,4191,4192,4193,4194,4195,
    4196,4197,4198,4199,4200,4201,4202,4203,4204,4205,4206,4207,
    4208,4209,4210,4211,4212,4213,4214,4215,4216,4217,4218,4219,
    4220,4221,4222,4223,4224,4225,4226,4227,4228,4229,4230,4231,
    4232,4233,4234,4235,4236,4237,4238,4239,4240,4241,4242,4243,
    4244,4245,4246,4247,4248,4249,4250,4251,4252,4253,4254,4255,
    4256,4257,4258,4259,4260,4261,4262,4263,4264,4265,4266,4267,
    4268,4269,4270,4271,4272,4273,4274,4275,4276,4277,4278,4279,
    4280,4281,4282,4283,4284,4285,4286,4287,4288,4289,4290,4291,
    4292,4293,4294,4295,4296,4297,4298,4299,4307,4316,4321,4324,
    4327,4328,4329,4331,4334,4336,4338,4339,4340,4341,4342,4343,
    4344,4345,4346,4347,4348,4349,4350,4351,4352,4353,4354,4355,
    4356,4357,4358,4359,4360,4361,4362,4363,4364,4365,4366,4367,
    4368,4369,4370,4371,4372,4373,4374,4375,4376,4377,4378,4379,
    4380,4381,4382,4383,4384,4385,4386,4387,4388,4389,4390,4391,
    4392,4393,4394,4395,4396,4397,4398,4399,4401,4402,4403,4404,
    4405,4406,4407,4408,4409,4410,4411,4412,4413,4414,4415,4416,
    4417,4418,4419,4420,4421,4422,4423,4424,4425,4426,4427,4428,
    4429,4430,4431,4432,4433,4434,4435,4436,4437,4438,4439,4440,
    4441,4442,4443,4444,4445,4446,4447,4448,4449,4450,4451,4452,
    4453,4454,4455,4456,4457,4458,4459,4460,4461,4462,4463,4464,
    4465,4466,4467,4468,4469,4470,4471,4472,4473,4474,4475,4476,
    4477,4478,4479,4480,4481,4482,4483,4484,4485,4486,4487,4488,
    4489,4490,4491,4492,4493,4494,4495,4496,4497,4498,4499,4500,
    4501,4502,4503,4504,4505,4506,4507,4508,4509,4510,4511,4512,
    4513,4514,4515,4516,4517,4518,4519,4520,4521,4522,4523,4524,
    4525,4526,4527,4528,4529,4530,4531,4532,4533,4534,4535,4536,
    4537,4538,4539,4540,4541,4542,4543,4544,4545,4546,4547,4548,
    4549,4550,4551,4552,4553,4554,4555,4556,4557,4558,4559,4560,
    4561,4562,4563,4564,4565,4566,4567,4568,4569,4570,4571,4572,
    4573,4574,4575,4576,4577,4578,4579,4580,4581,4582,4583,4584,
    4585,4586,4587,4588,4589,4590,4591,4592,4593,4594,4595,4596,
    4597,4598,4599,4600,4661,4689,4755,4901,4902,4904,4911,4912,
    4915,4916,4917,4919,4920,4921,4922,4923,4924,4925,4926,4927,
    4928,4929,4930,4931,4932,4933,4934,4935,4936,4937,4938,4939,
    4940,4941,4942,4943,4944,4945,4946,4947,4948,4949,4950,4951,
    4952,4953,4954,4955,4956,4957,4958,4959,4960,4961,4962,4963,
    4964,4965,4966,4967,4968,4969,4970,4971,4972,4973,4974,4975,
    4976,4977,4978,4979,4980,4981,4982,4983,4984,4985,4986,4987,
    4988,4989,4990,4991,4992,4993,4994,4995,4996,4997,4998,4999,
    5000,5001,5002,5003,5004,5005,5006,5007,5008,5009,5010,5011,
    5012,5013,5014,5015,5016,5017,5018,5019,5020,5021,5022,5023,
    5024,5025,5026,5027,5028,5029,5030,5031,5032,5033,5034,5035,
    5036,5037,5038,5039,5040,5041,5042,5043,5044,5045,5046,5047,
    5048,5049,5050,5051,5052,5053,5054,5055,5056,5057,5058,5059,
    5060,5061,5062,5063,5064,5065,5066,5067,5068,5069,5070,5071,
    5072,5073,5074,5075,5076,5077,5078,5079,5080,5081,5082,5083,
    5084,5085,5086,5087,5088,5089,5090,5091,5092,5093,5094,5095,
    5096,5097,5098,5099,5100,5101,5102,5103,5104,5105,5106,5107,
    5108,5109,5110,5111,5112,5113,5114,5115,5116,5117,5118,5119,
    5120,5121,5122,5123,5124,5125,5126,5127,5128,5129,5130,5131,
    5132,5133,5134,5135,5136,5137,5138,5139,5140,5141,5142,5143,
    5144,5145,5146,5147,5148,5149,5150,5151,5152,5153,5154,5155,
    5156,5157,5158,5159,5160,5161,5162,5163,5164,5165,5166,5167,
    5168,5169,5170,5171,5172,5173,5174,5175,5176,5177,5178,5179,
    5180,5181,5182,5183,5184,5185,5186,5187,5188,5189,5190,5191,
    5192,5193,5194,5195,5196,5197,5198,5199,5200,5201,5202,5203,
    5204,5205,5206,5207,5208,5209,5210,5211,5212,5213,5214,5215,
    5216,5217,5218,5219,5220,5221,5222,5223,5224,5225,5226,5227,
    5228,5229,5230,5231,5232,5233,5234,5235,5236,5237,5238,5239,
    5240,5241,5242,5243,5244,5245,5246,5247,5248,5249,5250,5251,
    5252,5253,5254,5255,5256,5257,5258,5259,5260,5261,5262,5263,
    5264,5265,5266,5267,5268,5269,5270,5271,5272,5273,5274,5275,
    5276,5277,5278,5279,5280,5281,5282,5283,5284,5285,5286,5287,
    5288,5289,5290,5291,5292,5293,5294,5295,5296,5297,5298,5299,
    5300,5301,5302,5303,5304,5305,5306,5307,5308,5309,5310,5311,
    5312,5313,5314,5315,5316,5317,5318,5319,5320,5321,5322,5323,
    5324,5325,5326,5327,5328,5329,5330,5331,5332,5333,5334,5335,
    5336,5337,5338,5339,5340,5341,5342,5343,5344,5345,5346,5347,
    5348,5349,5350,5351,5352,5353,5354,5355,5356,5357,5358,5359,
    5360,5361,5362,5363,5364,5365,5366,5367,5368,5369,5370,5371,
    5372,5373,5374,5375,5376,5377,5378,5379,5380,5381,5382,5383,
    5384,5385,5386,5387,5388,5389,5390,5391,5392,5393,5394,5395,
    5396,5397,5398,5399,5400,5401,5406,5411,5541,5706,5711,5713,
    5714,5715,5801,5802,5803,5901,5902,5903,5904,5905,5906,5907,
    5908,5909,5910,5911,5912,5913,5914,5915,5916,5917,5918,5919,
    5920,5921,5922,5923,5924,5925,5926,5927,5928,5929,5930,5931,
    5932,5933,5934,5935,5936,5937,5938,5939,5940,5941,5942,5943,
    5944,5945,5946,5947,5948,5949,5950,5951,5952,5953,5954,5955,
    5956,5957,5958,5959,5960,5961,5962,5963,5964,5965,5966,5967,
    5968,5969,5970,5971,5972,5973,5974,5975,5976,5977,5978,5979,
    5980,5981,5982,5983,5984,5985,5986,5987,5988,5989,5990,5991,
    5992,5993,5994,5995,5996,5997,5998,5999,
    6000,6001,6002,6003,6004,6005,6006,6007,6008,6009,6010,6011,
    6012,6013,6014,6015,6016,6017,6018,6019,6020,6021,6022,6023,
    6024,6025,6026,6027,6028,6029,6030,6031,6032,6033,6034,6035,
    6036,6037,6038,6039,6040,6041,6042,6043,6044,6045,6046,6047,
    6048,6049,6050,6051,6052,6053,6054,6055,6056,6057,6058,6059,
    6060,6061,6062,6063,6064,6065,6066,6067,6068,6069,6070,6071,
    6072,6073,6074,6075,6076,6077,6078,6079,6080,6081,6082,6083,
    6084,6085,6086,6087,6088,6089,6090,6091,6092,6093,6094,6095,
    6096,6097,6098,6099,6100,6101,6102,6103,6104,6105,6106,6107,
    6108,6109,6110,6111,6112,6113,6114,6115,6116,6117,6118,6119,
    6120,6121,6122,6123,6124,6125,6126,6127,6128,6129,6130,6131,
    6132,6133,6134,6135,6136,6137,6138,6139,6140,6141,6142,6143,
    6144,6145,6146,6147,6148,6149,6150,6151,6152,6153,6154,6155,
    6156,6157,6158,6159,6160,6161,6162,6163,6164,6165,6166,6167,
    6168,6169,6170,6171,6172,6173,6174,6175,6176,6177,6178,6179,
    6180,6181,6182,6183,6184,6185,6186,6187,6188,6189,6190,6191,
    6192,6193,6194,6195,6196,6197,6198,6199,6200,6201,6202,6203,
    6204,6205,6206,6207,6208,6209,6210,6211,6212,6213,6214,6215,
    6216,6217,6218,6219,6220,6221,6222,6223,6224,6225,6226,6227,
    6228,6229,6230,6231,6232,6233,6234,6235,6236,6237,6238,6239,
    6240,6241,6242,6243,6244,6245,6246,6247,6248,6249,6250,6251,
    6252,6253,6254,6255,6256,6257,6258,6259,6260,6261,6262,6263,
    6264,6265,6266,6267,6268,6269,6270,6271,6272,6273,6274,6275,
    6276,6277,6278,6279,6280,6281,6282,6283,6284,6285,6286,6287,
    6288,6289,6290,6291,6292,6293,6294,6295,6296,6297,6298,6299,
    6301,6302,6303,6304,6305,6306,6307,6308,6309,6310,6311,6312,
    6313,6314,6315,6316,6317,6318,6319,6320,6321,6322,6323,6324,
    6325,6326,6327,6328,6329,6330,6331,6332,6333,6334,6335,6336,
    6337,6338,6339,6340,6341,6342,6343,6344,6345,6346,6347,6348,
    6349,6350,6351,6352,6353,6354,6355,6356,6357,6358,6359,6360,
    6361,6362,6363,6364,6365,6366,6367,6368,6369,6370,6371,6372,
    6373,6374,6375,6376,6377,6378,6379,6380,6381,6382,6383,6384,
    6385,6386,6387,6388,6389,6390,6391,6392,6393,6394,6395,6396,
    6397,6398,6399,6471,6472,6473,6474,6475,6476,6477,6478,6479,
    6480,6481,6482,6483,6484,6485,6486,6487,6488,6489,6490,6491,
    6492,6493,6494,6495,6496,6497,6498,6499,6500,6501,6502,6503,
    6504,6505,6506,6507,6508,6509,6510,6511,6512,6513,6514,6515,
    6516,6517,6518,6519,6520,6521,6522,6523,6524,6525,6526,6527,
    6528,6529,6530,6531,6532,6533,6534,6535,6536,6537,6538,6539,
    6540,6541,6542,6543,6544,6545,6546,6547,6548,6549,6550,6551,
    6552,6553,6554,6555,6556,6557,6558,6559,6560,6561,6562,6563,
    6564,6565,6566,6567,6568,6569,6570,6571,6572,6573,6574,6575,
    6576,6577,6578,6579,6580,6581,6582,6583,6584,6585,6586,6587,
    6588,6589,6590,6591,6592,6593,6594,6595,6596,6597,6598,6599,
    6640,6641,6642,6643,6644,6645,6646,6647,6648,6649,6650,6651,
    6652,6653,6654,6655,6656,6657,6658,6659,6660,6661,6662,6663,
    6664,6665,6666,6667,6668,6669,6670,6671,6672,6673,6674,6675,
    6676,6677,6678,6679,6680,6681,6682,6683,6684,6685,6686,6687,
    6688,6689,6690,6691,6692,6693,6694,6695,6696,6697,6698,6699,
    6700,6701,6702,6703,6704,6705,6706,6707,6708,6709,6710,6711,
    6712,6713,6714,6715,6716,6717,6718,6719,6720,6721,6722,6723,
    6724,6725,6726,6727,6728,6729,6730,6731,6732,6733,6734,6735,
    6736,6737,6738,6739,6740,6741,6742,6743,6744,6745,6746,6747,
    6748,6749,6750,6751,6752,6753,6754,6755,6756,6757,6758,6759,
    6760,6761,6762,6763,6764,6765,6766,6767,6768,6769,6770,6771,
    6772,6773,6774,6775,6776,6777,6778,6779,6780,6781,6782,6783,
    6784,6785,6786,6787,6788,6789,6790,6791,6792,6793,6794,6795,
    6796,6797,6798,6799,6800,6841,6857,6861,6902,6952,6954,6971,
    6976,6981,6988,
    7001,7002,7003,7004,7005,7006,7007,7008,7009,7010,7011,7012,
    7013,7014,7015,7016,7017,7018,7019,7020,7021,7022,7023,7024,
    7025,7026,7027,7028,7029,7030,7031,7032,7033,7034,7035,7036,
    7037,7038,7039,7040,7041,7042,7043,7044,7045,7046,7047,7048,
    7049,7050,7051,7052,7053,7054,7055,7056,7057,7058,7059,7060,
    7061,7062,7063,7064,7065,7066,7067,7068,7069,7070,7071,7072,
    7073,7074,7075,7076,7077,7078,7079,7080,7081,7082,7083,7084,
    7085,7086,7087,7088,7089,7090,7091,7092,7093,7094,7095,7096,
    7097,7098,7099,7100,7101,7102,7103,7104,7105,7106,7107,7108,
    7109,7110,7111,7112,7113,7114,7115,7116,7117,7118,7119,7120,
    7121,7122,7123,7124,7125,7126,7127,7128,7129,7130,7131,7132,
    7133,7134,7135,7136,7137,7138,7139,7140,7141,7142,7143,7144,
    7145,7146,7147,7148,7149,7150,7151,7152,7153,7154,7155,7156,
    7157,7158,7159,7160,7161,7162,7163,7164,7165,7166,7167,7168,
    7169,7170,7171,7172,7173,7174,7175,7176,7177,7178,7179,7180,
    7181,7182,7183,7184,7185,7186,7187,7188,7189,7190,7191,7192,
    7193,7194,7195,7196,7197,7198,7199,7200,7201,7202,7203,7204,
    7205,7206,7207,7208,7209,7210,7211,7212,7213,7214,7215,7216,
    7217,7218,7219,7220,7221,7222,7223,7224,7225,7226,7227,7228,
    7229,7230,7231,7232,7233,7234,7235,7236,7237,7238,7239,7240,
    7241,7242,7243,7244,7245,7246,7247,7248,7249,7250,7251,7252,
    7253,7254,7255,7256,7257,7258,7259,7260,7261,7262,7263,7264,
    7265,7266,7267,7268,7269,7270,7271,7272,
    7731,7733,7735,7741,7751,7752,7762,7832,7911,7912,7951,7974,
    8001,8002,8003,8004,8005,8006,8007,8008,8009,8010,8011,8012,
    8013,8014,8015,8016,8017,8018,8019,8020,8021,8022,8023,8024,
    8025,8026,8027,8028,8029,8030,8031,8032,8033,8034,8035,8036,
    8037,8038,8039,8040,8041,8042,8043,8044,8045,8046,8047,8048,
    8049,8050,8051,8052,8053,8054,8055,8056,8057,8058,8059,8060,
    8061,8062,8063,8064,8065,8066,8067,8068,8069,8070,8071,8072,
    8073,8074,8075,8076,8077,8078,8079,8080,8081,8082,8083,8084,
    8085,8086,8087,8088,8089,8090,8091,8092,8093,8094,8095,8096,
    8097,8098,8099,8100,8101,8102,8103,8104,8105,8106,8107,8108,
    8109,8110,8111,8112,8113,8114,8115,8116,8117,8118,8119,8120,
    8121,8122,8123,8124,8125,8126,8127,8128,8129,8130,8131,8132,
    8133,8134,8135,8136,8137,8138,8139,8140,8141,8142,8143,8144,
    8145,8146,8147,8148,8149,8150,8151,8152,8153,8154,8155,8156,
    8157,8158,8159,8160,8161,8162,8163,8164,8165,8166,8167,8168,
    8169,8170,8171,8172,8173,8174,8175,8176,8177,8178,8179,8180,
    8181,8182,8183,8184,8185,8186,8187,8188,8189,8190,8191,8192,
    8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8203,8204,
    8205,8206,8207,8208,8209,8210,8211,8212,8213,8214,8215,8216,
    8217,8218,8219,8220,8221,8222,8223,8224,8225,8226,8227,8228,
    8229,8230,8231,8232,8233,8234,8235,8236,8237,8238,8239,8240,
    8241,8242,8243,8244,8245,8246,8247,8248,8249,8250,8251,8252,
    8253,8254,8255,8256,8257,8258,8259,8260,8261,8262,8263,8264,
    8265,8266,8267,8268,8269,8270,8271,8272,8273,8274,8275,8276,
    8277,8278,8279,8280,8281,8282,8283,8284,8285,8286,8287,8288,
    8289,8290,8291,8292,8293,8294,8295,8296,8297,8298,8299,8300,
    8301,8302,8303,8304,8305,8306,8307,8308,8309,8310,8311,8312,
    8313,8314,8315,8316,8317,8318,8319,8320,8321,8322,8323,8324,
    8325,8326,8327,8328,8329,8330,8331,8332,8333,8334,8335,8336,
    8337,8338,8339,8340,8341,8342,8343,8344,8345,8346,8347,8348,
    8349,8350,8351,8352,8353,8354,8355,8356,8357,8358,8359,8360,
    8361,8362,8363,8364,8365,8366,8367,8368,8369,8370,8371,8372,
    8373,8374,8375,8376,8377,8378,8379,8380,8381,8382,8383,8384,
    8385,8386,8387,8388,8389,8390,8391,8392,8393,8394,8395,8396,
    8397,8398,8399,8400,8401,8402,8403,8404,8405,8406,8407,8408,
    8409,8410,8411,8412,8413,8414,8415,8416,8417,8418,8419,8420,
    8421,8422,8423,8424,8425,8426,8427,8428,8429,8430,8431,8432,
    8433,8434,8435,8436,8437,8438,8439,8440,8441,8442,8443,8444,
    8445,8446,8447,8448,8449,8450,8451,8452,8453,8454,8455,8456,
    8457,8458,8459,8460,8461,8462,8463,8464,8465,8466,8467,8468,
    8469,8470,8471,8472,8473,8474,8475,8476,8477,8478,8479,8480,
    8481,8482,8483,8484,8485,8486,8487,8488,8489,8490,8491,8492,
    8493,8494,8495,8496,8497,8498,8499,8500,8501,8502,8503,8504,
    8505,8506,8507,8508,8509,8510,8511,8512,8513,8514,8515,8516,
    8517,8518,8519,8520,8521,8522,8523,8524,8525,8526,8527,8528,
    8529,8530,8531,8532,8533,8534,8535,8536,8537,8538,8539,8540,
    8541,8542,8543,8544,8545,8546,8547,8548,8549,8550,8551,8552,
    8553,8554,8555,8556,8557,8558,8559,8560,8561,8562,8563,8564,
    8565,8566,8567,8568,8569,8570,8571,8572,8573,8574,8575,8576,
    8577,8578,8579,8580,8581,8582,8583,8584,8585,8586,8587,8588,
    8589,8590,8591,8592,8593,8594,8595,8596,8597,8598,8599,8600,
    8601,8602,8603,8604,8605,8606,8607,8608,8609,8610,8611,8612,
    8613,8614,8615,8616,8617,8618,8619,8620,8621,8622,8623,8624,
    8625,8626,8627,8628,8629,8630,8631,8632,8633,8634,8635,8636,
    8637,8638,8639,8640,8641,8642,8643,8644,8645,8646,8647,8648,
    8649,8650,8651,8652,8653,8654,8655,8656,8657,8658,8659,8660,
    8661,8662,8663,8664,8665,8666,8667,8668,8669,8670,8671,8672,
    8673,8674,8675,8676,8677,8678,8679,8680,8681,8682,8683,8684,
    8685,8686,8687,8688,8689,8690,8691,8692,8693,8694,8695,8696,
    8697,8698,8699,8700,8701,8702,8703,8704,8705,8706,8707,8708,
    8709,8710,8711,8712,8713,8714,8715,8716,8717,8718,8719,8720,
    8721,8722,8723,8724,8725,8726,8727,8728,8729,8730,8731,8732,
    8733,8734,8735,8736,8737,8738,8739,8740,8741,8742,8743,8744,
    8745,8746,8747,8748,8749,8750,8751,8752,8753,8754,8755,8756,
    8757,8758,8759,8760,8761,8762,8763,8764,8765,8766,8767,8768,
    8769,8770,8771,8772,8773,8774,8775,8776,8777,8778,8779,8780,
    8781,8782,8783,8784,8785,8786,8787,8788,8789,8790,8791,8792,
    8793,8794,8795,8796,8797,8798,8799,8800,8801,8802,8803,8804,
    8805,8806,8807,8808,8809,8810,8811,8812,8813,8814,8815,8816,
    8817,8818,8819,8820,8821,8822,8823,8824,8825,8826,8827,8828,
    8829,8830,8831,8832,8833,8834,8835,8836,8837,8838,8839,8840,
    8841,8842,8843,8844,8845,8846,8847,8848,8849,8850,
    9001,9005,9007,9008,9009,9020,9021,9022,
    9064,9101,9104,9107,
    9201,9202,9203,9204,9205,9206,9207,9208,9209,9210,9211,9212,
    9213,9214,9215,9216,9217,9218,9219,9220,9221,9222,9223,9224,
    9225,9226,9227,9228,9229,9230,9231,9232,9233,9234,9235,9236,
    9237,9238,9239,9240,9241,9242,9243,9244,9245,9246,9247,9248,
    9249,9250,9251,9252,9253,9254,9255,9256,9257,9258,9259,9260,
    9261,9262,9263,9264,9265,9266,9267,9268,9269,9270,9271,9272,
    9273,9274,9275,9276,9277,9278,9279,9280,9281,9282,9283,9284,
    9285,9286,9287,9288,9289,9290,9291,9292,9293,9294,9295,9296,
    9297,9298,9299,9300,9301,9302,9303,9304,9305,9306,9307,9308,
    9309,9310,9311,9312,9313,9314,9315,9316,9317,9318,9319,9320,
    9321,9322,9323,9324,9325,9326,9327,9328,9329,9330,9331,9332,
    9333,9334,9335,9336,9337,9338,9339,9340,9341,9342,9343,9344,
    9345,9346,9347,9348,9349,9350,9351,9352,9353,9354,9355,9356,
    9357,9358,9359,9360,9361,9362,9363,9364,9365,9366,9367,9368,
    9369,9370,9371,9372,9373,9374,9375,9376,9377,9378,9379,9380,
    9381,9382,9383,9384,9385,9386,9387,9388,9389,9390,9391,9392,
    9393,9394,9395,9396,9397,9398,9399,9400,9401,9402,9403,9404,
    9405,9406,9407,9408,9409,9410,9411,9412,9413,9414,9415,9416,
    9417,9418,9419,9420,9421,9422,9423,9424,9425,9426,9427,9428,
    9429,9430,9431,9432,9433,9434,9435,9436,9437,9438,9439,9440,
    9441,9442,9443,9444,9445,9446,9447,9448,9449,9450,9451,9452,
    9453,9454,9455,9456,9457,9458,9459,9460,9461,9462,9463,9464,
    9465,9466,9467,9468,9469,9470,9471,9472,9473,9474,9475,9476,
    9477,9478,9479,9480,9481,9482,9483,9484,9485,9486,9487,9488,
    9489,9490,9491,9492,9493,9494,9495,9496,9497,9498,9499,9500,
    9501,9502,9503,9504,9505,9506,9507,9508,9531,9532,
    9602,9603,9681,9735,9843,9983,9984,
]


def get_prime_tickers():
    """
    JPXå…¬å¼Excelã‹ã‚‰ãƒ—ãƒ©ã‚¤ãƒ ã®ãƒ†ã‚£ãƒƒã‚«ãƒ¼ãƒªã‚¹ãƒˆã¨JPåè¾æ›¸ã‚’å–å¾—ã€‚
    æˆ»ã‚Šå€¤: (tickers, jp_names) jp_names={code: æ—¥æœ¬èªå}
    å¤±æ•—æ™‚ã¯FALLBACK_CODESã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€jp_names={}
    """
    try:
        print("ğŸ“¥ JPXå…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ éŠ˜æŸ„ä¸€è¦§ã‚’å–å¾—ä¸­...")
        url = "https://www.jpx.co.jp/markets/statistics-equities/misc/tvdivq0000001vg2-att/data_j.xls"
        r = req.get(url, timeout=30)
        r.raise_for_status()
        try:
            df = pd.read_excel(io.BytesIO(r.content), header=0, engine="xlrd")
        except Exception:
            df = pd.read_excel(io.BytesIO(r.content), header=0, engine="openpyxl")
        mkt_col  = [c for c in df.columns if "å¸‚å ´" in str(c)]
        code_col = [c for c in df.columns if "ã‚³ãƒ¼ãƒ‰" in str(c)]
        name_col = [c for c in df.columns if "éŠ˜æŸ„å" in str(c) or "åç§°" in str(c)]
        if not mkt_col or not code_col:
            raise ValueError("åˆ—åãŒæƒ³å®šå¤–")
        df_prime = df[df[mkt_col[0]].astype(str).str.contains("ãƒ—ãƒ©ã‚¤ãƒ ", na=False)]
        raw_codes = df_prime[code_col[0]].dropna().tolist()

        # æ—¥æœ¬èªåè¾æ›¸ã‚’æ§‹ç¯‰
        jp_names = {}
        if name_col:
            for _, row in df_prime.iterrows():
                c_str = str(row[code_col[0]]).strip().replace(".0","")
                n_str = str(row[name_col[0]]).strip()
                if c_str and n_str and n_str != "nan":
                    jp_names[c_str] = n_str
            print(f"  JPåè¾æ›¸: {len(jp_names)}ä»¶")

        tickers = []
        for c in raw_codes:
            c_str = str(c).strip().replace(".0","")
            if c_str:
                tickers.append(f"{c_str}.T")
        print(f"âœ“ JPXå…¬å¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ {len(tickers)} éŠ˜æŸ„å–å¾—ï¼ˆæ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ ï¼‰")
        return tickers, jp_names
    except Exception as e:
        print(f"âš  JPXå–å¾—å¤±æ•—ï¼ˆ{e}ï¼‰â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨")
        codes = sorted(set(FALLBACK_CODES))
        tickers = [f"{c}.T" for c in codes]
        print(f"  ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: {len(tickers)} éŠ˜æŸ„")
        return tickers, {}


def calc_rsi(prices, period=14):
    delta = prices.diff()
    gain  = delta.where(delta > 0, 0.0)
    loss  = -delta.where(delta < 0, 0.0)
    ag    = gain.rolling(window=period, min_periods=period).mean()
    al    = loss.rolling(window=period, min_periods=period).mean()
    rs    = ag / al.replace(0, np.nan)
    return (100 - 100 / (1 + rs)).fillna(50)


def fetch_one(ticker, _retry=0):
    try:
        time.sleep(0.1)  # æœ€å°ã‚¦ã‚§ã‚¤ãƒˆï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰
        stock = yf.Ticker(ticker)
        hist  = stock.history(period="120d")
        if hist.empty or len(hist) < 30:
            return None
        closes = hist["Close"]
        price  = round(float(closes.iloc[-1]), 1)
        ma25   = round(float(closes.rolling(25).mean().iloc[-1]), 1)
        ma75_v = closes.rolling(75).mean().iloc[-1]
        ma75   = round(float(ma75_v) if not pd.isna(ma75_v) else ma25 * 1.02, 1)
        rsi    = round(float(calc_rsi(closes).iloc[-1]), 0)
        vol5   = hist["Volume"].iloc[-5:].mean()
        vol20  = hist["Volume"].iloc[-20:].mean()
        vol_r  = round(vol5 / vol20, 2) if vol20 > 0 else 1.0
        info     = stock.info
        raw_div  = float(info.get("dividendYield", 0) or 0)
        dividend = round(raw_div if raw_div < 10 else raw_div / 100, 2)
        pbr      = round(float(info.get("priceToBook", 0) or 0), 2)
        per      = round(float(info.get("trailingPE",  0) or 0), 1)
        # éŠ˜æŸ„å: longNameã«æ—¥æœ¬èªãŒå…¥ã‚‹ã“ã¨ãŒå¤šã„ã®ã§å„ªå…ˆ
        long_name  = info.get("longName") or ""
        short_name = info.get("shortName") or ""
        # æ—¥æœ¬èªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°å„ªå…ˆã—ã¦ä½¿ã†
        def has_jp(s): return any(ord(c)>127 for c in s)
        if has_jp(long_name):
            name = long_name
        elif has_jp(short_name):
            name = short_name
        else:
            # è‹±èªåã—ã‹ãªã„å ´åˆã¯shortNameã‚’ä½¿ã†ï¼ˆå¾Œã§JPåè¾æ›¸ã§ä¸Šæ›¸ãï¼‰
            name = short_name or long_name or ticker.replace(".T","")
        sector   = info.get("sector") or info.get("industry") or "ãã®ä»–"

        # â”€â”€ è‹±èªâ†’æ—¥æœ¬èªã‚»ã‚¯ã‚¿ãƒ¼å¤‰æ› â”€â”€
        SECTOR_EN_TO_JP = {
            "Technology": "æƒ…å ±ãƒ»é€šä¿¡æ¥­",
            "Communication Services": "æƒ…å ±ãƒ»é€šä¿¡æ¥­",
            "Financial Services": "ãã®ä»–é‡‘èæ¥­",
            "Consumer Cyclical": "å°å£²æ¥­",
            "Consumer Defensive": "é£Ÿæ–™å“",
            "Healthcare": "åŒ»è–¬å“",
            "Industrials": "æ©Ÿæ¢°",
            "Basic Materials": "åŒ–å­¦",
            "Energy": "çŸ³æ²¹ãƒ»çŸ³ç‚­è£½å“",
            "Real Estate": "ä¸å‹•ç”£æ¥­",
            "Utilities": "é›»æ°—ãƒ»ã‚¬ã‚¹æ¥­",
        }
        if sector in SECTOR_EN_TO_JP:
            sector = SECTOR_EN_TO_JP[sector]

        # â”€â”€ ã‚«ã‚¹ã‚¿ãƒ æ¥­ç¨®ä¸Šæ›¸ãï¼ˆæ±è¨¼åˆ†é¡ãŒå®Ÿæ…‹ã¨åˆã‚ãªã„éŠ˜æŸ„ï¼‰â”€â”€
        code_str = ticker.replace(".T", "")
        CUSTOM_SECTOR = {
            # ã‚²ãƒ¼ãƒ 
            "7974": "ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡",  # ä»»å¤©å ‚
            "3635": "ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡",  # ã‚³ãƒ¼ã‚¨ãƒ¼ãƒ†ã‚¯ãƒ¢
            "9684": "ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡",  # ã‚¹ã‚¯ã‚¦ã‚§ã‚¢ãƒ»ã‚¨ãƒ‹ãƒƒã‚¯ã‚¹
            "9766": "ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡",  # ã‚³ãƒŠãƒŸ
            "3659": "ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡",  # ãƒã‚¯ã‚½ãƒ³
            "2121": "ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡",  # mixi
            "9697": "ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡",  # ã‚«ãƒ—ã‚³ãƒ³
            "7832": "ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡",  # ãƒãƒ³ãƒ€ã‚¤ãƒŠãƒ ã‚³
            "3668": "ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡",  # ã‚³ãƒ­ãƒ—ãƒ©
            "3765": "ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡",  # ã‚¬ãƒ³ãƒ›ãƒ¼
            # åŠå°ä½“
            "6723": "åŠå°ä½“",  # ãƒ«ãƒã‚µã‚¹ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ‹ã‚¯ã‚¹
            "6526": "åŠå°ä½“",  # ã‚½ã‚·ã‚ªãƒã‚¯ã‚¹ãƒˆ
            "6857": "åŠå°ä½“",  # ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆ
            "8035": "åŠå°ä½“",  # æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³
            "6920": "åŠå°ä½“",  # ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒƒã‚¯
            "6146": "åŠå°ä½“",  # ãƒ‡ã‚£ã‚¹ã‚³
            # ITãƒ»SaaS
            "4443": "ITãƒ»SaaS",  # Sansan
            "4478": "ITãƒ»SaaS",  # ãƒ•ãƒªãƒ¼
            "4751": "ITãƒ»ãƒãƒƒãƒˆ",  # ã‚µã‚¤ãƒãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
            "4689": "ITãƒ»ãƒãƒƒãƒˆ",  # Zãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹
            "4755": "ITãƒ»ãƒãƒƒãƒˆ",  # æ¥½å¤©ã‚°ãƒ«ãƒ¼ãƒ—
            "9434": "é€šä¿¡ã‚­ãƒ£ãƒªã‚¢",  # ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯
            "9433": "é€šä¿¡ã‚­ãƒ£ãƒªã‚¢",  # KDDI
            "9432": "é€šä¿¡ã‚­ãƒ£ãƒªã‚¢",  # NTT
            # å•†ç¤¾
            "8058": "ç·åˆå•†ç¤¾",  # ä¸‰è±å•†äº‹
            "8031": "ç·åˆå•†ç¤¾",  # ä¸‰äº•ç‰©ç”£
            "8001": "ç·åˆå•†ç¤¾",  # ä¼Šè—¤å¿ 
            "8002": "ç·åˆå•†ç¤¾",  # ä¸¸ç´…
            "8053": "ç·åˆå•†ç¤¾",  # ä½å‹å•†äº‹
            # ãƒ¡ã‚¬ãƒãƒ³ã‚¯
            "8306": "ãƒ¡ã‚¬ãƒãƒ³ã‚¯",  # ä¸‰è±UFJ
            "8316": "ãƒ¡ã‚¬ãƒãƒ³ã‚¯",  # ä¸‰äº•ä½å‹FG
            "8411": "ãƒ¡ã‚¬ãƒãƒ³ã‚¯",  # ã¿ãšã»FG
        }
        if code_str in CUSTOM_SECTOR:
            sector = CUSTOM_SECTOR[code_str]
        # æ™‚ä¾¡ç·é¡ï¼ˆå„„å††ï¼‰
        mc_raw   = info.get("marketCap") or 0
        market_cap_b = round(mc_raw / 1e8, 0) if mc_raw else 0  # å„„å††
        # å‡ºæ¥é«˜ãƒ»å£²è²·ä»£é‡‘ï¼ˆç›´è¿‘5æ—¥å¹³å‡ï¼‰
        vol_avg5      = round(float(hist["Volume"].iloc[-5:].mean()), 0)
        turnover_avg5 = round(float((hist["Volume"] * hist["Close"]).iloc[-5:].mean() / 1e8), 2)

        # â”€â”€ æ³¨ç›®åº¦æŒ‡æ¨™ï¼ˆè¿½åŠ APIä¸è¦ãƒ»histã‹ã‚‰è¨ˆç®—ï¼‰â”€â”€
        # æ˜¨æ—¥ã®å‡ºæ¥é«˜å€ç‡ï¼ˆæ˜¨æ—¥1æ—¥ vs éå»20æ—¥å¹³å‡ï¼‰
        vol_yesterday  = float(hist["Volume"].iloc[-1])
        vol_mean20     = float(hist["Volume"].iloc[-20:].mean())
        vol_ratio_1d   = round(vol_yesterday / vol_mean20, 2) if vol_mean20 > 0 else 1.0

        # å‰æ—¥æ¯”ï¼ˆæ˜¨æ—¥çµ‚å€¤ vs ä¸€æ˜¨æ—¥çµ‚å€¤ï¼‰
        ret_1d = 0.0
        if len(closes) >= 2:
            ret_1d = round((float(closes.iloc[-1]) - float(closes.iloc[-2])) / float(closes.iloc[-2]) * 100, 2)

        # æ˜¨æ—¥ã®å€¤å¹…ç‡ (é«˜å€¤-å®‰å€¤)/çµ‚å€¤ %
        range_pct = 0.0
        if "High" in hist.columns and "Low" in hist.columns:
            h_yesterday = float(hist["High"].iloc[-1])
            l_yesterday = float(hist["Low"].iloc[-1])
            range_pct   = round((h_yesterday - l_yesterday) / price * 100, 2)

        # å§‹å€¤ã‚®ãƒ£ãƒƒãƒ—ï¼ˆå¯„ã‚Šä»˜ãã‚®ãƒ£ãƒƒãƒ—ç‡ï¼‰
        gap_pct = 0.0
        if "Open" in hist.columns and len(closes) >= 2:
            open_today  = float(hist["Open"].iloc[-1])
            close_prev  = float(closes.iloc[-2])
            gap_pct     = round((open_today - close_prev) / close_prev * 100, 2)

        # trend_score: log(vol_ratio) * 60 + |ret_1d| * 4 + |range_pct| * 3
        import math
        trend_score = round(
            math.log(max(vol_ratio_1d, 0.01)) * 60
            + abs(ret_1d) * 4
            + abs(range_pct) * 3,
        1)

        # â”€â”€ ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼†è‡ªåˆ†æ¯”æŠ¼ã—ç›®åº¦ â”€â”€
        daily_ret = closes.pct_change().dropna()
        volatility = round(float(daily_ret.iloc[-60:].std()) * 100, 3) if len(daily_ret) >= 20 else 2.0
        d25_pct = (price - ma25) / ma25 * 100 if ma25 else 0
        dip_zscore = round(d25_pct / volatility, 2) if volatility > 0 else 0

        # â”€â”€ MAä¹–é›¢ç‡ï¼ˆ%ï¼‰ â”€â”€
        ma25_dev = round((price - ma25) / ma25 * 100, 2) if ma25 else 0
        ma75_dev = round((price - ma75) / ma75 * 100, 2) if ma75 else 0

        # â”€â”€ ãƒãƒ£ãƒ¼ãƒˆç”¨ çµ‚å€¤é…åˆ—ï¼ˆ60æ—¥åˆ†ï¼‰ â”€â”€
        closes_60d = []
        if len(closes) >= 60:
            closes_60d = [round(float(c), 1) for c in closes.iloc[-60:].tolist()]
        elif len(closes) >= 20:
            closes_60d = [round(float(c), 1) for c in closes.tolist()]

        # â”€â”€ çŸ­æœŸãƒ»ä¸­æœŸãƒªã‚¿ãƒ¼ãƒ³ â”€â”€
        ret5  = round((float(closes.iloc[-1]) / float(closes.iloc[-6]) - 1) * 100, 2) if len(closes) >= 6 else 0
        ret10 = round((float(closes.iloc[-1]) / float(closes.iloc[-11]) - 1) * 100, 2) if len(closes) >= 11 else 0
        ret20 = round((float(closes.iloc[-1]) / float(closes.iloc[-21]) - 1) * 100, 2) if len(closes) >= 21 else 0
        ret60 = round((float(closes.iloc[-1]) / float(closes.iloc[-61]) - 1) * 100, 2) if len(closes) >= 61 else 0
        ret120 = round((float(closes.iloc[-1]) / float(closes.iloc[0]) - 1) * 100, 2) if len(closes) >= 80 else 0

        # â”€â”€ æ©Ÿé–¢æŠ•è³‡å®¶æŒ‡æ¨™ï¼ˆyfinance .infoã‹ã‚‰ç„¡æ–™å–å¾—ï¼‰â”€â”€
        roe = round(float(info.get("returnOnEquity", 0) or 0) * 100, 1)  # ROE %
        profit_margin = round(float(info.get("profitMargins", 0) or 0) * 100, 1)  # åˆ©ç›Šç‡ %
        revenue_growth = round(float(info.get("revenueGrowth", 0) or 0) * 100, 1)  # å£²ä¸Šæˆé•·ç‡ %
        earnings_growth = round(float(info.get("earningsGrowth", 0) or 0) * 100, 1)  # åˆ©ç›Šæˆé•·ç‡ %

        # â”€â”€ å‡ºæ¥é«˜ãƒˆãƒ¬ãƒ³ãƒ‰ â”€â”€
        vol_trend = round(float(hist["Volume"].iloc[-5:].mean()) / float(hist["Volume"].iloc[-20:].mean()), 2) if vol_mean20 > 0 else 1.0

        # â”€â”€ ä¾¡æ ¼ä½ç½®ï¼ˆ52é€±é«˜å€¤/å®‰å€¤ã‹ã‚‰ã®ä½ç½®ï¼‰â”€â”€
        high_52w = float(closes.max()) if len(closes) >= 60 else price
        low_52w = float(closes.min()) if len(closes) >= 60 else price
        price_position = round((price - low_52w) / (high_52w - low_52w) * 100, 1) if high_52w != low_52w else 50.0

        # â”€â”€ æ±ºç®—æ—¥æƒ…å ± â”€â”€
        most_recent_q = info.get("mostRecentQuarter")  # timestamp
        earnings_date = None
        days_since_earnings = None
        days_to_next_earnings = None
        if most_recent_q:
            from datetime import date
            try:
                last_q = date.fromtimestamp(most_recent_q)
                today_d = date.today()
                days_since_earnings = (today_d - last_q).days
                # æ¬¡å›æ±ºç®—ã¯ç´„90æ—¥å¾Œã¨æ¨å®š
                next_q = last_q + __import__('datetime').timedelta(days=90)
                days_to_next_earnings = (next_q - today_d).days
                if days_to_next_earnings < 0:
                    # æ—¢ã«éãã¦ã„ã‚‹å ´åˆã¯+90æ—¥
                    next_q = next_q + __import__('datetime').timedelta(days=90)
                    days_to_next_earnings = (next_q - today_d).days
                earnings_date = last_q.strftime("%Y-%m-%d")
            except:
                pass

        return {
            "code":          ticker.replace(".T",""),
            "name":          name,
            "sector":        sector,
            "price":         price,
            "ma25":          ma25,
            "ma75":          ma75,
            "rsi":           int(rsi),
            "dividend":      dividend,
            "pbr":           pbr,
            "per":           per,
            "vol_r":         vol_r,
            "vol_avg5":      int(vol_avg5),
            "turnover_avg5": turnover_avg5,
            # â”€â”€ æ³¨ç›®åº¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ â”€â”€
            "vol_ratio_1d":  vol_ratio_1d,
            "avg_volume":    int(vol_mean20) if vol_mean20 > 0 else 0,
            "ret_1d":        ret_1d,
            "range_pct":     range_pct,
            "gap_pct":       gap_pct,
            "trend_score":   trend_score,
            "market_cap_b":  market_cap_b,
            "volatility":    volatility,
            "dip_zscore":    dip_zscore,
            "ret5":          ret5,
            "ret10":         ret10,
            "ret20":         ret20,
            "ret60":         ret60,
            "ret120":        ret120,
            # â”€â”€ æ©Ÿé–¢æŠ•è³‡å®¶æŒ‡æ¨™ â”€â”€
            "roe":              roe,
            "profit_margin":    profit_margin,
            "revenue_growth":   revenue_growth,
            "earnings_growth":  earnings_growth,
            "vol_trend":        vol_trend,
            "price_position":   price_position,
            # â”€â”€ æ±ºç®—æ—¥ â”€â”€
            "earnings_date":          earnings_date,
            "days_since_earnings":    days_since_earnings,
            "days_to_next_earnings":  days_to_next_earnings,
            # â”€â”€ MAä¹–é›¢ç‡+ãƒãƒ£ãƒ¼ãƒˆ â”€â”€
            "ma25_dev":       ma25_dev,
            "ma75_dev":       ma75_dev,
            "closes_60d":     closes_60d,
        }
    except Exception as e:
        err = str(e).lower()
        if "too many requests" in err or "rate limit" in err or "401" in err:
            if _retry < 3:
                time.sleep(5 + _retry * 5)  # 5ç§’â†’10ç§’â†’15ç§’
                return fetch_one(ticker, _retry + 1)
        return None


def fetch_market():
    print("\nğŸ“¡ å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...")
    market = {}
    specs = [
        ("^N225","nikkei"),("^IXIC","nasdaq"),
        ("^VIX","vix"),("JPY=X","usdjpy"),("^TNX","us10y"),
    ]
    for ticker, key in specs:
        try:
            hist = yf.Ticker(ticker).history(period="5d")
            if hist.empty: continue
            closes = hist["Close"]
            latest = float(closes.iloc[-1])
            prev   = float(closes.iloc[-2]) if len(closes)>=2 else latest
            chg    = round((latest-prev)/prev*100, 2)
            if key=="nikkei":
                market["nikkei_price"]  = round(latest,0)
                market["nikkei_1d_chg"] = chg
                h90 = yf.Ticker(ticker).history(period="90d")
                market["nikkei_ma25"] = round(float(h90["Close"].rolling(25).mean().iloc[-1]),0)
            elif key=="nasdaq":
                market["nasdaq_1d_chg"] = chg
            elif key=="vix":
                market["vix"]=round(latest,1); market["vix_chg"]=chg
            elif key=="usdjpy":
                market["usdjpy"]=round(latest,2); market["usdjpy_chg"]=round(latest-prev,2)
            elif key=="us10y":
                market["us10y"]=round(latest,2)
            print(f"  âœ“ {key}: {round(latest,2)}")
        except Exception as e:
            print(f"  âš  {key}: {e}")
    try:
        th = yf.Ticker("1306.T").history(period="5d")
        if not th.empty:
            market["topix_price"]  = round(float(th["Close"].iloc[-1]),0)
            market["topix_1d_chg"] = round((float(th["Close"].iloc[-1])-float(th["Close"].iloc[-2]))/float(th["Close"].iloc[-2])*100,2) if len(th)>=2 else 0
    except Exception: pass
    market["geo_risk"]      = False
    market["rate_cut_flag"] = False
    return market


def calc_score_stable(s):
    """å®‰å®šé«˜é…å½“ã‚¹ã‚³ã‚¢ï¼šæ™‚ä¾¡ç·é¡å¤§ãƒ»é…å½“é‡è¦–ãƒ»å¤§å‹å®‰å®šæ ªå„ªé‡"""
    d25 = (s["price"] - s["ma25"]) / s["ma25"] * 100 if s["ma25"] else 0
    div = s.get("dividend", 0)
    if div < 2: return 0  # é…å½“2%æœªæº€ã¯å¯¾è±¡å¤–

    score = 0

    # é…å½“åˆ©å›ã‚Š (max 30pt) â€” 3%å°ã§ã‚‚ã—ã£ã‹ã‚ŠåŠ ç‚¹
    score += (30 if div >= 5 else 25 if div >= 4.5 else 20 if div >= 4
              else 16 if div >= 3.5 else 12 if div >= 3 else 6 if div >= 2.5 else 0)

    # æ™‚ä¾¡ç·é¡ãƒœãƒ¼ãƒŠã‚¹ (max 15pt) â€” å¤§å‹å®‰å®šæ ªã‚’å„ªé‡
    mc = s.get("market_cap_b", 0)
    score += (15 if mc >= 10000 else 11 if mc >= 5000 else 7 if mc >= 1000
              else 3 if mc >= 500 else 0)
    # å°å‹ãƒšãƒŠãƒ«ãƒ†ã‚£
    if 0 < mc < 300: score -= 10

    # 25MAä¹–é›¢ (max 22pt) â€” å¤§å‹æ ªå‘ã‘ã«-1.5%ã‹ã‚‰åŠ ç‚¹
    score += (22 if d25 <= -10 else 18 if d25 <= -7 else 14 if d25 <= -5
              else 9 if d25 <= -3 else 4 if d25 <= -1.5 else 0)

    # RSI (max 18pt)
    rsi = s.get("rsi", 50)
    score += (18 if rsi <= 25 else 14 if rsi <= 30 else 9 if rsi <= 37 else 4 if rsi <= 43 else 0)

    # PBR (max 10pt)
    pbr = s.get("pbr", 99)
    score += (10 if pbr <= 0.7 else 7 if pbr <= 1.0 else 3 if pbr <= 1.5 else 0)

    # å®‰å®šæ ªãƒœãƒ¼ãƒŠã‚¹ (max 5pt) â€” é…å½“3%ä»¥ä¸Šãƒ»é»’å­—ãƒ»å¤§å‹ã®ä¸‰æ‹å­
    if div >= 3 and s.get("per", 0) > 0 and mc >= 1000:
        score += 5

    # å‡ºæ¥é«˜æ€¥å¢—ãƒšãƒŠãƒ«ãƒ†ã‚£
    if s.get("vol_r", 1) >= 1.5: score -= 15
    if s.get("vol_r", 1) >= 2.5: score -= 10

    return max(0, min(score, 100))


def calc_score_bluechip(s):
    """å®‰å®šé«˜é…å½“ã‚¹ã‚³ã‚¢ v4ï¼šãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæœ€é©åŒ–æ¸ˆã¿
    
    ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè¶³åˆ‡ã‚Šï¼‰: é…å½“>=2%, æ™‚ä¾¡ç·é¡>=500å„„
    ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé †ä½æ±ºå®šï¼‰: ã‚¿ã‚¤ãƒŸãƒ³ã‚°æŒ‡æ¨™ãŒæœ€é‡è¦
    
    ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ:
      - é…å½“åˆ©å›ã‚Š â†’ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åŠ¹ã‹ãªã„ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å°‚ç”¨ï¼‰
      - ret5, ret5_vs_sector â†’ æœ€ã‚‚5æ—¥å¾Œãƒªã‚¿ãƒ¼ãƒ³ã«ç›¸é–¢
      - dip_zscore â†’ æœ‰åŠ¹
    """
    div = s.get("dividend", 0)
    mc = s.get("market_cap_b", 0)
    if div < 2 or mc < 500: return 0

    score = 0

    # â”€â”€ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é€šéãƒœãƒ¼ãƒŠã‚¹ï¼ˆéŠ˜æŸ„ã®è³ªï¼‰â”€â”€ max 16pt
    # é…å½“ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å°‚ç”¨ã€‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ã¯ä½¿ã‚ãªã„ï¼ˆãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµè«–ï¼‰

    # æ™‚ä¾¡ç·é¡ (max 5pt) â€” å¤§å‹ã»ã©å®‰å®šã ãŒé…ç‚¹ã¯æ§ãˆã‚
    score += (5 if mc >= 50000 else 4 if mc >= 10000 else 3 if mc >= 5000
              else 2 if mc >= 1000 else 1 if mc >= 500 else 0)

    # å¢—é…ãƒœãƒ¼ãƒŠã‚¹ (max 6pt)
    dgy = s.get("div_growth_years", 0)
    score += (6 if dgy >= 15 else 4 if dgy >= 10 else 3 if dgy >= 7
              else 2 if dgy >= 5 else 0)

    # PBR (max 5pt)
    pbr = s.get("pbr", 99)
    score += (5 if pbr <= 0.7 else 4 if pbr <= 0.9 else 3 if pbr <= 1.2
              else 1 if pbr <= 1.5 else 0)

    # â”€â”€ ã‚¿ã‚¤ãƒŸãƒ³ã‚°æŒ‡æ¨™ï¼ˆæ¯æ—¥å¤‰ã‚ã‚‹ï¼‰â”€â”€ max 75pt
    # ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã§æœ€ã‚‚5æ—¥å¾Œãƒªã‚¿ãƒ¼ãƒ³ã«ç›¸é–¢ã—ãŸæŒ‡æ¨™ç¾¤

    # å€‹åˆ¥ vs ã‚»ã‚¯ã‚¿ãƒ¼å·®åˆ† (max 25pt) â† ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæœ‰åŠ¹
    diff5 = s.get("ret5_vs_sector", 0)
    score += (25 if diff5 <= -5 else 19 if diff5 <= -3 else 13 if diff5 <= -1.5
              else 6 if diff5 <= -0.5 else 0)

    # ã‚»ã‚¯ã‚¿ãƒ¼ä¸‹è½ãƒšãƒŠãƒ«ãƒ†ã‚£
    sec_r5 = s.get("sector_ret5", 0)
    if sec_r5 <= -3:
        score -= 5

    # å€‹åˆ¥5æ—¥ä¸‹è½ (max 25pt) â† ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæœ€å¼·æŒ‡æ¨™
    r5 = s.get("ret5", 0)
    score += (25 if r5 <= -5 else 18 if r5 <= -3 else 10 if r5 <= -1.5
              else 3 if r5 <= -0.5 else 0)

    # è‡ªåˆ†æ¯”æŠ¼ã—ç›®åº¦ (max 15pt)
    z = s.get("dip_zscore", 0)
    score += (15 if z <= -3.0 else 12 if z <= -2.0 else 9 if z <= -1.5
              else 6 if z <= -1.0 else 3 if z <= -0.5 else 0)

    # 10æ—¥ãƒªã‚¿ãƒ¼ãƒ³ (max 5pt)
    r10 = s.get("ret10", 0)
    score += (5 if r10 <= -8 else 3 if r10 <= -5 else 2 if r10 <= -2
              else 1 if r10 <= -1 else 0)

    # å®‰å®šæ ªãƒœãƒ¼ãƒŠã‚¹ (max 5pt)
    if s.get("per", 0) > 0 and div >= 2 and mc >= 5000:
        score += 5
    elif s.get("per", 0) > 0 and div >= 2 and mc >= 1000:
        score += 3

    # â”€â”€ æ€¥è½ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆè½ã¡ã‚‹ãƒŠã‚¤ãƒ•å›é¿ï¼‰â”€â”€
    # å‡ºæ¥é«˜å€ç‡3å€ä»¥ä¸Š = ãƒ‘ãƒ‹ãƒƒã‚¯å£²ã‚Šã®å¯èƒ½æ€§
    vr1d = s.get("vol_ratio_1d", 1)
    if vr1d >= 3.0:
        score -= 10
    elif vr1d >= 2.5:
        score -= 5
    # 1æ—¥ã®ä¸‹è½ãŒ-5%è¶… = æ‚ªææ–™ã®å¯èƒ½æ€§
    ret_1d = s.get("ret_1d", 0)
    if ret_1d <= -5:
        score -= 8
    elif ret_1d <= -3:
        score -= 4
    # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒé€šå¸¸ã®2å€ä»¥ä¸Š = ä¸å®‰å®š
    vol = s.get("volatility", 2)
    if vol >= 4.0:  # é€šå¸¸2%ç¨‹åº¦ãªã®ã§4%ä»¥ä¸Šã¯ç•°å¸¸
        score -= 5

    return max(0, min(score, 100))


def calc_score_momentum(s):
    """ğŸš€ å‹¢ã„ã‚¹ã‚³ã‚¢ï¼šãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ +ã‚¯ã‚ªãƒªãƒ†ã‚£+å‡ºæ¥é«˜ã§ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰éŠ˜æŸ„ã‚’æ¤œå‡º
    
    æ©Ÿé–¢æŠ•è³‡å®¶ã®ã‚¯ã‚ªãƒ³ãƒ„ãƒ¢ãƒ‡ãƒ«ã‚’ç°¡æ˜“å†ç¾:
      - ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ï¼ˆä¸ŠãŒã£ã¦ã„ã‚‹æ ªã¯ã•ã‚‰ã«ä¸ŠãŒã‚‹ï¼‰
      - ã‚¯ã‚ªãƒªãƒ†ã‚£ï¼ˆROEãƒ»åˆ©ç›Šæˆé•·ãŒé«˜ã„ï¼‰
      - å‡ºæ¥é«˜ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆæ©Ÿé–¢ã®å‚å…¥ã‚’æ¤œçŸ¥ï¼‰
      - ã‚»ã‚¯ã‚¿ãƒ¼å¼·åº¦ï¼ˆã‚»ã‚¯ã‚¿ãƒ¼å…¨ä½“ãŒå¼·ã„ = è¿½ã„é¢¨ï¼‰
    """
    mc = s.get("market_cap_b", 0)
    if mc < 300: return 0  # æœ€ä½æ™‚ä¾¡ç·é¡300å„„

    score = 0

    # â”€â”€ ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ æŒ‡æ¨™ï¼ˆmax 40ptï¼‰â”€â”€ æœ€é‡è¦
    # 20æ—¥ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ  (max 20pt)
    r20 = s.get("ret20", 0)
    score += (20 if r20 >= 15 else 16 if r20 >= 10 else 12 if r20 >= 5
              else 6 if r20 >= 2 else 0)

    # 60æ—¥ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ  (max 10pt)
    r60 = s.get("ret60", 0)
    score += (10 if r60 >= 25 else 8 if r60 >= 15 else 5 if r60 >= 8
              else 2 if r60 >= 3 else 0)

    # 5æ—¥ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ  â€” çŸ­æœŸã®å‹¢ã„ (max 10pt)
    r5 = s.get("ret5", 0)
    score += (10 if r5 >= 5 else 7 if r5 >= 3 else 4 if r5 >= 1
              else 1 if r5 >= 0 else 0)

    # â”€â”€ ã‚¯ã‚ªãƒªãƒ†ã‚£æŒ‡æ¨™ï¼ˆmax 25ptï¼‰â”€â”€
    # ROE (max 10pt)
    roe = s.get("roe", 0)
    score += (10 if roe >= 15 else 7 if roe >= 10 else 4 if roe >= 7
              else 2 if roe >= 5 else 0)

    # åˆ©ç›Šæˆé•·ç‡ (max 8pt)
    eg = s.get("earnings_growth", 0)
    score += (8 if eg >= 30 else 6 if eg >= 15 else 4 if eg >= 5
              else 1 if eg >= 0 else 0)

    # å£²ä¸Šæˆé•·ç‡ (max 7pt)
    rg = s.get("revenue_growth", 0)
    score += (7 if rg >= 20 else 5 if rg >= 10 else 3 if rg >= 5
              else 1 if rg >= 0 else 0)

    # â”€â”€ å‡ºæ¥é«˜ãƒ»éœ€çµ¦ï¼ˆmax 20ptï¼‰â”€â”€
    # å‡ºæ¥é«˜ãƒˆãƒ¬ãƒ³ãƒ‰ â€” æ©Ÿé–¢å‚å…¥ã®ç—•è·¡ (max 12pt)
    vt = s.get("vol_trend", 1)
    score += (12 if vt >= 2.5 else 9 if vt >= 1.8 else 6 if vt >= 1.3
              else 3 if vt >= 1.1 else 0)

    # å‡ºæ¥é«˜å€ç‡1æ—¥ (max 8pt)
    vr1d = s.get("vol_ratio_1d", 1)
    score += (8 if vr1d >= 3.0 else 6 if vr1d >= 2.0 else 4 if vr1d >= 1.5
              else 1 if vr1d >= 1.1 else 0)

    # â”€â”€ ã‚»ã‚¯ã‚¿ãƒ¼è¿½ã„é¢¨ï¼ˆmax 10ptï¼‰â”€â”€
    sec_r5 = s.get("sector_ret5", 0)
    score += (10 if sec_r5 >= 3 else 7 if sec_r5 >= 1.5 else 4 if sec_r5 >= 0.5
              else 0)

    # â”€â”€ ä¾¡æ ¼ä½ç½®ãƒšãƒŠãƒ«ãƒ†ã‚£ â”€â”€
    pp = s.get("price_position", 50)
    if pp >= 98:
        score -= 5  # å¤©äº•åœãƒšãƒŠãƒ«ãƒ†ã‚£

    # â”€â”€ éç†±ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆé«˜å€¤æ´ã¿å›é¿ï¼‰â”€â”€
    # RSI80ä»¥ä¸Š = è²·ã‚ã‚Œã™ã
    rsi = s.get("rsi", 50)
    if rsi >= 80:
        score -= 8
    elif rsi >= 75:
        score -= 4
    # å‡ºæ¥é«˜å€ç‡3å€ä»¥ä¸Š + æ€¥é¨° = ä»•æ‰‹çš„ãªå‹•ã
    vr1d = s.get("vol_ratio_1d", 1)
    r5 = s.get("ret5", 0)
    if vr1d >= 3.0 and r5 >= 5:
        score -= 5  # æ€¥é¨°+å‡ºæ¥é«˜æ€¥å¢— = éç†±è­¦æˆ’
    # 1æ—¥ã§+5%ä»¥ä¸Š = ã‚®ãƒ£ãƒƒãƒ—ã‚¢ãƒƒãƒ—å¾Œã®åè½ãƒªã‚¹ã‚¯
    ret_1d = s.get("ret_1d", 0)
    if ret_1d >= 7:
        score -= 5
    elif ret_1d >= 5:
        score -= 3

    # â”€â”€ ãƒœãƒ¼ãƒŠã‚¹ â”€â”€
    div = s.get("dividend", 0)
    if div >= 2 and r20 >= 5:
        score += 5

    return max(0, min(score, 100))


def calc_score_trend(s):
    """ğŸ“ˆ v7: MA75æŠ¼ã—ç›®ã‚¹ã‚³ã‚¢ï¼ˆã‚¯ã‚ªãƒªãƒ†ã‚£Ã—ã‚¿ã‚¤ãƒŸãƒ³ã‚°æˆ¦ç•¥ï¼‰
    
    ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ã€Œå¤§æ‰‹ã§é•·æœŸä¸Šæ˜‡ä¸­ã®éŠ˜æŸ„ã‚’MA75ï¼ˆç·‘ç·šï¼‰ã‚¿ãƒƒãƒã§è²·ã†ã€
    
    é…ç‚¹:
      MA75ä¹–é›¢ç‡      25pt  â† ç·‘ç·šã«ã©ã‚Œã ã‘è¿‘ã„ã‹ï¼ˆæŠ¼ã—ç›®ã®è³ªï¼‰
      MA25ä¹–é›¢ç‡      15pt  â† çŸ­æœŸèª¿æ•´ã®æ·±ã•
      20æ—¥ãƒªã‚¿ãƒ¼ãƒ³     15pt  â† ç›´è¿‘ã®æ–¹å‘
      120æ—¥ãƒªã‚¿ãƒ¼ãƒ³    10pt  â† é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰
      60æ—¥ãƒªã‚¿ãƒ¼ãƒ³     10pt  â† ä¸­æœŸãƒˆãƒ¬ãƒ³ãƒ‰
      æŒã£ã¦ã¦å®‰å¿ƒ     15pt  â† å®‰å®šæ€§+é…å½“+å¤§å‹
      ä¸€è²«æ€§          Â±10pt â† ãƒˆãƒ¬ãƒ³ãƒ‰ã®ä¿¡é ¼æ€§
                     â”€â”€â”€â”€â”€
                    max 100pt
    """
    mc = s.get("market_cap_b", 0)
    if mc < 300: return 0, "avoid"

    score = 0
    r120 = s.get("ret120", 0)
    r60  = s.get("ret60", 0)
    r20  = s.get("ret20", 0)
    ma75_dev = s.get("ma75_dev", 0)
    ma25_dev = s.get("ma25_dev", 0)

    # â”€â”€ MA75ä¹–é›¢ç‡ (max 25pt) â€” æœ€é‡è¦ï¼šç·‘ç·šã‚¿ãƒƒãƒ â”€â”€
    # MA75ã®ä¸Šã«ã„ã¦ã€ã‹ã¤è¿‘ã„ã»ã©é«˜ã‚¹ã‚³ã‚¢ï¼ˆæŠ¼ã—ç›®ã®æœ€é«˜ãƒã‚¤ãƒ³ãƒˆï¼‰
    if 0 <= ma75_dev <= 1:      score += 25   # ã‚¿ãƒƒãƒå¯¸å‰ = æœ€é«˜ã®æŠ¼ã—ç›®
    elif 0 <= ma75_dev <= 2:    score += 22
    elif 0 <= ma75_dev <= 3:    score += 18
    elif 0 <= ma75_dev <= 5:    score += 14
    elif 0 <= ma75_dev <= 8:    score += 10
    elif 0 <= ma75_dev <= 12:   score += 6
    elif ma75_dev > 12:         score += 2    # é›¢ã‚Œã™ãï¼ˆå‹¢ã„ã¯ã‚ã‚‹ãŒæŠ¼ã—ç›®ã§ã¯ãªã„ï¼‰
    elif -2 <= ma75_dev < 0:    score += 3    # ã‚ãšã‹ã«ä¸‹æŠœã‘ï¼ˆã»ã¼åŠ ç‚¹ãªã—ï¼‰
    elif -5 <= ma75_dev < -2:   score += 0    # æ˜ç¢ºã«ä¸‹æŠœã‘ï¼ˆ0ç‚¹ï¼‰
    else:                       score -= 5    # å¤§ããä¸‹æŠœã‘ = ãƒšãƒŠãƒ«ãƒ†ã‚£

    # â”€â”€ MA25ä¹–é›¢ç‡ (max 15pt) â€” çŸ­æœŸèª¿æ•´ã®æ·±ã• â”€â”€
    if -5 <= ma25_dev <= -3:    score += 15   # è‰¯ã„æŠ¼ã—ç›®ã‚¾ãƒ¼ãƒ³
    elif -8 <= ma25_dev < -5:   score += 10   # æ·±ã„æŠ¼ã—ç›®ï¼ˆã‚„ã‚„å±é™ºã‚‚ï¼‰
    elif -3 <= ma25_dev <= -1:  score += 10   # è»½ã„èª¿æ•´
    elif -1 < ma25_dev <= 0:    score += 6    # ã»ã¼MA25ä¸Š
    elif 0 < ma25_dev <= 3:     score += 3    # MA25ã‚ˆã‚Šä¸Šï¼ˆå‹¢ã„ï¼‰
    elif ma25_dev > 3:          score += 8    # å¼·ã„ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆå‹¢ã„éŠ˜æŸ„ç”¨ï¼‰
    elif ma25_dev < -8:         score += 3    # è½ã¡ã™ãï¼ˆãƒªã‚¹ã‚¯é«˜ã„ï¼‰

    # â”€â”€ 20æ—¥ãƒªã‚¿ãƒ¼ãƒ³ (max 15pt) â”€â”€
    if r20 >= 10:     score += 15
    elif r20 >= 5:    score += 12
    elif r20 >= 2:    score += 8
    elif r20 >= 0:    score += 4
    elif r20 >= -3:   score += 6   # è»½ã„æŠ¼ã—ç›®
    elif r20 >= -5:   score += 10  # è‰¯ã„æŠ¼ã—ç›®
    elif r20 >= -8:   score += 8   # æ·±ã„æŠ¼ã—ç›®
    else:             score += 3   # è½ã¡ã™ã

    # â”€â”€ 120æ—¥ãƒªã‚¿ãƒ¼ãƒ³ (max 10pt) â€” é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰ â”€â”€
    if r120 >= 30:    score += 10
    elif r120 >= 15:  score += 8
    elif r120 >= 5:   score += 6
    elif r120 >= 0:   score += 3
    elif r120 >= -5:  score += 0
    else:             score -= 3

    # â”€â”€ 60æ—¥ãƒªã‚¿ãƒ¼ãƒ³ (max 10pt) â€” ä¸­æœŸãƒˆãƒ¬ãƒ³ãƒ‰ â”€â”€
    if r60 >= 15:     score += 10
    elif r60 >= 8:    score += 8
    elif r60 >= 3:    score += 5
    elif r60 >= 0:    score += 2
    elif r60 >= -5:   score += 0
    else:             score -= 3

    # â”€â”€ æŒã£ã¦ã¦å®‰å¿ƒã‚¹ã‚³ã‚¢ (max 15pt) â”€â”€
    div = s.get("dividend", 0)
    vol = s.get("volatility", 2)
    roe = s.get("roe", 0)
    pbr = s.get("pbr", 99)

    # é…å½“ã®åšã¿ (max 5pt)
    if div >= 4:     score += 5
    elif div >= 3:   score += 4
    elif div >= 2.5: score += 3
    elif div >= 2:   score += 2

    # å®‰å®šä¸Šæ˜‡ï¼ˆä½ãƒœãƒ©+é•·æœŸãƒ—ãƒ©ã‚¹ï¼‰(max 5pt)
    if vol <= 1.5 and r120 >= 5:   score += 5
    elif vol <= 2.0 and r120 >= 5: score += 4
    elif vol <= 2.5 and r120 >= 0: score += 2

    # å¤§å‹å®‰å¿ƒ (max 5pt)
    if mc >= 10000:  score += 5   # 1å…†ä»¥ä¸Š
    elif mc >= 5000: score += 4   # 5000å„„ä»¥ä¸Š
    elif mc >= 2000: score += 3
    elif mc >= 1000: score += 2
    elif mc >= 500:  score += 1

    # â”€â”€ ä¸€è²«æ€§ãƒœãƒ¼ãƒŠã‚¹ (Â±10pt) â”€â”€
    periods = [r120, r60, r20]
    positive_count = sum(1 for r in periods if r > 0)
    if positive_count == 3:
        score += 10
    elif positive_count == 2:
        score += 5
    elif positive_count == 0:
        score -= 5

    # â”€â”€ æ€¥è½/éç†±ãƒšãƒŠãƒ«ãƒ†ã‚£ â”€â”€
    vr1d = s.get("vol_ratio_1d", 1)
    ret_1d = s.get("ret_1d", 0)
    rsi = s.get("rsi", 50)
    if vr1d >= 3.0 and ret_1d <= -3:
        score -= 10  # ãƒ‘ãƒ‹ãƒƒã‚¯å£²ã‚Š
    if vr1d >= 3.0 and ret_1d >= 5:
        score -= 8   # ä»•æ‰‹çš„æ€¥é¨°
    if rsi >= 80:
        score -= 5   # RSIéç†±

    score = max(0, min(score, 100))

    # â”€â”€ ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—åˆ¤å®š â”€â”€
    # MA75ã®ä¸Š + MA25ã®ä¸‹ = æŠ¼ã—ç›®
    # MA75ã®ä¸Š + MA25ã®ä¸Š = å‹¢ã„
    # MA75ã®ä¸‹ = å±é™º or åç™º
    if ma75_dev >= 0 and ma25_dev < 0 and positive_count >= 2:
        trend_type = "dip"       # ğŸ›¡ MA75ä¸Šã§MA25ä¸‹æŠœã‘ = æœ€é«˜ã®æŠ¼ã—ç›®
    elif ma75_dev >= 0 and ma25_dev >= 0 and positive_count >= 2:
        trend_type = "momentum"  # ğŸš€ ä¸¡MAä¸Š = å‹¢ã„
    elif ma75_dev < 0 and ma25_dev < 0:
        trend_type = "falling"   # âš  ä¸¡MAä¸‹ = è½ã¡ã‚‹ãƒŠã‚¤ãƒ•
    elif ma75_dev < 0 and ma25_dev >= 0:
        trend_type = "bounce"    # ğŸ”„ MA75ä¸‹ã ãŒMA25ä¸Š = åç™º
    elif ma75_dev >= 0 and positive_count <= 1:
        trend_type = "neutral"   # ğŸ˜ MA75ä¸Šã ãŒãƒˆãƒ¬ãƒ³ãƒ‰ä¸æ˜
    else:
        trend_type = "neutral"

    # fallingè¿½åŠ ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆ-10ptï¼‰
    if trend_type == "falling":
        score = max(0, score - 10)

    return score, trend_type


def calc_score_growth(s):
    """æˆé•·æŠ¼ã—ç›®ã‚¹ã‚³ã‚¢ï¼šMAä¹–é›¢ãƒ»RSIé‡è¦–ãƒ»å°å‹OK"""
    d25 = (s["price"] - s["ma25"]) / s["ma25"] * 100 if s["ma25"] else 0
    score = 0
    score += 35 if d25 <= -15 else 28 if d25 <= -10 else 20 if d25 <= -6 else 10 if d25 <= -3 else 3 if d25 <= -1 else 0
    rsi = s.get("rsi", 50)
    score += 30 if rsi <= 20 else 22 if rsi <= 28 else 14 if rsi <= 35 else 7 if rsi <= 42 else 0
    pbr = s.get("pbr", 99)
    score += 15 if pbr <= 0.8 else 10 if pbr <= 1.2 else 5 if pbr <= 2.0 else 0
    div = s.get("dividend", 0)
    score += 10 if div >= 4 else 6 if div >= 2 else 2 if div >= 1 else 0
    per = s.get("per", 99)
    score += 10 if per <= 10 else 5 if per <= 15 else 0
    if s.get("vol_r", 1) >= 2.0: score -= 15
    return max(0, min(score, 100))


def calc_score(s, mode="dividend"):
    d25 = (s["price"]-s["ma25"])/s["ma25"]*100 if s["ma25"] else 0
    score = 0

    # é…å½“ã‚¹ã‚³ã‚¢
    dp = (30 if s["dividend"]>=5 else 25 if s["dividend"]>=4.5 else
          20 if s["dividend"]>=4 else 15 if s["dividend"]>=3.5 else
          10 if s["dividend"]>=3 else 5  if s["dividend"]>=2.5 else 0)
    if mode=="dividend": dp=min(round(dp*1.4),40)
    score+=dp

    # MAä¹–é›¢ã‚¹ã‚³ã‚¢
    mp = (28 if d25<=-8 else 22 if d25<=-6 else 12 if d25<=-4 else 5 if d25<=-2 else 0)
    if mode=="rebound": mp=min(round(mp*1.5),35)
    score+=mp

    # RSIã‚¹ã‚³ã‚¢
    rp = (22 if s["rsi"]<=28 else 16 if s["rsi"]<=32 else 10 if s["rsi"]<=38 else 5 if s["rsi"]<=42 else 0)
    if mode=="rebound": rp=min(round(rp*1.3),25)
    score+=rp

    # PBRã‚¹ã‚³ã‚¢
    pp = (18 if s["pbr"]<=0.7 else 13 if s["pbr"]<=0.9 else 7 if s["pbr"]<=1.1 else 3 if s["pbr"]<=1.5 else 0)
    if mode=="value": pp=min(round(pp*1.6),25)
    score+=pp

    # PERã‚¹ã‚³ã‚¢
    ep = (12 if s["per"]<=9 else 8 if s["per"]<=11 else 5 if s["per"]<=13 else 2 if s["per"]<=15 else 0)
    if mode=="value": ep=min(round(ep*1.4),15)
    score+=ep

    # â”€â”€ ãƒšãƒŠãƒ«ãƒ†ã‚£ â”€â”€
    # å‡ºæ¥é«˜æ€¥å¢—ãƒšãƒŠãƒ«ãƒ†ã‚£
    if s["vol_r"]>=1.5: score-=20

    # é«˜é…å½“ãƒ¢ãƒ¼ãƒ‰: é…å½“ã‚¼ãƒ­éŠ˜æŸ„ã¯å¯¾è±¡å¤–ï¼ˆæŠ•æ©ŸéŠ˜æŸ„æ’é™¤ï¼‰
    if mode=="dividend" and s["dividend"]<0.5: score=min(score,10)

    # æŠ•æ©ŸéŠ˜æŸ„ãƒšãƒŠãƒ«ãƒ†ã‚£: é…å½“ãªã— + PBRæ¥µç«¯é«˜ï¼ˆ>8å€ï¼‰= æŠ•è³‡å®¶å‘ã‘ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ä¸é©åˆ‡
    if s["dividend"]<0.5 and s["pbr"]>8: score=max(0,score-30)

    # PERãªã—ï¼ˆèµ¤å­—ï¼‰ãƒšãƒŠãƒ«ãƒ†ã‚£: å®‰å®šé…å½“ãƒ¢ãƒ¼ãƒ‰ã§ã¯èµ¤å­—ä¼æ¥­ã‚’ä¸‹ã’ã‚‹
    if mode=="dividend" and s["per"]==0: score=max(0,score-10)

    return max(0,min(score,100))


def main():
    start = time.time()
    print("="*58)
    print("  ã‹ã¶ã®ã™ã‘ â€” æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ å…¨éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒ³")
    print(f"  å®Ÿè¡Œæ—¥æ™‚: {datetime.now().strftime('%Y/%m/%d %H:%M')}")
    print("="*58)

    market  = fetch_market()
    tickers, jp_names = get_prime_tickers()
    total   = len(tickers)
    print(f"  å¯¾è±¡: {total}éŠ˜æŸ„ï¼ˆJPXå…¬å¼ã¾ãŸã¯å†…éƒ¨ãƒªã‚¹ãƒˆï¼‰")

    print(f"\nğŸ” {total}éŠ˜æŸ„ã‚’ä¸¦åˆ—å–å¾—ä¸­ï¼ˆ4ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰...\n")
    results, errors = [], 0
    with ThreadPoolExecutor(max_workers=4) as ex:  # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ã§4ã«æŠ‘ãˆã‚‹
        fm = {ex.submit(fetch_one,t):t for t in tickers}
        done=0
        for future in as_completed(fm):
            done+=1
            data=future.result()
            if data: results.append(data)
            else: errors+=1
            if done%100==0 or done==total:
                pct=done/total*100
                bar="â–ˆ"*int(pct/5)+"â–‘"*(20-int(pct/5))
                print(f"\r  [{bar}] {done}/{total} ({pct:.0f}%) æˆåŠŸ:{len(results)}", end="", flush=True)
    print()

    if not results:
        print("\nâŒ 1ä»¶ã‚‚å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
        sys.exit(1)

    # JPXæ—¥æœ¬èªåã§ä¸Šæ›¸ãï¼ˆyfinanceã®è‹±èªåã‚’æ—¥æœ¬èªåŒ–ï¼‰
    if jp_names:
        overwritten = 0
        for s in results:
            jp = jp_names.get(s["code"])
            if jp:
                s["name"] = jp
                overwritten += 1
        print(f"  ğŸ“ æ—¥æœ¬èªåã«ä¸Šæ›¸ã: {overwritten}ä»¶")

    # â”€â”€ ã‚»ã‚¯ã‚¿ãƒ¼åˆ¥ å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³è¨ˆç®— â”€â”€
    from collections import defaultdict
    sector_ret5_sum  = defaultdict(lambda: [0, 0])  # [åˆè¨ˆ, ä»¶æ•°]
    sector_ret10_sum = defaultdict(lambda: [0, 0])
    for s in results:
        sec = s.get("sector", "ãã®ä»–")
        r5  = s.get("ret5", 0)
        r10 = s.get("ret10", 0)
        if r5 != 0:
            sector_ret5_sum[sec][0] += r5
            sector_ret5_sum[sec][1] += 1
        if r10 != 0:
            sector_ret10_sum[sec][0] += r10
            sector_ret10_sum[sec][1] += 1
    sector_ret5_avg  = {k: round(v[0]/v[1], 2) if v[1] > 0 else 0 for k, v in sector_ret5_sum.items()}
    sector_ret10_avg = {k: round(v[0]/v[1], 2) if v[1] > 0 else 0 for k, v in sector_ret10_sum.items()}
    print(f"  ğŸ“Š ã‚»ã‚¯ã‚¿ãƒ¼åˆ¥ret5å¹³å‡: {len(sector_ret5_avg)}ã‚»ã‚¯ã‚¿ãƒ¼è¨ˆç®—æ¸ˆã¿")

    # â”€â”€ å„éŠ˜æŸ„ã«ã‚»ã‚¯ã‚¿ãƒ¼å·®åˆ†ãƒ»å¢—é…ãƒ•ãƒ©ã‚°ã‚’ä»˜ä¸ â”€â”€
    for s in results:
        sec = s.get("sector", "ãã®ä»–")
        s["sector_ret5"]  = sector_ret5_avg.get(sec, 0)
        s["sector_ret10"] = sector_ret10_avg.get(sec, 0)
        # å€‹åˆ¥ret - ã‚»ã‚¯ã‚¿ãƒ¼å¹³å‡ = å·®åˆ†ï¼ˆãƒã‚¤ãƒŠã‚¹ãªã‚‰å€‹åˆ¥ã ã‘ä¸‹ãŒã£ã¦ã„ã‚‹ï¼‰
        s["ret5_vs_sector"]  = round(s.get("ret5", 0) - s["sector_ret5"], 2)
        s["ret10_vs_sector"] = round(s.get("ret10", 0) - s["sector_ret10"], 2)
        # å¢—é…ãƒ•ãƒ©ã‚°
        s["div_growth_years"] = DIVIDEND_GROWERS.get(s["code"], 0)

    for s in results:
        s["score_dividend"] = calc_score(s,"dividend")
        s["score_value"]    = calc_score(s,"value")
        s["score_rebound"]  = calc_score(s,"rebound")
        s["score_stable"]   = calc_score_stable(s)
        s["score_growth"]   = calc_score_growth(s)
        s["score_bluechip"] = calc_score_bluechip(s)
        s["score_momentum"] = calc_score_momentum(s)
        trend_score, trend_type = calc_score_trend(s)
        s["score_trend"]    = trend_score
        s["trend_type"]     = trend_type
        s["score"]          = trend_score  # v6: æ™‚é–“åŠ é‡ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¹ã‚³ã‚¢ã‚’ãƒ¡ã‚¤ãƒ³ã«
    results.sort(key=lambda x:-x["score"])

    prev_scores={}
    if os.path.exists("stocks_data.json"):
        try:
            with open("stocks_data.json",encoding="utf-8") as f:
                prev=json.load(f)
            for s in prev.get("stocks",[]):
                prev_scores[s["code"]]=s.get("score",0)
        except Exception: pass
    for s in results:
        if s["code"] in prev_scores:
            s["prev_score"]=prev_scores[s["code"]]

    buy_count   = sum(1 for s in results if s["score"]>=60)
    watch_count = sum(1 for s in results if 35<=s["score"]<60)
    prev_buy    = sum(1 for v in prev_scores.values() if v>=60) if prev_scores else None
    elapsed     = round(time.time()-start,1)

    # å‡ºæ¥é«˜ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP20
    vol_ranking = sorted(
        [s for s in results if s.get("vol_avg5",0)>0],
        key=lambda x: -x.get("turnover_avg5", 0)
    )[:20]
    vol_ranking_data = [
        {"code":s["code"],"name":s["name"],"sector":s["sector"],
         "price":s["price"],"vol_avg5":s.get("vol_avg5",0),
         "turnover_avg5":s.get("turnover_avg5",0),
         "score":s["score"],"dividend":s["dividend"]}
        for s in vol_ranking
    ]

    # æ³¨ç›®åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP20ï¼ˆtrend_scoreé †ï¼‰
    trend_ranking = sorted(
        [s for s in results if s.get("trend_score") is not None],
        key=lambda x: -x.get("trend_score", 0)
    )[:20]
    trend_ranking_data = [
        {
            "code":         s["code"],
            "name":         s["name"],
            "sector":       s["sector"],
            "price":        s["price"],
            "vol_ratio_1d": s.get("vol_ratio_1d", 1.0),
            "ret_1d":       s.get("ret_1d", 0),
            "range_pct":    s.get("range_pct", 0),
            "gap_pct":      s.get("gap_pct", 0),
            "trend_score":  s.get("trend_score", 0),
            "score":        s["score"],
            "dividend":     s["dividend"],
        }
        for s in trend_ranking
    ]

    # â”€â”€ é…ä¿¡ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’çµã‚‹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºå‰Šæ¸›ãƒ»é«˜é€ŸåŒ–ï¼‰ â”€â”€
    # ã‚¹ã‚³ã‚¢é †TOP200 + è²·ã„åœå…¨ä»¶ + å¤§å‹é«˜é…å½“æ ªï¼ˆå¸¸ã«å«ã‚ã‚‹ï¼‰
    buy_all   = [s for s in results if s["score"] >= 60]
    top200    = results[:200]
    # å¤§å‹é«˜é…å½“æ ª: æ™‚ä¾¡ç·é¡1000å„„ä»¥ä¸Š & é…å½“3%ä»¥ä¸Š â†’ æŠ¼ã—ç›®ã‚¿ãƒ–ã®æ¯é›†å›£ã¨ã—ã¦å¸¸ã«å«ã‚ã‚‹
    large_div = [s for s in results if (s.get("market_cap_b", 0) >= 1000 and s.get("dividend", 0) >= 3) or (s.get("market_cap_b", 0) >= 5000 and s.get("dividend", 0) >= 2)]
    print(f"  ğŸ“¦ å¤§å‹é«˜é…å½“æ ªï¼ˆå¸¸æ™‚åéŒ²ï¼‰: {len(large_div)}éŠ˜æŸ„")
    # å’Œé›†åˆï¼ˆé‡è¤‡ãªã—ãƒ»ã‚¹ã‚³ã‚¢é †ç¶­æŒï¼‰
    seen = set()
    stocks_out = []
    for s in top200 + buy_all + large_div:
        if s["code"] not in seen:
            seen.add(s["code"])
            stocks_out.append(s)
    stocks_out.sort(key=lambda x: -x["score"])

    # å„éŠ˜æŸ„ã‹ã‚‰ä¸è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’çœã„ã¦è»½é‡åŒ–
    KEEP = {"code","name","sector","price","ma25","ma75","rsi","dividend",
            "pbr","per","vol_r","vol_ratio_1d","ret_1d","range_pct","trend_score",
            "score_dividend","score_value","score_rebound",
            "score_stable","score_growth","score_bluechip","score_momentum",
            "score","prev_score","market_cap_b","volatility","dip_zscore","ret5","ret10",
            "ret20","ret60","ret120","roe","profit_margin","revenue_growth","earnings_growth",
            "vol_trend","price_position","score_trend","trend_type",
            "sector_ret5","sector_ret10","ret5_vs_sector","ret10_vs_sector","div_growth_years",
            "earnings_date","days_since_earnings","days_to_next_earnings",
            "ma25_dev","ma75_dev","closes_60d","avg_volume"}
    stocks_out = [{k:v for k,v in s.items() if k in KEEP} for s in stocks_out]

    output = {
        "updated_at":      datetime.now().strftime("%Y/%m/%d %H:%M"),
        "total":           len(results),        # ã‚¹ã‚­ãƒ£ãƒ³ç·æ•°ï¼ˆè¡¨ç¤ºç”¨ï¼‰
        "buy_count":       buy_count,
        "watch_count":     watch_count,
        "prev_buy_count":  prev_buy,
        "elapsed_sec":     elapsed,
        **market,
        "vol_ranking":     vol_ranking_data,
        "trend_ranking":   trend_ranking_data,
        "stocks":          stocks_out,          # TOP200+å¤§å‹é«˜é…å½“ã‚’é…ä¿¡
    }
    # â”€â”€ NaN/Infé˜²æ­¢ï¼ˆæ’ä¹…å¯¾ç­–ï¼‰â”€â”€
    import math as _math
    def sanitize(obj):
        if isinstance(obj, dict):
            return {k: sanitize(v) for k, v in obj.items()}
        if isinstance(obj, list):
            return [sanitize(v) for v in obj]
        if isinstance(obj, float) and (_math.isnan(obj) or _math.isinf(obj)):
            return 0
        return obj
    output = sanitize(output)
    with open("stocks_data.json","w",encoding="utf-8") as f:
        json.dump(output,f,ensure_ascii=False,indent=2)

    print("\n"+"="*58)
    print(f"  âœ… å®Œäº†ï¼  æ‰€è¦æ™‚é–“: {elapsed}ç§’")
    print(f"  å–å¾—æˆåŠŸ: {len(results)}éŠ˜æŸ„ / ãƒ‡ãƒ¼ã‚¿ãªã—: {errors}éŠ˜æŸ„")
    print(f"  â€»ãƒ‡ãƒ¼ã‚¿ãªã— = ä¸Šå ´å»ƒæ­¢ãƒ»ãƒ‡ãƒ¼ã‚¿æœªå…¬é–‹ãƒ»ãƒ†ã‚£ãƒƒã‚«ãƒ¼èª¤ã‚Šç­‰")
    print(f"  è²·ã„åœï¼ˆ60ç‚¹ä»¥ä¸Šï¼‰: {buy_count}éŠ˜æŸ„")
    print(f"  æ³¨æ„åœï¼ˆ35ã€œ59ç‚¹ï¼‰: {watch_count}éŠ˜æŸ„")
    if results:
        print(f"\n  ğŸ† TOP3:")
        for i,s in enumerate(results[:3],1):
            print(f"    {i}ä½: {s['name']}ï¼ˆ{s['code']}ï¼‰{s['score']}ç‚¹ é…å½“{s['dividend']}%")
    print(f"\n  ğŸ“ stocks_data.json ä¿å­˜å®Œäº†")

    # â”€â”€ å±¥æ­´ä¿å­˜ï¼ˆæ—¥æ¬¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰â”€â”€
    today_str = datetime.now().strftime("%Y-%m-%d")
    history_dir = "history"
    os.makedirs(history_dir, exist_ok=True)
    # v7: trend_typeåˆ¥ã«TOP10ã‚’ä¿å­˜
    dip_top10 = [s for s in results if s.get("trend_type") == "dip"][:10]
    mom_top10 = [s for s in results if s.get("trend_type") == "momentum"][:10]
    def hist_entry(s):
        return {
            "code": s["code"], "name": s.get("name",""), "score": s.get("score",0),
            "score_trend": s.get("score_trend",0), "trend_type": s.get("trend_type",""),
            "dividend": s.get("dividend",0), "market_cap_b": s.get("market_cap_b",0),
            "ma75_dev": s.get("ma75_dev",0), "ma25_dev": s.get("ma25_dev",0),
            "ret5": s.get("ret5",0), "ret20": s.get("ret20",0), "ret120": s.get("ret120",0),
            "vol_ratio_1d": s.get("vol_ratio_1d",1),
            "sector": s.get("sector",""), "price": s["price"],
            "pbr": s.get("pbr",0), "roe": s.get("roe",0),
        }
    history_entry = {
        "date": today_str,
        "updated_at": output["updated_at"],
        "version": "v7",
        "market": {k: output.get(k) for k in ["nikkei_price","nikkei_ma25","nikkei_1d_chg","nasdaq_1d_chg","vix","usdjpy"]},
        "total_scanned": len(results),
        "buy_count": buy_count,
        "dip_top10": [hist_entry(s) for s in dip_top10],
        "mom_top10": [hist_entry(s) for s in mom_top10],
        "top50_codes": [s["code"] for s in results[:50]],
        "top50_scores": [{"code":s["code"],"score":s.get("score",0),"trend_type":s.get("trend_type",""),
                          "price":s["price"],"dividend":s.get("dividend",0)}
                         for s in results[:50]],
    }
    hist_path = os.path.join(history_dir, f"{today_str}.json")
    with open(hist_path, "w", encoding="utf-8") as f:
        json.dump(history_entry, f, ensure_ascii=False, indent=2)
    print(f"  ğŸ“œ å±¥æ­´ä¿å­˜: {hist_path}")

    # â”€â”€ OGPç”»åƒè‡ªå‹•ç”Ÿæˆï¼ˆ1200Ã—630ï¼‰ â”€â”€
    try:
        from PIL import Image, ImageDraw, ImageFont
        W, H = 1200, 630
        img = Image.new("RGB", (W, H), "#0A1628")
        draw = ImageDraw.Draw(img)

        # ãƒ•ã‚©ãƒ³ãƒˆï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆåˆ©ç”¨ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        def get_font(size, bold=False):
            paths = [
                "/usr/share/fonts/truetype/noto/NotoSansCJK-Bold.ttc",
                "/usr/share/fonts/opentype/noto/NotoSansCJK-Bold.ttc",
                "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf",
                "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf",
            ]
            for p in paths:
                if os.path.exists(p):
                    try:
                        return ImageFont.truetype(p, size)
                    except:
                        pass
            return ImageFont.load_default()

        f_title = get_font(42, bold=True)
        f_sub = get_font(24)
        f_rank = get_font(56, bold=True)
        f_name = get_font(32, bold=True)
        f_score = get_font(28)
        f_meta = get_font(20)
        f_footer = get_font(18)

        # èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é¢¨ï¼ˆä¸Šéƒ¨ã«é’å¸¯ï¼‰
        for y in range(120):
            r = int(10 + y * 0.15)
            g = int(22 + y * 0.4)
            b = int(40 + y * 0.8)
            draw.line([(0, y), (W, y)], fill=(r, g, b))

        # ãƒ­ã‚´ + ã‚¿ã‚¤ãƒˆãƒ«
        draw.text((50, 30), "ã‹ã¶ã®ã™ã‘", fill="#4ADE80", font=f_title)
        draw.text((50, 82), f"{today_str} ã®æŠ¼ã—ç›® TOP3", fill="#FFFFFF", font=f_sub)

        # åŒºåˆ‡ã‚Šç·š
        draw.line([(50, 125), (W - 50, 125)], fill="#1B6AC9", width=3)

        # TOP3
        dip_top3 = [s for s in results if s.get("trend_type") == "dip"][:3]
        y_start = 155
        for i, s in enumerate(dip_top3):
            y = y_start + i * 140
            # èƒŒæ™¯ã‚«ãƒ¼ãƒ‰
            card_color = "#14233D" if i % 2 == 0 else "#0F1D33"
            draw.rounded_rectangle([(40, y), (W - 40, y + 125)], radius=12, fill=card_color)

            # é †ä½
            rank_colors = ["#F59E0B", "#9CA3AF", "#CD7F32"]
            cx, cy = 100, y + 62
            draw.ellipse([(cx - 30, cy - 30), (cx + 30, cy + 30)], fill=rank_colors[i] if i < 3 else "#4A5568")
            rank_text = str(i + 1)
            bbox = draw.textbbox((0, 0), rank_text, font=f_rank)
            tw = bbox[2] - bbox[0]
            th = bbox[3] - bbox[1]
            draw.text((cx - tw // 2, cy - th // 2 - 5), rank_text, fill="#FFFFFF", font=f_rank)

            # éŠ˜æŸ„å
            name = s.get("name", "")[:12]
            draw.text((155, y + 18), name, fill="#FFFFFF", font=f_name)

            # ãƒ¡ã‚¿æƒ…å ±
            sector = s.get("sector", "")
            div_val = s.get("dividend", 0)
            meta = f"{s['code']} Â· {sector} Â· é…å½“{div_val:.1f}%"
            draw.text((155, y + 62), meta, fill="#8E99A8", font=f_meta)

            # ã‚¹ã‚³ã‚¢
            score = s.get("score", 0)
            score_text = f"{score}pt"
            bbox = draw.textbbox((0, 0), score_text, font=f_rank)
            sw = bbox[2] - bbox[0]
            score_color = "#4ADE80" if score >= 60 else "#F59E0B" if score >= 40 else "#F87171"
            draw.text((W - 90 - sw, y + 25), score_text, fill=score_color, font=f_rank)

            # æŠ¼ã—ç›®ãƒãƒƒã‚¸
            badge = "æŠ¼ã—ç›®"
            draw.rounded_rectangle([(W - 160, y + 82), (W - 75, y + 110)], radius=6, fill="#059669")
            bbox = draw.textbbox((0, 0), badge, font=f_meta)
            bw = bbox[2] - bbox[0]
            draw.text((W - 118 - bw // 2, y + 84), badge, fill="#FFFFFF", font=f_meta)

        # ãƒ•ãƒƒã‚¿ãƒ¼
        buy_count_val = buy_count
        total_val = len(results)
        draw.line([(50, H - 70), (W - 50, H - 70)], fill="#1E3050", width=1)
        footer_text = f"å…¨{total_val}éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒ³ Â· {buy_count_val}éŠ˜æŸ„ãŒè²·ã„æ™‚ Â· æ¯æœ7:30è‡ªå‹•æ›´æ–°"
        draw.text((50, H - 55), footer_text, fill="#4A5568", font=f_footer)
        draw.text((W - 300, H - 55), "oshime.vercel.app", fill="#1B6AC9", font=f_footer)

        ogp_path = "ogp.png"
        img.save(ogp_path, "PNG", optimize=True)
        print(f"  ğŸ–¼ï¸  OGPç”»åƒç”Ÿæˆ: {ogp_path}")
    except Exception as e:
        print(f"  âš  OGPç”»åƒç”Ÿæˆã‚¹ã‚­ãƒƒãƒ—: {e}")

    print("="*58)

if __name__=="__main__":
    main()
