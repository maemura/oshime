<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ ªã®è²·ã„å ´ãƒŠãƒ“</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1:wght@400;700;800&family=Syne:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080c12;
  --bg2: #0e1520;
  --bg3: #141e2e;
  --bg4: #1a2438;
  --gold: #d4a843;
  --gold2: #f0c860;
  --gold-dim: rgba(212,168,67,0.12);
  --gold-glow: rgba(212,168,67,0.3);
  --green: #2ecc8e;
  --green2: #45e8a8;
  --green-dim: rgba(46,204,142,0.1);
  --red: #e84c6a;
  --red-dim: rgba(232,76,106,0.1);
  --amber: #f0a030;
  --amber-dim: rgba(240,160,48,0.1);
  --blue: #4a9eff;
  --text: #5a7090;
  --text2: #8aa0b8;
  --text3: #b8cce0;
  --bright: #e8f2ff;
  --border: rgba(255,255,255,0.05);
  --border2: rgba(255,255,255,0.09);
  --surface: rgba(255,255,255,0.025);
  --surface2: rgba(255,255,255,0.05);
  --pro: #7c5cfc;
  --pro-dim: rgba(124,92,252,0.12);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{
  background:var(--bg);color:var(--text2);
  font-family:'Noto Sans JP',sans-serif;
  min-height:100%;overflow-x:hidden;overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}

/* ===== TOP HEADER ===== */
.top-bar{
  position:sticky;top:0;z-index:200;
  background:rgba(8,12,18,0.92);
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  padding:0 16px;
  display:flex;align-items:center;justify-content:space-between;
  height:52px;
}
.logo{
  font-family:'Syne',sans-serif;font-weight:800;
  font-size:15px;color:var(--bright);letter-spacing:-0.3px;
  display:flex;align-items:center;gap:8px;
}
.logo-badge{
  background:var(--gold);color:var(--bg);
  font-size:8px;font-weight:700;letter-spacing:1px;
  padding:2px 6px;border-radius:3px;
}
.header-right{display:flex;align-items:center;gap:8px;}
.btn-pro{
  background:var(--pro);color:#fff;border:none;
  border-radius:6px;padding:5px 12px;font-size:10px;
  font-weight:700;letter-spacing:0.5px;cursor:pointer;
  font-family:'Syne',sans-serif;transition:all 0.2s;
}
.btn-pro:hover{background:#9070ff;}
.icon-btn{
  background:none;border:1px solid var(--border2);
  border-radius:8px;width:34px;height:34px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--text2);font-size:14px;
  transition:all 0.2s;position:relative;
}
.icon-btn:hover{border-color:var(--gold);color:var(--gold);}
.icon-btn .badge-dot{
  position:absolute;top:5px;right:5px;
  width:6px;height:6px;border-radius:50%;
  background:var(--gold);border:1px solid var(--bg);
  display:none;
}
.icon-btn .badge-dot.show{display:block;}

/* ===== MAIN SCROLL ===== */
.main{padding:16px 16px 100px;max-width:480px;margin:0 auto;}

/* ===== MARKET PULSE ===== */
.pulse-bar{
  display:flex;gap:6px;overflow-x:auto;
  scrollbar-width:none;-ms-overflow-style:none;
  padding-bottom:2px;margin-bottom:16px;
}
.pulse-bar::-webkit-scrollbar{display:none;}
.pulse-chip{
  flex-shrink:0;
  background:var(--surface);border:1px solid var(--border);
  border-radius:20px;padding:5px 12px;
  display:flex;align-items:center;gap:6px;
  font-size:10px;white-space:nowrap;
}
.pulse-chip .label{color:var(--text);}
.pulse-chip .val{font-family:'Syne',sans-serif;font-size:11px;font-weight:600;}
.pulse-chip .val.up{color:var(--green);}
.pulse-chip .val.dn{color:var(--red);}
.pulse-chip .val.neutral{color:var(--text3);}

/* ===== TODAY DIAGNOSIS ===== */
.diagnosis{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:16px;padding:18px 18px 14px;margin-bottom:16px;
  position:relative;overflow:hidden;
}
.diagnosis::before{
  content:'';position:absolute;top:0;right:0;
  width:120px;height:120px;
  background:radial-gradient(circle,rgba(212,168,67,0.08),transparent 70%);
  pointer-events:none;
}
.diag-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;}
.diag-label{font-size:9px;letter-spacing:2px;color:var(--gold);text-transform:uppercase;margin-bottom:5px;font-family:'Syne',sans-serif;}
.diag-title{font-family:'Shippori Mincho B1',serif;font-size:17px;color:var(--bright);line-height:1.4;}
.diag-status{
  flex-shrink:0;padding:5px 10px;border-radius:20px;
  font-size:10px;font-weight:700;font-family:'Syne',sans-serif;
  letter-spacing:0.5px;
}
.diag-status.buy{background:var(--green-dim);color:var(--green);border:1px solid rgba(46,204,142,0.2);}
.diag-status.caution{background:var(--amber-dim);color:var(--amber);border:1px solid rgba(240,160,48,0.2);}
.diag-status.wait{background:rgba(90,112,144,0.15);color:var(--text2);border:1px solid var(--border2);}
.diag-comment{font-size:11px;color:var(--text2);line-height:1.9;margin-bottom:12px;}
.diag-comment strong{color:var(--bright);}
.diag-chips{display:flex;gap:6px;flex-wrap:wrap;}
.diag-chip{
  background:var(--surface2);border-radius:6px;
  padding:4px 9px;font-size:9px;color:var(--text2);
  display:flex;align-items:center;gap:4px;
}
.diag-chip.ok{color:var(--green);}
.diag-chip.ng{color:var(--red);}
.diag-chip.warn{color:var(--amber);}

/* ===== MODE SELECTOR ===== */
.mode-wrap{margin-bottom:16px;}
.mode-label{font-size:9px;letter-spacing:2px;color:var(--text);text-transform:uppercase;margin-bottom:8px;font-family:'Syne',sans-serif;}
.mode-tabs{display:flex;gap:6px;}
.mode-tab{
  flex:1;background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:10px 8px;text-align:center;
  cursor:pointer;transition:all 0.2s;
}
.mode-tab.active{background:var(--gold-dim);border-color:rgba(212,168,67,0.3);}
.mode-tab-ico{font-size:18px;margin-bottom:3px;}
.mode-tab-t{font-size:9px;color:var(--text2);line-height:1.4;font-weight:500;}
.mode-tab.active .mode-tab-t{color:var(--gold);}

/* ===== TOP5 RANKINGS ===== */
.rankings{margin-bottom:20px;}
.rank-section{margin-bottom:14px;}
.rank-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:8px;
}
.rank-title{
  font-family:'Syne',sans-serif;font-size:11px;font-weight:700;
  color:var(--text3);letter-spacing:0.5px;
  display:flex;align-items:center;gap:6px;
}
.rank-ico{font-size:14px;}
.rank-more{font-size:10px;color:var(--text);cursor:pointer;transition:color 0.2s;}
.rank-more:hover{color:var(--gold);}

.rank-list{display:flex;flex-direction:column;gap:5px;}
.rank-row{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;
  display:flex;align-items:center;gap:10px;
  cursor:pointer;transition:all 0.15s;
}
.rank-row:hover{border-color:var(--border2);background:var(--bg3);}
.rank-num{
  font-family:'Syne',sans-serif;font-size:13px;font-weight:700;
  color:var(--text);width:18px;flex-shrink:0;
}
.rank-num.top{color:var(--gold);}
.rank-info{flex:1;min-width:0;}
.rank-name{font-size:12px;color:var(--bright);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:1px;}
.rank-meta{font-size:9px;color:var(--text);}
.rank-right{text-align:right;flex-shrink:0;}
.rank-score{
  display:inline-flex;align-items:center;justify-content:center;
  width:36px;height:36px;border-radius:50%;
  font-family:'Syne',sans-serif;font-size:12px;font-weight:700;
  border:2px solid;
}
.rank-score.hi{color:var(--green);border-color:rgba(46,204,142,0.3);background:var(--green-dim);}
.rank-score.md{color:var(--gold);border-color:rgba(212,168,67,0.3);background:var(--gold-dim);}
.rank-score.lo{color:var(--text);border-color:var(--border);background:var(--surface);}
.rank-key{font-size:10px;color:var(--text2);margin-top:2px;}
.rank-key.g{color:var(--green);}
.rank-key.w{color:var(--gold);}

/* ===== PRO BLUR ===== */
.pro-lock{
  position:relative;
  overflow:hidden;
}
.pro-lock .blur-row{
  filter:blur(4px);pointer-events:none;user-select:none;
}
.pro-overlay{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:linear-gradient(to bottom,transparent,rgba(8,12,18,0.9) 40%);
  gap:8px;
}
.pro-lock-badge{
  background:var(--pro);color:#fff;
  border-radius:20px;padding:6px 16px;
  font-size:11px;font-weight:700;letter-spacing:0.5px;
  font-family:'Syne',sans-serif;cursor:pointer;
  transition:all 0.2s;
}
.pro-lock-badge:hover{background:#9070ff;transform:scale(1.03);}
.pro-lock-note{font-size:10px;color:var(--text);}

/* ===== CARD VIEW ===== */
.card-view-wrap{margin-bottom:20px;}
.card-view-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;
}
.card-view-title{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;color:var(--text3);letter-spacing:0.5px;}
.card-nav{display:flex;align-items:center;gap:8px;}
.card-counter{font-size:10px;color:var(--text);}
.card-arr{
  background:var(--surface);border:1px solid var(--border);
  border-radius:6px;width:28px;height:28px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:12px;color:var(--text2);
  transition:all 0.2s;user-select:none;
}
.card-arr:hover{border-color:var(--gold);color:var(--gold);}
.card-arr:disabled{opacity:0.3;cursor:not-allowed;}

.stock-card-big{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:18px;padding:20px;
  position:relative;overflow:hidden;
  touch-action:pan-y;
}
.stock-card-big::after{
  content:'';position:absolute;top:0;right:0;
  width:150px;height:150px;
  background:radial-gradient(circle,rgba(212,168,67,0.05),transparent 70%);
  pointer-events:none;
}

/* OSHI-ME SCORE */
.score-hero{
  display:flex;align-items:center;gap:16px;margin-bottom:18px;
}
.score-ring{
  position:relative;flex-shrink:0;
  width:72px;height:72px;
}
.score-ring svg{transform:rotate(-90deg);}
.score-ring-val{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
}
.score-ring-num{
  font-family:'Syne',sans-serif;font-size:20px;font-weight:800;
  line-height:1;
}
.score-ring-label{font-size:7px;letter-spacing:1px;color:var(--text);text-transform:uppercase;margin-top:1px;}
.score-info{flex:1;}
.score-zone{
  display:inline-flex;align-items:center;gap:5px;
  padding:4px 10px;border-radius:20px;font-size:9px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;
  font-family:'Syne',sans-serif;
}
.score-zone.buy{background:var(--green-dim);color:var(--green);border:1px solid rgba(46,204,142,0.2);}
.score-zone.watch{background:var(--gold-dim);color:var(--gold);border:1px solid rgba(212,168,67,0.2);}
.score-zone.hold{background:var(--surface);color:var(--text);border:1px solid var(--border);}
.score-name{font-family:'Shippori Mincho B1',serif;font-size:18px;color:var(--bright);margin-bottom:2px;}
.score-code{font-size:10px;color:var(--text);letter-spacing:1px;}

/* Comment */
.ai-comment{
  background:rgba(212,168,67,0.06);
  border:1px solid rgba(212,168,67,0.12);
  border-radius:10px;padding:11px 13px;
  font-size:11px;color:var(--text2);line-height:1.8;
  margin-bottom:14px;
}
.ai-comment strong{color:var(--bright);}
.ai-tag{
  display:inline-flex;align-items:center;gap:4px;
  font-size:8px;letter-spacing:1.5px;color:var(--gold);
  text-transform:uppercase;margin-bottom:6px;
  font-family:'Syne',sans-serif;
}

/* Metrics grid */
.metrics-grid{
  display:grid;grid-template-columns:repeat(3,1fr);
  gap:6px;margin-bottom:14px;
}
.metric{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:10px;padding:9px 8px;text-align:center;
}
.metric-l{font-size:8px;letter-spacing:0.5px;color:var(--text);margin-bottom:3px;}
.metric-v{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--bright);}
.metric-v.g{color:var(--green);}
.metric-v.r{color:var(--red);}
.metric-v.w{color:var(--gold);}
.metric-hint{font-size:8px;color:var(--text);margin-top:1px;}

/* Score breakdown */
.breakdown{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;margin-bottom:14px;
}
.breakdown-title{font-size:8px;letter-spacing:1.5px;color:var(--text);text-transform:uppercase;margin-bottom:8px;font-family:'Syne',sans-serif;}
.bd-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:10px;}
.bd-row:last-child{margin-bottom:0;}
.bd-l{color:var(--text2);}
.bd-v{font-family:'Syne',sans-serif;font-weight:600;}
.bd-v.pos{color:var(--green);}
.bd-v.neg{color:var(--red);}
.bd-bar{flex:1;height:3px;background:var(--bg);border-radius:2px;margin:0 8px;overflow:hidden;}
.bd-fill{height:100%;border-radius:2px;}

/* Actions */
.card-actions{display:flex;gap:8px;}
.btn-fav{
  flex:1;background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:12px;
  font-size:11px;color:var(--text2);cursor:pointer;
  transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px;
  font-family:'Noto Sans JP',sans-serif;
}
.btn-fav:hover{border-color:var(--gold);color:var(--gold);}
.btn-fav.active{background:var(--gold-dim);border-color:rgba(212,168,67,0.3);color:var(--gold);}
.btn-detail{
  flex:2;background:var(--gold);border:none;
  border-radius:10px;padding:12px;
  font-size:12px;font-weight:700;color:var(--bg);cursor:pointer;
  transition:all 0.2s;font-family:'Syne',sans-serif;
}
.btn-detail:hover{background:var(--gold2);}

/* ===== SECTION TITLES ===== */
.section-title{
  font-family:'Syne',sans-serif;font-size:11px;font-weight:700;
  color:var(--text3);letter-spacing:0.5px;
  display:flex;align-items:center;gap:6px;
  margin-bottom:8px;
}
.section-title::before{
  content:'';display:block;width:3px;height:12px;
  background:var(--gold);border-radius:2px;
}

/* ===== WATCHLIST ===== */
.watchlist-section{margin-bottom:20px;}
.watch-empty{
  background:var(--surface);border:1px dashed var(--border2);
  border-radius:12px;padding:20px;text-align:center;
  font-size:11px;color:var(--text);
}
.watch-list{display:flex;flex-direction:column;gap:5px;}
.watch-row{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;
  display:flex;align-items:center;gap:10px;
  cursor:pointer;transition:all 0.15s;
}
.watch-row:hover{background:var(--bg3);}
.watch-name{flex:1;font-size:12px;color:var(--bright);font-weight:500;}
.watch-score{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;}
.watch-score.hi{color:var(--green);}
.watch-score.md{color:var(--gold);}
.watch-remove{background:none;border:none;color:var(--text);cursor:pointer;font-size:14px;padding:2px 4px;transition:color 0.2s;}
.watch-remove:hover{color:var(--red);}

/* ===== HISTORY ===== */
.history-section{margin-bottom:20px;}
.history-empty{font-size:11px;color:var(--text);text-align:center;padding:16px;}
.hist-list{display:flex;flex-direction:column;gap:5px;}
.hist-row{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:10px;padding:10px 14px;
  display:flex;align-items:center;justify-content:space-between;
  font-size:11px;cursor:pointer;transition:background 0.15s;
}
.hist-row:hover{background:var(--bg3);}
.hist-date{color:var(--text);}
.hist-info{color:var(--text3);}
.hist-diff{font-size:10px;}
.hist-diff.up{color:var(--green);}
.hist-diff.dn{color:var(--red);}

/* ===== EVENTS ===== */
.events-section{margin-bottom:20px;}
.event-list{display:flex;flex-direction:column;gap:6px;}
.event-row{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:10px;padding:11px 14px;
  display:flex;align-items:flex-start;gap:10px;
}
.event-ico{font-size:16px;flex-shrink:0;margin-top:1px;}
.event-body{flex:1;}
.event-title{font-size:12px;color:var(--bright);font-weight:500;margin-bottom:2px;}
.event-desc{font-size:10px;color:var(--text);line-height:1.6;}
.event-tag{
  display:inline-block;padding:2px 7px;border-radius:4px;
  font-size:9px;font-weight:600;margin-right:4px;
  font-family:'Syne',sans-serif;
}
.event-tag.bull{background:var(--green-dim);color:var(--green);}
.event-tag.bear{background:var(--red-dim);color:var(--red);}
.event-tag.neutral{background:var(--surface2);color:var(--text2);}

/* ===== DISCLAIMER ===== */
.disclaimer{
  background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:12px 14px;
  font-size:9px;color:var(--text);line-height:1.8;
  margin-bottom:16px;
}

/* ===== BOTTOM NAV ===== */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;z-index:200;
  background:rgba(8,12,18,0.95);backdrop-filter:blur(12px);
  border-top:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-around;
  padding:8px 0 max(8px,env(safe-area-inset-bottom));
  max-width:480px;margin:0 auto;
}
@media(min-width:480px){.bottom-nav{left:50%;transform:translateX(-50%);width:480px;}}
.nav-item{
  display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:4px 16px;cursor:pointer;transition:all 0.2s;
  background:none;border:none;
}
.nav-ico{font-size:18px;line-height:1;}
.nav-label{font-size:9px;color:var(--text);transition:color 0.2s;font-family:'Syne',sans-serif;letter-spacing:0.3px;}
.nav-item.active .nav-label{color:var(--gold);}
.nav-item.active .nav-ico{filter:drop-shadow(0 0 4px rgba(212,168,67,0.6));}

/* ===== PANELS ===== */
.panel{display:none;}
.panel.active{display:block;}

/* ===== MODAL ===== */
.modal-bg{
  display:none;position:fixed;inset:0;z-index:400;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);
}
.modal-bg.open{display:flex;align-items:flex-end;justify-content:center;}
@media(min-width:480px){.modal-bg.open{align-items:center;}}
.modal{
  background:var(--bg2);border:1px solid var(--border2);
  border-radius:20px 20px 0 0;
  width:100%;max-width:480px;
  max-height:88vh;overflow-y:auto;
  padding:24px 20px max(24px,env(safe-area-inset-bottom));
  animation:slideUp 0.25s ease;
}
@media(min-width:480px){.modal{border-radius:20px;max-height:80vh;}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{
  width:36px;height:4px;background:var(--border2);
  border-radius:2px;margin:0 auto 20px;
}
@media(min-width:480px){.modal-handle{display:none;}}
.modal-close{
  float:right;background:none;border:none;
  color:var(--text);font-size:18px;cursor:pointer;
  margin-top:-4px;
}

/* Pro Modal */
.pro-modal-title{
  font-family:'Syne',sans-serif;font-size:20px;font-weight:800;
  color:var(--bright);margin-bottom:6px;
}
.pro-modal-sub{font-size:12px;color:var(--text);margin-bottom:20px;line-height:1.6;}
.pro-feature-list{display:flex;flex-direction:column;gap:8px;margin-bottom:24px;}
.pro-feat{
  display:flex;align-items:center;gap:10px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:11px 13px;font-size:12px;color:var(--text2);
}
.pro-feat::before{content:'âœ“';color:var(--pro);font-weight:700;flex-shrink:0;}
.pro-price{text-align:center;margin-bottom:16px;}
.pro-price-val{font-family:'Syne',sans-serif;font-size:32px;font-weight:800;color:var(--bright);}
.pro-price-note{font-size:11px;color:var(--text);margin-top:4px;}
.btn-buy-pro{
  width:100%;background:var(--pro);color:#fff;border:none;
  border-radius:12px;padding:16px;
  font-family:'Syne',sans-serif;font-size:14px;font-weight:700;
  cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;
}
.btn-buy-pro:hover{background:#9070ff;transform:translateY(-1px);}
.btn-buy-note{font-size:10px;color:var(--text);text-align:center;margin-top:8px;}

/* Loader */
.loader{
  display:flex;flex-direction:column;align-items:center;
  padding:40px 20px;gap:12px;
}
.spin{
  width:24px;height:24px;border:2px solid var(--border2);
  border-top-color:var(--gold);border-radius:50%;
  animation:spin 0.7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-text{font-size:11px;color:var(--text);}

/* Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fadein{animation:fadeIn 0.3s ease both;}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="top-bar">
  <div class="logo">
    æ ªã®è²·ã„å ´ãƒŠãƒ“
    <span class="logo-badge">FREE</span>
  </div>
  <div class="header-right">
    <button class="btn-pro" onclick="openProModal()">Proç‰ˆ âœ¦</button>
    <button class="icon-btn" onclick="switchTab('watch')" id="watchBtn">
      â˜…
      <span class="badge-dot" id="watchDot"></span>
    </button>
  </div>
</div>

<!-- MAIN SCROLL -->
<div class="main">

  <!-- PANEL: HOME -->
  <div class="panel active" id="panel-home">

    <!-- Market Pulse -->
    <div class="pulse-bar" id="pulseBar"></div>

    <!-- Today Diagnosis -->
    <div class="diagnosis fadein" id="diagBox"></div>

    <!-- Mode Selector -->
    <div class="mode-wrap">
      <div class="mode-label">ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰</div>
      <div class="mode-tabs">
        <div class="mode-tab active" onclick="setMode('dividend',this)">
          <div class="mode-tab-ico">ğŸ’°</div>
          <div class="mode-tab-t">å®‰å®š<br>é«˜é…å½“</div>
        </div>
        <div class="mode-tab" onclick="setMode('value',this)">
          <div class="mode-tab-ico">ğŸ›¡ï¸</div>
          <div class="mode-tab-t">å‰²å®‰<br>ãƒãƒªãƒ¥ãƒ¼</div>
        </div>
        <div class="mode-tab" onclick="setMode('rebound',this)">
          <div class="mode-tab-ico">âš¡</div>
          <div class="mode-tab-t">å¼·æŠ¼ã—ç›®<br>ãƒªãƒã‚¦ãƒ³ãƒ‰</div>
        </div>
      </div>
    </div>

    <!-- Top Rankings -->
    <div class="rankings" id="rankings"></div>

    <!-- Card View -->
    <div class="card-view-wrap">
      <div class="card-view-header">
        <div class="card-view-title">ğŸ“‹ è©³ç´°ã‚«ãƒ¼ãƒ‰</div>
        <div class="card-nav">
          <span class="card-counter" id="cardCounter">1 / â€”</span>
          <button class="card-arr" id="cardPrev" onclick="cardMove(-1)">â†</button>
          <button class="card-arr" id="cardNext" onclick="cardMove(1)">â†’</button>
        </div>
      </div>
      <div id="cardArea"><div class="loader"><div class="spin"></div><div class="loader-text">åˆ†æä¸­...</div></div></div>
    </div>

    <!-- Events -->
    <div class="events-section">
      <div class="section-title">ä»Šæ—¥ã®ç›¸å ´ã‚¤ãƒ™ãƒ³ãƒˆ</div>
      <div class="event-list" id="eventList"></div>
    </div>

    <div class="disclaimer">
      âš ï¸ æœ¬ãƒ„ãƒ¼ãƒ«ã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚æ ªå¼æŠ•è³‡ã«ã¯å…ƒæœ¬å‰²ã‚Œã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
    </div>

  </div><!-- /panel-home -->

  <!-- PANEL: WATCHLIST & HISTORY -->
  <div class="panel" id="panel-watch">
    <div class="watchlist-section">
      <div class="section-title">â­ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ</div>
      <div id="watchlistBody"></div>
    </div>
    <div class="history-section">
      <div class="section-title">ğŸ• ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ï¼ˆç›´è¿‘7æ—¥ï¼‰</div>
      <div id="historyBody"></div>
    </div>
  </div>

</div><!-- /main -->

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" id="nav-home" onclick="switchTab('home')">
    <span class="nav-ico">ğŸ </span>
    <span class="nav-label">ãƒ›ãƒ¼ãƒ </span>
  </button>
  <button class="nav-item" id="nav-watch" onclick="switchTab('watch')">
    <span class="nav-ico">â­</span>
    <span class="nav-label">ã‚¦ã‚©ãƒƒãƒ</span>
  </button>
</nav>

<!-- PRO MODAL -->
<div class="modal-bg" id="proModal" onclick="closeProModal(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <button class="modal-close" onclick="closeProModal()">âœ•</button>
    <div class="pro-modal-title">Proç‰ˆã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</div>
    <div class="pro-modal-sub">ã‚ˆã‚Šå¤šãã®éŠ˜æŸ„ã¨æ©Ÿèƒ½ã§ã€æŠ•è³‡ãƒãƒ£ãƒ³ã‚¹ã‚’é€ƒã•ãªã„ã€‚</div>
    <div class="pro-feature-list">
      <div class="pro-feat">ã‚¹ã‚­ãƒ£ãƒ³éŠ˜æŸ„æ•° 10ä»¶ â†’ <strong style="color:var(--bright)">100ä»¶ä»¥ä¸Š</strong></div>
      <div class="pro-feat">ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ã‚’<strong style="color:var(--bright)">90æ—¥é–“</strong>ä¿å­˜</div>
      <div class="pro-feat">ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ãŒ<strong style="color:var(--bright)">ç„¡åˆ¶é™</strong></div>
      <div class="pro-feat">å‰å›ã¨ã®<strong style="color:var(--bright)">å·®åˆ†ã‚¢ãƒ©ãƒ¼ãƒˆ</strong>è¡¨ç¤º</div>
      <div class="pro-feat">OSHI-ME SCOREã®<strong style="color:var(--bright)">è©³ç´°å†…è¨³</strong>ã™ã¹ã¦è¡¨ç¤º</div>
    </div>
    <div class="pro-price">
      <div class="pro-price-val">Â¥980</div>
      <div class="pro-price-note">è²·ã„åˆ‡ã‚Šãƒ»ä¸€åº¦è³¼å…¥ã§æ°¸ä¹…åˆ©ç”¨</div>
    </div>
    <button class="btn-buy-pro">BOOTHã§è³¼å…¥ã™ã‚‹ â†’</button>
    <div class="btn-buy-note">è³¼å…¥å¾Œã€Proç‰ˆã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</div>
  </div>
</div>

<script>
// ===== DATA =====
const STOCKS = [
  {code:'8306',name:'ä¸‰è±UFJ',sector:'éŠ€è¡Œ',price:1423,ma25:1520,ma75:1580,rsi:32,dividend:3.8,pbr:0.7,per:9.2,vol_r:0.8},
  {code:'9432',name:'NTT',sector:'é€šä¿¡',price:163,ma25:168,ma75:172,rsi:38,dividend:3.2,pbr:1.1,per:11.5,vol_r:0.9},
  {code:'8058',name:'ä¸‰è±å•†äº‹',sector:'å•†ç¤¾',price:2890,ma25:3050,ma75:3200,rsi:29,dividend:4.1,pbr:0.9,per:8.7,vol_r:0.7},
  {code:'4502',name:'æ­¦ç”°è–¬å“',sector:'åŒ»è–¬å“',price:3820,ma25:3960,ma75:4050,rsi:41,dividend:5.6,pbr:1.3,per:15.2,vol_r:1.1},
  {code:'8001',name:'ä¼Šè—¤å¿ å•†äº‹',sector:'å•†ç¤¾',price:6780,ma25:7050,ma75:7200,rsi:33,dividend:3.5,pbr:1.8,per:12.3,vol_r:0.6},
  {code:'7203',name:'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š',sector:'è‡ªå‹•è»Š',price:2650,ma25:2720,ma75:2800,rsi:36,dividend:3.0,pbr:1.1,per:10.4,vol_r:0.9},
  {code:'8316',name:'ä¸‰äº•ä½å‹FG',sector:'éŠ€è¡Œ',price:7100,ma25:7600,ma75:7800,rsi:28,dividend:4.2,pbr:0.8,per:9.0,vol_r:0.7},
  {code:'2914',name:'JT',sector:'é£Ÿå“',price:3680,ma25:3780,ma75:3820,rsi:35,dividend:6.2,pbr:1.6,per:13.8,vol_r:0.8},
  {code:'9020',name:'JRæ±æ—¥æœ¬',sector:'é‰„é“',price:8150,ma25:8300,ma75:8450,rsi:42,dividend:2.1,pbr:1.4,per:14.2,vol_r:0.9},
  {code:'8411',name:'ã¿ãšã»FG',sector:'éŠ€è¡Œ',price:2680,ma25:2850,ma75:2950,rsi:31,dividend:3.9,pbr:0.7,per:8.5,vol_r:0.8},
  {code:'9433',name:'KDDI',sector:'é€šä¿¡',price:4350,ma25:4500,ma75:4600,rsi:37,dividend:3.3,pbr:1.9,per:13.5,vol_r:1.0},
  {code:'5108',name:'ãƒ–ãƒªãƒ‚ã‚¹ãƒˆãƒ³',sector:'ã‚´ãƒ ',price:5100,ma25:5280,ma75:5350,rsi:40,dividend:3.8,pbr:1.2,per:11.8,vol_r:0.8},
];
const FREE_LIMIT = 5;

// ===== STATE =====
let currentMode = 'dividend';
let processed = [];
let cardIndex = 0;
let watchlist = JSON.parse(localStorage.getItem('knv_watch') || '[]');
let scanHistory = JSON.parse(localStorage.getItem('knv_history') || '[]');

// ===== SCORING =====
function dv(p,m){ return +((p-m)/m*100).toFixed(1); }

function calcScore(s, mode) {
  let score = 0, bd = [];
  const d25 = dv(s.price, s.ma25);

  // é…å½“
  let dp = s.dividend>=5?30:s.dividend>=4.5?25:s.dividend>=4?20:s.dividend>=3.5?15:s.dividend>=3?10:s.dividend>=2.5?5:0;
  if(mode==='dividend') dp = Math.min(dp*1.4,40);
  if(dp>0) bd.push({l:'é…å½“åˆ©å›ã‚Š',v:Math.round(dp),max:40,pos:true});
  score += Math.round(dp);

  // MAä¹–é›¢
  let mp = d25<=-8?28:d25<=-6?22:d25<=-4?12:d25<=-2?5:0;
  if(mode==='rebound') mp = Math.min(mp*1.5,35);
  if(mp>0) bd.push({l:'ä¸‹è½å¹…',v:Math.round(mp),max:35,pos:true});
  score += Math.round(mp);

  // RSI
  let rp = s.rsi<=28?22:s.rsi<=32?16:s.rsi<=38?10:s.rsi<=42?5:0;
  if(mode==='rebound') rp = Math.min(rp*1.3,25);
  if(rp>0) bd.push({l:'å£²ã‚‰ã‚Œã™ãåº¦',v:Math.round(rp),max:25,pos:true});
  score += Math.round(rp);

  // PBR
  let pp = s.pbr<=0.7?18:s.pbr<=0.9?13:s.pbr<=1.1?7:s.pbr<=1.5?3:0;
  if(mode==='value') pp = Math.min(pp*1.6,25);
  if(pp>0) bd.push({l:'PBRå‰²å®‰',v:Math.round(pp),max:25,pos:true});
  score += Math.round(pp);

  // PER
  let erp = s.per<=9?12:s.per<=11?8:s.per<=13?5:s.per<=15?2:0;
  if(mode==='value') erp = Math.min(erp*1.4,15);
  if(erp>0) bd.push({l:'PERå‰²å®‰',v:Math.round(erp),max:15,pos:true});
  score += Math.round(erp);

  // ãƒšãƒŠãƒ«ãƒ†ã‚£
  if(s.vol_r>=1.5){ score-=20; bd.push({l:'å‡ºæ¥é«˜æ€¥å¢—',v:-20,max:20,pos:false}); }

  return { score: Math.max(0,Math.min(score,100)), bd };
}

function getZone(sc) {
  if(sc>=60) return {label:'è²·ã„åœ',cls:'buy',color:'var(--green)'};
  if(sc>=35) return {label:'æ³¨æ„åœ',cls:'watch',color:'var(--gold)'};
  return {label:'å¾…æ©Ÿåœ',cls:'hold',color:'var(--text)'};
}

function generateComment(s, d25) {
  const parts = [];
  if(d25<=-6) parts.push(`25MAã‹ã‚‰<strong>${d25}%</strong>ä¸‹è½`);
  else if(d25<=-3) parts.push(`25MAã‹ã‚‰<strong>${d25}%</strong>æŠ¼ã—ç›®`);
  if(s.rsi<=30) parts.push(`RSI <strong>${s.rsi}</strong>ã§å¼·ã„å£²ã‚‰ã‚Œã™ãæ°´æº–`);
  else if(s.rsi<=38) parts.push(`RSI <strong>${s.rsi}</strong>ã§åè»¢åœ`);
  if(s.dividend>=4.5) parts.push(`é…å½“<strong>${s.dividend}%</strong>ã¨é«˜æ°´æº–`);
  else if(s.dividend>=3) parts.push(`é…å½“<strong>${s.dividend}%</strong>ã§ä¸‹å€¤ã‚µãƒãƒ¼ãƒˆ`);
  if(s.pbr<=0.8) parts.push(`PBR <strong>${s.pbr}å€</strong>ã®å‰²å®‰åœ`);
  return parts.join('ã€‚') + 'ã€‚';
}

// ===== PROCESS =====
function processStocks() {
  const modeFilter = {
    dividend: s => s.dividend >= 3.0,
    value:    s => s.pbr <= 1.5 && s.per <= 15,
    rebound:  s => dv(s.price,s.ma25) <= -3 && s.rsi <= 42,
  };
  processed = STOCKS
    .filter(modeFilter[currentMode] || (()=>true))
    .map(s => {
      const d25 = dv(s.price, s.ma25);
      const d75 = dv(s.price, s.ma75);
      const {score, bd} = calcScore(s, currentMode);
      const zone = getZone(score);
      const comment = generateComment(s, d25);
      return {...s, d25, d75, score, bd, zone, comment};
    })
    .sort((a,b) => b.score - a.score);

  // Save history
  saveHistory();
}

function saveHistory() {
  const now = new Date();
  const entry = {
    date: `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
    mode: currentMode,
    count: processed.length,
    top: processed[0]?.name || 'â€”',
    topScore: processed[0]?.score || 0,
  };
  scanHistory.unshift(entry);
  scanHistory = scanHistory.slice(0, 14);
  localStorage.setItem('knv_history', JSON.stringify(scanHistory));
}

// ===== RENDER: PULSE =====
function renderPulse() {
  const chips = [
    {label:'æ—¥çµŒå¹³å‡', val:'38,240', chg:'-312', dir:'dn'},
    {label:'TOPIX', val:'2,718', chg:'-18', dir:'dn'},
    {label:'ãƒ‰ãƒ«å††', val:'149.82', chg:'+0.34', dir:'up'},
    {label:'VIX', val:'18.4', chg:'+1.2', dir:'neutral'},
    {label:'10å¹´å‚µ', val:'1.08%', chg:'+0.02', dir:'neutral'},
  ];
  document.getElementById('pulseBar').innerHTML = chips.map(c=>`
    <div class="pulse-chip">
      <span class="label">${c.label}</span>
      <span class="val ${c.dir}">${c.val} <span style="font-size:9px">${c.chg}</span></span>
    </div>`).join('');
}

// ===== RENDER: DIAGNOSIS =====
function renderDiagnosis() {
  const buyCount = processed.filter(s=>s.zone.cls==='buy').length;
  const avgScore = processed.length ? Math.round(processed.reduce((a,s)=>a+s.score,0)/processed.length) : 0;
  const status = buyCount>=4 ? {cls:'buy',label:'è²·ã„ã‚„ã™ã„æ—¥'} : buyCount>=2 ? {cls:'caution',label:'é¸åˆ¥ãŒå¿…è¦ãªæ—¥'} : {cls:'wait',label:'æ§˜å­è¦‹ã®æ—¥'};
  const now = new Date();
  const days=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const modeNames={dividend:'å®‰å®šé«˜é…å½“',value:'å‰²å®‰ãƒãƒªãƒ¥ãƒ¼',rebound:'å¼·æŠ¼ã—ç›®'};

  const comments = [
    `æ—¥çµŒå¹³å‡ãŒç¶šè½ã—ã€ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã®é«˜é…å½“éŠ˜æŸ„ã§<strong>è²·ã„å ´ãŒ${buyCount}ä»¶</strong>ç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚`,
    `ç›¸å ´ãŒå¹³å‡ã‚ˆã‚Šä¸‹ãŒã£ãŸæ°´æº–ã§ã€<strong>é…å½“åˆ©å›ã‚Š4%è¶…ã®éŠ˜æŸ„ãŒ${processed.filter(s=>s.dividend>=4).length}ä»¶</strong>ã‚¹ã‚­ãƒ£ãƒ³ã«å¼•ã£ã‹ã‹ã£ã¦ã„ã¾ã™ã€‚`,
    `å£²è²·ä»£é‡‘ãŒå°‘ãªã„é™ã‹ãªç›¸å ´ã§ã™ã€‚<strong>æ€¥é¨°ãƒ»æ€¥è½ãƒªã‚¹ã‚¯ãŒä½ã„</strong>å®‰å®šæ ªã‚’é¸ã¶ãªã‚‰ä»Šæ—¥ã¯å‹•ãã‚„ã™ã„åœ°åˆã„ã§ã™ã€‚`,
  ];

  document.getElementById('diagBox').innerHTML = `
    <div class="diag-top">
      <div>
        <div class="diag-label">${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼ˆ${days[now.getDay()]}ï¼‰â€” ${modeNames[currentMode]}ãƒ¢ãƒ¼ãƒ‰</div>
        <div class="diag-title">ä»Šæ—¥ã®æˆ¦ç•¥ï¼š<br>${status.cls==='buy'?'ç©æ¥µçš„ã«æ‹¾ã†æ—¥':'æ…é‡ã«é¸åˆ¥ã™ã‚‹æ—¥'}</div>
      </div>
      <div class="diag-status ${status.cls}">${status.label}</div>
    </div>
    <div class="diag-comment">${comments[Math.floor(Math.random()*comments.length)]}</div>
    <div class="diag-chips">
      <div class="diag-chip ok">ğŸŸ¢ è²·ã„åœ ${processed.filter(s=>s.zone.cls==='buy').length}ä»¶</div>
      <div class="diag-chip warn">ğŸŸ¡ æ³¨æ„åœ ${processed.filter(s=>s.zone.cls==='watch').length}ä»¶</div>
      <div class="diag-chip">âšª å¾…æ©Ÿåœ ${processed.filter(s=>s.zone.cls==='hold').length}ä»¶</div>
    </div>`;
}

// ===== RENDER: RANKINGS =====
function renderRankings() {
  const top5div = processed.sort((a,b)=>b.dividend-a.dividend).slice(0,5);
  const top5score = [...processed].sort((a,b)=>b.score-a.score).slice(0,5);
  const top5dev = [...processed].sort((a,b)=>a.d25-b.d25).slice(0,5);
  processed.sort((a,b)=>b.score-a.score); // restore

  function rowsHtml(list, keyFn, isFree) {
    const freeList = isFree ? list.slice(0, FREE_LIMIT) : list;
    const locked = isFree ? list.slice(FREE_LIMIT) : [];
    let html = freeList.map((s,i)=>{
      const sc = s.score>=60?'hi':s.score>=35?'md':'lo';
      const {v,cls} = keyFn(s);
      return `<div class="rank-row" onclick="jumpToCard('${s.code}')">
        <div class="rank-num ${i<3?'top':''}">${i+1}</div>
        <div class="rank-info">
          <div class="rank-name">${s.name}</div>
          <div class="rank-meta">${s.code} Â· ${s.sector}</div>
        </div>
        <div class="rank-right">
          <div class="rank-score ${sc}">${s.score}</div>
          <div class="rank-key ${cls}">${v}</div>
        </div>
      </div>`;
    }).join('');
    if(locked.length>0){
      html += `<div class="pro-lock">
        ${locked.map(s=>`<div class="rank-row blur-row">
          <div class="rank-num">?</div>
          <div class="rank-info"><div class="rank-name">â—â—â—â—â—</div><div class="rank-meta">â—â— Â· â—â—</div></div>
          <div class="rank-right"><div class="rank-score md">??</div><div class="rank-key">?.?%</div></div>
        </div>`).join('')}
        <div class="pro-overlay">
          <div class="pro-lock-badge" onclick="openProModal()">âœ¦ Proç‰ˆã§å…¨ä»¶è¡¨ç¤º</div>
          <div class="pro-lock-note">æ®‹ã‚Š${locked.length}ä»¶ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™</div>
        </div>
      </div>`;
    }
    return html;
  }

  document.getElementById('rankings').innerHTML = `
    <div class="rank-section">
      <div class="rank-header">
        <div class="rank-title"><span class="rank-ico">ğŸ’°</span> é«˜é…å½“ TOP5</div>
      </div>
      <div class="rank-list">${rowsHtml(top5div, s=>({v:s.dividend+'%',cls:'w'}), true)}</div>
    </div>
    <div class="rank-section">
      <div class="rank-header">
        <div class="rank-title"><span class="rank-ico">ğŸ†</span> ç·åˆã‚¹ã‚³ã‚¢ TOP5</div>
      </div>
      <div class="rank-list">${rowsHtml(top5score, s=>({v:'score '+s.score,cls:'g'}), false)}</div>
    </div>
    <div class="rank-section">
      <div class="rank-header">
        <div class="rank-title"><span class="rank-ico">âš¡</span> å¼·æŠ¼ã—ç›® TOP5</div>
      </div>
      <div class="rank-list">${rowsHtml(top5dev, s=>({v:s.d25+'%',cls:'g'}), false)}</div>
    </div>`;
}

// ===== RENDER: CARD =====
function renderCard() {
  const list = processed;
  if(!list.length){
    document.getElementById('cardArea').innerHTML='<div class="loader"><div class="loader-text">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    return;
  }
  cardIndex = Math.max(0, Math.min(cardIndex, list.length-1));
  const s = list[cardIndex];
  document.getElementById('cardCounter').textContent = `${cardIndex+1} / ${list.length}`;
  document.getElementById('cardPrev').disabled = cardIndex===0;
  document.getElementById('cardNext').disabled = cardIndex===list.length-1;

  const isFav = watchlist.includes(s.code);
  const r = 30; const circ = 2*Math.PI*r;
  const fill = circ - (s.score/100)*circ;
  const col = s.score>=60?'var(--green)':s.score>=35?'var(--gold)':'var(--text)';

  const bdHtml = s.bd.map(item=>`
    <div class="bd-row">
      <div class="bd-l">${item.l}</div>
      <div class="bd-bar"><div class="bd-fill" style="width:${Math.abs(item.v)/item.max*100}%;background:${item.pos?'var(--green)':'var(--red)'}"></div></div>
      <div class="bd-v ${item.pos?'pos':'neg'}">${item.v>0?'+':''}${item.v}</div>
    </div>`).join('');

  document.getElementById('cardArea').innerHTML = `
    <div class="stock-card-big fadein">
      <div class="score-hero">
        <div class="score-ring">
          <svg width="72" height="72" viewBox="0 0 72 72">
            <circle cx="36" cy="36" r="${r}" fill="none" stroke="var(--bg3)" stroke-width="5"/>
            <circle cx="36" cy="36" r="${r}" fill="none" stroke="${col}" stroke-width="5"
              stroke-dasharray="${circ}" stroke-dashoffset="${fill}"
              stroke-linecap="round" style="transition:stroke-dashoffset 0.8s ease"/>
          </svg>
          <div class="score-ring-val">
            <div class="score-ring-num" style="color:${col}">${s.score}</div>
            <div class="score-ring-label">SCORE</div>
          </div>
        </div>
        <div class="score-info">
          <div class="score-zone ${s.zone.cls}">${s.zone.label}</div>
          <div class="score-name">${s.name}</div>
          <div class="score-code">${s.code} Â· ${s.sector}</div>
        </div>
      </div>

      <div class="ai-comment">
        <div class="ai-tag">â— AIåˆ†æ</div>
        ${s.comment}
      </div>

      <div class="metrics-grid">
        <div class="metric">
          <div class="metric-l">ç¾åœ¨å€¤</div>
          <div class="metric-v">Â¥${s.price.toLocaleString()}</div>
          <div class="metric-hint">&nbsp;</div>
        </div>
        <div class="metric">
          <div class="metric-l">ä¸‹è½ç‡</div>
          <div class="metric-v ${s.d25<0?'g':'r'}">${s.d25>0?'+':''}${s.d25}%</div>
          <div class="metric-hint">25æ—¥å¹³å‡æ¯”</div>
        </div>
        <div class="metric">
          <div class="metric-l">å£²ã‚‰ã‚Œã™ãåº¦</div>
          <div class="metric-v ${s.rsi<=30?'g':s.rsi>=50?'r':''}">${s.rsi}</div>
          <div class="metric-hint">30ä»¥ä¸‹ãŒç›®å®‰</div>
        </div>
        <div class="metric">
          <div class="metric-l">é…å½“åˆ©å›ã‚Š</div>
          <div class="metric-v w">${s.dividend}%</div>
          <div class="metric-hint">3%ä»¥ä¸ŠãŒé«˜é…å½“</div>
        </div>
        <div class="metric">
          <div class="metric-l">PBR</div>
          <div class="metric-v ${s.pbr<=1?'g':''}">${s.pbr}å€</div>
          <div class="metric-hint">1ä»¥ä¸‹ãŒå‰²å®‰</div>
        </div>
        <div class="metric">
          <div class="metric-l">PER</div>
          <div class="metric-v ${s.per<=13?'g':''}">${s.per}å€</div>
          <div class="metric-hint">ä½ã„ã»ã©å‰²å®‰</div>
        </div>
      </div>

      <div class="breakdown">
        <div class="breakdown-title">OSHI-ME SCORE å†…è¨³</div>
        ${bdHtml}
      </div>

      <div class="card-actions">
        <button class="btn-fav ${isFav?'active':''}" onclick="toggleFav('${s.code}')">
          ${isFav?'â˜… ç™»éŒ²æ¸ˆã¿':'â˜† ã‚¦ã‚©ãƒƒãƒç™»éŒ²'}
        </button>
        <button class="btn-detail" onclick="openProModal()">âœ¦ Proç‰ˆã§è©³ç´°ã‚’è¦‹ã‚‹</button>
      </div>
    </div>`;

  // Swipe
  setupSwipe();
}

function cardMove(dir) {
  cardIndex = Math.max(0, Math.min(cardIndex + dir, processed.length-1));
  renderCard();
}

function jumpToCard(code) {
  const idx = processed.findIndex(s=>s.code===code);
  if(idx>=0){ cardIndex=idx; renderCard(); document.getElementById('cardArea').scrollIntoView({behavior:'smooth',block:'nearest'}); }
}

// ===== SWIPE =====
function setupSwipe() {
  const el = document.querySelector('.stock-card-big');
  if(!el) return;
  let sx=0,sy=0;
  el.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;},{passive:true});
  el.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-sx;
    const dy=e.changedTouches[0].clientY-sy;
    if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>40){
      if(dx<0&&cardIndex<processed.length-1){cardIndex++;renderCard();}
      if(dx>0&&cardIndex>0){cardIndex--;renderCard();}
    }
  },{passive:true});
}

// ===== EVENTS =====
function renderEvents() {
  const events = [
    {ico:'ğŸ“ˆ',title:'æ—¥çµŒå¹³å‡ -0.81%',desc:'2æ—¥é€£ç¶šã®ä¸‹è½ã€‚éŠ€è¡Œãƒ»å•†ç¤¾ã‚’ä¸­å¿ƒã«å£²ã‚‰ã‚Œã€å‰²å®‰æ°´æº–ã«è¿‘ã¥ã„ã¦ã„ã‚‹éŠ˜æŸ„ãŒå¢—åŠ ã€‚',tag:{t:'bear',l:'ä¸‹è½'}},
    {ico:'ğŸ’´',title:'ãƒ‰ãƒ«å†† 149.82å††ï¼ˆå††å®‰æ–¹å‘ï¼‰',desc:'å††å®‰ãŒç¶šã„ã¦ãŠã‚Šã€è¼¸å‡ºä¼æ¥­ï¼ˆè‡ªå‹•è»Šãƒ»å•†ç¤¾ãªã©ï¼‰ã®æ¥­ç¸¾ã«ãƒ—ãƒ©ã‚¹è¦å› ã€‚',tag:{t:'bull',l:'è¿½ã„é¢¨'}},
    {ico:'ğŸ“Š',title:'æ±è¨¼ å£²è²·ä»£é‡‘ 3.8å…†å††',desc:'å‰æ—¥ã‚ˆã‚Šå°‘ãªã‚ã€‚å¤§å£ã®å£²è²·ãŒå°‘ãªã„é™ã‹ãªç›¸å ´ã€‚æ€¥å¤‰ãƒªã‚¹ã‚¯ã¯ä½ã‚ã€‚',tag:{t:'neutral',l:'ä¸­ç«‹'}},
    {ico:'ğŸ‡ºğŸ‡¸',title:'ç±³å›½å¸‚å ´ NASDAQ å¼·å«ã¿',desc:'å‰æ—¥ã®NASDAQãŒä¸Šæ˜‡ã€‚ä»Šå¤œã®ç±³å›½å¸‚å ´ãŒå¥½èª¿ãªã‚‰ã€æ˜æœã®æ—¥æœ¬æ ªã«ãƒ—ãƒ©ã‚¹ã®å¯èƒ½æ€§ã€‚',tag:{t:'bull',l:'è¿½ã„é¢¨'}},
  ];
  document.getElementById('eventList').innerHTML = events.map(e=>`
    <div class="event-row">
      <div class="event-ico">${e.ico}</div>
      <div class="event-body">
        <div class="event-title">
          <span class="event-tag ${e.tag.t}">${e.tag.l}</span>
          ${e.title}
        </div>
        <div class="event-desc">${e.desc}</div>
      </div>
    </div>`).join('');
}

// ===== WATCHLIST =====
function toggleFav(code) {
  if(watchlist.includes(code)){
    watchlist = watchlist.filter(c=>c!==code);
  } else {
    if(watchlist.length>=3){
      openProModal();return;
    }
    watchlist.push(code);
  }
  localStorage.setItem('knv_watch', JSON.stringify(watchlist));
  document.getElementById('watchDot').classList.toggle('show', watchlist.length>0);
  renderCard();
  renderWatchlist();
}

function renderWatchlist() {
  const el = document.getElementById('watchlistBody');
  document.getElementById('watchDot').classList.toggle('show', watchlist.length>0);
  if(!watchlist.length){
    el.innerHTML='<div class="watch-empty">ã‚¦ã‚©ãƒƒãƒç™»éŒ²ã—ãŸéŠ˜æŸ„ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™<br><span style="font-size:10px;color:var(--text);margin-top:4px;display:block">ã‚«ãƒ¼ãƒ‰ã®ã€Œâ˜† ã‚¦ã‚©ãƒƒãƒç™»éŒ²ã€ã‹ã‚‰è¿½åŠ ã§ãã¾ã™ï¼ˆç„¡æ–™ç‰ˆã¯3ä»¶ã¾ã§ï¼‰</span></div>';
    return;
  }
  el.innerHTML=`<div class="watch-list">${watchlist.map(code=>{
    const s = STOCKS.find(x=>x.code===code);
    if(!s)return'';
    const d25=dv(s.price,s.ma25);
    const {score}=calcScore(s,currentMode);
    const sc=score>=60?'hi':score>=35?'md':'lo';
    return `<div class="watch-row" onclick="jumpToCard('${code}');switchTab('home')">
      <div style="font-size:12px;color:var(--gold);">${code}</div>
      <div class="watch-name">${s.name}</div>
      <div style="text-align:right">
        <div class="watch-score ${sc}">${score}ç‚¹</div>
        <div style="font-size:9px;color:${d25<0?'var(--green)':'var(--red)'}">${d25>0?'+':''}${d25}%</div>
      </div>
      <button class="watch-remove" onclick="event.stopPropagation();toggleFav('${code}')">âœ•</button>
    </div>`;
  }).join('')}</div>`;
}

// ===== HISTORY =====
function renderHistory() {
  const el = document.getElementById('historyBody');
  if(!scanHistory.length){
    el.innerHTML='<div class="history-empty">ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã¨å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¾ã™</div>';
    return;
  }
  const modeNames={dividend:'é«˜é…å½“',value:'ãƒãƒªãƒ¥ãƒ¼',rebound:'æŠ¼ã—ç›®'};
  el.innerHTML=`<div class="hist-list">${scanHistory.slice(0,7).map((h,i)=>{
    const prev = scanHistory[i+1];
    const diff = prev ? h.topScore - prev.topScore : null;
    return `<div class="hist-row">
      <span class="hist-date">${h.date}</span>
      <span class="hist-info">${modeNames[h.mode]||h.mode} Â· ${h.count}ä»¶</span>
      <span>
        <span style="font-size:10px;color:var(--text2)">${h.top}</span>
        ${diff!==null?`<span class="hist-diff ${diff>0?'up':'dn'}"> ${diff>0?'+':''}${diff}</span>`:''}
      </span>
    </div>`;
  }).join('')}</div>`;
}

// ===== MODE =====
function setMode(mode, el) {
  currentMode = mode;
  document.querySelectorAll('.mode-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  run();
}

// ===== TABS =====
function switchTab(tab) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
  document.getElementById('nav-'+tab).classList.add('active');
  if(tab==='watch'){ renderWatchlist(); renderHistory(); }
}

// ===== PRO MODAL =====
function openProModal(){ document.getElementById('proModal').classList.add('open'); }
function closeProModal(e){
  if(!e||e.target===document.getElementById('proModal'))
    document.getElementById('proModal').classList.remove('open');
}

// ===== INIT =====
function run() {
  processStocks();
  renderPulse();
  renderDiagnosis();
  renderRankings();
  cardIndex = 0;
  renderCard();
  renderEvents();
}

// Init watchlist dot
document.getElementById('watchDot').classList.toggle('show', watchlist.length>0);
run();
</script>
</body>
</html>
