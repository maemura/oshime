<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>„Åã„Å∂„ÅÆ„Åô„ÅëNavi ‚Äî AI √ó È´òÈÖçÂΩì„ÉªÂâ≤ÂÆâÊ†™</title>
<meta name="description" content="Êù±Ë®º„Éó„É©„Ç§„É†ÂÖ®ÈäòÊüÑ„ÇíÊØéÊúùËá™Âãï„Çπ„Ç≠„É£„É≥„ÄÇÂú∞Âêà„ÅÑÂà§ÂÆö√óÈ´òÈÖçÂΩì√óÂâ≤ÂÆâ„Åß‰ªäÊó•„ÅÆË≤∑„ÅÑÂ†¥„ÇíÂç≥Ë°®Á§∫„ÄÇ">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DWW0W11P5T"></script>
<script>
  window.dataLayer=window.dataLayer||[];
  function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());
  gtag('config','G-DWW0W11P5T',{page_title:'„Åã„Å∂„ÅÆ„Åô„ÅëNavi'});
  function gaEvent(n,p){if(typeof gtag!=='undefined')gtag('event',n,p||{});}
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;800&family=JetBrains+Mono:wght@500;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --navy:#000000; --navy2:#0a0a0a;
  --orange:#00DC82; --orange2:#00FF96; --orange-lt:rgba(0,220,130,0.06);
  --up:#00DC82; --dn:#FF4D4D;
  --green:#00DC82; --green-lt:rgba(0,220,130,0.08);
  --amber:#FFAA00; --amber-lt:rgba(255,170,0,0.08);
  --bg:#000000; --bg2:#0a0a0a; --bg3:#0f0f0f;
  --border:rgba(255,255,255,0.05);
  --text:#e0e0e0; --text2:#ffffff; --text3:#555555;
  --r:14px; --r2:8px;
  --fn:'JetBrains Mono','DM Mono',monospace;
  --fh:'DM Sans','Noto Sans JP',sans-serif;
  --fb:'DM Sans','Noto Sans JP',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{font-size:15px;}
body{background:var(--bg);color:var(--text);font-family:var(--fb);min-height:100vh;overflow-x:hidden;}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{
  position:sticky;top:0;z-index:300;
  background:var(--navy);border-bottom:3px solid var(--orange);
  height:54px;display:flex;align-items:center;padding:0 20px;
}
.topbar-inner{width:100%;max-width:1300px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;}
.logo-name{font-family:var(--fh);font-size:17px;font-weight:800;color:#fff;letter-spacing:-0.3px;}
.logo-tag{font-size:9px;color:rgba(255,255,255,0.4);font-family:var(--fh);margin-left:8px;}
.topbar-right{display:flex;align-items:center;gap:8px;}
.btn-topbar{
  background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);
  border-radius:var(--r2);padding:5px 12px;color:#fff;cursor:pointer;
  font-family:var(--fh);font-size:11px;font-weight:600;
  display:flex;align-items:center;gap:5px;
}
.btn-topbar:hover{background:rgba(255,255,255,0.18);}
.watch-count{
  background:var(--orange);color:#fff;border-radius:10px;
  padding:1px 5px;font-size:9px;font-weight:700;display:none;
}
.watch-count.show{display:inline-block;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.page{max-width:1300px;margin:0 auto;padding:20px 20px 100px;}
@media(max-width:480px){.page{padding:12px 12px 90px;}}

/* ‚îÄ‚îÄ HERO (compact) ‚îÄ‚îÄ */
.hero{
  background:linear-gradient(135deg,var(--navy) 0%,#0e2f5a 100%);
  border-radius:var(--r);padding:20px 24px;margin-bottom:14px;
  position:relative;overflow:hidden;
}
.hero::before{
  content:'';position:absolute;right:-40px;top:-40px;
  width:180px;height:180px;border-radius:50%;
  background:rgba(232,84,30,0.08);pointer-events:none;
}
.hero-top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.hero-left{}
.hero-eyebrow{
  display:inline-flex;align-items:center;gap:6px;
  font-family:var(--fh);font-size:10px;color:rgba(255,255,255,0.5);
  margin-bottom:8px;
}
.hero-dot{width:6px;height:6px;border-radius:50%;background:var(--orange);flex-shrink:0;animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}
.hero-title{font-family:var(--fh);font-size:22px;font-weight:800;color:#fff;line-height:1.2;letter-spacing:-0.3px;}
.hero-title span{color:var(--orange2);}
@media(max-width:480px){.hero-title{font-size:18px;}}
.hero-stats{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;}
.hero-stat{
  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);
  border-radius:var(--r2);padding:8px 14px;
}
.hero-stat-val{font-family:var(--fn);font-size:20px;color:#fff;line-height:1;}
.hero-stat-val.buy{color:var(--orange2);}
.hero-stat-label{font-size:9px;color:rgba(255,255,255,0.4);font-family:var(--fh);margin-top:2px;}

/* ‚îÄ‚îÄ TRUST BAR ‚îÄ‚îÄ */
.trust-bar{
  background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--amber);
  border-radius:var(--r);padding:8px 14px;margin-bottom:12px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.trust-left{display:flex;align-items:center;gap:8px;}
.trust-dot{width:8px;height:8px;border-radius:50%;background:var(--amber);flex-shrink:0;}
.trust-text{font-size:11px;color:var(--text3);}
.trust-text .hi{color:var(--green);font-weight:700;}
.trust-text .warn{color:var(--amber);font-weight:700;}
.trust-badges{display:flex;gap:6px;flex-wrap:wrap;}
.tbadge{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:4px;padding:2px 8px;font-size:10px;color:var(--text3);
  font-family:var(--fh);
}
.tbadge.link{cursor:pointer;color:var(--navy);border-color:var(--navy);}
.tbadge.link:hover{background:var(--navy);color:#fff;}

/* ‚îÄ‚îÄ MARKET PULSE ‚îÄ‚îÄ */
.pulse{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);margin-bottom:12px;overflow:hidden;
}
.pulse-row{display:flex;overflow-x:auto;scrollbar-width:none;}
.pulse-row::-webkit-scrollbar{display:none;}
.pc{flex-shrink:0;padding:9px 14px;border-right:1px solid var(--border);min-width:88px;text-align:center;}
.pc:last-child{border-right:none;}
.pc-l{font-size:9px;color:var(--text3);font-family:var(--fh);margin-bottom:2px;}
.pc-v{font-family:var(--fn);font-size:13px;color:var(--text2);}
.pc-v.up{color:var(--up);}  .pc-v.dn{color:var(--dn);}
.pc-c{font-family:var(--fn);font-size:10px;color:var(--text3);}
.pc-c.up{color:var(--up);}  .pc-c.dn{color:var(--dn);}

/* ‚îÄ‚îÄ STANCE ‚îÄ‚îÄ */
.stance{
  background:var(--bg2);border:1px solid var(--border);border-left:4px solid var(--border);
  border-radius:var(--r);padding:16px 18px;margin-bottom:14px;
}
.stance.bull{border-left-color:var(--up);}
.stance.neutral{border-left-color:var(--amber);}
.stance.bear{border-left-color:var(--dn);}
.stance-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
.stance-title{font-family:var(--fh);font-size:16px;font-weight:800;color:var(--text2);}
.stance-date{font-size:10px;color:var(--text3);font-family:var(--fh);margin-top:2px;}
.stance-badge{
  flex-shrink:0;padding:4px 12px;border-radius:20px;
  font-family:var(--fh);font-size:11px;font-weight:700;border:1px solid;
}
.stance-badge.bull{background:rgba(208,2,27,0.07);color:var(--up);border-color:rgba(208,2,27,0.2);}
.stance-badge.neutral{background:var(--amber-lt);color:var(--amber);border-color:rgba(148,101,0,0.2);}
.stance-badge.bear{background:rgba(0,85,204,0.07);color:var(--dn);border-color:rgba(0,85,204,0.2);}
.stance-reason{font-size:12px;color:var(--text);line-height:1.85;margin-bottom:12px;}
.stance-reason strong{color:var(--navy);font-weight:700;}
.stance-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.stance-chip{
  border:1px solid var(--border);border-radius:var(--r2);
  padding:6px 10px;text-align:center;flex:1;min-width:70px;background:var(--bg3);
}
.stance-chip.buy{background:var(--green-lt);border-color:rgba(0,135,90,0.2);}
.stance-chip.warn{background:var(--amber-lt);border-color:rgba(148,101,0,0.2);}
.stance-chip-val{font-family:var(--fn);font-size:15px;color:var(--text2);}
.stance-chip-label{font-size:9px;color:var(--text3);}
.stance-axes{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;}
.axis-row{display:flex;align-items:center;gap:8px;font-size:11px;}
.axis-name{min-width:110px;color:var(--text3);}
.axis-bar{display:flex;gap:3px;}
.axis-seg{width:24px;height:6px;border-radius:3px;background:var(--border);}
.axis-seg.on.hi{background:var(--up);}
.axis-seg.on.mid{background:var(--amber);}
.axis-score{font-family:var(--fn);font-size:10px;color:var(--text3);}
.axis-total{font-size:11px;font-weight:700;color:var(--text3);padding-top:4px;border-top:1px solid var(--border);}
.stance-note{font-size:10px;color:var(--text3);background:var(--bg3);padding:6px 10px;border-radius:var(--r2);line-height:1.6;}

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.sec-head{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;
}
.sec-head-title{font-family:var(--fh);font-size:13px;font-weight:700;color:var(--text2);}
.sec-head-sub{font-size:10px;color:var(--text3);}

/* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
.filter-bar{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  padding:12px 14px;margin-bottom:12px;
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.filter-label{font-family:var(--fh);font-size:11px;color:var(--text3);font-weight:600;}
.filter-tabs{display:flex;gap:4px;flex-wrap:wrap;}
.filter-tab{
  border:1px solid var(--border);border-radius:4px;padding:4px 10px;
  font-family:var(--fh);font-size:11px;font-weight:600;color:var(--text3);
  cursor:pointer;background:var(--bg3);white-space:nowrap;
}
.filter-tab.active{background:var(--navy);color:#fff;border-color:var(--navy);}
.filter-sep{width:1px;height:20px;background:var(--border);}
.filter-count{font-family:var(--fn);font-size:11px;color:var(--text3);margin-left:auto;}

/* ‚îÄ‚îÄ STOCK TABLE ‚îÄ‚îÄ */
.stock-table-wrap{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);overflow:hidden;margin-bottom:14px;
}
.stock-table{width:100%;border-collapse:collapse;}
.stock-table th{
  background:var(--bg3);padding:8px 10px;
  font-family:var(--fh);font-size:10px;font-weight:700;color:var(--text3);
  text-align:right;border-bottom:2px solid var(--border);
  white-space:nowrap;cursor:pointer;user-select:none;
}
.stock-table th:first-child{text-align:left;}
.stock-table th:hover{color:var(--navy);}
.stock-table th.sort-asc::after{content:' ‚ñ≤';}
.stock-table th.sort-desc::after{content:' ‚ñº';}
.stock-table td{
  padding:9px 10px;border-bottom:1px solid var(--border);
  font-size:12px;text-align:right;color:var(--text);
  vertical-align:middle;
}
.stock-table td:first-child{text-align:left;}
.stock-table tr:last-child td{border-bottom:none;}
.stock-table tr.tbl-row{cursor:pointer;transition:background 0.1s;}
.stock-table tr.tbl-row:hover{background:var(--bg3);}
.stock-table tr.tbl-row.expanded{background:#f0f7ff;}
.tbl-rank{
  font-family:var(--fn);font-size:11px;font-weight:700;
  width:28px;text-align:center;
}
.tbl-rank.top{color:var(--orange);}
.tbl-name{font-weight:600;color:var(--text2);font-size:12px;}
.tbl-name-link{font-weight:600;color:var(--text2);font-size:12px;text-decoration:none;display:block;}
.tbl-name-link:hover{color:var(--navy);text-decoration:underline;}
.tbl-code{font-family:var(--fn);font-size:10px;color:var(--text3);}
.tbl-zone{
  display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;
  font-family:var(--fh);font-size:10px;font-weight:700;white-space:nowrap;
}
.tbl-zone.buy{background:var(--green-lt);color:var(--green);}
.tbl-zone.watch{background:var(--amber-lt);color:var(--amber);}
.tbl-zone.hold{background:var(--bg3);color:var(--text3);}
.tbl-score{font-family:var(--fn);font-size:13px;font-weight:700;}
.tbl-score.hi{color:var(--up);}
.tbl-score.md{color:var(--amber);}
.tbl-score.lo{color:var(--text3);}
.tbl-num{font-family:var(--fn);font-size:12px;}
.tbl-num.dn{color:var(--up);}   /* ‰πñÈõ¢„Éû„Ç§„Éä„Çπ=Ëµ§=Ë≤∑„ÅÑÂ†¥ */
.tbl-num.up{color:var(--dn);}
.tbl-prev{font-family:var(--fn);font-size:10px;}
.tbl-prev.up{color:var(--up);}
.tbl-prev.dn{color:var(--dn);}
/* Â±ïÈñãË©≥Á¥∞Ë°å */
.detail-row td{padding:0;background:#f0f7ff;}
.detail-box{padding:14px 16px;border-top:1px solid #d0e4f7;}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:600px){.detail-grid{grid-template-columns:1fr;}}
.detail-section-title{font-family:var(--fh);font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.5px;margin-bottom:8px;}
.why-items{display:flex;flex-direction:column;gap:6px;}
.why-item{
  background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--r2);
  padding:8px 12px;position:relative;
}
.why-item.strong{border-color:rgba(208,2,27,0.25);background:rgba(208,2,27,0.03);}
.why-item.mid{border-color:rgba(148,101,0,0.25);background:var(--amber-lt);}
.why-rank-badge{
  position:absolute;top:8px;right:8px;
  width:16px;height:16px;border-radius:50%;
  font-family:var(--fh);font-size:8px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
}
.why-rank-badge.strong{background:rgba(208,2,27,0.1);color:var(--up);}
.why-rank-badge.mid{background:rgba(148,101,0,0.1);color:var(--amber);}
.why-val{font-family:var(--fn);font-size:18px;color:var(--text2);}
.why-item.strong .why-val{color:var(--up);}
.why-item.mid .why-val{color:var(--amber);}
.why-label{font-size:9px;color:var(--text3);}
.why-note-text{font-size:11px;font-weight:700;margin-top:2px;}
.why-item.strong .why-note-text{color:var(--up);}
.why-item.mid .why-note-text{color:var(--amber);}
.why-desc{font-size:10px;color:var(--text3);line-height:1.6;margin-top:2px;}
.score-breakdown{display:flex;flex-direction:column;gap:5px;}
.bd-row{display:flex;align-items:center;gap:8px;}
.bd-l{font-size:10px;color:var(--text3);min-width:70px;}
.bd-bar{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.bd-fill{height:100%;border-radius:3px;transition:width 0.4s ease;}
.bd-v{font-family:var(--fn);font-size:10px;min-width:38px;text-align:right;}
.bd-v.pos{color:var(--green);}  .bd-v.neg{color:var(--up);}
.detail-fav-btn{
  padding:7px 16px;border-radius:var(--r2);
  font-family:var(--fh);font-size:11px;font-weight:700;cursor:pointer;
  border:1.5px solid var(--border);background:var(--bg2);color:var(--text2);
}
.detail-fav-btn.active{background:var(--orange);color:#fff;border-color:var(--orange);}
.detail-link-btn{
  padding:7px 14px;border-radius:var(--r2);
  font-family:var(--fh);font-size:11px;font-weight:700;
  border:1.5px solid var(--border);background:var(--bg3);color:var(--navy);
  text-decoration:none;display:inline-flex;align-items:center;
}
.detail-link-btn:hover{background:var(--navy);color:#fff;border-color:var(--navy);}

/* ‚îÄ‚îÄ TREND BADGES ‚îÄ‚îÄ */
.trend-badge{
  display:inline-flex;align-items:center;
  padding:1px 6px;border-radius:3px;
  font-size:9px;font-weight:700;font-family:var(--fh);
  white-space:nowrap;cursor:default;
}
.trend-badge.hot{background:rgba(208,2,27,0.1);color:var(--up);border:1px solid rgba(208,2,27,0.2);}
.trend-badge.warm{background:rgba(148,101,0,0.08);color:var(--amber);border:1px solid rgba(148,101,0,0.15);}

/* ‚îÄ‚îÄ 3 TABS („Çª„ÇØ„Çø„Éº/‰∏äÊòá/Ââ≤ÂÆâ) ‚îÄ‚îÄ */
.t5-tabs{display:flex;gap:0;margin-bottom:14px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.t5-tab{
  flex:1;padding:10px 4px;text-align:center;cursor:pointer;
  font-family:var(--fh);font-size:12px;font-weight:700;color:var(--text3);
  border-right:1px solid var(--border);transition:all 0.15s;
}
.t5-tab:last-child{border-right:none;}
.t5-tab.active{color:#fff;background:var(--navy);}
.t5-tab:hover:not(.active){background:var(--bg3);}

/* ‚îÄ‚îÄ TOP10 CARDS ‚îÄ‚îÄ */
.top10-cards{display:flex;flex-direction:column;gap:8px;}
.top10-card{
  display:flex;align-items:center;gap:12px;
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  padding:12px 14px;cursor:pointer;transition:background 0.15s;
}
.top10-card:hover{background:var(--bg3);}
.top10-rank{font-family:var(--fn);font-size:16px;font-weight:800;color:var(--navy);min-width:22px;text-align:center;}
.top10-info{flex:1;min-width:0;}
.top10-name{font-size:13px;font-weight:700;color:var(--text1);}
.top10-meta{font-size:10px;color:var(--text3);margin-top:2px;}
.top10-right{text-align:right;min-width:55px;}
.top10-score{font-family:var(--fn);font-size:15px;font-weight:800;}
.top10-score.hi{color:var(--dn);} .top10-score.mid{color:var(--amber);}
.top10-badge{display:inline-block;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-top:2px;}
.top10-badge.div{background:rgba(78,170,135,0.12);color:var(--dn);}
.top10-badge.mom{background:rgba(0,82,204,0.1);color:var(--navy);}

/* ‚îÄ‚îÄ SECTOR GRID ‚îÄ‚îÄ */
.sec-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;}
@media(max-width:640px){.sec-grid{grid-template-columns:1fr 1fr;}}
.sec-tile{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.15s;
}
.sec-tile:hover{border-color:var(--navy);background:var(--bg3);}
.sec-tile-ico{font-size:22px;margin-bottom:4px;}
.sec-tile-name{font-family:var(--fh);font-size:11px;font-weight:700;color:var(--text2);}
.sec-tile-sub{font-family:var(--fn);font-size:10px;color:var(--text3);margin-top:2px;}
.sec-back-btn{
  display:inline-flex;align-items:center;gap:4px;padding:6px 12px;margin-bottom:10px;
  background:var(--bg3);border:1px solid var(--border);border-radius:var(--r2);
  font-size:11px;font-weight:700;color:var(--text3);cursor:pointer;
}
.sec-back-btn:hover{background:var(--border);}

/* ‚îÄ‚îÄ TREND WARNING ‚îÄ‚îÄ */
.trend-warning{
  background:rgba(208,2,27,0.06);border:1px solid rgba(208,2,27,0.2);
  border-radius:var(--r2);padding:8px 14px;margin-bottom:12px;
  font-size:11px;font-weight:700;color:var(--up);
}

/* ‚îÄ‚îÄ PORTFOLIO DIARY ‚îÄ‚îÄ */
.pf-hero{display:flex;align-items:baseline;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);margin-bottom:12px;}
.pf-nav{font-family:var(--fn);font-size:24px;font-weight:800;color:var(--text1);}
.pf-pnl{font-family:var(--fn);font-size:14px;font-weight:700;}
.pf-pnl.up{color:var(--dn);} .pf-pnl.dn{color:var(--up);}
.pf-day{font-size:11px;color:var(--text3);}
.pf-bars{display:flex;gap:4px;margin-bottom:10px;}
.pf-bar{flex:1;text-align:center;font-size:10px;padding:4px 0;border-radius:4px;}
.pf-bar.cash{background:rgba(0,82,204,0.08);color:var(--navy);}
.pf-bar.stock{background:rgba(78,170,135,0.08);color:var(--dn);}
.pf-holdings{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;}
.pf-hold{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);}
.pf-hold-name{flex:1;font-size:12px;font-weight:600;color:var(--text2);}
.pf-hold-pnl{font-family:var(--fn);font-size:13px;font-weight:700;min-width:50px;text-align:right;}
.pf-hold-pnl.up{color:var(--dn);} .pf-hold-pnl.dn{color:var(--up);}
.pf-note-link{display:block;text-align:center;padding:12px;background:var(--navy);color:#fff;border-radius:var(--r);font-size:13px;font-weight:700;text-decoration:none;margin-top:10px;transition:opacity 0.15s;}
.pf-note-link:hover{opacity:0.85;}

/* ‚îÄ‚îÄ WATCHLIST / HISTORY ‚îÄ‚îÄ */
.watch-empty{padding:20px;text-align:center;font-size:12px;color:var(--text3);}
.watch-list{display:flex;flex-direction:column;gap:6px;}
.watch-row{
  display:flex;align-items:center;gap:10px;padding:10px 14px;
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;
}
.watch-row:hover{background:var(--bg3);}
.watch-code{font-family:var(--fn);font-size:11px;color:var(--text3);min-width:36px;}
.watch-name{flex:1;font-size:12px;font-weight:600;color:var(--text2);}
.watch-score{font-family:var(--fn);font-size:13px;font-weight:700;}
.watch-score.hi{color:var(--up);} .watch-score.md{color:var(--amber);} .watch-score.lo{color:var(--text3);}
.watch-remove{background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px;padding:4px;}
.hist-table{width:100%;border-collapse:collapse;font-size:11px;}
.hist-table th{background:var(--bg3);padding:6px 10px;text-align:left;font-family:var(--fh);font-size:10px;color:var(--text3);border-bottom:1px solid var(--border);}
.hist-table td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text);}
.hist-table tr:last-child td{border-bottom:none;}

/* ‚îÄ‚îÄ SETTINGS PANEL ‚îÄ‚îÄ */
.settings-overlay{
  position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.4);
  display:none;align-items:flex-end;justify-content:center;
}
.settings-overlay.open{display:flex;}
.settings-box{
  background:var(--bg2);border-radius:16px 16px 0 0;
  padding:20px;width:100%;max-width:600px;max-height:85vh;overflow-y:auto;
}
.settings-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.settings-title{font-family:var(--fh);font-size:15px;font-weight:800;color:var(--text2);margin-bottom:16px;}
.setting-row{margin-bottom:14px;}
.setting-label{font-family:var(--fh);font-size:11px;font-weight:700;color:var(--text3);margin-bottom:6px;letter-spacing:0.5px;}
.setting-opts{display:flex;gap:6px;flex-wrap:wrap;}
.setting-opt{
  border:1.5px solid var(--border);border-radius:var(--r2);padding:6px 12px;
  font-family:var(--fh);font-size:11px;font-weight:600;color:var(--text);
  cursor:pointer;background:var(--bg3);
}
.setting-opt.active{background:var(--navy);color:#fff;border-color:var(--navy);}
.settings-save{
  width:100%;padding:12px;margin-top:8px;
  background:var(--orange);color:#fff;border:none;border-radius:var(--r);
  font-family:var(--fh);font-size:13px;font-weight:700;cursor:pointer;
}
.settings-save:hover{background:var(--orange2);}

/* ‚îÄ‚îÄ NAV TABS ‚îÄ‚îÄ */
.nav-tabs{
  display:flex;background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);margin-bottom:14px;overflow:hidden;
}
.nav-tab{
  flex:1;padding:10px;text-align:center;cursor:pointer;
  font-family:var(--fh);font-size:11px;font-weight:700;color:var(--text3);
  border-right:1px solid var(--border);position:relative;
}
.nav-tab:last-child{border-right:none;}
.nav-tab.active{color:var(--navy);background:var(--navy);color:#fff;}

/* ‚îÄ‚îÄ BOTTOM NAV (mobile) ‚îÄ‚îÄ */
.bottom-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;z-index:200;
  background:var(--bg2);border-top:1px solid var(--border);
  padding:6px 0 8px;
}
@media(max-width:768px){.bottom-nav{display:flex;}}
.nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;
  background:none;border:none;cursor:pointer;color:var(--text3);padding:4px;
}
.nav-item.active{color:var(--navy);}
.nav-ico{font-size:18px;}
.nav-label{font-size:9px;font-family:var(--fh);font-weight:700;}

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel{display:none;}
.panel.active{display:block;}

/* ‚îÄ‚îÄ SKELETON ‚îÄ‚îÄ */
.skeleton{background:var(--border);border-radius:4px;animation:shimmer 1.5s infinite linear;background:linear-gradient(90deg,var(--border) 25%,#e8edf2 50%,var(--border) 75%);background-size:200% 100%;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.skel-row{height:40px;margin-bottom:4px;border-radius:4px;}

/* ‚îÄ‚îÄ CHART & DETAIL EXPAND ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ BRAIN SCANNER 3Â±§ÂêåÂøÉÂÜÜ ‚îÄ‚îÄ */
.brain-wrap{background:#060a14;border-radius:var(--r);padding:16px 8px;margin-bottom:14px;border:1px solid #1a2744;position:relative;overflow:hidden;}
.brain-wrap::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 40%,rgba(74,170,255,0.03) 0%,transparent 60%),linear-gradient(rgba(74,170,255,0.012) 1px,transparent 1px),linear-gradient(90deg,rgba(74,170,255,0.012) 1px,transparent 1px);background-size:100% 100%,28px 28px,28px 28px;pointer-events:none;}
.brain-head{text-align:center;margin-bottom:4px;position:relative;z-index:1;}
.brain-title{font-family:var(--fn);font-size:10px;font-weight:700;color:#4af;letter-spacing:5px;text-transform:uppercase;opacity:0.6;}
.brain-sub{font-size:11px;color:#445;margin-top:4px;}
.brain-container{position:relative;width:100%;max-width:380px;aspect-ratio:1/1;margin:0 auto;}
/* 3„Å§„ÅÆÂêåÂøÉÂÜÜ„Ç¨„Ç§„Éâ */
.brain-guide{position:absolute;border-radius:50%;left:50%;transform:translateX(-50%);}
.brain-guide.outer{top:0;width:100%;height:100%;border:1px solid rgba(74,170,255,0.08);}
.brain-guide.mid{top:17%;width:66%;height:66%;border:1px solid rgba(74,170,255,0.07);}
.brain-guide.inner{top:30%;width:38%;height:38%;border:1px solid rgba(167,139,250,0.08);background:radial-gradient(circle,rgba(167,139,250,0.03) 0%,transparent 70%);}
/* Â±§„É©„Éô„É´ */
.brain-tag{position:absolute;font-family:var(--fn);font-size:7px;letter-spacing:2px;text-transform:uppercase;opacity:0.3;left:50%;transform:translateX(-50%);pointer-events:none;white-space:nowrap;}
.brain-tag.t1{top:2%;color:#4af;}
.brain-tag.t2{top:15%;color:#4aeaaa;}
.brain-tag.t3{top:31%;color:#a78bfa;}
/* ÂêÑÂ±§„ÅÆ„É™„É≥„Ç∞ */
.brain-ring{position:absolute;left:50%;transform:translateX(-50%);}
.brain-ring.outer{top:0;width:100%;height:100%;}
.brain-ring.mid{top:17%;width:66%;height:66%;}
/* ÂÜÖÂÅ¥„ÉØ„Éº„Éâ„ÇØ„É©„Ç¶„Éâ */
.brain-core{position:absolute;top:30%;left:50%;transform:translateX(-50%);width:38%;height:38%;border-radius:50%;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:2px 4px;padding:14px 10px;overflow:hidden;}
/* „Çπ„Ç≠„É£„É≥„É™„É≥„Ç∞ */
.brain-scan{position:absolute;border-radius:50%;border:1.5px solid transparent;pointer-events:none;left:50%;transform:translateX(-50%);}
.brain-scan.s1{top:0;width:100%;height:100%;border-top-color:rgba(74,170,255,0.15);animation:bspin 6s linear infinite;}
.brain-scan.s2{top:17%;width:66%;height:66%;border-right-color:rgba(74,234,170,0.12);animation:bspin 8s linear infinite reverse;}
/* Â§ñÂÅ¥„ÉØ„Éº„Éâ */
.bw-outer{position:absolute;font-family:var(--fn);font-size:9px;letter-spacing:0.3px;white-space:nowrap;opacity:0;animation:bfade .6s ease forwards;cursor:default;transition:transform .2s,text-shadow .2s;transform:translate(-50%,-50%);}
.bw-outer:hover{transform:translate(-50%,-50%) scale(1.15);text-shadow:0 0 12px currentColor;z-index:10;}
/* ‰∏≠Èñì„ÉØ„Éº„Éâ */
.bw-mid{position:absolute;font-family:var(--fn);font-size:8.5px;white-space:nowrap;opacity:0;animation:bfade .6s ease forwards;cursor:default;transition:transform .2s;transform:translate(-50%,-50%);}
.bw-mid:hover{transform:translate(-50%,-50%) scale(1.15);text-shadow:0 0 10px currentColor;z-index:10;}
/* ÂÜÖÂÅ¥„ÉØ„Éº„Éâ */
.bw-inner{display:inline-block;padding:1px 3px;font-weight:700;white-space:nowrap;opacity:0;animation:bpop .4s ease forwards;cursor:default;transition:transform .2s;}
.bw-inner:hover{transform:scale(1.25);text-shadow:0 0 8px currentColor;}
.bw-inner.xl{font-size:13px;}.bw-inner.lg{font-size:10px;}.bw-inner.md{font-size:8px;}.bw-inner.sm{font-size:7px;opacity:.6;}
/* Ëâ≤Ôºà„Éç„Ç™„É≥Áô∫ÂÖâÔºâ */
.bw-greed{color:#4aeaaa;text-shadow:0 0 4px rgba(74,234,170,0.3);}.bw-fear{color:#ff6b7a;text-shadow:0 0 4px rgba(255,107,122,0.3);}
.bw-hype{color:#ff9f43;text-shadow:0 0 4px rgba(255,159,67,0.3);}.bw-buzz{color:#a78bfa;text-shadow:0 0 4px rgba(167,139,250,0.3);}
.bw-calm{color:#4a9eff;text-shadow:0 0 4px rgba(74,158,255,0.3);}.bw-bull{color:#4aeaaa;text-shadow:0 0 4px rgba(74,234,170,0.3);}
.bw-bear{color:#ff6b7a;text-shadow:0 0 4px rgba(255,107,122,0.3);}.bw-note{color:#6b9fff;text-shadow:0 0 4px rgba(107,159,255,0.3);}
.bw-risk{color:#ff6b7a;}.bw-tail{color:#4aeaaa;}.bw-event{color:#ffb347;}.bw-data{color:#6b9fff;}
/* Âá°‰æã */
.brain-legend{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-top:10px;position:relative;z-index:1;}
.brain-leg-card{padding:6px 10px;background:rgba(255,255,255,0.015);border:1px solid rgba(255,255,255,0.07);border-radius:6px;}
.brain-leg-title{font-family:var(--fn);font-size:7px;letter-spacing:1.5px;opacity:0.4;margin-bottom:3px;font-weight:600;}
.brain-leg-items{display:flex;gap:6px;}
.brain-leg-item{display:flex;align-items:center;gap:3px;font-size:8.5px;color:#556;}
.brain-leg-dot{width:5px;height:5px;border-radius:1px;}
.brain-date{text-align:center;font-size:7.5px;color:#334;margin-top:6px;letter-spacing:1px;position:relative;z-index:1;}
@keyframes bspin{to{transform:translateX(-50%) rotate(360deg);}}
@keyframes bfade{from{opacity:0;transform:translate(-50%,-50%) scale(.7);}to{opacity:.85;transform:translate(-50%,-50%) scale(1);}}
@keyframes bpop{from{opacity:0;transform:scale(.4);}to{opacity:1;transform:scale(1);}}

/* ‚îÄ‚îÄ CHART & DETAIL EXPAND ‚îÄ‚îÄ */
.t5-spark{width:100px;height:36px;flex-shrink:0;}
.t5-expand{background:var(--bg3);padding:18px;border-top:1px solid var(--border);border-left:4px solid var(--orange);animation:fi .25s ease;}
.d-grid{display:grid;grid-template-columns:1fr;gap:14px;}
@media(min-width:640px){.d-grid{grid-template-columns:1fr 1fr;}}
.d-sec-ttl{font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px;display:flex;align-items:center;gap:5px;}
.d-chart-box{background:var(--bg3);border-radius:8px;padding:10px 8px 6px;border:1px solid var(--border);overflow:hidden;}
.d-chart-svg{width:100%;height:auto;display:block;overflow:hidden;aspect-ratio:400/160;}
.d-ma{display:flex;flex-direction:column;gap:5px;margin-top:14px;padding:10px;background:var(--bg2);border-radius:8px;border:1px solid var(--border);}
.d-ma-row{display:flex;align-items:center;gap:6px;font-size:11px;margin-top:4px;}
.d-ma-lbl{min-width:90px;color:var(--text);font-weight:500;font-size:10px;}
.d-ma-bar{flex:1;height:16px;background:var(--border);border-radius:3px;position:relative;overflow:hidden;}
.d-ma-ctr{position:absolute;left:50%;top:0;bottom:0;width:1px;background:var(--text3);opacity:0.3;}
.d-ma-dot{position:absolute;top:50%;transform:translate(-50%,-50%);width:8px;height:8px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);}
.d-ma-val{min-width:48px;text-align:right;font-family:var(--fn);font-size:11px;font-weight:700;}
.d-ma-val.up{color:var(--dn);}.d-ma-val.dn{color:var(--up);}
.d-ma-tag{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:3px;}
.d-ma-tag.near{background:rgba(148,101,0,0.15);color:var(--amber);}
.d-cards{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px;}
.d-card{text-align:center;padding:12px 6px;background:var(--bg2);border-radius:8px;border:1px solid var(--border);}
.d-card b{font-family:var(--fn);font-size:16px;font-weight:800;display:block;color:var(--text2);}
.d-card small{font-size:9px;color:var(--text3);}
.d-signal{background:rgba(232,84,30,0.06);border-radius:8px;padding:12px;margin-top:10px;border:1px solid rgba(232,84,30,0.15);}
.d-signal b{font-size:10px;font-weight:700;color:var(--orange);display:block;margin-bottom:4px;}
.d-signal p{font-size:11px;color:var(--text);line-height:1.7;margin:0;}
.d-btns{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap;}
.d-btn{padding:6px 14px;border-radius:8px;font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--bg2);color:var(--text2);cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;text-decoration:none;}
.d-btn:hover{border-color:var(--orange);color:var(--orange);}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.fadein{animation:fi 0.3s ease;}
@keyframes fi{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}
.disclaimer{font-size:10px;color:var(--text3);text-align:center;padding:12px 0;line-height:1.8;}
.sec-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:14px;}
.empty-msg{text-align:center;padding:20px;font-size:12px;color:var(--text3);}

/* ‚ïê‚ïê MARKET COMMENT (A) ‚ïê‚ïê */
.mkt-card{background:linear-gradient(145deg,#141e2e 0%,#1a2540 100%);border:1px solid rgba(80,120,200,0.12);border-radius:var(--r);overflow:hidden;margin-bottom:14px;box-shadow:0 4px 20px rgba(0,0,0,0.15);}
.mkt-header{display:flex;align-items:center;gap:10px;padding:14px 16px 10px;}
.mkt-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#4a90d9,#7c5cbf);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;box-shadow:0 2px 8px rgba(74,144,217,0.3);}
.mkt-who{font-size:12px;font-weight:900;color:#e0e6f0;}
.mkt-when{font-size:9px;color:rgba(160,180,210,0.4);font-family:var(--fn);}
.mkt-body{padding:0 16px 14px;}
.mkt-comment{font-size:12.5px;line-height:1.75;color:#c0cce0;}
.mkt-comment strong{color:#e8ecf4;}
.mkt-tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:10px;}
.mkt-tag{font-size:9px;font-weight:700;padding:3px 8px;border-radius:20px;}
.mkt-tag.bullish{background:rgba(74,234,170,0.12);color:#4aeaaa;}
.mkt-tag.bearish{background:rgba(255,107,122,0.12);color:#ff7a85;}
.mkt-tag.hot{background:rgba(255,159,67,0.12);color:#ff9f43;}
.mkt-tag.neutral{background:rgba(150,180,220,0.1);color:#a0b4d8;}
.mkt-sources{display:flex;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid rgba(100,150,255,0.06);}
.mkt-src{font-size:9px;color:rgba(140,165,210,0.35);display:flex;align-items:center;gap:3px;}

/* ‚ïê‚ïê RANKING TABLE (B) ‚ïê‚ïê */
.rank-card{background:linear-gradient(145deg,#141e2e 0%,#1a2540 100%);border:1px solid rgba(80,120,200,0.12);border-radius:var(--r);overflow:hidden;margin-bottom:14px;box-shadow:0 4px 20px rgba(0,0,0,0.15);}
.rank-header{background:linear-gradient(135deg,#1e3a5f 0%,#2a1f4e 100%);padding:12px 16px;text-align:center;border-bottom:1px solid rgba(100,150,255,0.1);}
.rank-header-title{font-size:15px;font-weight:900;color:#e8ecf4;letter-spacing:1px;}
.rank-header-sub{font-size:9px;color:rgba(180,200,230,0.4);margin-top:2px;font-family:var(--fn);}
.rank-grid{display:grid;grid-template-columns:1fr 1fr;}
.rank-col{display:flex;flex-direction:column;}
.rank-col+.rank-col{border-left:1px solid rgba(100,150,255,0.06);}
.rank-row{border-bottom:1px solid rgba(100,150,255,0.05);cursor:pointer;transition:background 0.15s;}
.rank-row:hover{background:rgba(100,150,255,0.04);}
.rank-row:last-child{border-bottom:none;}
.rank-row.active{background:rgba(74,144,217,0.08);}
.rank-row-main{display:flex;align-items:center;padding:7px 10px;gap:5px;}
.rank-name{flex:1;font-size:11px;font-weight:700;color:#c8d4e4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.has-comment .rank-name::after{content:' üí¨';font-size:7px;opacity:0.5;}
.rank-chg{font-family:var(--fn);font-size:11px;font-weight:500;padding:2px 6px;border-radius:4px;min-width:50px;text-align:center;}
.rank-chg.r-up{background:rgba(42,157,106,0.2);color:#4aeaaa;}
.rank-chg.r-dn{background:rgba(255,90,100,0.15);color:#ff7a85;}
.rank-chg.r-flat{background:rgba(150,150,150,0.1);color:rgba(180,200,230,0.4);}
.rank-chg.r-big-up{background:rgba(42,157,106,0.35);color:#4aeaaa;font-weight:700;}
.rank-chg.r-big-dn{background:rgba(255,90,100,0.3);color:#ff7a85;font-weight:700;}
.rank-cap{font-family:var(--fn);font-size:9px;color:rgba(150,175,210,0.3);min-width:34px;text-align:right;}
.rank-footer{padding:8px 12px;text-align:center;font-size:9px;color:rgba(150,175,210,0.25);border-top:1px solid rgba(100,150,255,0.06);font-family:var(--fn);}

/* ‚ïê‚ïê DETAIL PANEL (C) ‚ïê‚ïê */
.detail-panel{display:none;background:linear-gradient(145deg,#141e2e 0%,#1a2540 100%);border:1px solid rgba(100,150,255,0.15);border-radius:var(--r);overflow:hidden;margin-bottom:14px;box-shadow:0 4px 24px rgba(0,0,0,0.2);animation:rankSlide 0.25s ease;}
.detail-panel.show{display:block;}
@keyframes rankSlide{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:none;}}
.detail-top{padding:14px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(100,150,255,0.08);}
.detail-close{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,0.06);border:none;color:rgba(180,200,230,0.5);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.15s;}
.detail-close:hover{background:rgba(255,255,255,0.1);}
.detail-info{flex:1;}
.detail-name{font-size:15px;font-weight:900;color:#e8ecf4;}
.detail-meta{font-size:10px;color:rgba(160,180,210,0.4);font-family:var(--fn);margin-top:1px;}
.detail-chg-big{font-family:var(--fn);font-size:18px;font-weight:700;padding:4px 12px;border-radius:6px;flex-shrink:0;}
.detail-chg-big.r-up{background:rgba(42,157,106,0.25);color:#4aeaaa;}
.detail-chg-big.r-dn{background:rgba(255,90,100,0.2);color:#ff7a85;}
.detail-stats{display:grid;grid-template-columns:repeat(4,1fr);border-bottom:1px solid rgba(100,150,255,0.06);}
.detail-stat{text-align:center;padding:10px 4px;border-right:1px solid rgba(100,150,255,0.05);}
.detail-stat:last-child{border-right:none;}
.detail-stat-val{font-family:var(--fn);font-size:13px;font-weight:700;color:#d0daf0;}
.detail-stat-label{font-size:8px;color:rgba(150,175,210,0.4);margin-top:2px;font-weight:700;}
.detail-cmt{padding:14px 16px;}
.detail-cmt-head{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.detail-cmt-avatar{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,#4a90d9,#7c5cbf);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.detail-cmt-label{font-size:11px;font-weight:800;color:rgba(180,200,230,0.6);}
.detail-cmt-body{font-size:12px;line-height:1.75;color:#b0c4e0;background:rgba(74,144,217,0.05);border-radius:10px;padding:12px 14px;border:1px solid rgba(74,144,217,0.08);}
.detail-cmt-body strong{color:#d0e0f4;}
.detail-cmt-sources{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;}
.src-tag{font-size:8px;font-weight:700;padding:2px 7px;border-radius:10px;}
.src-tag.yt{background:rgba(255,0,0,0.12);color:#ff6b6b;}
.src-tag.news{background:rgba(100,180,255,0.1);color:#7ab8f0;}
.src-tag.tech{background:rgba(255,200,50,0.1);color:#ddb840;}
.src-tag.score{background:rgba(74,234,170,0.1);color:#4aeaaa;}

/* ‚îÄ‚îÄ LOGIC MODAL ‚îÄ‚îÄ */
.logic-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.4);display:none;align-items:flex-end;justify-content:center;}
.logic-overlay.open{display:flex;}
.logic-box{background:var(--bg2);border-radius:16px 16px 0 0;padding:20px;width:100%;max-width:600px;max-height:80vh;overflow-y:auto;}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.logic-title{font-family:var(--fh);font-size:15px;font-weight:800;color:var(--text2);margin-bottom:6px;}
.logic-sub{font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.7;}
.logic-tbl{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:14px;}
.logic-tbl th{background:var(--bg3);padding:7px 10px;text-align:left;font-family:var(--fh);font-size:10px;color:var(--text3);border-bottom:1px solid var(--border);}
.logic-tbl td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text);}
.logic-tbl .pts{text-align:right;font-family:var(--fn);font-weight:700;}
.logic-note{background:var(--bg3);border-radius:var(--r2);padding:12px;font-size:11px;color:var(--text);line-height:1.9;margin-bottom:14px;}
.btn-logic-close{width:100%;padding:10px;background:var(--navy);color:#fff;border:none;border-radius:var(--r);font-family:var(--fh);font-size:13px;font-weight:700;cursor:pointer;}

@media(max-width:600px){
  .stock-table th:nth-child(n+7),.stock-table td:nth-child(n+7){display:none;}
}
@media(max-width:480px){
  .stock-table th:nth-child(n+6),.stock-table td:nth-child(n+6){display:none;}
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ROBINHOOD DARK THEME OVERRIDES
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
html{font-size:15px;background:#000}
body{background:#000;color:#e0e0e0}

/* ‚îÄ‚îÄ Topbar ‚îÄ‚îÄ */
.topbar{background:rgba(0,0,0,0.88);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.05)}
.logo-name{color:#fff}
.logo-tag{color:#555;font-size:9px}
.btn-topbar{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.15);color:#ccc}
.btn-topbar:hover{background:rgba(255,255,255,0.16)}

/* ‚îÄ‚îÄ Hero ‚îÄ‚îÄ */
.hero{background:#181818;border:1px solid rgba(255,255,255,0.07);border-radius:14px;margin:8px 12px}
.hero-eyebrow{color:#555}
.hero-dot{background:var(--green);box-shadow:0 0 6px var(--green)}
.hero-title{color:#fff}
.hero-title span{color:var(--green)}
.hero-stat{background:rgba(255,255,255,0.02);border-radius:10px}
.hero-stat-val{color:#fff;font-family:var(--fn)}
.hero-stat-val.buy{color:var(--green)}
.hero-stat-label{color:#555}

/* ‚îÄ‚îÄ Trust Bar ‚îÄ‚îÄ */
.trust-bar{background:#181818;border:1px solid rgba(255,255,255,0.07);border-radius:14px;margin:8px 12px}
.trust-text{color:#888}
.tbadge{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.12);color:#aaa}
.tbadge.link{color:var(--green)}

/* ‚îÄ‚îÄ Pulse ‚îÄ‚îÄ */
.pulse{background:transparent;padding:8px 12px;margin:0}
.pulse-row{gap:6px;display:flex}
.pulse-item{background:#181818!important;border:1px solid rgba(255,255,255,0.07)!important;border-radius:12px!important;color:#fff}
.pulse-item .p-label,.pulse-item .label{color:#555!important;font-size:8px!important}
.pulse-item .p-val,.pulse-item .val{font-family:var(--fn)!important;color:#fff!important;font-weight:800!important}

/* ‚îÄ‚îÄ Stance ‚îÄ‚îÄ */
.stance-card,.stance-box{background:#181818;border:1px solid rgba(255,255,255,0.07);border-radius:14px}

/* ‚îÄ‚îÄ Brain Scanner ‚îÄ‚îÄ */
.brain-wrap{background:#181818!important;border:1px solid rgba(255,255,255,0.07)!important;border-radius:16px!important;margin:8px 12px}
.brain-wrap::before{background:radial-gradient(ellipse at 50% 45%,rgba(0,220,130,0.015) 0%,transparent 55%),none!important}
.brain-title{color:#555!important;font-size:10px!important;letter-spacing:2px!important}
.brain-sub{color:#444!important}
.brain-guide{border-color:rgba(255,255,255,0.04)!important}
.brain-guide.inner{border-color:rgba(0,220,130,0.06)!important;background:radial-gradient(circle,rgba(0,220,130,0.025) 0%,transparent 70%)!important}
.brain-scan.s1{border-top-color:rgba(0,220,130,0.12)!important}
.brain-scan.s2{border-right-color:rgba(0,220,130,0.08)!important}
.brain-tag{color:#333!important}
.brain-leg-card{background:rgba(255,255,255,0.02)!important;border-color:rgba(255,255,255,0.04)!important}
.brain-leg-title{opacity:0.5}
.brain-leg-item{color:#555!important}
.brain-date{color:#333!important}
.bw-outer,.bw-mid,.bw-inner{text-shadow:0 2px 12px rgba(0,0,0,0.9)!important}
.bw-greed,.bw-bull{color:var(--green)!important}
.bw-fear,.bw-bear,.bw-risk{color:var(--dn)!important}
.bw-hype,.bw-buzz,.bw-event{color:var(--amber)!important}
.bw-calm,.bw-data,.bw-tail,.bw-note{color:#888!important}
.brain-core{background:none!important}

/* ‚îÄ‚îÄ AI Commentary Card ‚îÄ‚îÄ */
.mkt-card{background:#181818!important;border:1px solid rgba(255,255,255,0.07)!important;border-radius:16px!important;margin:8px 12px!important;position:relative;overflow:hidden}
.mkt-card::after{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,220,130,0.15),transparent)}
.mkt-avatar{font-size:20px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:rgba(0,220,130,0.08);border-radius:12px;border:1px solid rgba(0,220,130,0.15)}
.mkt-who{color:#fff!important;font-weight:700!important}
.mkt-when{color:#444!important;font-family:var(--fn)!important}
.mkt-comment{color:#999!important;line-height:1.85!important}
.mkt-comment strong{color:#fff!important}
.mkt-tag{border-radius:8px!important}
.mkt-tag.bull,.mkt-tag.bullish{background:rgba(0,220,130,0.08)!important;color:var(--green)!important;border-color:rgba(0,220,130,0.12)!important}
.mkt-tag.bear,.mkt-tag.bearish{background:rgba(255,77,77,0.08)!important;color:var(--dn)!important;border-color:rgba(255,77,77,0.12)!important}
.mkt-source{color:#555!important}

/* ‚îÄ‚îÄ Ranking ‚îÄ‚îÄ */
.rank-card{background:#181818!important;border:1px solid rgba(255,255,255,0.07)!important;border-radius:16px!important;margin:8px 12px!important}
.rank-header-title{color:#fff!important;font-weight:800!important}
.rank-header-sub{color:#444!important}
.rank-row{border-bottom-color:rgba(255,255,255,0.03)!important}
.rank-name{color:#999!important;font-weight:600!important}
.rank-chg{font-family:var(--fn)!important;font-weight:700!important}
.rank-chg.up{color:var(--green)!important}
.rank-chg.dn{color:var(--dn)!important}
.rank-footer{border-top-color:rgba(255,255,255,0.04)!important;color:#444!important}

/* ‚îÄ‚îÄ Detail Panel ‚îÄ‚îÄ */
.detail-panel{background:#181818;border:1px solid rgba(255,255,255,0.07);border-radius:16px;margin:8px 12px}
.detail-name{color:#fff!important}
.detail-close{color:#555!important}
.detail-section-title{color:#555!important}
.detail-chg-big.up{color:var(--green)!important}
.detail-chg-big.dn{color:var(--dn)!important}
.detail-box{background:rgba(255,255,255,0.02)!important;border-color:rgba(255,255,255,0.04)!important;border-radius:10px!important}
.detail-cmt{background:rgba(0,220,130,0.04)!important;border:1px solid rgba(0,220,130,0.08)!important;border-radius:12px!important}
.detail-cmt-body{color:#999!important}
.detail-fav-btn{border-color:rgba(255,255,255,0.15)!important;color:#aaa!important}
.detail-fav-btn.active{border-color:rgba(0,220,130,0.3)!important;color:var(--green)!important;background:rgba(0,220,130,0.08)!important}
.d-btn{background:rgba(255,255,255,0.08)!important;border-color:rgba(255,255,255,0.12)!important;color:var(--green)!important;border-radius:8px!important}
.d-card{background:rgba(255,255,255,0.02)!important;border-color:rgba(255,255,255,0.04)!important;border-radius:10px!important}
.d-card label{color:#999!important}
.d-card .val,.d-card .value{color:#fff!important}
.d-sec-ttl{color:#555!important}
.d-signal{border-radius:8px!important}
.d-ma-row{border-bottom-color:rgba(255,255,255,0.03)!important}
.d-ma-lbl{color:#888!important}
.d-ma-val{color:#fff!important;font-family:var(--fn)!important}
.d-ma-tag{border-radius:6px!important}
.d-chart-box{background:rgba(255,255,255,0.02)!important;border-radius:10px!important}

/* ‚îÄ‚îÄ 3 Tabs ‚îÄ‚îÄ */
.t5-tabs{background:#0f0f0f;border-radius:12px;margin:8px 12px;padding:3px;display:flex;gap:0;border:1px solid rgba(255,255,255,0.08)}
.t5-tab{background:transparent!important;color:#888!important;border-radius:10px!important;font-weight:700!important}
.t5-tab.active{background:#1a1a1a!important;color:var(--green)!important;box-shadow:0 2px 8px rgba(0,0,0,0.4)!important}

/* ‚îÄ‚îÄ Tab Content Cards ‚îÄ‚îÄ */
#top5Body{margin:0 12px}
.top10-card,.sec-card{background:#181818!important;border:1px solid rgba(255,255,255,0.07)!important;border-radius:14px!important}
.top10-name{color:#fff!important}
.top10-score{font-family:var(--fn)!important}
.top10-score.hi{color:var(--green)!important}
.top10-meta{color:#555!important}
.sec-back-btn{color:var(--green)!important}

/* ‚îÄ‚îÄ Sector Section ‚îÄ‚îÄ */
.sec-wrap{background:#181818!important;border:1px solid rgba(255,255,255,0.07)!important;border-radius:16px!important;margin:8px 12px!important}
.sec-head-title{color:#fff!important;font-weight:800!important}
.sec-head-sub{color:#444!important}

/* ‚îÄ‚îÄ Portfolio/Diary ‚îÄ‚îÄ */
.pf-hero{background:rgba(0,220,130,0.04)!important;border-radius:12px!important}
.pf-total{color:#fff!important;font-family:var(--fn)!important}
.pf-chg.up{color:var(--green)!important}
.pf-chg.dn{color:var(--dn)!important}
.pf-stat{background:rgba(255,255,255,0.02)!important;border-radius:8px!important}
.pf-stat-val{color:#fff!important;font-family:var(--fn)!important}
.pf-stat-label{color:#555!important}
.pf-stock{border-bottom-color:rgba(255,255,255,0.03)!important}
.pf-stock-name{color:#fff!important}
.pf-stock-chg.up{color:var(--green)!important}
.pf-stock-chg.dn{color:var(--dn)!important}
.pf-note-link{color:var(--green)!important;background:rgba(0,220,130,0.1)!important;border-radius:8px!important}
.pf-note-link:hover{background:rgba(0,220,130,0.15)!important}

/* ‚îÄ‚îÄ Score badge colors ‚îÄ‚îÄ */
.zone-badge.buy{background:rgba(0,220,130,0.1)!important;color:var(--green)!important;border:1px solid rgba(0,220,130,0.2)!important}
.zone-badge.watch{background:rgba(255,170,0,0.1)!important;color:var(--amber)!important;border:1px solid rgba(255,170,0,0.2)!important}
.zone-badge.hold{background:rgba(255,255,255,0.04)!important;color:#888!important;border:1px solid rgba(255,255,255,0.08)!important}

/* ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ */
.bottom-nav{background:rgba(0,0,0,0.92)!important;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,0.05)!important}
.bottom-nav .nav-item{color:#555!important}
.bottom-nav .nav-item.active{color:var(--green)!important}

/* ‚îÄ‚îÄ Settings / Logic Modal ‚îÄ‚îÄ */
.settings-panel{background:#181818!important;border-color:rgba(255,255,255,0.04)!important}
.settings-panel h2,.settings-panel h3{color:#fff!important}
.settings-panel label{color:#888!important}
.logic-overlay{background:rgba(0,0,0,0.85)!important}
.logic-modal{background:#181818!important;border:1px solid rgba(255,255,255,0.06)!important;border-radius:16px!important;color:#999!important}
.logic-modal h2{color:#fff!important}
.logic-title{color:var(--green)!important}
.btn-logic-close{background:rgba(255,255,255,0.06)!important;color:#fff!important;border-radius:10px!important}

/* ‚îÄ‚îÄ Watch Panel ‚îÄ‚îÄ */
.watch-empty{color:#555!important}
.watch-card{background:#181818!important;border:1px solid rgba(255,255,255,0.07)!important;border-radius:14px!important}
.watch-name{color:#fff!important}
.watch-score{font-family:var(--fn)!important}
.watch-meta{color:#555!important}

/* ‚îÄ‚îÄ Disclaimer ‚îÄ‚îÄ */
.disclaimer{color:#333!important;border:none!important;background:transparent!important}

/* ‚îÄ‚îÄ Kokusaku Badge ‚îÄ‚îÄ */
.kok-badge{background:rgba(0,220,130,0.08)!important;color:var(--green)!important;border:1px solid rgba(0,220,130,0.15)!important;border-radius:6px!important}

/* ‚îÄ‚îÄ Skeleton ‚îÄ‚îÄ */
.skeleton,.skel-row{background:rgba(255,255,255,0.04)!important}

/* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:2px}

/* ‚îÄ‚îÄ Axis/Score bars ‚îÄ‚îÄ */
.axis-bar{background:rgba(255,255,255,0.04)!important;border-radius:4px!important;overflow:hidden}
.axis-seg{border-radius:0!important}
.axis-name{color:#888!important}
.axis-score{color:#555!important}
.axis-total{color:#fff!important}

/* ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ */
.filter-btn{background:rgba(255,255,255,0.08)!important;border-color:rgba(255,255,255,0.12)!important;color:#aaa!important;border-radius:8px!important}
.filter-btn.active{background:rgba(0,220,130,0.12)!important;border-color:rgba(0,220,130,0.25)!important;color:var(--green)!important}

/* ‚îÄ‚îÄ Global accent override ‚îÄ‚îÄ */
a{color:var(--green)}
::selection{background:rgba(0,220,130,0.2);color:#fff}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-inner">
    <div>
      <span class="logo-name">„Åã„Å∂„ÅÆ„Åô„Åë<span style="color:var(--orange)">Navi</span></span>
      <span class="logo-tag" id="lastUpdate">üì° Êõ¥Êñ∞Á¢∫Ë™ç‰∏≠...</span>
    </div>
    <div class="topbar-right">
      <button class="btn-topbar" onclick="switchTab('watch')">
        ‚≠ê „Ç¶„Ç©„ÉÉ„ÉÅ <span class="watch-count" id="watchCount">0</span>
      </button>
      <button class="btn-topbar" onclick="openSettings()">‚öô Ë®≠ÂÆö</button>
    </div>
  </div>
</div>

<div class="page">

  <!-- ‚ïê‚ïê HOME PANEL ‚ïê‚ïê -->
  <div class="panel active" id="panel-home">

    <!-- MARKET PULSE -->
    <div class="pulse"><div class="pulse-row" id="pulseBar"></div></div>

    <!-- ü§ñ AI„Ç≥„É°„É≥„Éà + È®∞ËêΩ„É©„É≥„Ç≠„É≥„Ç∞ -->
    <div class="mkt-card" id="mktCommentSection" style="display:none">
      <div class="mkt-header">
        <div class="mkt-avatar">ü§ñ</div>
        <div>
          <div class="mkt-who">„Åã„Å∂„ÅÆ„Åô„ÅëÔºàAIÔºâ„ÅÆ‰ªäÊó•„ÅÆË¶ãÁ´ã„Å¶</div>
          <div class="mkt-when" id="mktCommentDate"></div>
        </div>
      </div>
      <div class="mkt-body">
        <div class="mkt-comment" id="mktCommentBody"></div>
        <div class="mkt-tags" id="mktCommentTags"></div>
        <div class="mkt-sources" id="mktCommentSources"></div>
      </div>
    </div>

    <!-- üì° BRAIN SCANNER 3Â±§ÂêåÂøÉÂÜÜ -->
    <div class="brain-wrap" id="brainSection" style="display:none">
      <div class="brain-head">
        <div class="brain-title">ÊäïË≥áÂÆ∂„ÅÆË©±È°å„Éû„ÉÉ„Éó</div>
        <div class="brain-sub">YouTube„ÇÑSNS„Åß‰ªäÊó•Ë©±È°å„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ</div>
      </div>
      <div id="brainBody"></div>
      <div class="brain-legend">
        <div class="brain-leg-card">
          <div class="brain-leg-title" style="color:#4af">„Éû„ÇØ„É≠ÔºàÂ§ñÂÅ¥Ôºâ</div>
          <div class="brain-leg-items">
            <div class="brain-leg-item"><div class="brain-leg-dot" style="background:#4aeaaa"></div>ËøΩ„ÅÑÈ¢®</div>
            <div class="brain-leg-item"><div class="brain-leg-dot" style="background:#ff6b7a"></div>„É™„Çπ„ÇØ</div>
            <div class="brain-leg-item"><div class="brain-leg-dot" style="background:#ffb347"></div>Ê≥®ÁõÆ</div>
          </div>
        </div>
        <div class="brain-leg-card">
          <div class="brain-leg-title" style="color:#4aeaaa">Ê©üÈñ¢Ôºà‰∏≠ÈñìÔºâ</div>
          <div class="brain-leg-items">
            <div class="brain-leg-item"><div class="brain-leg-dot" style="background:#4aeaaa"></div>Ë≤∑„ÅÑ</div>
            <div class="brain-leg-item"><div class="brain-leg-dot" style="background:#ff6b7a"></div>Â£≤„Çä</div>
            <div class="brain-leg-item"><div class="brain-leg-dot" style="background:#6b9fff"></div>ÂàÜÊûê</div>
          </div>
        </div>
        <div class="brain-leg-card">
          <div class="brain-leg-title" style="color:#a78bfa">ÂÄã‰∫∫ÔºàÂÜÖÂÅ¥Ôºâ</div>
          <div class="brain-leg-items">
            <div class="brain-leg-item"><div class="brain-leg-dot" style="background:#4aeaaa"></div>Âº∑Ê∞ó</div>
            <div class="brain-leg-item"><div class="brain-leg-dot" style="background:#ff6b7a"></div>‰∏çÂÆâ</div>
            <div class="brain-leg-item"><div class="brain-leg-dot" style="background:#ff9f43"></div>ÈÅéÁÜ±</div>
          </div>
        </div>
      </div>
    </div>

    <div class="rank-card" id="rankSection" style="display:none">
      <div class="rank-header">
        <div><span style="margin-right:6px">üáØüáµ</span><span class="rank-header-title">ÊôÇ‰æ°Á∑èÈ°çTOP30„ÅÆÈ®∞ËêΩ</span></div>
        <div class="rank-header-sub"><span id="rankDate"></span>ÂâçÊó•ÊØî „Éª „Çø„ÉÉ„Éó„ÅßË©≥Á¥∞</div>
      </div>
      <div class="rank-grid" id="rankGrid"></div>
      <div class="rank-footer" id="rankFooter"></div>
    </div>

    <div class="detail-panel" id="detailPanel"></div>

    <!-- HERO -->
    <div class="hero">
      <div class="hero-eyebrow" id="heroEyebrow">
        <span class="hero-dot"></span>AI √ó È´òÈÖçÂΩì √ó Ââ≤ÂÆâ ‚Äî ÊØéÊúù8:30Ëá™ÂãïÊõ¥Êñ∞
      </div>
      <div class="hero-top">
        <div class="hero-left">
          <div class="hero-title">‰ªäÊó•„ÅÆ<span>Êäº„ÅóÁõÆÂÄôË£ú</span>„ÇíÂç≥Ë°®Á§∫</div>
        </div>
      </div>
      <div class="hero-stats" id="heroStats">
        <div class="hero-stat"><div class="hero-stat-val buy" id="hsBuy">‚Äî</div><div class="hero-stat-label">Ë≤∑„ÅÑÂúè„ÅÆÈäòÊüÑÊï∞</div></div>
        <div class="hero-stat"><div class="hero-stat-val" id="hsTop">‚Äî</div><div class="hero-stat-label">Êú¨Êó•1‰Ωç„Çπ„Ç≥„Ç¢</div></div>
        <div class="hero-stat"><div class="hero-stat-val" id="hsDiv">‚Äî</div><div class="hero-stat-label">ÊúÄÈ´òÈÖçÂΩìÂà©Âõû„Çä</div></div>
        <div class="hero-stat"><div class="hero-stat-val" id="hsTotal">‚Äî</div><div class="hero-stat-label">„Çπ„Ç≠„É£„É≥ÈäòÊüÑÊï∞</div></div>
      </div>
    </div>

    <!-- TRUST BAR -->
    <div class="trust-bar" id="trustBanner">
      <div class="trust-left">
        <div class="trust-dot" id="trustDot"></div>
        <div class="trust-text" id="trustText">„Éá„Éº„ÇøÁ¢∫Ë™ç‰∏≠...</div>
      </div>
      <div class="trust-badges">
        <span class="tbadge" id="totalCountBadge">Êù±Ë®º„Éó„É©„Ç§„É†</span>
        <span class="tbadge link" onclick="openLogicModal()">„Çπ„Ç≥„Ç¢Ë®àÁÆóÂºè ‚ñ∂</span>
      </div>
    </div>

    <!-- STANCE -->
    <div id="stanceBox"></div>

    <!-- 3 TABS -->
    <div class="t5-tabs">
      <div class="t5-tab active" id="t5TabSec" onclick="setTop5Tab('sector')">üìä „Çª„ÇØ„Çø„Éº</div>
      <div class="t5-tab" id="t5TabMom" onclick="setTop5Tab('mom')">üìà ‰∏äÊòá</div>
      <div class="t5-tab" id="t5TabDip" onclick="setTop5Tab('dip')">üìâ Ââ≤ÂÆâ</div>
    </div>

    <!-- TAB CONTENT -->
    <div id="top5Body">
      <div style="padding:20px;text-align:center">
        <div class="skel-row skeleton"></div>
        <div class="skel-row skeleton"></div>
        <div style="font-size:11px;color:var(--text3);margin-top:8px">„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...</div>
      </div>
    </div>

    <!-- üìä ÊäïË≥áÊó•Ë®ò -->
    <div class="sec-wrap" id="portfolioSection">
      <div class="sec-head">
        <div class="sec-head-title">üìä „Åã„Å∂„ÅÆ„Åô„ÅëÔºàAIÔºâ„ÅÆÊäïË≥áÊó•Ë®ò</div>
        <div class="sec-head-sub">AI √ó 1000‰∏áÂÜÜ Ôºè 2026.2.24„Çπ„Çø„Éº„Éà</div>
      </div>
      <div id="portfolioBody">
        <div style="padding:16px;text-align:center;font-size:11px;color:var(--text3)">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
      </div>
    </div>

    <!-- DISCLAIMER -->
    <div class="disclaimer">‚ö†Ô∏è Êú¨„ÉÑ„Éº„É´„ÅØÂèÇËÄÉÊÉÖÂ†±„ÅÆÊèê‰æõ„ÇíÁõÆÁöÑ„Å®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÆüÈöõ„ÅÆÊäïË≥áÂà§Êñ≠„ÅØ„ÅîËá™Ë∫´„ÅÆË≤¨‰ªª„ÅßË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊ†™ÂºèÊäïË≥á„Å´„ÅØÂÖÉÊú¨Ââ≤„Çå„ÅÆ„É™„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ</div>

  </div><!-- /panel-home -->

  <!-- ‚ïê‚ïê WATCH PANEL ‚ïê‚ïê -->
  <div class="panel" id="panel-watch">
    <div class="sec-wrap">
      <div class="sec-head">
        <div class="sec-head-title">‚≠ê „Ç¶„Ç©„ÉÉ„ÉÅ„É™„Çπ„Éà</div>
      </div>
      <div id="watchlistBody"></div>
    </div>
    <div class="sec-wrap">
      <div class="sec-head">
        <div class="sec-head-title">üïê „Çπ„Ç≠„É£„É≥Â±•Ê≠¥</div>
      </div>
      <div id="historyBody"></div>
    </div>
  </div>

</div><!-- /page -->

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" id="nav-home" onclick="switchTab('home')">
    <span class="nav-ico">üè†</span><span class="nav-label">„Éõ„Éº„É†</span>
  </button>
  <button class="nav-item" id="nav-watch" onclick="switchTab('watch')">
    <span class="nav-ico">‚≠ê</span><span class="nav-label">„Ç¶„Ç©„ÉÉ„ÉÅ</span>
  </button>
</nav>

<!-- SETTINGS PANEL -->
<div class="settings-overlay" id="settingsOverlay" onclick="closeSettingsBg(event)">
  <div class="settings-box">
    <div class="settings-handle"></div>
    <div class="settings-title">‚öô Ë°®Á§∫Ë®≠ÂÆö</div>
    <div class="setting-row">
      <div class="setting-label">„Çπ„Ç≠„É£„É≥„É¢„Éº„Éâ</div>
      <div class="setting-opts" id="set-mode">
        <div class="setting-opt active" data-val="dividend" onclick="selectSettingOpt(this,'mode')">üí∞ ÂÆâÂÆöÈ´òÈÖçÂΩì</div>
        <div class="setting-opt" data-val="value" onclick="selectSettingOpt(this,'mode')">üõ° Ââ≤ÂÆâ„Éê„É™„É•„Éº</div>
        <div class="setting-opt" data-val="rebound" onclick="selectSettingOpt(this,'mode')">‚ö° Âº∑Êäº„ÅóÁõÆ</div>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">Ë°®Á§∫‰ª∂Êï∞</div>
      <div class="setting-opts" id="set-count">
        <div class="setting-opt" data-val="10" onclick="selectSettingOpt(this,'count')">TOP 10</div>
        <div class="setting-opt active" data-val="30" onclick="selectSettingOpt(this,'count')">TOP 30</div>
        <div class="setting-opt" data-val="999" onclick="selectSettingOpt(this,'count')">ÂÖ®‰ª∂Ë°®Á§∫</div>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">ÊúÄ‰ΩéÈÖçÂΩìÂà©Âõû„Çä</div>
      <div class="setting-opts" id="set-mindiv">
        <div class="setting-opt active" data-val="0" onclick="selectSettingOpt(this,'mindiv')">Âà∂Èôê„Å™„Åó</div>
        <div class="setting-opt" data-val="2" onclick="selectSettingOpt(this,'mindiv')">2%‰ª•‰∏ä</div>
        <div class="setting-opt" data-val="3" onclick="selectSettingOpt(this,'mindiv')">3%‰ª•‰∏ä</div>
        <div class="setting-opt" data-val="4" onclick="selectSettingOpt(this,'mindiv')">4%‰ª•‰∏ä</div>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">„Çæ„Éº„É≥„Éï„Ç£„É´„Çø„Éº</div>
      <div class="setting-opts" id="set-zone">
        <div class="setting-opt active" data-val="all" onclick="selectSettingOpt(this,'zone')">ÂÖ®„Å¶</div>
        <div class="setting-opt" data-val="buy" onclick="selectSettingOpt(this,'zone')">Ë≤∑„ÅÑÂúè„ÅÆ„Åø</div>
        <div class="setting-opt" data-val="buywatch" onclick="selectSettingOpt(this,'zone')">Ë≤∑„ÅÑÂúèÔºãÊ≥®ÊÑèÂúè</div>
      </div>
    </div>
    <button class="settings-save" onclick="saveSettings()">‚úì ‰øùÂ≠ò„Åó„Å¶ÈÅ©Áî®</button>
  </div>
</div>

<!-- LOGIC MODAL -->
<div class="logic-overlay" id="logicModal" onclick="closeLogicModal(event)">
  <div class="logic-box">
    <div class="modal-handle"></div>
    <div class="logic-title">üìä „Çπ„Ç≥„Ç¢„É™„É≥„Ç∞„ÅÆËÄÉ„ÅàÊñπ</div>
    <div class="logic-sub">Ë§áÊï∞„ÅÆÊåáÊ®ô„ÇíAI„ÅåÁ∑èÂêàÁöÑ„Å´Âà§ÂÆö„Åó„ÄÅ100ÁÇπÊ∫ÄÁÇπ„Åß„Çπ„Ç≥„Ç¢„É™„É≥„Ç∞„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</div>
    <div class="logic-note">
      <b>5„Å§„ÅÆË©ï‰æ°Ëª∏</b><br>
      üí∞ ÈÖçÂΩìÂà©Âõû„Çä ‚Äî È´òÈÖçÂΩì„Åª„Å©Âä†ÁÇπ<br>
      üìâ ÁßªÂãïÂπ≥Âùá‰πñÈõ¢ ‚Äî Êäº„ÅóÁõÆ„ÅåÊ∑±„ÅÑ„Åª„Å©Âä†ÁÇπ<br>
      üìä RSI ‚Äî Â£≤„Çâ„Çå„Åô„ÅéÊ∞¥Ê∫ñ„ÅßÂä†ÁÇπ<br>
      üõ° PBR ‚Äî Ââ≤ÂÆâ„Åª„Å©Âä†ÁÇπ<br>
      üìà PER ‚Äî ÂèéÁõäÊÄß„Å´ÂØæ„Åó„Å¶Ââ≤ÂÆâ„Å™„ÇâÂä†ÁÇπ<br><br>
      <b>3„Å§„ÅÆ„Çπ„Ç≠„É£„É≥„É¢„Éº„Éâ</b><br>
      üí∞ ÂÆâÂÆöÈ´òÈÖçÂΩì ‚Üí ÈÖçÂΩìÈáçË¶ñ<br>
      üõ° Ââ≤ÂÆâ„Éê„É™„É•„Éº ‚Üí PBR„ÉªPERÈáçË¶ñ<br>
      ‚ö° Âº∑Êäº„ÅóÁõÆ ‚Üí „ÉÜ„ÇØ„Éã„Ç´„É´ÈáçË¶ñ<br><br>
      <span style="font-size:10px;color:var(--text3)">‚Äª Âá∫Êù•È´òÊÄ•È®∞ÈäòÊüÑ„ÇÑË∂ÖÂ∞èÂûãÊ†™„Å´„ÅØ„Éö„Éä„É´„ÉÜ„Ç£„ÇíÈÅ©Áî®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</span>
    </div>
    <button class="btn-logic-close" onclick="closeLogicModal()">Èñâ„Åò„Çã</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SAMPLE_STOCKS=[
  {code:'8306',name:'‰∏âËè±UFJ„Éï„Ç£„Éä„É≥„Ç∑„É£„É´',sector:'ÈäÄË°å',price:1423,ma25:1520,ma75:1580,rsi:32,dividend:3.8,pbr:0.7,per:9.2,vol_r:0.8},
  {code:'9432',name:'NTT',sector:'ÈÄö‰ø°',price:163,ma25:168,ma75:172,rsi:38,dividend:3.2,pbr:1.1,per:11.5,vol_r:0.9},
  {code:'8058',name:'‰∏âËè±ÂïÜ‰∫ã',sector:'ÂïÜÁ§æ',price:2890,ma25:3050,ma75:3200,rsi:29,dividend:4.1,pbr:0.9,per:8.7,vol_r:0.7},
  {code:'4502',name:'Ê≠¶Áî∞Ëñ¨ÂìÅÂ∑•Ê•≠',sector:'ÂåªËñ¨ÂìÅ',price:3820,ma25:3960,ma75:4050,rsi:41,dividend:5.6,pbr:1.3,per:15.2,vol_r:1.1},
  {code:'8001',name:'‰ºäËó§Âø†ÂïÜ‰∫ã',sector:'ÂïÜÁ§æ',price:6780,ma25:7050,ma75:7200,rsi:33,dividend:3.5,pbr:1.8,per:12.3,vol_r:0.6},
  {code:'7203',name:'„Éà„É®„ÇøËá™ÂãïËªä',sector:'Ëá™ÂãïËªä',price:2650,ma25:2720,ma75:2800,rsi:36,dividend:3.0,pbr:1.1,per:10.4,vol_r:0.9},
  {code:'8316',name:'‰∏â‰∫ï‰ΩèÂèãFG',sector:'ÈäÄË°å',price:7100,ma25:7600,ma75:7800,rsi:28,dividend:4.2,pbr:0.8,per:9.0,vol_r:0.7},
  {code:'2914',name:'JTÔºàÊó•Êú¨„Åü„Å∞„ÅìÁî£Ê•≠Ôºâ',sector:'È£üÂìÅ',price:3680,ma25:3780,ma75:3820,rsi:35,dividend:6.2,pbr:1.6,per:13.8,vol_r:0.8},
  {code:'8411',name:'„Åø„Åö„ÅªFG',sector:'ÈäÄË°å',price:2680,ma25:2850,ma75:2950,rsi:31,dividend:3.9,pbr:0.7,per:8.5,vol_r:0.8},
  {code:'9433',name:'KDDI',sector:'ÈÄö‰ø°',price:4350,ma25:4500,ma75:4600,rsi:37,dividend:3.3,pbr:1.9,per:13.5,vol_r:1.0},
  {code:'9503',name:'Èñ¢Ë•øÈõªÂäõ',sector:'ÈõªÂäõ',price:2140,ma25:2250,ma75:2300,rsi:33,dividend:3.5,pbr:0.9,per:10.1,vol_r:0.7},
  {code:'5108',name:'„Éñ„É™„ÉÇ„Çπ„Éà„É≥',sector:'„Ç¥„É†',price:5100,ma25:5280,ma75:5350,rsi:40,dividend:3.8,pbr:1.2,per:11.8,vol_r:0.8},
];

let STOCKS=[...SAMPLE_STOCKS];
let processed=[];
let dataSource='sample';
let currentMode='dividend';
let currentTab='sector'; // 'sector','mom','dip'
let activeSector=null;
let sectorScoresData={};
let sortKey='score'; let sortDir='desc';
let expandedCode=null;
let watchlist=[];
let scanHistory=[];
let settings={mode:'dividend',count:10,mindiv:0,zone:'all'};
let trendRankingData=[];
let portfolioData=null;
let marketData={
  nikkei_price:null,nikkei_ma25:null,nikkei_1d_chg:null,
  nasdaq_1d_chg:null,vix:null,usdjpy:null,us10y:null,
  geo_risk:false,rate_cut_flag:false,prev_buy_count:null,
};

// ‚îÄ localStorage„Åã„ÇâÂæ©ÂÖÉ ‚îÄ
try{
  const sw=localStorage.getItem('kbs_watch');
  if(sw)watchlist=JSON.parse(sw);
  const sh=localStorage.getItem('kbs_history');
  if(sh)scanHistory=JSON.parse(sh);
  const ss=localStorage.getItem('kbs_settings');
  if(ss){
    settings=Object.assign(settings,JSON.parse(ss));
    currentMode=settings.mode||'dividend';
    dispCount=settings.count||10;
    // „Éï„Ç£„É´„Çø„Éº„Çø„Éñ„ÇíÂæ©ÂÖÉ
    document.querySelectorAll('.filter-tab[id^="mode-"]').forEach(t=>t.classList.remove('active'));
    const mt=document.getElementById('mode-'+currentMode);
    if(mt)mt.classList.add('active');
    document.querySelectorAll('.filter-tab[id^="disp-"]').forEach(t=>t.classList.remove('active'));
    const cnt=dispCount>=999?'all':String(dispCount);
    const dt=document.getElementById('disp-'+cnt);
    if(dt)dt.classList.add('active');
  }
}catch(e){}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHART FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcMA(prices,period){
  return prices.map((v,i)=>{
    if(i<period-1)return null;
    let s=0;for(let j=i-period+1;j<=i;j++)s+=prices[j];return s/period;
  });
}
function toPath(vals,w,h,pad,mn,mx){
  const pts=[];const rng=mx-mn||1;
  vals.forEach((v,i)=>{
    if(v===null)return;
    const x=pad+(i/(vals.length-1))*(w-2*pad);
    const y=pad+(1-(v-mn)/rng)*(h-2*pad);
    pts.push(`${pts.length?'L':'M'}${x.toFixed(1)},${y.toFixed(1)}`);
  });
  return pts.join(' ');
}
function drawSpark(el,closes,w,h){
  if(!closes||!closes.length||!el)return;
  const pad=2;
  const ma=calcMA(closes,20);
  const all=closes.concat(ma.filter(v=>v!==null));
  const mn=Math.min(...all),mx=Math.max(...all);
  const pp=toPath(closes,w,h,pad,mn,mx);
  const mp=toPath(ma,w,h,pad,mn,mx);
  const lastX=pad+((closes.length-1)/(closes.length-1))*(w-2*pad);
  const isUp=closes[closes.length-1]>=closes[0];
  const col=isUp?'#059669':'#DC2626';
  const id='sg_'+Math.random().toString(36).substr(2,6);
  el.innerHTML=`<defs><linearGradient id="${id}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${col}" stop-opacity="0.15"/><stop offset="100%" stop-color="${col}" stop-opacity="0.01"/></linearGradient></defs>`+
    `<path d="${pp} L${lastX},${h-pad} L${pad},${h-pad} Z" fill="url(#${id})"/>`+
    `<path d="${mp}" fill="none" stroke="#059669" stroke-width="1" opacity="0.5"/>`+
    `<path d="${pp}" fill="none" stroke="${col}" stroke-width="1.5"/>`;
}
function drawDetailChart(el,closes,ma25v,ma75v){
  if(!closes||!closes.length||!el)return;
  const W=400,H=160,P=6,PR=45;
  const ma25calc=calcMA(closes,25);
  const allVals=[...closes,...ma25calc.filter(v=>v!==null)];
  if(ma75v&&ma75v>0)allVals.push(ma75v);
  if(ma25v&&ma25v>0)allVals.push(ma25v);
  let mn=Math.min(...allVals),mx=Math.max(...allVals);
  const range=mx-mn||1;
  mn-=range*0.06;mx+=range*0.06;
  const rng=mx-mn||1;
  function niceStep(r){
    const raw=r/4;const mag=Math.pow(10,Math.floor(Math.log10(raw)));const norm=raw/mag;
    if(norm<=1.5)return mag;if(norm<=3.5)return 2.5*mag;if(norm<=7.5)return 5*mag;return 10*mag;
  }
  const step=niceStep(rng);const gridStart=Math.ceil(mn/step)*step;
  let gridLines='';
  for(let v=gridStart;v<=mx;v+=step){
    const y=P+(1-(v-mn)/rng)*(H-2*P);
    if(y<P+2||y>H-P-10)continue;
    gridLines+=`<line x1="${P}" y1="${y}" x2="${W-PR}" y2="${y}" stroke="#E2E8F0" stroke-width="0.8"/>`;
    let label;
    if(v>=10000)label=`¬•${(v/1000).toFixed(v%1000===0?0:1)}k`;
    else label=`¬•${Math.round(v).toLocaleString()}`;
    gridLines+=`<text x="${W-PR+4}" y="${y+3}" font-size="8" fill="#94A3B8" font-family="sans-serif">${label}</text>`;
  }
  const CW=W-PR;
  const pp=toPath(closes,CW,H,P,mn,mx);
  const lastX=P+((closes.length-1)/(closes.length-1))*(CW-2*P);
  const lastY=P+(1-(closes[closes.length-1]-mn)/rng)*(H-2*P);
  const id='dg_'+Math.random().toString(36).substr(2,6);
  let ma75line='';
  if(ma75v&&ma75v>0){
    let y75=P+(1-(ma75v-mn)/rng)*(H-2*P);
    y75=Math.max(P+2,Math.min(H-P-2,y75));
    ma75line=`<line x1="${P}" y1="${y75}" x2="${CW-P}" y2="${y75}" stroke="#059669" stroke-width="1.2" opacity="0.5"/>`;
  }
  const ma25path=toPath(ma25calc,CW,H,P,mn,mx);
  el.setAttribute('viewBox',`0 0 ${W} ${H}`);
  el.innerHTML=`<defs><linearGradient id="${id}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1B6AC9" stop-opacity="0.10"/><stop offset="100%" stop-color="#1B6AC9" stop-opacity="0.01"/></linearGradient></defs>`+
    gridLines+
    `<path d="${pp} L${lastX},${H-P} L${P},${H-P} Z" fill="url(#${id})"/>`+
    ma75line+
    `<path d="${ma25path}" fill="none" stroke="#F59E0B" stroke-width="1.2" opacity="0.6"/>`+
    `<path d="${pp}" fill="none" stroke="#1A1A1A" stroke-width="2.2"/>`+
    `<circle cx="${lastX}" cy="${lastY}" r="4" fill="#DC2626" stroke="#fff" stroke-width="2"/>`+
    `<text x="${P}" y="${H-1}" font-size="9" fill="#B0B8C4" font-family="sans-serif">60Êó•Ââç</text>`+
    `<text x="${CW-P}" y="${H-1}" font-size="9" fill="#B0B8C4" text-anchor="end" font-family="sans-serif">‰ªäÊó•</text>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dv(p,m){return m?Math.round((p-m)/m*1000)/10:0;}

function calcScore(s){
  // PythonÂÅ¥„ÅßË®àÁÆóÊ∏à„Åø„ÅÆscore„ÇíÂÑ™ÂÖà‰ΩøÁî®ÔºàÂÆü„Éá„Éº„ÇøÔºâ
  if(dataSource==='real' && s.score!=null) return s.score;
  // „Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
  return calcScoreStable(s);
}
function calcScoreStable(s){
  // „Çµ„É≥„Éó„É´„Éá„Éº„ÇøÁî®„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØË®àÁÆó
  const d25=dv(s.price,s.ma25);
  const div=s.dividend||0;
  let score=0;
  score+=div>=5?40:div>=4.5?32:div>=4?25:div>=3.5?18:div>=3?10:0;
  const pbr=s.pbr||99;
  score+=pbr<=0.7?20:pbr<=0.9?15:pbr<=1.1?8:pbr<=1.5?3:0;
  score+=d25<=-8?20:d25<=-5?14:d25<=-3?8:d25<=-1?3:0;
  const rsi=s.rsi||50;
  score+=rsi<=30?15:rsi<=38?10:rsi<=45?5:0;
  const per=s.per||99;
  score+=per<=10?10:per<=13?6:per<=16?3:0;
  if((s.vol_r||1)>=1.5) score-=20;
  if(div<0.5) score=Math.min(score,5);
  const mc=s.market_cap_b||9999;
  if(mc>0&&mc<300) score-=20;
  else if(mc>0&&mc<500) score-=10;
  return Math.max(0,Math.min(score,100));
}
function calcScoreGrowth(s){
  const d25=dv(s.price,s.ma25);
  let score=0;
  score+=d25<=-15?35:d25<=-10?28:d25<=-6?20:d25<=-3?10:d25<=-1?3:0;
  const rsi=s.rsi||50;
  score+=rsi<=20?30:rsi<=28?22:rsi<=35?14:rsi<=42?7:0;
  const pbr=s.pbr||99;
  score+=pbr<=0.8?15:pbr<=1.2?10:pbr<=2.0?5:0;
  const div=s.dividend||0;
  score+=div>=4?10:div>=2?6:div>=1?2:0;
  const per=s.per||99;
  score+=per<=10?10:per<=15?5:0;
  if((s.vol_r||1)>=2.0) score-=15;
  return Math.max(0,Math.min(score,100));
}


function getZone(sc){
  return sc>=60?{label:'Ë≤∑„ÅÑÂúè',cls:'buy'}:sc>=35?{label:'Ê≥®ÊÑèÂúè',cls:'watch'}:{label:'ÂæÖÊ©üÂúè',cls:'hold'};
}

function buildReasons(s,d25){
  const r=[];
  if(d25<=-6)r.push({val:`${d25}%`,label:'25MA‰πñÈõ¢',note:'Âº∑„ÅÑÊäº„ÅóÁõÆÊ∞¥Ê∫ñ',desc:'-6%‰ª•‰∏ã„ÅØÈÅéÂéª„ÅÆÂèçÁô∫ÂÆüÁ∏æ„ÅåÈ´ò„ÅÑÊ∞¥Ê∫ñ',cls:'strong',rank:'A'});
  else if(d25<=-3)r.push({val:`${d25}%`,label:'25MA‰πñÈõ¢',note:'Êäº„ÅóÁõÆÊ∞¥Ê∫ñ',desc:'-3%‰ª•‰∏ä„ÅÆ‰∏ãËêΩ„ÅßÂèçÁô∫ÂÄôË£ú„Å´',cls:'mid',rank:'B'});
  if(s.rsi<=30)r.push({val:String(s.rsi),label:'RSI',note:'Âº∑„ÅÑÂ£≤„Çâ„Çå„Åô„Åé',desc:'30‰ª•‰∏ã„ÅØËá™ÂæãÂèçÁô∫„ÅåÊúüÂæÖ„Åß„Åç„ÇãÊ∞¥Ê∫ñ',cls:'strong',rank:'A'});
  else if(s.rsi<=38)r.push({val:String(s.rsi),label:'RSI',note:'Â£≤„Çâ„Çå„Åô„ÅéÂúèÂÜÖ',desc:'38‰ª•‰∏ã„ÅßÂ£≤„ÇäÈÅéÂâ∞„ÅåÂíå„Çâ„Åê„Çø„Ç§„Éü„É≥„Ç∞',cls:'mid',rank:'B'});
  if(s.dividend>=4.5)r.push({val:`${s.dividend}%`,label:'ÈÖçÂΩìÂà©Âõû„Çä',note:'È´òÈÖçÂΩì„Éª‰∏ãÂÄ§„Çµ„Éù„Éº„Éà',desc:'4.5%Ë∂Ö„ÅØÈÖçÂΩì„ÅåÊ†™‰æ°„ÅÆ‰∏ãÂÄ§„ÇíÊîØ„Åà„Çã',cls:'strong',rank:'A'});
  else if(s.dividend>=3)r.push({val:`${s.dividend}%`,label:'ÈÖçÂΩìÂà©Âõû„Çä',note:'„Ç§„É≥„Ç´„É†ÊúüÂæÖ',desc:'3%‰ª•‰∏ä„ÅßÈï∑Êúü‰øùÊúâ„ÅÆ„É™„Çπ„ÇØ‰ΩéÊ∏õ„Å´Âäπ„Åè',cls:'mid',rank:'B'});
  if(s.pbr<=0.8)r.push({val:`${s.pbr}ÂÄç`,label:'PBR',note:'Ëß£Êï£‰æ°ÂÄ§‰ª•‰∏ã',desc:'1ÂÄçÂâ≤„Çå„ÅØÁêÜË´ñ‰∏ä„ÅÆ‰∏ãÂÄ§„ÅåÂõ∫„ÅÑÊ∞¥Ê∫ñ',cls:'strong',rank:'A'});
  else if(s.pbr<=1.1)r.push({val:`${s.pbr}ÂÄç`,label:'PBR',note:'Ââ≤ÂÆâÂúè',desc:'1ÂÄç‰ªòËøë„ÅØÊ©üÈñ¢ÊäïË≥áÂÆ∂„ÅåÊ≥®ÁõÆ„Åô„ÇãÊ∞¥Ê∫ñ',cls:'mid',rank:'B'});
  if(s.per<=10)r.push({val:`${s.per}ÂÄç`,label:'PER',note:'Ââ≤ÂÆâÊ∞¥Ê∫ñ',desc:'10ÂÄç‰ª•‰∏ã„ÅØÊó•Êú¨Ê†™Âπ≥Âùá„ÇíÂ§ß„Åç„Åè‰∏ãÂõû„Çã',cls:'mid',rank:'B'});
  return r;
}

function calcBreakdown(s,mode){
  const d25=dv(s.price,s.ma25);
  const bd=[];
  let dp=s.dividend>=5?30:s.dividend>=4.5?25:s.dividend>=4?20:s.dividend>=3.5?15:s.dividend>=3?10:s.dividend>=2.5?5:0;
  if(mode==='dividend')dp=Math.min(Math.round(dp*1.4),40);
  if(dp>0)bd.push({l:'ÈÖçÂΩìÂà©Âõû„Çä',v:dp,max:40,pos:true});
  let mp=d25<=-8?28:d25<=-6?22:d25<=-4?12:d25<=-2?5:0;
  if(mode==='rebound')mp=Math.min(Math.round(mp*1.5),35);
  if(mp>0)bd.push({l:'25MA‰πñÈõ¢',v:mp,max:35,pos:true});
  let rp=s.rsi<=28?22:s.rsi<=32?16:s.rsi<=38?10:s.rsi<=42?5:0;
  if(mode==='rebound')rp=Math.min(Math.round(rp*1.3),25);
  if(rp>0)bd.push({l:'RSI',v:rp,max:25,pos:true});
  let pp=s.pbr<=0.7?18:s.pbr<=0.9?13:s.pbr<=1.1?7:s.pbr<=1.5?3:0;
  if(mode==='value')pp=Math.min(Math.round(pp*1.6),25);
  if(pp>0)bd.push({l:'PBR',v:pp,max:25,pos:true});
  let ep=s.per<=9?12:s.per<=11?8:s.per<=13?5:s.per<=15?2:0;
  if(mode==='value')ep=Math.min(Math.round(ep*1.4),15);
  if(ep>0)bd.push({l:'PER',v:ep,max:15,pos:true});
  if(s.vol_r>=1.5)bd.push({l:'Âá∫Êù•È´òÊÄ•Â¢ó',v:-20,max:20,pos:false});
  return bd;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROCESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function processStocks(){
  const minDiv=settings.mindiv||0;
  const zoneFilter=settings.zone||'all';

  let list=STOCKS.filter(s=>{
    if(minDiv>0&&(s.dividend||0)<minDiv) return false;
    return true;
  });

  processed=list.map(s=>{
    const d25=dv(s.price,s.ma25);
    const score = calcScore(s);
    const zone=getZone(score);
    const ma75d = s.ma75 ? dv(s.price, s.ma75) : 0;
    const mc = s.market_cap_b||0;
    const div = s.dividend||0;
    let _type='neutral';
    if(ma75d < -8) _type='falling';
    else if(ma75d < -2 && mc >= 3000 && div >= 2.5) _type='value_dip';
    else if(-5 <= ma75d && ma75d <= 3 && d25 < -1) _type='dip';
    else if(ma75d > 0 && d25 > 0 && mc >= 1000) _type='momentum';
    else if(ma75d >= -2 && d25 > 0) _type='bounce';
    return{...s,name:NAME_JP[s.code]||s.name||s.code,d25,score,zone,_type,ma75d};
  });

  if(zoneFilter==='buy')processed=processed.filter(s=>s.zone.cls==='buy');
  else if(zoneFilter==='buywatch')processed=processed.filter(s=>s.zone.cls!=='hold');

  // „ÇΩ„Éº„Éà
  processed.sort((a,b)=>{
    let av=a[sortKey]??0, bv=b[sortKey]??0;
    if(sortKey==='d25'){av=a.d25;bv=b.d25;}
    return sortDir==='asc'?av-bv:bv-av;
  });

  // Â±•Ê≠¥Ë®òÈå≤ÔºàÈùûÂêåÊúü„ÅßÂæåÂõû„ÅóÔºâ
  requestAnimationFrame(()=>{
    const now=new Date();
    const e={
      date:`${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
      mode:currentMode,count:processed.length,
      top:processed[0]?.name||'‚Äî',topScore:processed[0]?.score||0
    };
    scanHistory.unshift(e);
    scanHistory=scanHistory.slice(0,14);
    try{localStorage.setItem('kbs_history',JSON.stringify(scanHistory));}catch(e){}
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER: HERO STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHeroStats(){
  const buyN=processed.filter(s=>s.zone.cls==='buy').length;
  const topScore=processed.length?processed[0].score:'‚Äî';
  const maxDiv=processed.length?Math.max(...processed.map(s=>s.dividend)).toFixed(1)+'%':'‚Äî';
  document.getElementById('hsBuy').textContent=buyN+'‰ª∂';
  document.getElementById('hsTop').textContent=topScore+'ÁÇπ';
  document.getElementById('hsDiv').textContent=maxDiv;
  document.getElementById('hsTotal').textContent=STOCKS.length+'ÈäòÊüÑ';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER: MARKET PULSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPulse(){
  const md=marketData;
  const sign=v=>v>0?'+':'';
  const dir=v=>v>0?'up':v<0?'dn':'neutral';
  const chips=[
    {l:'Êó•ÁµåÂπ≥Âùá',v:md.nikkei_price?md.nikkei_price.toLocaleString():'‚Äî',c:md.nikkei_1d_chg!=null?sign(md.nikkei_1d_chg)+md.nikkei_1d_chg+'%':'‚Äî',d:dir(md.nikkei_1d_chg)},
    {l:'NASDAQ',v:md.nasdaq_1d_chg!=null?sign(md.nasdaq_1d_chg)+md.nasdaq_1d_chg+'%':'‚Äî',c:'ÂâçÊó•ÊØî',d:dir(md.nasdaq_1d_chg)},
    {l:'„Éâ„É´ÂÜÜ',v:md.usdjpy||'‚Äî',c:'',d:'neutral'},
    {l:'VIX',v:md.vix||'‚Äî',c:'',d:md.vix>25?'dn':md.vix<18?'up':'neutral'},
    {l:'Á±≥10Âπ¥ÂÇµ',v:md.us10y?md.us10y+'%':'‚Äî',c:'',d:'neutral'},
  ];
  document.getElementById('pulseBar').innerHTML=chips.map(c=>`
    <div class="pc">
      <div class="pc-l">${c.l}</div>
      <div class="pc-v ${c.d}">${c.v}</div>
      <div class="pc-c ${c.d}">${c.c}</div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER: STANCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcStanceScore(){
  const md=marketData;
  const buyN=processed.filter(s=>s.zone.cls==='buy').length;
  const avgRsi=processed.length?(processed.reduce((a,s)=>a+s.rsi,0)/processed.length):50;
  const avgD25=processed.length?(processed.reduce((a,s)=>a+s.d25,0)/processed.length):0;
  const highDiv=processed.filter(s=>s.dividend>=4).length;
  let axes={tech:1,macro:1,scan:0};

  // Ëª∏‚ë†„ÉÜ„ÇØ„Éã„Ç´„É´
  let t=1;
  if(md.nikkei_price&&md.nikkei_ma25){
    if(md.nikkei_price>=md.nikkei_ma25)t++;else t--;
  }
  if(md.nikkei_1d_chg!=null){
    if(md.nikkei_1d_chg>-1)t++;else if(md.nikkei_1d_chg<-1.5)t--;
  }
  if(md.vix){if(md.vix<20)t++;else if(md.vix>25)t--;}
  if(md.usdjpy){if(md.usdjpy>=147)t++;else if(md.usdjpy<140)t--;}
  axes.tech=Math.max(0,Math.min(t,3));

  // Ëª∏‚ë°„Éû„ÇØ„É≠
  let m=1;
  if(md.nasdaq_1d_chg!=null){
    if(md.nasdaq_1d_chg>0.5)m++;else if(md.nasdaq_1d_chg<-1.5)m-=2;else if(md.nasdaq_1d_chg<0)m--;
  }
  if(md.us10y){if(md.us10y>=3.5&&md.us10y<=4.5)m++;else if(md.us10y>5)m--;}
  if(md.geo_risk)m-=2;
  if(md.rate_cut_flag)m++;
  axes.macro=Math.max(0,Math.min(m,3));

  // Ëª∏‚ë¢„Çπ„Ç≠„É£„É≥
  let sc=0;
  if(buyN>=5)sc+=2;else if(buyN>=3)sc+=1;
  if(avgRsi<=35)sc++;else if(avgRsi<=42)sc+=0.5;
  if(avgD25<=-4)sc++;
  if(md.prev_buy_count!=null&&buyN>md.prev_buy_count)sc++;
  axes.scan=Math.max(0,Math.min(Math.round(sc),3));

  const total=axes.tech+axes.macro+axes.scan;
  return{total,axes,buyN,watchN:processed.filter(s=>s.zone.cls==='watch').length,
    avgRsi:avgRsi.toFixed(1),avgD25:avgD25.toFixed(1),highDiv};
}

function renderStance(){
  const{total,axes,buyN,watchN,avgRsi,avgD25,highDiv}=calcStanceScore();
  const now=new Date();
  const days=['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
  const md=marketData;
  const hasMacro=dataSource==='real'&&md.nikkei_price;

  let stance,icon,label,title,reason;
  if(total>=7){
    stance='bull';icon='üü¢';label='Âº∑Ê∞ó ‚Äî Á©çÊ•µÁöÑ„Å´‰ªïËæº„ÇÅ„ÇãÊó•';
    title='‰ªäÊó•„ÅØË≤∑„ÅÑ„ÇÑ„Åô„ÅÑÂú∞Âêà„ÅÑ';
    reason=hasMacro
      ?`3Ëª∏„Çπ„Ç≥„Ç¢<strong>${total}/9ÁÇπ</strong>„ÄÇÊó•Áµå${md.nikkei_1d_chg>0?'+':''}${md.nikkei_1d_chg}%„ÉªNASDAQ${md.nasdaq_1d_chg>0?'+':''}${md.nasdaq_1d_chg}%„Å®Â§ñÈÉ®Áí∞Â¢É„ÇÇÂÆâÂÆö„ÄÇË≤∑„ÅÑÂúè<strong>${buyN}ÈäòÊüÑ</strong>„ÄÅÂπ≥ÂùáRSI<strong>${avgRsi}</strong>„ÅßÁ©çÊ•µÁöÑ„Å´Ê§úË®é„Åß„Åç„ÇãÂ±ÄÈù¢„ÄÇ`
      :`Ë≤∑„ÅÑÂúè<strong>${buyN}ÈäòÊüÑ</strong>„ÄÅÂπ≥ÂùáRSI<strong>${avgRsi}</strong>„ÄÅÂπ≥Âùá25MA‰πñÈõ¢<strong>${avgD25}%</strong>„ÄÇÊï∞ÂÄ§„ÅåÊèÉ„Å£„Å¶„Åä„ÇäÁ©çÊ•µÁöÑ„Å´Ê§úË®é„Åß„Åç„ÇãÂ±ÄÈù¢„Åß„Åô„ÄÇ`;
  }else if(total>=4){
    stance='neutral';icon='üü°';label='‰∏≠Á´ã ‚Äî Âé≥ÈÅ∏„Åó„Å¶‰ªïËæº„ÇÄÊó•';
    title='‰ªäÊó•„ÅØÈäòÊüÑ„ÇíÈÅ∏„Å∂Êó•';
    reason=hasMacro
      ?`3Ëª∏„Çπ„Ç≥„Ç¢<strong>${total}/9ÁÇπ</strong>„ÄÇË≤∑„ÅÑÂúè<strong>${buyN}ÈäòÊüÑ</strong>„ÄÅÊ≥®ÊÑèÂúè<strong>${watchN}ÈäòÊüÑ</strong>„ÄÇ„Çπ„Ç≥„Ç¢‰∏ä‰Ωç„Å´Áµû„Çå„Å∞‰ªïËæº„Åø„ÇÑ„Åô„ÅÑÈäòÊüÑ„ÅåÂ≠òÂú®„Åó„Åæ„Åô„ÄÇ`
      :`Ë≤∑„ÅÑÂúè<strong>${buyN}ÈäòÊüÑ</strong>„ÄÅÂπ≥ÂùáRSI<strong>${avgRsi}</strong>„ÄÇ„Çπ„Ç≥„Ç¢60ÁÇπ‰ª•‰∏ä„Å´Áµû„Å£„Å¶ÊÖéÈáç„Å´ÈÅ∏Âà•„Çí„ÄÇ`;
  }else{
    stance='bear';icon='üî¥';label='Âº±Ê∞ó ‚Äî ÊßòÂ≠êË¶ã„ÅåÁÑ°Èõ£„Å™Êó•';
    title='‰ªäÊó•„ÅØÁÑ°ÁêÜ„Åó„Å¶Ë≤∑„Çè„Å™„ÅÑÊó•';
    reason=hasMacro
      ?`3Ëª∏„Çπ„Ç≥„Ç¢<strong>${total}/9ÁÇπ</strong>„ÄÇ${md.nasdaq_1d_chg<-1?`NASDAQ${md.nasdaq_1d_chg}%„Å®Á±≥ÂõΩÊ†™„ÅåËªüË™ø„ÄÇ`:''}Ë≤∑„ÅÑÂúè<strong>${buyN}ÈäòÊüÑ</strong>„Å®Â∞ë„Å™„Åè„ÄÅÂçÅÂàÜ„Å™Êäº„ÅóÁõÆ„ÅåÂΩ¢Êàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ`
      :`Ë≤∑„ÅÑÂúè<strong>${buyN}ÈäòÊüÑ</strong>„ÄÅÂπ≥Âùá25MA‰πñÈõ¢<strong>${avgD25}%</strong>„Å®Êäº„ÅóÁõÆ„ÅåÊµÖ„ÅÑ„ÄÇÊ¨°„ÅÆÊòéÁ¢∫„Å™‰∏ãËêΩÂ±ÄÈù¢„ÇíÂæÖ„Å§„ÅÆ„ÅåË≥¢Êòé„Åß„Åô„ÄÇ`;
  }

  const axisBar=(name,score,ico)=>`
    <div class="axis-row">
      <div class="axis-name">${ico} ${name}</div>
      <div class="axis-bar">
        ${[0,1,2].map(i=>`<div class="axis-seg ${i<score?'on':''} ${score===0?'zero':score>=2?'hi':'mid'}"></div>`).join('')}
      </div>
      <div class="axis-score">${score}/3</div>
    </div>`;

  const chips=[
    {label:'Ë≤∑„ÅÑÂúè',val:buyN+'ÈäòÊüÑ',cls:buyN>=5?'buy':buyN>=3?'warn':''},
    {label:'Âπ≥ÂùáRSI',val:avgRsi,cls:parseFloat(avgRsi)<=35?'buy':parseFloat(avgRsi)<=45?'warn':''},
    {label:'MA‰πñÈõ¢Âπ≥Âùá',val:avgD25+'%',cls:parseFloat(avgD25)<=-4?'buy':parseFloat(avgD25)<=-2?'warn':''},
    {label:'È´òÈÖçÂΩì4%Ë∂Ö',val:highDiv+'‰ª∂',cls:highDiv>=3?'buy':highDiv>=1?'warn':''},
  ];

  document.getElementById('stanceBox').innerHTML=`
    <div class="stance ${stance} fadein">
      <div class="stance-head">
        <div>
          <div class="stance-title">${title}</div>
          <div class="stance-date">${now.getFullYear()}Âπ¥${now.getMonth()+1}Êúà${now.getDate()}Êó•Ôºà${days[now.getDay()]}Ôºâ</div>
        </div>
        <div class="stance-badge ${stance}">${icon} ${label}</div>
      </div>
      <div class="stance-reason">${reason}</div>
      <div class="stance-axes">
        ${axisBar('„ÉÜ„ÇØ„Éã„Ç´„É´',axes.tech,'üìä')}
        ${axisBar('„Éû„ÇØ„É≠',axes.macro,'üåè')}
        ${axisBar('„Çπ„Ç≠„É£„É≥ÁµêÊûú',axes.scan,'üîç')}
        <div class="axis-total">Á∑èÂêà„Çπ„Ç≥„Ç¢ ${total} / 9ÁÇπ</div>
      </div>
      <div class="stance-chips">
        ${chips.map(c=>`<div class="stance-chip ${c.cls}"><div class="stance-chip-val">${c.val}</div><div class="stance-chip-label">${c.label}</div></div>`).join('')}
      </div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 3-TAB SYSTEM: „Çª„ÇØ„Çø„Éº / ‰∏äÊòá / Ââ≤ÂÆâ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTop5Tab(tab){
  currentTab=tab;
  activeSector=null;
  document.querySelectorAll('.t5-tab').forEach(t=>t.classList.remove('active'));
  const tabEl={sector:'t5TabSec',mom:'t5TabMom',dip:'t5TabDip'}[tab];
  if(tabEl)document.getElementById(tabEl).classList.add('active');
  // „Çª„ÇØ„Çø„Éº„Çø„Éñ„É©„Éô„É´„Çí„É™„Çª„ÉÉ„Éà
  document.getElementById('t5TabSec').textContent='üìä „Çª„ÇØ„Çø„Éº';
  renderTop10();
  gaEvent('tab_changed',{tab});
}

function renderTop10(){
  if(currentTab==='sector'){
    if(activeSector) showSectorStocks(activeSector);
    else renderSectorTrend();
  } else if(currentTab==='mom'){
    // ‰∏äÊòá„Éà„É¨„É≥„Éâ or 75Êó•Á∑ö‰∏ä„ÅÆÂ§ßÂûãÊ†™
    const moms=processed.filter(s=>{
      const m75=s.ma75d||0;
      return (m75 > -2 && s.d25 > -2 && (s.market_cap_b||0)>=500 && s.score>=20);
    }).sort((a,b)=>b.score-a.score).slice(0,10);
    renderTop10Items(moms,'‰∏äÊòá‰∏≠ TOP10');
  } else {
    // Ââ≤ÂÆâÔºöÈÖçÂΩì2%‰ª•‰∏ä„ÅÆÊäº„ÅóÁõÆÈäòÊüÑ
    const dips=processed.filter(s=>{
      return (s.d25 < -2 && (s.dividend||0)>=2.0 && (s.market_cap_b||0)>=500 && s.score>=20);
    }).sort((a,b)=>b.score-a.score).slice(0,10);
    renderTop10Items(dips,'Ââ≤ÂÆâ„ÉÅ„É£„É≥„Çπ TOP10');
  }
}

function renderSectorTrend(){
  const body=document.getElementById('top5Body');
  const SEC_MAP={
    'ÈäÄË°å':   {jp:'ÈäÄË°å',ico:'üè¶'},
    'Ë®ºÂà∏':   {jp:'Ë®ºÂà∏',ico:'üìà'},
    '‰øùÈô∫':   {jp:'‰øùÈô∫',ico:'üõ°Ô∏è'},
    'ÂïÜÁ§æ':   {jp:'ÂïÜÁ§æ',ico:'üåê'},
    'ÈÄö‰ø°':   {jp:'ÈÄö‰ø°',ico:'üì°'},
    'Ëá™ÂãïËªä': {jp:'Ëá™ÂãïËªä',ico:'üöó'},
    'ÈõªÂäõ':   {jp:'ÈõªÂäõ',ico:'‚ö°'},
    '„Ç¨„Çπ':   {jp:'„Ç¨„Çπ',ico:'üî•'},
    'ÈâÑÈãº':   {jp:'ÈâÑÈãº',ico:'‚öôÔ∏è'},
    'Áü≥Ê≤π':   {jp:'Áü≥Ê≤π',ico:'‚õΩ'},
    'ÈùûÈâÑ':   {jp:'ÈùûÈâÑÈáëÂ±û',ico:'üî©'},
    'Âª∫Ë®≠':   {jp:'Âª∫Ë®≠',ico:'üèóÔ∏è'},
    '‰∏çÂãïÁî£': {jp:'‰∏çÂãïÁî£',ico:'üè†'},
    'È£üÂìÅ':   {jp:'È£üÂìÅ',ico:'üçô'},
    'ÂåªËñ¨ÂìÅ': {jp:'ÂåªËñ¨ÂìÅ',ico:'üíä'},
    'ÂåñÂ≠¶':   {jp:'ÂåñÂ≠¶',ico:'üß™'},
    'Ê©üÊ¢∞':   {jp:'Ê©üÊ¢∞',ico:'üè≠'},
    'ÈõªÊ©ü':   {jp:'ÈõªÊ©ü',ico:'üíª'},
    'Á≤æÂØÜ':   {jp:'Á≤æÂØÜÊ©üÂô®',ico:'üî¨'},
    'IT':     {jp:'IT',ico:'üñ•Ô∏è'},
    '„Çµ„Éº„Éì„Çπ':{jp:'„Çµ„Éº„Éì„Çπ',ico:'üè¢'},
    '„É°„Éá„Ç£„Ç¢':{jp:'„É°„Éá„Ç£„Ç¢',ico:'üì∫'},
    'ÈÅãËº∏':   {jp:'ÈÅãËº∏',ico:'üöÉ'},
    'Êµ∑ÈÅã':   {jp:'Êµ∑ÈÅã',ico:'üö¢'},
    '„Ç¥„É†':   {jp:'„Ç¥„É†',ico:'üõû'},
    '„É™„Éº„Çπ': {jp:'„É™„Éº„Çπ',ico:'üí≥'},
    'Â∞èÂ£≤':   {jp:'Â∞èÂ£≤',ico:'üõí'},
    '„Åù„ÅÆ‰ªñ': {jp:'„Åù„ÅÆ‰ªñ',ico:'üìä'},
  };

  // „Çª„ÇØ„Çø„ÉºÈõÜË®àÔºöË≤∑„ÅÑÂúè„ÅÆÈäòÊüÑÊï∞„Åß‰∏¶„Åπ„Çã
  const secMap={};
  processed.forEach(s=>{
    const sec=s.sector||'„Åù„ÅÆ‰ªñ';
    if(!secMap[sec])secMap[sec]={count:0,buyCount:0,topScore:0,topName:''};
    secMap[sec].count++;
    if(s.zone&&s.zone.cls==='buy')secMap[sec].buyCount++;
    if(s.score>secMap[sec].topScore){secMap[sec].topScore=s.score;secMap[sec].topName=s.name||'';}
  });

  const sorted=Object.entries(secMap)
    .map(([name,data])=>({name,...data,
      jp:(SEC_MAP[name]||{}).jp||name,
      ico:(SEC_MAP[name]||{}).ico||'üìä'
    }))
    .filter(d=>d.count>=3)
    .sort((a,b)=>b.buyCount-a.buyCount || b.topScore-a.topScore);

  if(!sorted.length){
    body.innerHTML='<div style="padding:20px;text-align:center;font-size:12px;color:var(--text3)">„Çª„ÇØ„Çø„Éº„Éá„Éº„Çø„Å™„Åó</div>';
    return;
  }

  body.innerHTML=`<div class="sec-grid fadein">${sorted.map(d=>{
    const sub=d.buyCount>0?`${d.buyCount}ÈäòÊüÑ„ÅåË≤∑„ÅÑÂúè`:`${d.count}ÈäòÊüÑ`;
    return`<div class="sec-tile" onclick="showSectorStocks('${d.name}')">
      <div class="sec-tile-ico">${d.ico}</div>
      <div class="sec-tile-name">${d.jp}</div>
      <div class="sec-tile-sub">${sub}</div>
    </div>`;
  }).join('')}</div>`;
}

function showSectorStocks(secName){
  activeSector=secName;
  const SEC_JP={'Technology':'„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº','Financial Services':'ÈáëËûç','Communication Services':'ÈÄö‰ø°',
    'Consumer Cyclical':'Ê∂àË≤ªÔºàÊôØÊ∞óÊïèÊÑüÔºâ','Industrials':'Áî£Ê•≠„ÉªË≥áÊú¨Ë≤°','Consumer Defensive':'Ê∂àË≤ªÔºàÂÆâÂÆöÔºâ',
    'Energy':'„Ç®„Éç„É´„ÇÆ„Éº','Basic Materials':'Á¥†Êùê','Healthcare':'„Éò„É´„Çπ„Ç±„Ç¢','Utilities':'ÂÖ¨Áõä',
    'Real Estate':'‰∏çÂãïÁî£'};
  const jpName=SEC_JP[secName]||secName;
  document.getElementById('t5TabSec').textContent=jpName+' ‚úï';
  const stocks=processed.filter(s=>(s.sector||'')==secName).sort((a,b)=>b.score-a.score).slice(0,10);
  const body=document.getElementById('top5Body');
  const backBtn=`<div class="sec-back-btn" onclick="activeSector=null;setTop5Tab('sector')">‚Üê „Çª„ÇØ„Çø„Éº‰∏ÄË¶ß„Å´Êàª„Çã</div>`;
  if(!stocks.length){
    body.innerHTML=backBtn+'<div style="padding:16px;text-align:center;font-size:11px;color:var(--text3)">Ë©≤ÂΩì„Å™„Åó</div>';
    return;
  }
  body.innerHTML=backBtn+`<div class="top10-cards fadein">${stocks.map((s,i)=>renderCard(s,i+1)).join('')}</div>`;
  // Draw sparklines
  stocks.forEach(s=>{
    if(s.closes_60d&&s.closes_60d.length>10){
      const el=body.querySelector(`[data-spark="${s.code}"]`);
      if(el)drawSpark(el,s.closes_60d,120,44);
    }
  });
  if(expandedCode){
    setTimeout(()=>{
      const s=stocks.find(x=>x.code===expandedCode);
      if(s&&s.closes_60d&&s.closes_60d.length>10){
        const el=document.querySelector(`[data-dchart="${expandedCode}"]`);
        if(el)drawDetailChart(el,s.closes_60d,s.ma25,s.ma75);
      }
    },50);
  }
}

function toggleExpand(code){
  expandedCode=expandedCode===code?null:code;
  renderTop10();
  if(expandedCode){
    setTimeout(()=>{
      const el=document.querySelector(`[data-dchart="${code}"]`);
      if(el)el.scrollIntoView({behavior:'smooth',block:'nearest'});
    },100);
    gaEvent('detail_open',{code});
  }
}

function buildExpand(s){
  const hasSpark=s.closes_60d&&s.closes_60d.length>10;
  const ma75pct=Math.max(5,Math.min(95,50+(s.ma75d||0)*3));
  const ma25pct=Math.max(5,Math.min(95,50+(s.d25||0)*3));
  const ma75col=(s.ma75d||0)>=0?'var(--dn)':'var(--up)';
  const ma25col=(s.d25||0)>=0?'var(--dn)':'var(--up)';
  let signal='';
  if(s._type==='value_dip'){
    signal=`<strong>üíé Â§ßÂûãÈ´òÈÖçÂΩìÊ†™„ÅÆÈÄÜÂºµ„Çä„ÉÅ„É£„É≥„Çπ„ÄÇ</strong>‰∏ÄÊôÇÁöÑ„Å™‰∏ãËêΩ„ÅßÂâ≤ÂÆâ„Å´„ÄÇÈÖçÂΩì${(s.dividend||0).toFixed(1)}%„Çí„ÇÇ„Çâ„ÅÑ„Å™„Åå„ÇâÂõûÂæ©„ÇíÂæÖ„Å¶„ÇãÂ±ÄÈù¢„ÄÇ`;
  }else if(s._type==='dip'){
    signal=`Èï∑Êúü„Åß„ÅØ‰∏äÊòá„Éà„É¨„É≥„Éâ„ÄÇÁü≠ÊúüÁöÑ„Å´Ë™øÊï¥‰∏≠„Åß<strong>Ë≤∑„ÅÑ„ÇÑ„Åô„ÅÑ‰æ°Ê†ºÂ∏Ø„Å´Êé•Ëøë‰∏≠</strong>„ÄÇ`;
  }else if(s._type==='momentum'){
    signal=`Áü≠Êúü„ÉªÈï∑Êúü„Å®„ÇÇ„Å´‰∏äÊòá‰∏≠„ÄÇ<strong>Âã¢„ÅÑ„Å´‰πó„Å£„Å¶„ÅÑ„ÇãÁä∂ÊÖã</strong>„ÄÇÈ´òÂÄ§Êé¥„Åø„Å´Ê≥®ÊÑè„Åó„Å§„Å§„ÄÅÊµÅ„Çå„Å´‰πó„Çã„Çø„Ç§„Éü„É≥„Ç∞„ÄÇ`;
  }else{
    signal=`ÁèæÂú®„ÅØÊñπÂêëÊÑü„ÅåË™≠„Åø„Å´„Åè„ÅÑÁä∂Ê≥Å„ÄÇÁÑ°ÁêÜ„Åõ„ÅöÊßòÂ≠êË¶ã„Åå„Åä„Åô„Åô„ÇÅ„ÄÇ`;
  }
  let ma75tag='';
  if((s.ma75d||99)>=0&&(s.ma75d||99)<=3)ma75tag='<span class="d-ma-tag near">Êé•Ëøë‰∏≠!</span>';

  return `<div class="t5-expand">
  <div class="d-grid">
    <div>
      <div class="d-sec-ttl">üìä ÂÄ§Âãï„Åç„ÉÅ„É£„Éº„ÉàÔºà60Êó•Ôºâ</div>
      ${hasSpark?`<div class="d-chart-box">
        <svg class="d-chart-svg" viewBox="0 0 400 160" overflow="hidden" data-dchart="${s.code}"></svg>
      </div>
      <div style="display:flex;gap:14px;padding:10px 0 2px;flex-wrap:wrap;font-size:11px;color:var(--text)">
        <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;border-radius:50%;background:#1A1A1A"></div>Ê†™‰æ° <b>¬•${(s.price||0).toLocaleString()}</b></div>
        <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;border-radius:50%;background:#F59E0B"></div>25Êó•Âπ≥Âùá <b style="color:#F59E0B">¬•${(s.ma25||0).toLocaleString()}</b></div>
        <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;border-radius:50%;background:#059669"></div>75Êó•Âπ≥Âùá <b style="color:#059669">¬•${(s.ma75||0).toLocaleString()}</b></div>
      </div>
      `:`<div style="padding:12px;text-align:center;background:var(--bg2);border-radius:8px;border:1px solid var(--border);font-size:12px;color:var(--text)">Ê†™‰æ° ¬•${(s.price||0).toLocaleString()} / 25Êó•Âπ≥Âùá ¬•${(s.ma25||0).toLocaleString()} / 75Êó•Âπ≥Âùá ¬•${(s.ma75||0).toLocaleString()}</div>`}
      <div class="d-ma">
        <div style="font-size:10px;font-weight:700;color:var(--text2);margin-bottom:4px">üìè ‰ªä„ÅÆÊ†™‰æ°„ÅÆ‰ΩçÁΩÆ</div>
        <div class="d-ma-row">
          <div class="d-ma-lbl">25Êó•Âπ≥Âùá„Å®„ÅÆÂ∑Æ</div>
          <div class="d-ma-bar"><div class="d-ma-ctr"></div><div class="d-ma-dot" style="left:${ma25pct}%;background:${ma25col}"></div></div>
          <div class="d-ma-val ${(s.d25||0)>=0?'up':'dn'}">${(s.d25||0)>=0?'+':''}${(s.d25||0).toFixed(1)}%</div>
        </div>
        <div class="d-ma-row">
          <div class="d-ma-lbl">75Êó•Âπ≥Âùá„Å®„ÅÆÂ∑Æ</div>
          <div class="d-ma-bar"><div class="d-ma-ctr"></div><div class="d-ma-dot" style="left:${ma75pct}%;background:${ma75col}"></div></div>
          <div class="d-ma-val ${(s.ma75d||0)>=0?'up':'dn'}">${(s.ma75d||0)>=0?'+':''}${(s.ma75d||0).toFixed(1)}%</div>
          ${ma75tag}
        </div>
      </div>
    </div>
    <div>
      <div class="d-sec-ttl">üìà „Åì„ÅÆÈäòÊüÑ„ÅÆ„Éù„Ç§„É≥„Éà</div>
      <div style="padding:10px 14px;margin-bottom:10px;background:rgba(0,135,90,0.06);border-radius:8px;border:1px solid rgba(0,135,90,0.15);font-size:13px;color:var(--text)">
        üí∞ Ë≥ºÂÖ•„Å´ÂøÖË¶Å„Å™ÈáëÈ°ç ‚Üí <b style="font-size:16px;color:var(--green)">Á¥Ñ${((s.price||0)*100)>=10000?Math.round((s.price||0)*100/10000)+'‰∏á':Math.round((s.price||0)*100/1000)+'ÂçÉ'}ÂÜÜ</b><span style="font-size:10px;color:var(--text3)">Ôºà100Ê†™ √ó ¬•${(s.price||0).toLocaleString()}Ôºâ</span>
        ${(s.dividend||0)>0?`<br>üì¶ Âπ¥ÈñìÈÖçÂΩìÈáë ‚Üí <b style="font-size:16px;color:var(--green)">Á¥Ñ¬•${Math.round((s.price||0)*100*(s.dividend||0)/100).toLocaleString()}</b><span style="font-size:10px;color:var(--text3)">ÔºàÁ®éÂºïÂâç„Éª100Ê†™‰øùÊúâÊôÇÔºâ</span>`:''}
      </div>
      <div class="d-cards">
        <div class="d-card"><b>${(s.dividend||0).toFixed(1)}%</b><small>ÈÖçÂΩìÂà©Âõû„Çä</small></div>
        <div class="d-card"><b>${(s.pbr||0).toFixed(2)}ÂÄç</b><small>PBR(Ââ≤ÂÆâÂ∫¶)</small></div>
        <div class="d-card"><b>${(s.per||0)>0?(s.per||0).toFixed(0)+'ÂÄç':'‚Äî'}</b><small>PER</small></div>
      </div>
      <div class="d-signal"><b>üìù „Åã„Å∂„ÅÆ„Åô„ÅëÔºàAIÔºâ„ÅÆÂà§ÂÆö</b><p>${signal}</p></div>
      <div class="d-btns">
        <a class="d-btn" href="https://finance.yahoo.co.jp/quote/${s.code}.T" target="_blank" rel="noopener" onclick="event.stopPropagation()">Yahoo!„Éï„Ç°„Ç§„Éä„É≥„Çπ ‚Üí</a>
        <a class="d-btn" href="https://kabutan.jp/stock/?code=${s.code}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Ê†™Êé¢„ÅßË©≥„Åó„Åè ‚Üí</a>
      </div>
    </div>
  </div></div>`;
}

function renderCard(s,rank){
  const sc=s.score>=60?'hi':s.score>=40?'mid':'lo';
  const divBadge=(s.dividend||0)>=2.5?`<span class="top10-badge div">üí∞${s.dividend}%</span>`:'';
  const momBadge=s._type==='momentum'?`<span class="top10-badge mom">‚Üó‰∏äÊòá</span>`:'';
  const mc=s.market_cap_b?(s.market_cap_b>=10000?(s.market_cap_b/10000).toFixed(1)+'ÂÖÜ':Math.round(s.market_cap_b)+'ÂÑÑ'):'';
  const d75=s.ma75d!=null?`75Êó•Á∑ö${s.ma75d>0?'+':''}${s.ma75d.toFixed(1)}%`:'';
  const hasSpark=s.closes_60d&&s.closes_60d.length>10;
  const isOpen=expandedCode===s.code;
  return`<div class="top10-card${isOpen?' expanded':''}" onclick="toggleExpand('${s.code}')" style="${isOpen?'border-color:var(--orange)':''}">
    <div class="top10-rank">${rank}</div>
    <div class="top10-info">
      <div class="top10-name">${s.name}</div>
      <div class="top10-meta">${s.code} „Éª ${s.sector||''} „Éª ${mc}${d75?' „Éª '+d75:''}</div>
    </div>
    ${hasSpark?`<svg class="t5-spark" viewBox="0 0 120 44" data-spark="${s.code}"></svg>`:''}
    <div class="top10-right">
      <div class="top10-score ${sc}">${s.score}pt</div>
      ${divBadge}${momBadge}
      <div style="font-size:9px;color:var(--text3);margin-top:2px">${isOpen?'‚ñ≤ Èñâ„Åò„Çã':'‚ñº Ë©≥Á¥∞'}</div>
    </div>
  </div>${isOpen?buildExpand(s):''}`;
}

function renderTop10Items(items,title){
  const body=document.getElementById('top5Body');
  if(!items.length){
    body.innerHTML=`<div style="padding:20px;text-align:center;font-size:12px;color:var(--text3)">Ë©≤ÂΩì„Åô„ÇãÈäòÊüÑ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
    return;
  }
  body.innerHTML=`<div class="top10-cards fadein">${items.map((s,i)=>renderCard(s,i+1)).join('')}</div>`;
  // Draw sparklines
  items.forEach(s=>{
    if(s.closes_60d&&s.closes_60d.length>10){
      const el=body.querySelector(`[data-spark="${s.code}"]`);
      if(el)drawSpark(el,s.closes_60d,120,44);
    }
  });
  // Draw detail chart if expanded
  if(expandedCode){
    setTimeout(()=>{
      const s=items.find(x=>x.code===expandedCode);
      if(s&&s.closes_60d&&s.closes_60d.length>10){
        const el=document.querySelector(`[data-dchart="${expandedCode}"]`);
        if(el)drawDetailChart(el,s.closes_60d,s.ma25,s.ma75);
      }
    },50);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PORTFOLIO DIARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPortfolio(){
  try{
    const res=await fetch('portfolio.json?t='+Date.now());
    if(res.ok)portfolioData=await res.json();
  }catch(e){console.log('portfolio.json not found');}
  renderPortfolio();
}

function renderPortfolio(){
  const body=document.getElementById('portfolioBody');
  if(!body)return;
  if(!portfolioData||!portfolioData.daily_nav||portfolioData.daily_nav.length<=1){
    body.innerHTML=`<div style="padding:20px;text-align:center">
      <div style="font-size:32px;margin-bottom:8px">üöÄ</div>
      <div style="font-size:13px;font-weight:700;color:var(--text1);margin-bottom:4px">1000‰∏áÂÜÜ„ÅßÈÅãÁî®ÈñãÂßã</div>
      <div style="font-size:11px;color:var(--text3);margin-bottom:12px">AI„Åå„Çπ„Ç≥„Ç¢„Å´Âü∫„Å•„ÅÑ„Å¶Ëá™ÂãïÂ£≤Ë≤∑„ÄÇÊØéÊó•Êõ¥Êñ∞„Åó„Åæ„Åô„ÄÇ</div>
      <a class="pf-note-link" href="https://note.com/kabunosuke_navi" target="_blank" rel="noopener">üìù ÊäïË≥áÊó•Ë®ò„Çínote„ÅßË™≠„ÇÄ ‚Üí</a>
    </div>`;
    return;
  }
  const pf=portfolioData;
  const nav=pf.daily_nav[pf.daily_nav.length-1];
  const currentNav=nav.nav;
  const pnl=currentNav-pf.initial_capital;
  const pnlPct=(pnl/pf.initial_capital*100).toFixed(2);
  const dayCount=pf.daily_nav.length;
  const posCount=(pf.positions||[]).length;
  const cashPct=Math.round(pf.cash/currentNav*100);
  const stockPct=100-cashPct;
  const pnlCls=pnl>=0?'up':'dn';
  const pnlSign=pnl>=0?'+':'';

  const holdingsHtml=posCount
    ?(pf.positions||[]).map(p=>{
        const pc=(p.pnl_pct||0)>=0?'up':'dn';
        const ps=(p.pnl_pct||0)>=0?'+':'';
        return`<div class="pf-hold">
          <div style="flex:1"><div class="pf-hold-name">${p.name}</div><div style="font-size:10px;color:var(--text3)">${p.code} „Éª ${p.shares}Ê†™</div></div>
          <div class="pf-hold-pnl ${pc}">${ps}${(p.pnl_pct||0).toFixed(1)}%</div>
        </div>`;}).join('')
    :'<div style="font-size:11px;color:var(--text3);padding:4px 0">ÁèæÈáëÂæÖÊ©ü‰∏≠ üîç</div>';

  let chartHtml='';
  if(pf.daily_nav.length>=3){
    const vals=pf.daily_nav.map(d=>d.nav);
    const mn=Math.min(...vals),mx=Math.max(...vals),rng=mx-mn||1;
    const w=280,h=40;
    const pts=vals.map((v,i)=>`${(i/(vals.length-1))*w},${h-((v-mn)/rng)*h*0.8-h*0.1}`).join(' ');
    const clr=vals[vals.length-1]>=pf.initial_capital?'var(--dn)':'var(--up)';
    chartHtml=`<svg viewBox="0 0 ${w} ${h}" style="width:100%;height:40px;margin:6px 0">
      <line x1="0" y1="${h-((pf.initial_capital-mn)/rng)*h*0.8-h*0.1}" x2="${w}" y2="${h-((pf.initial_capital-mn)/rng)*h*0.8-h*0.1}" stroke="var(--text3)" stroke-dasharray="3,3" stroke-width="0.5" opacity="0.5"/>
      <polyline points="${pts}" fill="none" stroke="${clr}" stroke-width="1.5"/>
    </svg>`;
  }

  body.innerHTML=`
    <div class="pf-hero"><div class="pf-nav">¬•${currentNav.toLocaleString()}</div><div class="pf-pnl ${pnlCls}">${pnlSign}${pnlPct}%</div><div class="pf-day">Day ${dayCount}</div></div>
    <div class="pf-bars"><div class="pf-bar cash" style="flex:${cashPct}">üí¥ ÁèæÈáë ${cashPct}%</div>${posCount?`<div class="pf-bar stock" style="flex:${stockPct}">üìà Ê†™Âºè ${stockPct}%</div>`:''}</div>
    ${chartHtml}
    <div style="font-size:11px;font-weight:700;color:var(--text2);margin:8px 0 4px">üìã ‰øùÊúâ ${posCount}ÈäòÊüÑ</div>
    <div class="pf-holdings">${holdingsHtml}</div>
    <a class="pf-note-link" href="https://note.com/kabunosuke_navi" target="_blank" rel="noopener">üìù ÊäïË≥áÊó•Ë®ò„Çínote„ÅßË™≠„ÇÄ ‚Üí</a>
    <div style="font-size:9px;color:var(--text3);margin-top:8px;text-align:center">‚Äª‰ªÆÊÉ≥ÊäïË≥á„Åß„Åô„ÄÇÂÆüÈöõ„ÅÆÂ£≤Ë≤∑„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER & MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(m,el){
  currentMode=m;
  document.querySelectorAll('.filter-tab[id^="mode-"]').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
  document.querySelectorAll('#set-mode .setting-opt').forEach(o=>{
    o.classList.toggle('active',o.dataset.val===m);
  });
  run();
  gaEvent('mode_changed',{mode:m});
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSettings(){
  // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèçÊò†
  document.querySelectorAll('#set-mode .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===settings.mode));
  document.querySelectorAll('#set-count .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===String(settings.count)));
  document.querySelectorAll('#set-mindiv .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===String(settings.mindiv)));
  document.querySelectorAll('#set-zone .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===settings.zone));
  document.getElementById('settingsOverlay').classList.add('open');
  gaEvent('click_settings');
}
function closeSettingsBg(e){if(e.target===document.getElementById('settingsOverlay'))document.getElementById('settingsOverlay').classList.remove('open');}

function selectSettingOpt(el,group){
  document.querySelectorAll(`#set-${group} .setting-opt`).forEach(o=>o.classList.remove('active'));
  el.classList.add('active');
}

function saveSettings(){
  settings.mode=document.querySelector('#set-mode .setting-opt.active')?.dataset.val||'dividend';
  settings.count=parseInt(document.querySelector('#set-count .setting-opt.active')?.dataset.val||'30');
  settings.mindiv=parseFloat(document.querySelector('#set-mindiv .setting-opt.active')?.dataset.val||'0');
  settings.zone=document.querySelector('#set-zone .setting-opt.active')?.dataset.val||'all';
  try{localStorage.setItem('kbs_settings',JSON.stringify(settings));}catch(e){}

  currentMode=settings.mode;
  dispCount=settings.count;

  // „Éï„Ç£„É´„Çø„Éº„Çø„ÉñÂêåÊúü
  document.querySelectorAll('.filter-tab[id^="mode-"]').forEach(t=>t.classList.remove('active'));
  const mt=document.getElementById('mode-'+currentMode);if(mt)mt.classList.add('active');
  document.querySelectorAll('.filter-tab[id^="disp-"]').forEach(t=>t.classList.remove('active'));
  const cnt=dispCount>=999?'all':String(dispCount);
  const dt=document.getElementById('disp-'+cnt);if(dt)dt.classList.add('active');

  document.getElementById('settingsOverlay').classList.remove('open');
  run();
  gaEvent('change_filter',settings);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WATCHLIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFav(code){
  const adding=!watchlist.includes(code);
  if(adding){
    watchlist.push(code);
    const s=processed.find(x=>x.code===code);
    gaEvent('watchlist_add',{stock_code:code,score:s?.score||0});
  }else{
    watchlist=watchlist.filter(c=>c!==code);
    gaEvent('watchlist_remove',{stock_code:code});
  }
  try{localStorage.setItem('kbs_watch',JSON.stringify(watchlist));}catch(e){}
  updateWatchCount();
  // ÂÜçÊèèÁîª
  renderWatchlist();
}

function updateWatchCount(){
  const el=document.getElementById('watchCount');
  el.textContent=watchlist.length;
  el.classList.toggle('show',watchlist.length>0);
}

function renderWatchlist(){
  updateWatchCount();
  const el=document.getElementById('watchlistBody');
  if(!watchlist.length){
    el.innerHTML='<div class="watch-empty">„Ç¶„Ç©„ÉÉ„ÉÅÁôªÈå≤„Åó„ÅüÈäòÊüÑ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ<br>ÈäòÊüÑË°å„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë©≥Á¥∞„ÇíÈñã„Åç„Äå„Ç¶„Ç©„ÉÉ„ÉÅ„Å´ËøΩÂä†„Äç„Åã„ÇâÁôªÈå≤„Åß„Åç„Åæ„Åô„ÄÇ</div>';
    return;
  }
  el.innerHTML=`<div class="watch-list">${watchlist.map(code=>{
    const s=STOCKS.find(x=>x.code===code);if(!s)return'';
    const score=calcScore(s);
    const sc=score>=60?'hi':score>=35?'md':'lo';
    const d25=dv(s.price,s.ma25);
    return`<div class="watch-row" onclick="window.open('https://finance.yahoo.co.jp/quote/${code}.T','_blank')">
      <div class="watch-code">${code}</div>
      <div class="watch-name">${s.name}</div>
      <div style="text-align:right">
        <div class="watch-score ${sc}">${score}ÁÇπ</div>
        <div style="font-size:10px;color:var(--text3)">${d25>0?'+':''}${d25}%</div>
      </div>
      <button class="watch-remove" onclick="event.stopPropagation();toggleFav('${code}')">‚úï</button>
    </div>`;
  }).join('')}</div>`;
}

function renderHistory(){
  const el=document.getElementById('historyBody');
  const modeNames={dividend:'È´òÈÖçÂΩì',value:'„Éê„É™„É•„Éº',rebound:'Êäº„ÅóÁõÆ'};
  if(!scanHistory.length){
    el.innerHTML='<div class="watch-empty">„Çπ„Ç≠„É£„É≥Â±•Ê≠¥„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>';
    return;
  }
  el.innerHTML=`<table class="hist-table">
    <tr><th>Êó•ÊôÇ</th><th>„É¢„Éº„Éâ</th><th>‰ª∂Êï∞</th><th>1‰ΩçÈäòÊüÑ</th></tr>
    ${scanHistory.slice(0,7).map(h=>`<tr>
      <td>${h.date}</td><td>${modeNames[h.mode]||h.mode}</td>
      <td>${h.count}‰ª∂</td><td>${h.top}</td>
    </tr>`).join('')}
  </table>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
  const n=document.getElementById('nav-'+tab);if(n)n.classList.add('active');
  if(tab==='watch'){renderWatchlist();renderHistory();}
  gaEvent('tab_switched',{tab});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLogicModal(){document.getElementById('logicModal').classList.add('open');}
function closeLogicModal(e){if(!e||e.target===document.getElementById('logicModal'))document.getElementById('logicModal').classList.remove('open');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadRealData(){
  try{
    const r=await fetch('stocks_data.json?t='+Date.now());
    if(!r.ok)throw new Error('fetch failed');
    const j=await r.json();
    if(j.stocks&&j.stocks.length>0){
      STOCKS=j.stocks.map(s=>{
        // ÈÖçÂΩìÂà©Âõû„Çä„Çµ„Éã„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØÔºàyfinance„ÅÆËøî„ÇäÂÄ§„Éñ„É¨ÂØæÂøúÔºâ
        if(s.dividend>20) s.dividend=s.dividend>100?Math.round(s.dividend/100*100)/100:0;
        return s;
      });
      dataSource='real';
      // Â∏ÇÂ†¥„Éá„Éº„Çø
      const mFields=['nikkei_price','nikkei_ma25','nikkei_1d_chg','nasdaq_1d_chg',
                     'vix','usdjpy','us10y','geo_risk','rate_cut_flag','prev_buy_count'];
      mFields.forEach(k=>{if(j[k]!==undefined)marketData[k]=j[k];});
      if(j.updated_at)marketData.updated_at=j.updated_at;
      if(j.vol_ranking&&j.vol_ranking.length)volRankingData=j.vol_ranking;
      if(j.trend_ranking&&j.trend_ranking.length)trendRankingData=j.trend_ranking;
      if(j.sector_scores)sectorScoresData=j.sector_scores;
      // ‰ø°È†º„Éê„Éº
      document.getElementById('trustText').innerHTML=`<span class="hi">${j.updated_at}</span> Êõ¥Êñ∞ ¬∑ ${j.total}ÈäòÊüÑ„Çπ„Ç≠„É£„É≥Ê∏à„Åø`;
      document.getElementById('lastUpdate').textContent='üì° '+j.updated_at+' Êõ¥Êñ∞';
      document.getElementById('trustDot').style.background='var(--green)';
      document.getElementById('trustBanner').style.borderLeftColor='var(--green)';
      document.getElementById('totalCountBadge').textContent=j.total+'ÈäòÊüÑ';
      document.getElementById('heroEyebrow').innerHTML='<span class="hero-dot"></span>üì° ÂÆü„Éá„Éº„ÇøË™≠ËæºÊ∏à„Åø ‚Äî Êäº„ÅóÁõÆ √ó È´òÈÖçÂΩì ‚Äî ÊØéÊúù8:30Ëá™ÂãïÊõ¥Êñ∞';
    }else throw new Error('no stocks');
  }catch{
    dataSource='sample';
    STOCKS=[...SAMPLE_STOCKS];
    document.getElementById('trustText').innerHTML='<span class="warn">„Çµ„É≥„Éó„É´„Éá„Éº„ÇøË°®Á§∫‰∏≠</span> ‚Äî ÂÆü„Éá„Éº„Çø„ÅØÊØéÊúù8:30Êõ¥Êñ∞';
    document.getElementById('trustDot').style.background='var(--amber)';
    document.getElementById('trustBanner').style.borderLeftColor='var(--amber)';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RUN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function run(){
  processStocks();
  renderHeroStats();
  renderPulse();
  renderTop10();
  requestAnimationFrame(()=>{
    renderStance();
  });
  gaEvent('scan_executed',{mode:currentMode,data_source:dataSource});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BRAIN SCANNER 3Â±§ÂêåÂøÉÂÜÜ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadBrainScanner(){
  try{
    const res=await fetch('https://raw.githubusercontent.com/maemura/oshime/main/sentiment_latest.json?t='+Date.now());
    if(!res.ok) throw new Error('not found');
    const data=await res.json();
    document.getElementById('brainSection').style.display='';
    renderBrain3(data);
  }catch(e){
    console.log('Brain Scanner:',e);
    document.getElementById('brainSection').style.display='none';
  }
}

function renderBrain3(d){
  const el=document.getElementById('brainBody');
  // moodÊ≠£Ë¶èÂåñ
  const normMood=(m)=>{
    if(m==='greed'||m==='bullish') return 'greed';
    if(m==='fear'||m==='bearish'||m==='cautious') return 'fear';
    if(m==='hype') return 'hype';
    return 'calm';
  };
  // macro„Ç´„ÉÜ„Ç¥„É™Áî®mood‚ÜíÂ§ñÂÅ¥Ëâ≤„ÇØ„É©„Çπ
  const macroClass=(m)=>{
    const nm=normMood(m);
    if(nm==='greed') return 'tail';
    if(nm==='fear') return 'risk';
    if(nm==='hype') return 'event';
    return 'data';
  };
  // institutional„Ç´„ÉÜ„Ç¥„É™Áî®mood‚Üí‰∏≠ÈñìËâ≤„ÇØ„É©„Çπ
  const instiClass=(m)=>{
    const nm=normMood(m);
    if(nm==='greed') return 'bull';
    if(nm==='fear') return 'bear';
    return 'note';
  };

  el.innerHTML=`
    <div class="brain-container">
      <div class="brain-guide outer"></div>
      <div class="brain-guide mid"></div>
      <div class="brain-guide inner"></div>
      <div class="brain-tag t1">MACRO ‚Äî ‰∏ñÁïå„ÅÆÊΩÆÊµÅ</div>
      <div class="brain-tag t2">INSTITUTIONAL ‚Äî Ê©üÈñ¢„ÅÆÂãï„Åç</div>
      <div class="brain-tag t3">RETAIL ‚Äî ÂÄã‰∫∫„ÅÆÂ£∞</div>
      <div class="brain-ring outer" id="brMacro"></div>
      <div class="brain-ring mid" id="brInsti"></div>
      <div class="brain-core" id="brRetail"></div>
      <div class="brain-scan s1"></div>
      <div class="brain-scan s2"></div>
    </div>
    ${d.date?`<div class="brain-date">ÊØéÊúùËá™ÂãïÊõ¥Êñ∞ ‚Äî ${d.date}</div>`:''}`;

  // „Ç≥„É≥„ÉÜ„Éä„Çµ„Ç§„Ç∫ÂèñÂæó
  const container=el.querySelector('.brain-container');
  const W=container.offsetWidth||380;

  // ‚îÄ‚îÄ Â§ñÂ±§: MACRO ‚îÄ‚îÄ
  const macroEl=document.getElementById('brMacro');
  const mItems=(d.macro||[]).slice(0,10);
  const mR=W*0.46, mCx=W*0.5, mCy=W*0.5;
  mItems.forEach((item,i)=>{
    const angle=(i/mItems.length)*2*Math.PI-Math.PI*0.55;
    const sp=document.createElement('span');
    sp.className='bw-outer bw-'+macroClass(item.mood);
    sp.textContent=item.word;
    const sc=item.size==='lg'?1.05:item.size==='md'?.95:.85;
    sp.style.fontSize=(9*sc)+'px';
    sp.style.left=(mCx+mR*Math.cos(angle))+'px';
    sp.style.top=(mCy+mR*Math.sin(angle))+'px';
    sp.style.animationDelay=(0.3+i*0.1)+'s';
    macroEl.appendChild(sp);
  });

  // ‚îÄ‚îÄ ‰∏≠Â±§: INSTITUTIONAL ‚îÄ‚îÄ
  const instiEl=document.getElementById('brInsti');
  const iItems=(d.institutional||[]).slice(0,10);
  const iW=W*0.66, iR=iW*0.42, iCx=iW*0.5, iCy=iW*0.5;
  iItems.forEach((item,i)=>{
    const angle=(i/iItems.length)*2*Math.PI-Math.PI*0.45;
    const sp=document.createElement('span');
    sp.className='bw-mid bw-'+instiClass(item.mood);
    sp.textContent=item.word;
    sp.style.left=(iCx+iR*Math.cos(angle))+'px';
    sp.style.top=(iCy+iR*Math.sin(angle))+'px';
    sp.style.animationDelay=(1+i*0.1)+'s';
    instiEl.appendChild(sp);
  });

  // ‚îÄ‚îÄ ÂÜÖÂ±§: RETAIL ‚îÄ‚îÄ
  const retailEl=document.getElementById('brRetail');
  const rItems=(d.retail||[]).sort(()=>Math.random()-0.5).slice(0,10);
  rItems.forEach((item,i)=>{
    const sp=document.createElement('span');
    const nm=normMood(item.mood);
    sp.className='bw-inner '+(item.size||'sm')+' bw-'+nm;
    sp.textContent=item.word;
    sp.style.animationDelay=(1.5+i*0.08)+'s';
    retailEl.appendChild(sp);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// È®∞ËêΩ„É©„É≥„Ç≠„É≥„Ç∞ + AI„Ç≥„É°„É≥„Éà
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var rankStocks=[];
var commentaryData=null;
var activeRankIdx=-1;

var NAME_JP={
  '7203':'„Éà„É®„ÇøËá™ÂãïËªä','8306':'‰∏âËè±UFJ','9984':'„ÇΩ„Éï„Éà„Éê„É≥„ÇØG','6501':'Êó•Á´ãË£Ω‰ΩúÊâÄ',
  '8316':'‰∏â‰∫ï‰ΩèÂèãFG','9983':'„Éï„Ç°„Éº„Çπ„Éà„É™„ÉÜ','6857':'„Ç¢„Éâ„Éê„É≥„ÉÜ„Çπ„Éà','8035':'Êù±‰∫¨„Ç®„É¨„ÇØ„Éà„É≠„É≥',
  '8058':'‰∏âËè±ÂïÜ‰∫ã','6758':'„ÇΩ„Éã„ÉºG','8001':'‰ºäËó§Âø†ÂïÜ‰∫ã','8411':'„Åø„Åö„ÅªFG',
  '4519':'‰∏≠Â§ñË£ΩËñ¨','8031':'‰∏â‰∫ïÁâ©Áî£','7011':'‰∏âËè±ÈáçÂ∑•','6861':'„Ç≠„Éº„Ç®„É≥„Çπ',
  '9432':'NTT','8766':'Êù±‰∫¨Êµ∑‰∏ä','6503':'‰∏âËè±ÈõªÊ©ü','2914':'JT',
  '4063':'‰ø°Ë∂äÂåñÂ≠¶','285A':'„Ç≠„Ç™„ÇØ„Ç∑„Ç¢','7974':'‰ªªÂ§©Â†Ç','9433':'KDDI',
  '7182':'„ÇÜ„ÅÜ„Å°„ÇáÈäÄË°å','6098':'„É™„ÇØ„É´„Éº„Éà','9434':'„ÇΩ„Éï„Éà„Éê„É≥„ÇØ','8002':'‰∏∏Á¥Ö',
  '7741':'HOYA','4502':'Ê≠¶Áî∞Ëñ¨ÂìÅ','7267':'„Éõ„É≥„ÉÄ','7270':'SUBARU',
  '6902':'„Éá„É≥„ÇΩ„Éº','8053':'‰ΩèÂèãÂïÜ‰∫ã','8015':'Ë±äÁî∞ÈÄöÂïÜ','6504':'ÂØåÂ£´ÈõªÊ©ü',
  '6702':'ÂØåÂ£´ÈÄö','6752':'„Éë„Éä„ÇΩ„Éã„ÉÉ„ÇØ','6981':'ÊùëÁî∞Ë£Ω‰ΩúÊâÄ','6988':'Êó•Êù±ÈõªÂ∑•',
  '7751':'„Ç≠„É§„Éé„É≥','7731':'„Éã„Ç≥„É≥','4503':'„Ç¢„Çπ„ÉÜ„É©„Çπ','4506':'‰ΩèÂèã„Éï„Ç°„Éº„Éû',
  '4507':'Â°©ÈáéÁæ©','4523':'„Ç®„Éº„Ç∂„Ç§','4568':'Á¨¨‰∏Ä‰∏âÂÖ±','9501':'Êù±‰∫¨ÈõªÂäõ',
  '9502':'‰∏≠ÈÉ®ÈõªÂäõ','9503':'Èñ¢Ë•øÈõªÂäõ','5401':'Êó•Êú¨Ë£ΩÈâÑ','5411':'JFE',
  '9020':'JRÊù±Êó•Êú¨','9021':'JRË•øÊó•Êú¨','9022':'JRÊù±Êµ∑','9101':'Êó•Êú¨ÈÉµËàπ',
  '9104':'ÂïÜËàπ‰∏â‰∫ï','9107':'Â∑ùÂ¥éÊ±ΩËàπ','3382':'„Çª„Éñ„É≥&„Ç¢„Ç§','8267':'„Ç§„Ç™„É≥',
  '4676':'„Éï„Ç∏„É°„Éá„Ç£„Ç¢','7172':'JIA','2181':'„Éë„Éº„ÇΩ„É´HD','3668':'„Ç≥„É≠„Éó„É©',
  '4331':'T&G','8304':'„ÅÇ„Åä„Åû„ÇâÈäÄË°å','8308':'„Çä„Åù„Å™HD','8309':'‰∏â‰∫ï‰ΩèÂèã„Éà„É©„Çπ„Éà',
  '1801':'Â§ßÊàêÂª∫Ë®≠','1802':'Â§ßÊûóÁµÑ','1812':'ÈπøÂ≥∂Âª∫Ë®≠','8801':'‰∏â‰∫ï‰∏çÂãïÁî£',
  '8802':'‰∏âËè±Âú∞ÊâÄ','5108':'„Éñ„É™„ÉÇ„Çπ„Éà„É≥','8750':'Á¨¨‰∏ÄÁîüÂëΩ','8795':'T&D',
  '8630':'SOMPO','8725':'MS&AD','8601':'Â§ßÂíåË®ºÂà∏','8604':'ÈáéÊùëHD',
  '2502':'„Ç¢„Çµ„Éí','2503':'„Ç≠„É™„É≥','2801':'„Ç≠„ÉÉ„Ç≥„Éº„Éû„É≥',
  '4188':'‰∏âËè±„Ç±„Éü„Ç´„É´','4042':'Êù±„ÇΩ„Éº','3405':'„ÇØ„É©„É¨',
  '6301':'„Ç≥„Éû„ÉÑ','6302':'‰ΩèÂèãÈáçÊ©ü','6305':'Êó•Á´ãÂª∫Ê©ü','6326':'„ÇØ„Éú„Çø',
  '5020':'ENEOS','7201':'Êó•Áî£','7211':'‰∏âËè±Ëá™ÂãïËªä','7261':'„Éû„ÉÑ„ÉÄ',
  '4689':'Z„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„Çπ','4755':'Ê•ΩÂ§©','9613':'NTT„Éá„Éº„Çø',
  '8830':'‰ΩèÂèã‰∏çÂãïÁî£','3289':'Êù±ÊÄ•‰∏çÂãïÁî£','8591':'„Ç™„É™„ÉÉ„ÇØ„Çπ',
  '8697':'Êó•Êú¨ÂèñÂºïÊâÄ','7752':'„É™„Ç≥„Éº','7911':'Âá∏Áâà','7912':'Â§ßÊó•Êú¨Âç∞Âà∑',
  '6920':'„É¨„Éº„Ç∂„Éº„ÉÜ„ÉÉ„ÇØ','6146':'„Éá„Ç£„Çπ„Ç≥','6723':'„É´„Éç„Çµ„Çπ','3436':'SUMCO',
  '6526':'„ÇΩ„Ç∑„Ç™„Éç„ÇØ„Çπ„Éà','7012':'Â∑ùÂ¥éÈáçÂ∑•','7013':'IHI','7721':'Êù±‰∫¨Ë®àÂô®',
  '1605':'INPEX','9201':'JAL','9202':'ANA','6273':'SMC','3923':'„É©„ÇØ„Çπ',
  '6178':'Êó•Êú¨ÈÉµÊîø','6532':'„Éô„Ç§„Ç´„É¨„É≥„Éà','8593':'‰∏âËè±HC„Ç≠„É£„Éî„Çø„É´',
  '8566':'„É™„Ç≥„Éº„É™„Éº„Çπ','5019':'Âá∫ÂÖâËààÁî£','5021':'„Ç≥„Çπ„É¢„Ç®„Éç„É´„ÇÆ„Éº',
  '5802':'‰ΩèÂèãÈõªÂ∑•','5801':'Âè§Ê≤≥ÈõªÂ∑•','5803':'„Éï„Ç∏„ÇØ„É©',
  '9843':'„Éã„Éà„É™','7532':'„Éë„É≥„Éë„Ç∑HD','9735':'„Çª„Ç≥„É†',
  '9504':'‰∏≠ÂõΩÈõªÂäõ','9505':'ÂåóÈô∏ÈõªÂäõ','9506':'Êù±ÂåóÈõªÂäõ',
  '9507':'ÂõõÂõΩÈõªÂäõ','9508':'‰πùÂ∑ûÈõªÂäõ','9509':'ÂåóÊµ∑ÈÅìÈõªÂäõ',
  '7269':'„Çπ„Ç∫„Ç≠','8354':'„Åµ„Åè„Åä„ÅãFG','8355':'ÈùôÂ≤°ÈäÄË°å',
  '1928':'Á©çÊ∞¥„Éè„Ç¶„Çπ','1925':'Â§ßÂíå„Éè„Ç¶„Çπ','1878':'Â§ßÊù±Âª∫Ë®ó',
  '8804':'Êù±‰∫¨Âª∫Áâ©','8848':'„É¨„Ç™„Éë„É¨„Çπ',
  '4684':'„Ç™„Éº„Éì„ÉÉ„ÇØ','4751':'„Çµ„Ç§„Éê„ÉºA','9602':'Êù±ÂÆù',
  '2802':'Âë≥„ÅÆÁ¥†','2809':'„Ç≠„É¶„Éº„Éî„Éº','2871':'„Éã„ÉÅ„É¨„Ç§',
  '2282':'Êó•Êú¨„Éè„É†','2269':'ÊòéÊ≤ªHD',
  '4183':'‰∏â‰∫ïÂåñÂ≠¶','4631':'DIC','4005':'‰ΩèÂèãÂåñÂ≠¶',
  '5406':'Á•ûÊà∏Ë£ΩÈãº','5413':'Êó•Êñ∞Ë£ΩÈãº',
  '6361':'ËçèÂéüË£Ω‰ΩúÊâÄ','6471':'Êó•Êú¨Á≤æÂ∑•',
  '9531':'Êù±‰∫¨„Ç¨„Çπ','9532':'Â§ßÈò™„Ç¨„Çπ',
  '5101':'Ê®™Êµú„Ç¥„É†','7951':'„É§„Éû„Éè','7186':'„Ç≥„É≥„Ç≥„É´„Éá„Ç£„Ç¢',
  '9064':'„É§„Éû„ÉàHD','8252':'‰∏∏‰∫ïG','8168':'„Ç±„Éº„É®„Éº',
};

function formatCap(b){
  if(!b||b<=0)return'‚Äî';
  if(b>=10000)return (b/10000).toFixed(1)+'ÂÖÜ';
  return Math.round(b)+'ÂÑÑ';
}

function rankChgClass(v){
  if(v>=3)return'r-big-up';
  if(v>0.05)return'r-up';
  if(v<=-2)return'r-big-dn';
  if(v<-0.05)return'r-dn';
  return'r-flat';
}

function buildRanking(){
  if(!STOCKS||!STOCKS.length)return;
  // TOP30 by market_cap_b
  var top=STOCKS.filter(function(s){return s.market_cap_b&&s.market_cap_b>0;})
    .sort(function(a,b){return(b.market_cap_b||0)-(a.market_cap_b||0);})
    .slice(0,30);
  if(top.length<10)return;

  // calc daily change from closes_60d
  rankStocks=top.map(function(s){
    var c=s.closes_60d||[];
    var chg=0;
    if(c.length>=2)chg=((c[c.length-1]-c[c.length-2])/c[c.length-2])*100;
    var d25=s.ma25?((s.price/s.ma25)-1)*100:0;
    // find commentary if available
    var cmt=null;
    if(commentaryData&&commentaryData.stocks){
      cmt=commentaryData.stocks[s.code]||null;
    }
    return{
      name:NAME_JP[s.code]||s.name||s.code,code:s.code,sector:s.sector||'',
      chg:Math.round(chg*100)/100,
      cap:formatCap(s.market_cap_b),capB:s.market_cap_b||0,
      price:s.price||0,rsi:s.rsi||0,
      ma25d:d25>=0?'+'+d25.toFixed(1)+'%':d25.toFixed(1)+'%',
      div:((s.dividend||0)).toFixed(1)+'%',
      score:s.score||0,
      kokusaku:s.kokusaku||'',
      cmt:cmt
    };
  });

  // Build grid
  var grid=document.getElementById('rankGrid');
  var half=Math.ceil(rankStocks.length/2);
  function makeRow(s,idx){
    var sign=s.chg>0?'+':'';
    var nm=s.name.length>7?s.name.substring(0,7)+'‚Ä¶':s.name;
    var hasCmt=s.cmt?' has-comment':'';
    var kokMini=s.kokusaku?'<span style="font-size:7px;margin-left:2px" title="ÂõΩÁ≠ñ:'+s.kokusaku+'">üèõÔ∏è</span>':'';
    return'<div class="rank-row'+hasCmt+'" data-ridx="'+idx+'" onclick="showRankDetail('+idx+')">'+
      '<div class="rank-row-main">'+
      '<div class="rank-name">'+nm+kokMini+'</div>'+
      '<div class="rank-chg '+rankChgClass(s.chg)+'">'+sign+s.chg.toFixed(1)+'%</div>'+
      '<div class="rank-cap">'+s.cap+'</div>'+
      '</div></div>';
  }
  var left=rankStocks.slice(0,half);
  var right=rankStocks.slice(half);
  grid.innerHTML='<div class="rank-col">'+left.map(function(s,i){return makeRow(s,i);}).join('')+'</div>'+
    '<div class="rank-col">'+right.map(function(s,i){return makeRow(s,i+half);}).join('')+'</div>';

  // Footer with date
  var dt=commentaryData&&commentaryData.date?commentaryData.date:(marketData.updated_at||'');
  document.getElementById('rankFooter').textContent=dt+' ÁµÇÂÄ§ „Éª „Åã„Å∂„ÅÆ„Åô„ÅëNavi';
  var rdEl=document.getElementById('rankDate');
  if(rdEl&&marketData.updated_at)rdEl.textContent=marketData.updated_at.split(' ')[0]+' ÁµÇÂÄ§ „Éª ';

  document.getElementById('rankSection').style.display='';
}

function showRankDetail(idx){
  var panel=document.getElementById('detailPanel');
  var s=rankStocks[idx];
  if(!s)return;

  // Toggle off
  if(activeRankIdx===idx){
    panel.classList.remove('show');
    var rows=document.querySelectorAll('.rank-row');
    for(var i=0;i<rows.length;i++)rows[i].classList.remove('active');
    activeRankIdx=-1;
    return;
  }
  activeRankIdx=idx;
  var rows=document.querySelectorAll('.rank-row');
  for(var i=0;i<rows.length;i++)rows[i].classList.remove('active');
  var target=document.querySelector('.rank-row[data-ridx="'+idx+'"]');
  if(target)target.classList.add('active');

  var sign=s.chg>0?'+':'';
  var chgCls=s.chg>=0?'r-up':'r-dn';

  // Comment section
  var cmtHtml;
  if(s.cmt&&s.cmt.text){
    var srcLabels={yt:'üì∫ YouTube',news:'üì∞ „Éã„É•„Éº„Çπ',tech:'üìä „ÉÜ„ÇØ„Éã„Ç´„É´',score:'‚≠ê „Çπ„Ç≥„Ç¢'};
    var srcTags=(s.cmt.sources||[]).map(function(t){
      return'<span class="src-tag '+t+'">'+(srcLabels[t]||t)+'</span>';
    }).join('');
    cmtHtml='<div class="detail-cmt">'+
      '<div class="detail-cmt-head">'+
      '<div class="detail-cmt-avatar">ü§ñ</div>'+
      '<div class="detail-cmt-label">„Åã„Å∂„ÅÆ„Åô„ÅëÔºàAIÔºâ„ÅÆÂàÜÊûê</div></div>'+
      '<div class="detail-cmt-body">'+s.cmt.text+'</div>'+
      '<div class="detail-cmt-sources">'+srcTags+'</div></div>';
  }else{
    // Auto-generate comment from data
    var autoText='';
    var rsi=s.rsi||0;
    var divN=parseFloat(s.div)||0;
    var sc=s.score||0;
    if(rsi<=30)autoText+='<strong>RSI'+rsi+'„ÅßÂ£≤„Çâ„Çå„Åô„ÅéÊ∞¥Ê∫ñ</strong>„ÄÇÊäº„ÅóÁõÆ„ÉÅ„É£„É≥„Çπ„Åã„ÇÇ„ÄÇ';
    else if(rsi>=70)autoText+='RSI'+rsi+'„ÅßÈÅéÁÜ±Ê∞óÂë≥„ÄÇÂà©Á¢∫„Çø„Ç§„Éü„É≥„Ç∞„Å´Ê≥®ÊÑè„ÄÇ';
    else autoText+='RSI'+rsi+'„Åß‰∏≠Á´ãÂúè„ÄÇ';
    if(divN>=4)autoText+='ÈÖçÂΩì'+s.div+'„ÅØÈ≠ÖÂäõÁöÑ„Å™È´òÈÖçÂΩìÊ∞¥Ê∫ñ„Å†„Å≠„ÄÇ';
    else if(divN>=2.5)autoText+='ÈÖçÂΩì'+s.div+'„ÅßÂÆâÂÆöÊÑü„ÅÇ„Çä„ÄÇ';
    if(sc>=60)autoText+='„Çπ„Ç≥„Ç¢'+sc+'pt„ÅØÂÉï„ÅÆÂü∫Ê∫ñ„ÇØ„É™„Ç¢‚ú®';
    else if(sc>=45)autoText+='„Çπ„Ç≥„Ç¢'+sc+'pt„Åß„Åæ„Åö„Åæ„Åö„ÄÇ„ÇÇ„ÅÜÂ∞ë„ÅóÊäº„Åó„Åü„ÇâÈù¢ÁôΩ„ÅÑ„ÄÇ';
    else autoText+='„Çπ„Ç≥„Ç¢'+sc+'pt„ÄÇ‰ªä„ÅØÊßòÂ≠êË¶ã„Åã„Å™„ÄÇ';
    var autoSrc=['tech','score'].map(function(t){
      var srcLabels={tech:'üìä „ÉÜ„ÇØ„Éã„Ç´„É´',score:'‚≠ê „Çπ„Ç≥„Ç¢'};
      return'<span class="src-tag '+t+'">'+(srcLabels[t]||t)+'</span>';
    }).join('');
    cmtHtml='<div class="detail-cmt">'+
      '<div class="detail-cmt-head">'+
      '<div class="detail-cmt-avatar">ü§ñ</div>'+
      '<div class="detail-cmt-label">„Åã„Å∂„ÅÆ„Åô„ÅëÔºàAIÔºâ„ÅÆÂàÜÊûê</div></div>'+
      '<div class="detail-cmt-body">'+autoText+'</div>'+
      '<div class="detail-cmt-sources">'+autoSrc+'</div></div>';
  }

  var kokBadge=s.kokusaku?'<span style="display:inline-block;background:linear-gradient(135deg,#d4af37,#f0d060);color:#1a1a2e;font-size:10px;font-weight:700;padding:2px 6px;border-radius:3px;margin-left:6px">üèõÔ∏è ÂõΩÁ≠ñ:'+s.kokusaku+'</span>':'';

  panel.innerHTML=
    '<div class="detail-top">'+
      '<div class="detail-info"><div class="detail-name">'+s.name+kokBadge+'</div>'+
      '<div class="detail-meta">'+s.code+' „Éª '+s.sector+' „Éª '+s.cap+'</div></div>'+
      '<div class="detail-chg-big '+chgCls+'">'+sign+s.chg.toFixed(1)+'%</div>'+
      '<button class="detail-close" onclick="showRankDetail('+idx+')">‚úï</button></div>'+
    '<div class="detail-stats">'+
      '<div class="detail-stat"><div class="detail-stat-val">'+s.rsi+'</div><div class="detail-stat-label">RSI</div></div>'+
      '<div class="detail-stat"><div class="detail-stat-val">'+s.ma25d+'</div><div class="detail-stat-label">25MA‰πñÈõ¢</div></div>'+
      '<div class="detail-stat"><div class="detail-stat-val">'+s.div+'</div><div class="detail-stat-label">ÈÖçÂΩìÂà©Âõû„Çä</div></div>'+
      '<div class="detail-stat"><div class="detail-stat-val">'+s.score+'pt</div><div class="detail-stat-label">„Çπ„Ç≥„Ç¢</div></div>'+
    '</div>'+cmtHtml;

  panel.classList.remove('show');
  void panel.offsetWidth;
  panel.classList.add('show');
  setTimeout(function(){panel.scrollIntoView({behavior:'smooth',block:'nearest'});},50);
}

async function loadCommentary(){
  try{
    var res=await fetch('commentary.json?t='+Date.now());
    if(!res.ok)throw new Error('not found');
    commentaryData=await res.json();
    // Render market comment (A)
    if(commentaryData.market){
      var m=commentaryData.market;
      document.getElementById('mktCommentBody').innerHTML=m.text||'';
      document.getElementById('mktCommentDate').textContent=commentaryData.date||'';
      // Tags
      var tagsHtml=(m.tags||[]).map(function(t){
        return'<span class="mkt-tag '+(t.type||'neutral')+'">'+t.label+'</span>';
      }).join('');
      document.getElementById('mktCommentTags').innerHTML=tagsHtml;
      // Sources
      var srcHtml=(m.sources||[]).map(function(s){
        return'<span class="mkt-src">'+s+'</span>';
      }).join('');
      document.getElementById('mktCommentSources').innerHTML=srcHtml;
      document.getElementById('mktCommentSection').style.display='';
    }
  }catch(e){
    console.log('commentary.json not available yet');
  }
}

async function init(){
  updateWatchCount();
  await loadRealData();
  run();
  loadPortfolio();
  loadBrainScanner();
  await loadCommentary();
  buildRanking();
  gaEvent('view_app',{data_source:dataSource});
}

init();
</script>
</body>
</html>
