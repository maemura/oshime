<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‹ã¶ã®ã™ã‘ â€” é«˜é…å½“æ ªã®è²·ã„å ´ã‚’æ¯æ—¥ã‚¹ã‚­ãƒ£ãƒ³</title>
<meta name="description" content="æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ 1,600éŠ˜æŸ„ã‚’æ¯æœè‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³ã€‚æŠ¼ã—ç›®ã‚¹ã‚³ã‚¢ã§ä»Šæ—¥ã®è²·ã„å ´ã‚’å³æ¤œå‡ºã€‚">
<meta property="og:title" content="ã‹ã¶ã®ã™ã‘ â€” é«˜é…å½“æ ªã®è²·ã„å ´ã‚’æ¯æœã‚¹ã‚­ãƒ£ãƒ³">
<meta property="og:description" content="æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ 1,600éŠ˜æŸ„ã‚’æ¯æœ7:30ã«è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³ã€‚6ãƒ¶æœˆãƒˆãƒ¬ãƒ³ãƒ‰Ã—MA75ã§ä»Šæ—¥ã®æŠ¼ã—ç›®TOP5ã‚’å³è¡¨ç¤ºã€‚">
<meta property="og:image" content="https://oshime.vercel.app/ogp.png">
<meta property="og:url" content="https://oshime.vercel.app/app.html">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@kabunosuke_navi">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DWW0W11P5T"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-DWW0W11P5T');function gaEvent(n,p){if(typeof gtag!=='undefined')gtag('event',n,p||{});}</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#F0F3F7;--card:#FFF;--border:#E3E8EE;--border-l:#F1F5F9;
  --blue:#003D99;--blue-m:#1B6AC9;--blue-l:#E8F0FB;--blue-tab:#0056C4;
  --navy:#0A1628;--navy-bar:#1A2744;
  --green:#059669;--green-bg:#ECFDF5;
  --red:#DC2626;--red-bg:#FEF2F2;
  --amber:#D97706;--amber-bg:#FFFBEB;
  --purple:#7C3AED;--purple-bg:#F5F3FF;
  --text:#1A1A1A;--text2:#4A5568;--text3:#8E99A8;
  --sh:0 1px 4px rgba(0,0,0,0.04),0 2px 8px rgba(0,0,0,0.04);
  --sh-m:0 2px 8px rgba(0,0,0,0.06),0 4px 16px rgba(0,0,0,0.04);
  --r:14px;
  --f:-apple-system,BlinkMacSystemFont,'Hiragino Sans','Hiragino Kaku Gothic ProN','ãƒ¡ã‚¤ãƒªã‚ª',Meiryo,'Yu Gothic',sans-serif;
  --fn:'DM Sans',-apple-system,sans-serif;
}
body{font-family:var(--f);background:var(--bg);color:var(--text);max-width:960px;margin:0 auto;padding-bottom:72px;-webkit-font-smoothing:antialiased;line-height:1.6;}
a{color:var(--blue-m);text-decoration:none;}

/* LOGO + TICKER */
.logo-bar{background:var(--navy-bar);padding:8px 16px;display:flex;align-items:center;position:sticky;top:0;z-index:100;}
.logo{font-family:var(--fn);font-size:16px;font-weight:800;color:#fff;letter-spacing:-0.03em;flex-shrink:0;}
.logo span{color:#4ADE80;}
.ticker{display:flex;flex:1;margin-left:16px;}
.ticker-item{text-align:center;flex:1;}
.ticker-lbl{font-size:9px;color:rgba(255,255,255,0.5);font-weight:500;}
.ticker-val{font-family:var(--fn);font-size:14px;font-weight:800;color:#fff;letter-spacing:-0.03em;line-height:1.3;}
.ticker-chg{font-family:var(--fn);font-size:10px;font-weight:700;}
.ticker-chg.up{color:#4ADE80;}.ticker-chg.dn{color:#F87171;}

/* HERO */
.hero{background:var(--card);border-radius:var(--r);margin:10px 12px;padding:24px 22px;box-shadow:var(--sh-m);border-left:5px solid var(--blue);}
.hero-date{font-size:11px;color:var(--text3);margin-bottom:6px;}
.hero-hl{font-size:17px;font-weight:800;color:var(--text);line-height:1.5;margin-bottom:10px;}
.hero-hl em{font-style:normal;color:var(--blue-m);}
.hero-big{display:flex;align-items:baseline;gap:6px;margin-bottom:4px;}
.hero-big b{font-family:var(--fn);font-size:48px;font-weight:900;color:var(--green);letter-spacing:-2px;line-height:1;}
.hero-big span{font-size:14px;font-weight:600;color:var(--green);}
.hero-sub{font-size:12px;color:var(--text3);margin-bottom:14px;}
.stance{display:inline-flex;align-items:center;gap:5px;padding:5px 13px;border-radius:20px;font-size:12px;font-weight:700;}
.stance.bear{background:var(--red-bg);color:var(--red);}.stance.bull{background:var(--green-bg);color:var(--green);}.stance.neutral{background:var(--amber-bg);color:var(--amber);}
.hero-chips{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;}
.hero-chip{padding:4px 11px;border-radius:20px;font-size:11px;font-weight:600;background:var(--blue-l);color:var(--blue);}
.hero-stats{display:flex;gap:16px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border);}
.hero-stat{font-size:11px;color:var(--text3);}
.hero-stat b{font-family:var(--fn);font-size:14px;font-weight:800;color:var(--text);display:block;}
.hero-stat small{font-size:10px;color:var(--text3);}

/* TOP5 */
.t5-sec{margin:10px 12px;}
.t5-tabs{display:flex;gap:8px;padding:12px 16px;background:var(--bg);}
.t5-tab{flex:1;padding:12px 8px;text-align:center;font-size:14px;font-weight:700;cursor:pointer;border:2px solid var(--border);color:var(--text3);transition:all .2s;background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);}
.t5-tab:active{transform:scale(.97);}
.t5-tab.active{color:#fff;border-color:var(--blue);background:var(--blue);box-shadow:0 2px 8px rgba(59,130,246,.3);}
.t5-body{background:var(--card);border-radius:0 0 var(--r) var(--r);box-shadow:var(--sh);}
.t5-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
.t5-item:last-child{border-bottom:none;}.t5-item:active{background:var(--blue-l);}
.t5-tap{font-size:9px;color:var(--blue);font-weight:700;margin-top:2px;}
.t5-rank{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--fn);font-size:13px;font-weight:800;background:var(--bg);color:var(--text2);flex-shrink:0;}
.t5-rank.gold{background:linear-gradient(135deg,#FEF3C7,#FDE68A);font-size:18px;border:2px solid #F59E0B;}
.t5-rank.silver{background:linear-gradient(135deg,#F1F5F9,#E2E8F0);font-size:16px;border:2px solid #94A3B8;}
.t5-rank.bronze{background:linear-gradient(135deg,#FEF3C7,#FDE68A);font-size:16px;border:2px solid #D97706;opacity:0.85;}
.t5-info{flex:1;min-width:0;}
.t5-nm{font-size:14px;font-weight:700;line-height:1.4;}
.t5-meta{font-family:var(--fn);font-size:11px;color:var(--text3);margin-top:1px;}
.t5-spark{flex-shrink:0;width:80px;height:36px;}
.t5-right{text-align:right;flex-shrink:0;min-width:56px;}
.t5-sc{font-family:var(--fn);font-size:20px;font-weight:800;line-height:1.2;}
.t5-sc span{font-size:11px;font-weight:500;color:var(--text3);}
.t5-gauge{width:48px;height:4px;background:var(--border);border-radius:2px;margin:4px 0 3px auto;overflow:hidden;}
.t5-gauge-fill{height:100%;border-radius:2px;}
.t5-type{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;display:inline-block;}
.t5-type.dip{background:var(--green-bg);color:var(--green);}
.t5-type.mom{background:var(--blue-l);color:var(--blue);}
.t5-reason{font-size:12px;color:var(--text2);margin-top:5px;line-height:1.6;padding:8px 10px;background:var(--bg);border-radius:8px;border-left:3px solid var(--green);}
.t5-reason strong{color:var(--green);}
.t5-item.first-place{background:linear-gradient(135deg,#F0FDF4,#ECFDF5);}
.score-feel{display:inline-block;font-size:9px;font-weight:700;padding:2px 7px;border-radius:6px;margin-top:3px;}
.score-feel.great{background:#DCFCE7;color:#16A34A;}
.score-feel.good{background:#FEF3C7;color:#D97706;}
.score-feel.ok{background:#E8ECF2;color:#64748B;}
/* é…å½“ãƒãƒƒã‚¸ */
.div-badge{display:inline-flex;align-items:center;gap:2px;padding:2px 8px;border-radius:10px;font-family:var(--fn);font-size:11px;font-weight:800;background:var(--green-bg);color:var(--green);border:1px solid rgba(5,150,105,0.15);}
/* PC: 1ã‚«ãƒ©ãƒ æ¨ªé•·ã‚«ãƒ¼ãƒ‰+ä¸­å¤®å¯„ã› */
@media(min-width:700px){
  .logo-bar,.hero,.t5-sec,.share,.danger,.footer{max-width:720px;margin-left:auto;margin-right:auto;}
  .t5-grid{max-width:720px;margin:0 auto;}
  .t5-item{padding:16px 20px;gap:16px;}
  .t5-spark{width:140px;height:48px;}
  .t5-sc{font-size:24px;}
  .t5-nm{font-size:15px;}
  .t5-rank{width:34px;height:34px;font-size:15px;}
  .t5-reason{font-size:13px;}
  .div-badge{font-size:12px;padding:3px 10px;}
  .t5-expand{grid-column:1/-1;}
}

/* MARKET MODE */
.market-mode{margin:12px;padding:16px;border-radius:14px;border:2px solid;max-width:720px;}
@media(min-width:700px){.market-mode{margin:12px auto;}}
.market-mode.aggressive{border-color:#059669;background:linear-gradient(135deg,#F0FDF4,#ECFDF5);}
.market-mode.cautious{border-color:#EF4444;background:linear-gradient(135deg,#FEF2F2,#FEE2E2);}
.market-mode.normal{border-color:#F59E0B;background:linear-gradient(135deg,#FFFBEB,#FEF3C7);}
.mm-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.mm-label{font-size:18px;font-weight:800;}
.mm-score{font-size:11px;padding:3px 8px;border-radius:8px;font-weight:700;}
.mm-advice{font-size:13px;font-weight:700;margin-bottom:10px;line-height:1.5;}
.mm-signals{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.mm-sig{font-size:10px;padding:3px 8px;border-radius:6px;font-weight:600;background:rgba(0,0,0,0.05);}
.mm-sig.pos{color:#059669;}.mm-sig.neg{color:#EF4444;}.mm-sig.neu{color:#6B7280;}
.mm-news{margin-top:10px;padding-top:10px;border-top:1px solid rgba(0,0,0,0.08);}
.mm-news-title{font-size:11px;font-weight:700;color:var(--text2);margin-bottom:6px;}
.mm-news-item{font-size:11px;color:var(--text);line-height:1.6;padding:2px 0;}
.mm-news-src{font-size:9px;color:var(--text3);}
.mm-ai{margin-top:10px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.7);font-size:12px;line-height:1.7;color:var(--text);}
.mm-ai-header{font-size:11px;font-weight:700;color:var(--text2);margin-bottom:6px;}
.mm-toggle{font-size:10px;color:var(--blue);cursor:pointer;font-weight:600;}

/* SHARE */
.share{margin:10px auto;display:flex;gap:8px;max-width:720px;padding:0 12px;}
.share-btn{flex:1;padding:10px;border-radius:10px;text-align:center;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:var(--f);}
.share-btn.x{background:#0F1419;color:#fff;}.share-btn.line{background:#06C755;color:#fff;}.share-btn.copy{background:var(--card);color:var(--text2);border:1px solid var(--border);}

/* DANGER */
.danger{background:var(--red-bg);border-radius:var(--r);margin:10px 12px;padding:16px;border:1px solid #FDCFC4;}
.danger-ttl{font-size:12px;font-weight:700;color:var(--red);margin-bottom:8px;}
.danger-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(220,38,38,0.08);font-size:12px;}
.danger-row:last-child{border-bottom:none;}
.danger-nm{font-weight:700;}.danger-cd{font-family:var(--fn);font-size:10px;color:var(--text3);}
.danger-badge{font-size:10px;color:var(--red);font-weight:600;background:rgba(220,38,38,0.08);padding:2px 7px;border-radius:4px;}

/* AD */
.ad{margin:10px 12px;border-radius:var(--r);background:linear-gradient(135deg,var(--navy-bar),#2A4068);padding:16px 18px;display:flex;align-items:center;gap:12px;box-shadow:var(--sh);cursor:pointer;color:#fff;}
.ad-t{font-size:13px;font-weight:700;margin-bottom:2px;}.ad-d{font-size:10px;opacity:0.7;line-height:1.5;}
.ad-cta{padding:7px 16px;border-radius:8px;font-size:11px;font-weight:700;background:#fff;color:var(--navy-bar);white-space:nowrap;}
.ad-pr{font-size:8px;color:rgba(255,255,255,0.3);margin-top:5px;}

/* (old table/filter/detail CSS removed) */

/* QUADRANT */
/* (quadrant removed) */

/* BOTTOM NAV */
.bnav{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:5px 0 max(5px,env(safe-area-inset-bottom));z-index:100;max-width:960px;margin:0 auto;}
.bnav a{display:flex;flex-direction:column;align-items:center;gap:1px;font-size:9px;color:var(--text3);text-decoration:none;font-weight:600;padding:3px 8px;}.bnav a.active{color:var(--blue);}
.bnav-i{font-size:18px;line-height:1.2;}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(15,23,42,0.5);backdrop-filter:blur(3px);z-index:200;display:none;justify-content:center;align-items:center;}
.modal-bg.open{display:flex;}
.modal{background:var(--card);border-radius:16px;padding:24px;max-width:560px;width:90vw;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.15);}
.modal h3{font-size:15px;font-weight:800;margin-bottom:12px;}
.modal p{font-size:12px;line-height:1.8;color:var(--text2);margin-bottom:8px;}
.modal .close-btn{width:100%;margin-top:16px;padding:10px;font-size:13px;background:var(--navy-bar);border:none;color:#fff;border-radius:8px;cursor:pointer;font-family:var(--f);font-weight:700;}
.settings-panel{position:fixed;right:0;top:0;bottom:0;width:300px;max-width:85vw;background:var(--card);box-shadow:-4px 0 20px rgba(0,0,0,0.1);z-index:201;padding:24px;overflow-y:auto;transform:translateX(100%);transition:transform .2s;}
.settings-panel.open{transform:translateX(0);}

/* FOOTER */
.footer{text-align:center;padding:20px 12px;font-size:10px;color:var(--text3);line-height:1.6;}

/* RESPONSIVE */
@media(max-width:600px){
  .ticker-val{font-size:15px;}.hero-hl{font-size:16px;}
  .hero-big b{font-size:40px;}
}
@media(min-width:600px){.d-grid{grid-template-columns:1fr 1fr;}}

/* ANIMATION */
.fadein{animation:fadein .3s ease;}
@keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* æ¨ç§»ãƒãƒƒã‚¸ */
.rank-chg{font-size:9px;font-weight:700;margin-left:4px;padding:1px 5px;border-radius:6px;}
.rank-chg.up{background:var(--green-bg);color:var(--green);}
.rank-chg.dn{background:var(--red-bg);color:var(--red);}
.rank-chg.same{background:var(--border-l);color:var(--text3);}
.rank-chg.new{background:var(--amber-bg);color:var(--amber);}
/* å‡ºæ¥é«˜ãƒãƒƒã‚¸ */
.vol-badge{display:inline-flex;align-items:center;gap:2px;padding:2px 7px;border-radius:8px;font-family:var(--fn);font-size:10px;font-weight:700;}
.vol-badge.high{background:var(--amber-bg);color:var(--amber);}
.vol-badge.normal{background:var(--border-l);color:var(--text3);}
/* å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.hist-sec{margin:10px 12px;}
.hist-toggle{background:var(--card);border-radius:var(--r);padding:12px 16px;box-shadow:var(--sh);cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:13px;font-weight:700;color:var(--text2);}
.hist-toggle:hover{background:var(--blue-l);}
.hist-arrow{transition:transform .2s;font-size:10px;color:var(--text3);}
.hist-arrow.open{transform:rotate(180deg);}
.hist-body{background:var(--card);border-radius:0 0 var(--r) var(--r);box-shadow:var(--sh);margin-top:-4px;padding:0 16px 14px;animation:fadein .2s ease;}
.hist-day{margin-top:12px;}
.hist-day-ttl{font-size:11px;font-weight:700;color:var(--text2);padding:6px 0;border-bottom:1px solid var(--border);}
.hist-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border-l);font-size:12px;}
.hist-row:last-child{border-bottom:none;}
.hist-rank{width:20px;text-align:center;font-family:var(--fn);font-weight:800;color:var(--text2);}
.hist-nm{flex:1;font-weight:600;}.hist-sc{font-family:var(--fn);font-weight:800;}

/* â”€â”€ DETAIL EXPAND (TOP10å†…ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³) â”€â”€ */
.t5-expand{background:var(--bg);padding:18px;border-top:1px solid var(--border);border-left:4px solid var(--blue);animation:fadein .25s ease;}
.d-grid{display:grid;grid-template-columns:1fr;gap:14px;}
.d-sec-ttl{font-size:12px;font-weight:700;color:var(--text);margin-bottom:8px;display:flex;align-items:center;gap:5px;}
.d-chart-box{background:#FAFBFC;border-radius:10px;padding:10px 8px 6px;border:1px solid var(--border);overflow:hidden;}
.d-chart-svg{width:100%;height:auto;display:block;overflow:hidden;aspect-ratio:400/160;}
.d-legend{display:flex;gap:10px;padding:6px 0 2px;flex-wrap:wrap;}
.d-leg{display:flex;align-items:center;gap:3px;font-size:10px;color:var(--text2);}
.d-leg-ln{width:12px;height:2px;border-radius:1px;}
.d-leg b{font-family:var(--fn);font-weight:700;font-size:10px;}
.d-ma{display:flex;flex-direction:column;gap:5px;margin-top:14px;padding:10px;background:var(--card);border-radius:8px;border:1px solid var(--border);}
.d-ma-row{display:flex;align-items:center;gap:6px;font-size:11px;margin-top:4px;}
.d-ma-lbl{min-width:90px;color:var(--text2);font-weight:500;font-size:10px;}
.d-ma-bar{flex:1;height:16px;background:#DDE3EC;border-radius:3px;position:relative;overflow:hidden;border:1px solid var(--border);}
.d-ma-ctr{position:absolute;left:50%;top:0;bottom:0;width:1px;background:var(--text3);opacity:0.3;}
.d-ma-dot{position:absolute;top:50%;transform:translate(-50%,-50%);width:8px;height:8px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);}
.d-ma-val{min-width:48px;text-align:right;font-family:var(--fn);font-size:11px;font-weight:700;}
.d-ma-val.up{color:var(--green);}.d-ma-val.dn{color:var(--red);}
.d-ma-tag{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:3px;}
.d-ma-tag.near{background:var(--amber-bg);color:var(--amber);}
.d-pl{margin-top:8px;padding-top:8px;border-top:1px solid var(--border);}
.d-pl-row{display:flex;justify-content:space-between;padding:3px 0;font-size:11px;}
.d-pl-lbl{color:var(--text2);font-weight:500;}.d-pl-val{font-family:var(--fn);font-weight:700;}
.d-cards{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px;}
.d-card{text-align:center;padding:14px 8px;background:var(--card);border-radius:10px;border:1px solid var(--border);}
.d-card b{font-size:20px;}
.d-card b{font-family:var(--fn);font-size:18px;font-weight:800;display:block;}
.d-card small{font-size:9px;color:var(--text3);}
/* (safety rating uses inline styles now) */
.d-signal{background:var(--blue-l);border-radius:8px;padding:12px;margin-top:10px;border:1px solid rgba(27,106,201,0.12);}
.d-signal b{font-size:10px;font-weight:700;color:var(--blue);display:block;margin-bottom:4px;}
.d-signal p{font-size:11px;color:var(--text);line-height:1.7;margin:0;}
.d-btns{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap;}
.d-btn{padding:6px 14px;border-radius:8px;font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--card);color:var(--text2);cursor:pointer;font-family:var(--f);transition:all .15s;display:inline-flex;align-items:center;text-decoration:none;}
.d-btn:hover{border-color:var(--blue-m);color:var(--blue-m);}

/* SECTOR CHIPS */
.sector-scroll{overflow-x:auto;margin:0 12px 8px;-webkit-overflow-scrolling:touch;padding:2px 0;}
.sector-scroll::-webkit-scrollbar{display:none;}
.sector-inner{display:flex;gap:5px;}
.s-chip{white-space:nowrap;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;color:var(--text2);background:var(--card);border:1px solid var(--border);transition:all .15s;}
.s-chip:hover{border-color:var(--blue-m);}.s-chip.active{background:var(--blue);color:#fff;border-color:var(--blue);}
</style>
</head>
<body>

<!-- LOGO + TICKER -->
<div class="logo-bar">
  <div class="logo">ã‹ã¶ã®<span>ã™ã‘</span></div>
  <div class="ticker" id="tickerBar"></div>
</div>
<div style="text-align:center;padding:6px 12px 0;font-size:11px;color:var(--text3);max-width:720px;margin:0 auto">AIãŒæ¯æ—¥500éŠ˜æŸ„ä»¥ä¸Šã‚’ã‚¹ã‚­ãƒ£ãƒ³ â†’ ãŠã™ã™ã‚æ ªã‚’è‡ªå‹•ã§é¸å®š</div>

<!-- MARKET MODE BANNER -->
<div id="marketMode" class="market-mode" style="display:none"></div>

<!-- HERO CONCLUSION -->
<div class="hero" id="heroBox"></div>

<!-- SECTOR TREND -->
<div class="t5-sec" id="sectorSection" style="display:none">
  <div style="padding:16px;background:var(--card);border-bottom:1px solid var(--border)">
    <div style="font-weight:700;font-size:15px;margin-bottom:8px">ğŸ“ˆ ã‚»ã‚¯ã‚¿ãƒ¼ãƒˆãƒ¬ãƒ³ãƒ‰</div>
    <div style="font-size:11px;color:var(--text3);margin-bottom:12px">é…å½“Ã—ãƒªã‚¿ãƒ¼ãƒ³Ã—å‡ºæ¥é«˜ã‹ã‚‰è‡ªå‹•ç®—å‡ºã€‚æ¯æ—¥æ›´æ–°ã€‚</div>
    <div id="sectorBars"></div>
    <div id="sectorTheme" style="margin-top:12px;font-size:12px;color:var(--text2)"></div>
  </div>
</div>

<!-- TOP10 -->
<div class="t5-sec" id="top5Section" style="display:none">
  <div class="t5-tabs">
    <div class="t5-tab active" id="t5TabDip" onclick="setTop5Tab('dip')">ğŸ“‰ å‰²å®‰ãƒãƒ£ãƒ³ã‚¹ TOP10</div>
    <div class="t5-tab" id="t5TabMom" onclick="setTop5Tab('mom')">ğŸ“ˆ ä¸Šæ˜‡ä¸­ TOP10</div>
  </div>
  <div id="t5Subtitle" style="padding:8px 16px;font-size:11px;color:var(--text3);background:var(--card);border-bottom:1px solid var(--border);line-height:1.5">
    <span id="t5SubText">ğŸ“‰ å€¤ä¸‹ãŒã‚Šã—ãŸä»ŠãŒè²·ã„æ™‚ã®æ ªã€‚75æ—¥å¹³å‡ï¼ˆè²·ã„ãƒ©ã‚¤ãƒ³ï¼‰ã«è¿‘ã¥ã„ãŸå‰²å®‰éŠ˜æŸ„ã§ã™</span>
    <div style="margin-top:4px;font-size:10px;color:var(--blue)">ğŸ‘‡ æ°—ã«ãªã‚‹éŠ˜æŸ„ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è©³ç´°ã‚’è¦‹ã¦ã¿ã‚ˆã†</div>
  </div>
  <div class="t5-body" id="top5Body"></div>
</div>

<!-- DANGER -->
<div id="dangerSection" style="max-width:720px;margin:0 auto"></div>

<!-- HISTORY -->
<div class="hist-sec" id="histSection" style="display:none">
  <div class="hist-toggle" onclick="toggleHistory()">
    <span>ğŸ“… æ˜¨æ—¥ãƒ»ä¸€æ˜¨æ—¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
    <span class="hist-arrow" id="histArrow">â–¼</span>
  </div>
  <div class="hist-body" id="histBody" style="display:none"></div>
</div>

<!-- SHARE -->
<div class="share">
  <button class="share-btn x" onclick="shareX()">ğ• ã§ã‚·ã‚§ã‚¢</button>
  <button class="share-btn line" onclick="shareLine()">LINE ã§é€ã‚‹</button>
  <button class="share-btn copy" onclick="copyLink()">ğŸ”— ã‚³ãƒ”ãƒ¼</button>
</div>

<!-- AD #1 -->
<div class="ad" id="adSlot1" onclick="gaEvent('ad_click',{slot:'top'})">
  <div style="flex:1"><div class="ad-t">ğŸ“ˆ æŠ¼ã—ç›®ã§è²·ã†ãªã‚‰ SBIè¨¼åˆ¸</div><div class="ad-d">NISAå¯¾å¿œãƒ»æ‰‹æ•°æ–™0å††ã€‚ã‹ã¶ã®ã™ã‘ã®éŠ˜æŸ„ã‚’ã™ãè³¼å…¥</div><div class="ad-pr">PR</div></div>
  <div class="ad-cta">å£åº§é–‹è¨­ â†’</div>
</div>

<!-- AD #2 -->
<div class="ad" id="adSlot2" onclick="gaEvent('ad_click',{slot:'bottom'})" style="background:linear-gradient(135deg,#059669,#047857)">
  <div style="flex:1"><div class="ad-t">ğŸ¯ NISAã§é«˜é…å½“æ ªã‚’å§‹ã‚ã‚ˆã†</div><div class="ad-d">éèª²ç¨ã§é…å½“é‡‘ã‚’å—ã‘å–ã‚Šã€‚ã‹ã¶ã®ã™ã‘éŠ˜æŸ„ã‚’NISAã§é•·æœŸä¿æœ‰</div><div class="ad-pr">PR</div></div>
  <div class="ad-cta" style="color:#059669">è©³ã—ãè¦‹ã‚‹ â†’</div>
</div>

<!-- FOOTER -->
<div class="footer">
  â€» æœ¬ã‚µã‚¤ãƒˆã¯æŠ•è³‡åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æŠ•è³‡åˆ¤æ–­ã¯è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚<br>
  ã‹ã¶ã®ã™ã‘ = ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«Ã—çŸ­æœŸã®æŠ¼ã—ç›®ã‚¹ã‚³ã‚¢ï¼ˆã‚µãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã§è²·ã„å ´ã‚’æ¤œå‡ºï¼‰<br>
  ã‹ã¶ã®ã™ã‘ v7.5 Â· æ¯æœ7:30è‡ªå‹•æ›´æ–°<br>
  <a href="#" onclick="openLogic();return false" style="color:var(--blue-m);text-decoration:none;font-weight:600">ğŸ“ ã‚¹ã‚³ã‚¢ã®ä»•çµ„ã¿ã‚’è¦‹ã‚‹</a>
</div>

<!-- LOGIC MODAL -->
<div class="modal-bg" id="logicModal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal">
    <h3>ğŸ“ ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ v7</h3>
    <p><strong style="color:var(--text)">ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼š</strong>å¤§æ‰‹ã®å®‰å®šä¸Šæ˜‡æ ªã‚’ã€ã€Œä¸‹ãŒã‚Šã«ãã„ä¾¡æ ¼å¸¯ã€ã¾ã§ä¸‹ãŒã£ãŸæ™‚ã«è²·ã†</p>
    <table style="width:100%;font-size:11px;border-collapse:collapse;margin:8px 0">
      <tr style="background:var(--blue);color:#fff"><th style="padding:6px 8px;text-align:left">è¦ç´ </th><th style="padding:6px 8px;text-align:right">é…ç‚¹</th><th style="padding:6px 8px;text-align:left">æ„å‘³</th></tr>
      <tr><td style="padding:5px 8px;border-bottom:1px solid var(--border)">ã‚µãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã¨ã®è·é›¢</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border)"><strong>25ç‚¹</strong></td><td style="padding:5px 8px;border-bottom:1px solid var(--border)">åç™ºã—ã‚„ã™ã„ä¾¡æ ¼å¸¯ã«è¿‘ã„ï¼è²·ã„æ™‚</td></tr>
      <tr><td style="padding:5px 8px;border-bottom:1px solid var(--border)">çŸ­æœŸã®ç›®å®‰ã¨ã®å·®</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border)">15ç‚¹</td><td style="padding:5px 8px;border-bottom:1px solid var(--border)">çŸ­æœŸçš„ã«ã©ã‚Œã ã‘èª¿æ•´ã—ã¦ã„ã‚‹ã‹</td></tr>
      <tr><td style="padding:5px 8px;border-bottom:1px solid var(--border)">20æ—¥ãƒªã‚¿ãƒ¼ãƒ³</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border)">15ç‚¹</td><td style="padding:5px 8px;border-bottom:1px solid var(--border)">ç›´è¿‘ã®æ–¹å‘</td></tr>
      <tr><td style="padding:5px 8px;border-bottom:1px solid var(--border)">120æ—¥ãƒªã‚¿ãƒ¼ãƒ³</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border)">10ç‚¹</td><td style="padding:5px 8px;border-bottom:1px solid var(--border)">é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰</td></tr>
      <tr><td style="padding:5px 8px;border-bottom:1px solid var(--border)">60æ—¥ãƒªã‚¿ãƒ¼ãƒ³</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border)">10ç‚¹</td><td style="padding:5px 8px;border-bottom:1px solid var(--border)">ä¸­æœŸãƒˆãƒ¬ãƒ³ãƒ‰</td></tr>
      <tr><td style="padding:5px 8px;border-bottom:1px solid var(--border)">æŒã£ã¦ã¦å®‰å¿ƒ</td><td style="padding:5px 8px;text-align:right;border-bottom:1px solid var(--border)">15ç‚¹</td><td style="padding:5px 8px;border-bottom:1px solid var(--border)">é…å½“+å®‰å®š+å¤§å‹</td></tr>
      <tr><td style="padding:5px 8px">ä¸€è²«æ€§ãƒœãƒ¼ãƒŠã‚¹</td><td style="padding:5px 8px;text-align:right">Â±10ç‚¹</td><td style="padding:5px 8px">ãƒˆãƒ¬ãƒ³ãƒ‰ã®ä¿¡é ¼æ€§</td></tr>
    </table>
    <p><strong style="color:var(--text)">ğŸ· ã‚¿ã‚¤ãƒ—è‡ªå‹•åˆ¤å®šï¼š</strong></p>
    <p>ğŸ›¡ æŠ¼ã—ç›® â€” ã‚µãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã®ä¸Šã§çŸ­æœŸèª¿æ•´ä¸­ = è²·ã„ãƒãƒ£ãƒ³ã‚¹<br>ğŸš€ å‹¢ã„ â€” ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰å…¨é–‹ = æµã‚Œã«ä¹—ã‚‹<br>âš  è½ã¡ã‚‹ãƒŠã‚¤ãƒ• â€” ã‚µãƒãƒ¼ãƒˆå‰²ã‚Œ = ä»Šã¯è§¦ã‚‰ãªã„<br>ğŸ”„ åç™º â€” ä¸‹è½å¾Œã«æŒã¡ç›´ã—ã®å…†ã— = æ§˜å­è¦‹</p>
    <button class="close-btn" onclick="document.getElementById('logicModal').classList.remove('open')">âœ• é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- SETTINGS -->
<div class="settings-panel" id="settingsPanel">
  <h3 style="font-size:15px;font-weight:800;margin-bottom:16px">âš™ è¨­å®š</h3>
  <div style="margin-bottom:16px">
    <div style="font-size:11px;font-weight:600;color:var(--text2);margin-bottom:6px">æœ€ä½é…å½“åˆ©å›ã‚Š</div>
    <div style="display:flex;align-items:center;gap:8px">
      <input type="range" id="minDivSlider" min="0" max="5" step="0.5" value="0" oninput="settings.mindiv=parseFloat(this.value);document.getElementById('minDivVal').textContent=this.value+'%';run();" style="flex:1">
      <span id="minDivVal" style="font-family:var(--fn);font-size:12px">0%</span>
    </div>
  </div>
  <div style="margin-bottom:16px">
    <div style="font-size:11px;font-weight:600;color:var(--text2);margin-bottom:6px">ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ</div>
    <div id="watchlistDisp" style="font-size:11px;color:var(--text3)"></div>
  </div>
  <button class="close-btn" onclick="document.getElementById('settingsPanel').classList.remove('open')">âœ• é–‰ã˜ã‚‹</button>
</div>

<!-- BOTTOM NAV -->
<nav class="bnav">
  <a href="#" class="active" onclick="return false"><span class="bnav-i">ğŸ </span>ãƒ›ãƒ¼ãƒ </a>
  <a href="#" onclick="document.getElementById('top5Section').scrollIntoView({behavior:'smooth'});return false"><span class="bnav-i">ğŸ“‹</span>TOP10</a>
  <a href="#" onclick="return false"><span class="bnav-i">â­</span>ã‚¦ã‚©ãƒƒãƒ</a>
  <a href="#" onclick="document.getElementById('settingsPanel').classList.toggle('open');return false"><span class="bnav-i">âš™</span>è¨­å®š</a>
  <a href="#" onclick="shareX();return false"><span class="bnav-i">ğŸ“¤</span>ã‚·ã‚§ã‚¢</a>
</nav>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KABUNOSUKE v7 â€” MA75 QualityÃ—Timing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SAMPLE_STOCKS=[
{code:"8316",name:"ä¸‰äº•ä½å‹FG",sector:"éŠ€è¡Œæ¥­",price:3200,ma25:3300,ma75:3100,rsi:38,dividend:3.8,pbr:0.9,per:11,vol_r:1.1,market_cap_b:9500,volatility:1.5,ret5:-2.5,ret10:-1.8,ret20:-3.2,ret60:8.5,ret120:22,roe:12,ma25_dev:-3.0,ma75_dev:3.2,trend_type:"dip",closes_60d:[]},
{code:"9433",name:"KDDI",sector:"æƒ…å ±ãƒ»é€šä¿¡æ¥­",price:4800,ma25:4900,ma75:4700,rsi:41,dividend:3.2,pbr:1.8,per:14,vol_r:0.9,market_cap_b:11000,volatility:1.2,ret5:-1.8,ret10:-0.5,ret20:-2.1,ret60:5.2,ret120:12,roe:15,ma25_dev:-2.1,ma75_dev:2.1,trend_type:"dip",closes_60d:[]},
];
const SECTOR_MAP={"éŠ€è¡Œæ¥­":"ğŸ¦ éŠ€è¡Œ","ãƒ¡ã‚¬ãƒãƒ³ã‚¯":"ğŸ¦ ãƒ¡ã‚¬ãƒãƒ³ã‚¯","æƒ…å ±ãƒ»é€šä¿¡æ¥­":"ğŸ“¡ é€šä¿¡","é€šä¿¡ã‚­ãƒ£ãƒªã‚¢":"ğŸ“¡ é€šä¿¡ã‚­ãƒ£ãƒªã‚¢","é›»æ°—æ©Ÿå™¨":"âš¡ é›»æ©Ÿ","è¼¸é€ç”¨æ©Ÿå™¨":"ğŸš— è‡ªå‹•è»Š","åŒ»è–¬å“":"ğŸ’Š åŒ»è–¬","åŒ–å­¦":"ğŸ§ª åŒ–å­¦","å¸å£²æ¥­":"ğŸ“¦ å•†ç¤¾","ç·åˆå•†ç¤¾":"ğŸ“¦ ç·åˆå•†ç¤¾","ä¿é™ºæ¥­":"ğŸ›¡ ä¿é™º","å»ºè¨­æ¥­":"ğŸ— å»ºè¨­","é£Ÿæ–™å“":"ğŸ™ é£Ÿå“","ä¸å‹•ç”£æ¥­":"ğŸ  ä¸å‹•ç”£","é™¸é‹æ¥­":"ğŸšƒ é™¸é‹","æ©Ÿæ¢°":"âš™ æ©Ÿæ¢°","é‰„é‹¼":"ğŸ”© é‰„é‹¼","ã‚µãƒ¼ãƒ“ã‚¹æ¥­":"ğŸ’¼ ã‚µãƒ¼ãƒ“ã‚¹","å°å£²æ¥­":"ğŸ›’ å°å£²","ãã®ä»–é‡‘èæ¥­":"ğŸ’³ é‡‘è","ã‚¬ãƒ©ã‚¹ãƒ»åœŸçŸ³è£½å“":"ğŸ§± ã‚¬ãƒ©ã‚¹","éé‰„é‡‘å±":"ğŸ”§ éé‰„","ç¹Šç¶­è£½å“":"ğŸ‘• ç¹Šç¶­","çŸ³æ²¹ãƒ»çŸ³ç‚­è£½å“":"â›½ çŸ³æ²¹","é›»æ°—ãƒ»ã‚¬ã‚¹æ¥­":"ğŸ’¡ é›»åŠ›","æµ·é‹æ¥­":"ğŸš¢ æµ·é‹","ç©ºé‹æ¥­":"âœˆ ç©ºé‹","é‰±æ¥­":"â› é‰±æ¥­","ãƒ‘ãƒ«ãƒ—ãƒ»ç´™":"ğŸ“„ ç´™ãƒ‘","ã‚´ãƒ è£½å“":"ğŸ”´ ã‚´ãƒ ","é‡‘å±è£½å“":"ğŸ”¨ é‡‘å±","ç²¾å¯†æ©Ÿå™¨":"ğŸ”¬ ç²¾å¯†","æ°´ç”£ãƒ»è¾²æ—æ¥­":"ğŸŸ æ°´ç”£","å€‰åº«ãƒ»é‹è¼¸é–¢é€£æ¥­":"ğŸ“¦ å€‰åº«","ãã®ä»–è£½å“":"ğŸ¯ ãã®ä»–è£½å“","è¨¼åˆ¸ã€å•†å“å…ˆç‰©å–å¼•æ¥­":"ğŸ“ˆ è¨¼åˆ¸","ã‚²ãƒ¼ãƒ ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡":"ğŸ® ã‚²ãƒ¼ãƒ ","åŠå°ä½“":"ğŸ’ åŠå°ä½“","ITãƒ»SaaS":"ğŸ’» SaaS","ITãƒ»ãƒãƒƒãƒˆ":"ğŸŒ IT","Technology":"ğŸ’» ãƒ†ãƒƒã‚¯","Communication Services":"ğŸ“¡ é€šä¿¡","Financial Services":"ğŸ’³ é‡‘è","Consumer Cyclical":"ğŸ›’ æ¶ˆè²»","Consumer Defensive":"ğŸ™ ç”Ÿæ´»å¿…éœ€","Healthcare":"ğŸ’Š åŒ»è–¬","Industrials":"âš™ ç”£æ¥­","Basic Materials":"ğŸ§ª ç´ æ","Energy":"â›½ ã‚¨ãƒãƒ«ã‚®ãƒ¼","Real Estate":"ğŸ  ä¸å‹•ç”£","Utilities":"ğŸ’¡ å…¬ç›Š"};
const TREND_LABEL={"dip":"ğŸ“‰ å‰²å®‰","momentum":"ğŸ“ˆ ä¸Šæ˜‡ä¸­","falling":"âš  ä¸‹è½ä¸­","bounce":"ğŸ”„ åç™º","neutral":"ğŸ˜ æ§˜å­è¦‹","avoid":"ğŸš« å¯¾è±¡å¤–","value_dip":"ğŸ’ é€†å¼µã‚Šãƒãƒ£ãƒ³ã‚¹"};
let RAW=[],processed=[],EVENTS=[];
let histYesterday=null,histDayBefore=null;
let settings={mindiv:0,style:'trend',disp:10,zone:'all',sort:'score',sortDir:-1,sector:'all',top5tab:'dip'};
let favorites=JSON.parse(localStorage.getItem('kbn_fav')||'[]');


// â”€â”€ LocalStorage â”€â”€
try{
  const sv=JSON.parse(localStorage.getItem('kbn_settings')||'{}');
  if(sv.mindiv!==undefined)settings.mindiv=sv.mindiv;
}catch(e){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcMA(prices,period){
  return prices.map((v,i)=>{
    if(i<period-1)return null;
    let s=0;for(let j=i-period+1;j<=i;j++)s+=prices[j];return s/period;
  });
}
function toPath(vals,w,h,pad,mn,mx){
  const pts=[];const rng=mx-mn||1;
  vals.forEach((v,i)=>{
    if(v===null)return;
    const x=pad+(i/(vals.length-1))*(w-2*pad);
    const y=pad+(1-(v-mn)/rng)*(h-2*pad);
    pts.push(`${pts.length?'L':'M'}${x.toFixed(1)},${y.toFixed(1)}`);
  });
  return pts.join(' ');
}
function drawSpark(el,closes,w,h){
  if(!closes||!closes.length||!el)return;
  const pad=2;
  const ma=calcMA(closes,20);
  const all=closes.concat(ma.filter(v=>v!==null));
  const mn=Math.min(...all),mx=Math.max(...all);
  const pp=toPath(closes,w,h,pad,mn,mx);
  const mp=toPath(ma,w,h,pad,mn,mx);
  const lastX=pad+((closes.length-1)/(closes.length-1))*(w-2*pad);
  const isUp=closes[closes.length-1]>=closes[0];
  const col=isUp?'#059669':'#DC2626';
  const id='sg_'+Math.random().toString(36).substr(2,6);
  el.innerHTML=`<defs><linearGradient id="${id}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${col}" stop-opacity="0.15"/><stop offset="100%" stop-color="${col}" stop-opacity="0.01"/></linearGradient></defs>`+
    `<path d="${pp} L${lastX},${h-pad} L${pad},${h-pad} Z" fill="url(#${id})"/>`+
    `<path d="${mp}" fill="none" stroke="#059669" stroke-width="1" opacity="0.5"/>`+
    `<path d="${pp}" fill="none" stroke="${col}" stroke-width="1.5"/>`;
}
function drawDetailChart(el,closes,ma25v,ma75v){
  if(!closes||!closes.length||!el)return;
  const W=400,H=160,P=6,PR=45; // PR=å³å´ã®Yè»¸ãƒ©ãƒ™ãƒ«ç”¨ä½™ç™½
  const ma25calc=calcMA(closes,25);
  const allVals=[...closes,...ma25calc.filter(v=>v!==null)];
  if(ma75v&&ma75v>0)allVals.push(ma75v);
  if(ma25v&&ma25v>0)allVals.push(ma25v);
  let mn=Math.min(...allVals),mx=Math.max(...allVals);
  const range=mx-mn||1;
  mn-=range*0.06;mx+=range*0.06;
  const rng=mx-mn||1;

  // ã‚°ãƒªãƒƒãƒ‰é–“éš”ã‚’è‡ªå‹•è¨ˆç®—ï¼ˆãã‚Šã®ã„ã„æ•°å­—ï¼‰
  function niceStep(r){
    const raw=r/4; // 4æœ¬ãã‚‰ã„ã®ã‚°ãƒªãƒƒãƒ‰
    const mag=Math.pow(10,Math.floor(Math.log10(raw)));
    const norm=raw/mag;
    if(norm<=1.5)return mag;
    if(norm<=3.5)return 2.5*mag;
    if(norm<=7.5)return 5*mag;
    return 10*mag;
  }
  const step=niceStep(rng);
  const gridStart=Math.ceil(mn/step)*step;

  // ã‚°ãƒªãƒƒãƒ‰ç·š+Yè»¸ãƒ©ãƒ™ãƒ«
  let gridLines='';
  for(let v=gridStart;v<=mx;v+=step){
    const y=P+(1-(v-mn)/rng)*(H-2*P);
    if(y<P+2||y>H-P-10)continue;
    gridLines+=`<line x1="${P}" y1="${y}" x2="${W-PR}" y2="${y}" stroke="#E2E8F0" stroke-width="0.8"/>`;
    // é‡‘é¡ãƒ©ãƒ™ãƒ«ï¼ˆå³å´ï¼‰
    let label;
    if(v>=10000)label=`Â¥${(v/1000).toFixed(v%1000===0?0:1)}k`;
    else label=`Â¥${Math.round(v).toLocaleString()}`;
    gridLines+=`<text x="${W-PR+4}" y="${y+3}" font-size="8" fill="#94A3B8" font-family="sans-serif">${label}</text>`;
  }

  const CW=W-PR; // ãƒãƒ£ãƒ¼ãƒˆæç”»å¹…
  const pp=toPath(closes,CW,H,P,mn,mx);
  const lastX=P+((closes.length-1)/(closes.length-1))*(CW-2*P);
  const lastY=P+(1-(closes[closes.length-1]-mn)/rng)*(H-2*P);
  const id='dg_'+Math.random().toString(36).substr(2,6);

  // MA75 â€” ç´°ã„å®Ÿç·šï¼ˆæ§ãˆã‚ï¼‰
  let ma75line='';
  if(ma75v&&ma75v>0){
    let y75=P+(1-(ma75v-mn)/rng)*(H-2*P);
    y75=Math.max(P+2,Math.min(H-P-2,y75));
    ma75line=`<line x1="${P}" y1="${y75}" x2="${CW-P}" y2="${y75}" stroke="#059669" stroke-width="1.2" opacity="0.5"/>`;
  }
  // MA25æ›²ç·š
  const ma25path=toPath(ma25calc,CW,H,P,mn,mx);
  el.setAttribute('viewBox',`0 0 ${W} ${H}`);
  el.innerHTML=`<defs><linearGradient id="${id}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1B6AC9" stop-opacity="0.10"/><stop offset="100%" stop-color="#1B6AC9" stop-opacity="0.01"/></linearGradient></defs>`+
    gridLines+
    `<path d="${pp} L${lastX},${H-P} L${P},${H-P} Z" fill="url(#${id})"/>`+
    ma75line+
    `<path d="${ma25path}" fill="none" stroke="#F59E0B" stroke-width="1.2" opacity="0.6"/>`+
    `<path d="${pp}" fill="none" stroke="#1A1A1A" stroke-width="2.2"/>`+
    `<circle cx="${lastX}" cy="${lastY}" r="4" fill="#DC2626" stroke="#fff" stroke-width="2"/>`+
    `<text x="${P}" y="${H-1}" font-size="9" fill="#B0B8C4" font-family="sans-serif">60æ—¥å‰</text>`+
    `<text x="${CW-P}" y="${H-1}" font-size="9" fill="#B0B8C4" text-anchor="end" font-family="sans-serif">ä»Šæ—¥</text>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECTOR SCOREï¼ˆå‹•çš„ã‚»ã‚¯ã‚¿ãƒ¼ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sectorScores={};  // JSONã‹ã‚‰èª­ã¿è¾¼ã¿
let sectorRankMap={};  // ã‚»ã‚¯ã‚¿ãƒ¼åâ†’ãƒ©ãƒ³ã‚¯é †ä½ãƒœãƒ¼ãƒŠã‚¹ã®ãƒãƒƒãƒ—

function buildSectorRankMap(){
  // sectorScoresã‚’ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ãƒ©ãƒ³ã‚¯åŠ ç‚¹ã‚’å‰²ã‚Šå½“ã¦
  const entries=Object.entries(sectorScores).sort((a,b)=>b[1].score-a[1].score);
  const bonuses=[8,7,6,5,4,3,2,1];  // 1ä½=8ç‚¹ã€œ8ä½=1ç‚¹
  sectorRankMap={};
  entries.forEach(([name,d],i)=>{
    sectorRankMap[name]=i<bonuses.length?bonuses[i]:0;
  });
}

function getSectorBonus(sector,code){
  // yfinanceã®è‹±èªã‚»ã‚¯ã‚¿ãƒ¼åã‚’æ—¥æœ¬èªã«å¤‰æ›ã—ã¦ç…§åˆ
  const SECTOR_JP_MAP={
    'Financial Services':'é‡‘è','Basic Materials':'ç´ æ',
    'Energy':'ã‚¨ãƒãƒ«ã‚®ãƒ¼','Industrials':'ç”£æ¥­',
    'Real Estate':'ä¸å‹•ç”£','Consumer Cyclical':'æ¶ˆè²»ï¼ˆæ™¯æ°—æ•æ„Ÿï¼‰',
    'Consumer Defensive':'æ¶ˆè²»ï¼ˆå®‰å®šï¼‰','Healthcare':'åŒ»è–¬ãƒ»ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢',
    'Technology':'ãƒ†ãƒƒã‚¯','Communication Services':'é€šä¿¡ãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢',
    'Utilities':'é›»åŠ›ãƒ»ã‚¬ã‚¹'
  };
  // è¡¨ç¤ºåâ†’ã‚¹ã‚³ã‚¢ã‚­ãƒ¼ã®è£œåŠ©ãƒãƒƒãƒ
  const DISP_TO_KEY={"ãƒ¡ã‚¬ãƒãƒ³ã‚¯":"é‡‘è","åœ°éŠ€":"é‡‘è","è¨¼åˆ¸":"é‡‘è","ä¿é™º":"é‡‘è",
    "ãƒªãƒ¼ã‚¹":"é‡‘è","ç·åˆå•†ç¤¾":"ç”£æ¥­","å•†ç¤¾":"ç”£æ¥­","é‰„é‹¼":"ç´ æ","åŒ–å­¦":"ç´ æ",
    "å»ºè¨­":"ç”£æ¥­","é›»åŠ›":"é›»åŠ›ãƒ»ã‚¬ã‚¹","ã‚¬ã‚¹":"é›»åŠ›ãƒ»ã‚¬ã‚¹","é€šä¿¡":"é€šä¿¡ãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢",
    "æµ·é‹":"ç”£æ¥­","è‡ªå‹•è»Š":"ç”£æ¥­","é‡å·¥":"ç”£æ¥­","æ©Ÿæ¢°":"ç”£æ¥­","ä¸å‹•ç”£":"ä¸å‹•ç”£",
    "ä½å®…":"ä¸å‹•ç”£","åŠå°ä½“":"ãƒ†ãƒƒã‚¯","IT":"ãƒ†ãƒƒã‚¯","SaaS":"ãƒ†ãƒƒã‚¯","ã‚²ãƒ¼ãƒ ":"ãƒ†ãƒƒã‚¯",
    "é£Ÿå“":"æ¶ˆè²»ï¼ˆå®‰å®šï¼‰","åŒ»è–¬":"åŒ»è–¬ãƒ»ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢","ã‚¨ãƒãƒ«ã‚®ãƒ¼":"ã‚¨ãƒãƒ«ã‚®ãƒ¼"};
  // ã¾ãšç›´æ¥ãƒãƒƒãƒ
  if(sectorRankMap[sector])return sectorRankMap[sector];
  // è‹±èªâ†’æ—¥æœ¬èªå¤‰æ›ã—ã¦ãƒãƒƒãƒ
  const jpName=SECTOR_JP_MAP[sector];
  if(jpName&&sectorRankMap[jpName])return sectorRankMap[jpName];
  // CODE_SECTORã®è¡¨ç¤ºåã‹ã‚‰ãƒãƒƒãƒ
  const dispName=sMap(sector,code);
  for(const[kw,scKey]of Object.entries(DISP_TO_KEY)){
    if(dispName.includes(kw)&&sectorRankMap[scKey])return sectorRankMap[scKey];
  }
  // éƒ¨åˆ†ä¸€è‡´
  for(const[key,bonus]of Object.entries(sectorRankMap)){
    if(key.includes(sector||'')||( sector||'').includes(key))return bonus;
  }
  return 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORE (JSç‰ˆ â€” Pythonå´ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcScoreTrend(s){
  const mc=s.market_cap_b||0;
  if(mc<300)return{score:0,type:'avoid'};
  let sc=0;
  const r120=s.ret120||0,r60=s.ret60||0,r20=s.ret20||0;
  const ma75d=s.ma75_dev||0,ma25d=s.ma25_dev||0;
  const div=s.dividend||0,vol=s.volatility||2;

  // â”€â”€ æ™‚ä¾¡ç·é¡ (18pt) â”€â”€ å¤§å‹ï¼å®‰å¿ƒï¼å‹è² ã§ãã‚‹ã€‚1000å„„ã”ã¨ã«åŠ ç‚¹ã€‚
  if(mc>=30000)sc+=18;else if(mc>=10000)sc+=15;else if(mc>=5000)sc+=12;
  else if(mc>=3000)sc+=8;else if(mc>=1000)sc+=4;else if(mc>=500)sc+=2;

  // â”€â”€ é…å½“åˆ©å›ã‚Š (15pt) â”€â”€ åˆ©å›ã‚ŠãŒå®‰å¿ƒã®æ ¹æ‹ 
  if(div>=5)sc+=15;else if(div>=4)sc+=13;else if(div>=3.5)sc+=11;
  else if(div>=3)sc+=9;else if(div>=2.5)sc+=6;else if(div>=2)sc+=3;else if(div>=1)sc+=1;

  // â”€â”€ MA75ä¹–é›¢ (20pt) â”€â”€ 75æ—¥å¹³å‡æ¥è¿‘ï¼è²·ã„å ´
  if(ma75d>=0&&ma75d<=1)sc+=20;else if(ma75d>=0&&ma75d<=2)sc+=18;else if(ma75d>=0&&ma75d<=3)sc+=15;
  else if(ma75d>=0&&ma75d<=5)sc+=11;else if(ma75d>=0&&ma75d<=8)sc+=8;else if(ma75d>=0&&ma75d<=12)sc+=5;
  else if(ma75d>12)sc+=2;
  else if(ma75d>=-2&&ma75d<0)sc+=3;
  else if(ma75d>=-5&&ma75d<-2)sc+=0;
  else sc-=5;

  // â”€â”€ MA25æŠ¼ã—ç›® (10pt)
  if(ma25d>=-5&&ma25d<=-3)sc+=10;else if(ma25d>=-8&&ma25d<-5)sc+=7;else if(ma25d>=-3&&ma25d<=-1)sc+=8;
  else if(ma25d>-1&&ma25d<=0)sc+=5;else if(ma25d>0&&ma25d<=3)sc+=3;else if(ma25d>3)sc+=6;else if(ma25d<-8)sc+=2;

  // â”€â”€ å®‰å®šæ€§ (8pt) â”€â”€ ä½ãƒœãƒ©ï¼ä¸‹ãŒã£ã¦ã‚‚ã„ãšã‚Œä¸ŠãŒã‚‹
  if(vol<=1.2)sc+=8;else if(vol<=1.5)sc+=6;else if(vol<=2.0)sc+=4;else if(vol<=2.5)sc+=2;else if(vol>3.5)sc-=3;

  // â”€â”€ 120æ—¥ãƒªã‚¿ãƒ¼ãƒ³ (8pt)
  if(r120>=30)sc+=8;else if(r120>=15)sc+=7;else if(r120>=5)sc+=5;else if(r120>=0)sc+=3;else if(r120>=-5)sc+=0;else sc-=2;

  // â”€â”€ 60æ—¥ãƒªã‚¿ãƒ¼ãƒ³ (8pt)
  if(r60>=15)sc+=8;else if(r60>=8)sc+=7;else if(r60>=3)sc+=5;else if(r60>=0)sc+=2;else if(r60>=-5)sc+=0;else sc-=2;

  // â”€â”€ 20æ—¥ãƒªã‚¿ãƒ¼ãƒ³ (5pt)
  if(r20>=10)sc+=5;else if(r20>=5)sc+=4;else if(r20>=2)sc+=3;else if(r20>=0)sc+=2;
  else if(r20>=-3)sc+=3;else if(r20>=-5)sc+=4;else if(r20>=-8)sc+=3;else sc+=1;

  // â”€â”€ ä¸€è²«æ€§ (Â±8pt) â”€â”€ çŸ­ä¸­é•·æœŸã®æ–¹å‘ãŒæƒã£ã¦ã‚‹ã‹
  const pc=[r120,r60,r20].filter(r=>r>0).length;
  if(pc===3)sc+=8;else if(pc===2)sc+=4;else if(pc===0)sc-=4;

  // â”€â”€ ãƒšãƒŠãƒ«ãƒ†ã‚£ â”€â”€
  const vr1d=s.vol_ratio_1d||1,ret1d=s.ret_1d||0,rsi=s.rsi||50;
  if(vr1d>=3&&ret1d<=-3)sc-=10;if(vr1d>=3&&ret1d>=5)sc-=8;if(rsi>=80)sc-=5;
  // ä½é…å½“ãƒšãƒŠãƒ«ãƒ†ã‚£å¼·åŒ–ï¼ˆåˆ©å›ã‚Š1%æœªæº€ã¯ã‹ãªã‚Šæ¸›ç‚¹ï¼‰
  if(div<1)sc-=10;else if(div<1.5)sc-=5;

  // ãƒšãƒŠãƒ«ãƒ†ã‚£å¾Œã®ã‚¹ã‚³ã‚¢ã‚’0ä»¥ä¸Šã«ç¶­æŒï¼ˆä¸Šé™ã‚¯ãƒ©ãƒ³ãƒ—ã¯æœ€å¾Œã«1å›ï¼‰
  sc=Math.max(0,sc);
  // type
  let type='neutral';
  if(ma75d>=0&&ma25d<0&&pc>=2)type='dip';
  else if(ma75d>=0&&ma25d>=0&&pc>=2)type='momentum';
  else if(ma75d<0&&ma25d<0)type='falling';
  else if(ma75d<0&&ma25d>=0)type='bounce';

  // â”€â”€ å¤§å‹é€†å¼µã‚Šãƒãƒªãƒ¥ãƒ¼ â”€â”€
  // å¤§å‹é«˜é…å½“ï¼ˆæ™‚ä¾¡ç·é¡3000å„„+é…å½“2.5%+ï¼‰ãŒæµ…ã„ä¸‹è½ä¸­ â†’ é€†å¼µã‚Šãƒãƒ£ãƒ³ã‚¹
  const isLargeCap=mc>=3000&&div>=2.5;
  const shallowDip=ma75d>=-8&&ma75d<=-2;  // -2%ã€œ-8%ã®æµ…ã„ä¸‹è½ã®ã¿
  const secBonus=getSectorBonus(s.sector,s.code);  // ã‚»ã‚¯ã‚¿ãƒ¼ãƒœãƒ¼ãƒŠã‚¹

  if(type==='falling'&&isLargeCap&&shallowDip){
    type='value_dip';  // é€†å¼µã‚Šãƒãƒ£ãƒ³ã‚¹
    sc+=6+secBonus;    // ãƒœãƒ¼ãƒŠã‚¹ï¼ˆã‚»ã‚¯ã‚¿ãƒ¼äººæ°—åº¦ã§åŠ æ¸›ï¼‰
  } else if(type==='falling'){
    sc=Math.max(0,sc-10);  // ãã‚Œä»¥å¤–ã®fallingã¯ãƒšãƒŠãƒ«ãƒ†ã‚£
  }
  // å¤§å‹bounceï¼ˆ75æ—¥å‰²ã‚Œã ãŒåç™ºæ°—é…ï¼‰ã‚‚ãƒœãƒ¼ãƒŠã‚¹
  if(type==='bounce'&&isLargeCap)sc+=4+Math.floor(secBonus/2);

  // å…¨éŠ˜æŸ„ã«ã‚»ã‚¯ã‚¿ãƒ¼ãƒœãƒ¼ãƒŠã‚¹åŠ ç®—ï¼ˆæœ€å¤§15ç‚¹ä¸­ã®ä¸€éƒ¨ï¼‰
  sc+=secBonus;

  sc=Math.max(0,Math.min(sc,100));
  return{score:sc,type};
}

function getZone(sc){return sc>=60?'buy':sc>=40?'watch':'hold';}
// ã‚³ãƒ¼ãƒ‰åˆ¥ã®å¼·åˆ¶ä¸Šæ›¸ãï¼ˆJSONã®åˆ†é¡ã«é–¢ã‚ã‚‰ãšç¢ºå®Ÿã«æ—¥æœ¬èªè¡¨ç¤ºï¼‰
const CODE_SECTOR={"7974":"ğŸ® ã‚²ãƒ¼ãƒ ","3635":"ğŸ® ã‚²ãƒ¼ãƒ ","9684":"ğŸ® ã‚²ãƒ¼ãƒ ","9766":"ğŸ® ã‚²ãƒ¼ãƒ ","3659":"ğŸ® ã‚²ãƒ¼ãƒ ","2121":"ğŸ® ã‚²ãƒ¼ãƒ ","9697":"ğŸ® ã‚²ãƒ¼ãƒ ","7832":"ğŸ® ã‚²ãƒ¼ãƒ ","3668":"ğŸ® ã‚²ãƒ¼ãƒ ","3765":"ğŸ® ã‚²ãƒ¼ãƒ ","6723":"ğŸ’ åŠå°ä½“","6526":"ğŸ’ åŠå°ä½“","6857":"ğŸ’ åŠå°ä½“","8035":"ğŸ’ åŠå°ä½“","6920":"ğŸ’ åŠå°ä½“","6146":"ğŸ’ åŠå°ä½“","4443":"ğŸ’» SaaS","4478":"ğŸ’» SaaS","4751":"ğŸŒ IT","4689":"ğŸŒ IT","4755":"ğŸŒ IT","9434":"ğŸ“¡ é€šä¿¡ã‚­ãƒ£ãƒªã‚¢","9433":"ğŸ“¡ é€šä¿¡ã‚­ãƒ£ãƒªã‚¢","9432":"ğŸ“¡ é€šä¿¡ã‚­ãƒ£ãƒªã‚¢","8058":"ğŸ“¦ ç·åˆå•†ç¤¾","8031":"ğŸ“¦ ç·åˆå•†ç¤¾","8001":"ğŸ“¦ ç·åˆå•†ç¤¾","8002":"ğŸ“¦ ç·åˆå•†ç¤¾","8053":"ğŸ“¦ ç·åˆå•†ç¤¾","8306":"ğŸ¦ ãƒ¡ã‚¬ãƒãƒ³ã‚¯","8316":"ğŸ¦ ãƒ¡ã‚¬ãƒãƒ³ã‚¯","8411":"ğŸ¦ ãƒ¡ã‚¬ãƒãƒ³ã‚¯"};
function sMap(s,code){if(code&&CODE_SECTOR[code])return CODE_SECTOR[code];return SECTOR_MAP[s]||s||'ãã®ä»–';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processStocks(){
  let out=RAW.map(s=>{
    const {score,type}=calcScoreTrend(s);
    s.score=score;s.trend_type=type;s.zone=getZone(score);
    return s;
  });
  if(settings.mindiv>0)out=out.filter(s=>(s.dividend||0)>=settings.mindiv);
  if(settings.zone==='buy')out=out.filter(s=>s.zone==='buy');
  else if(settings.zone==='buywatch')out=out.filter(s=>s.zone==='buy'||s.zone==='watch');
  if(settings.sector!=='all')out=out.filter(s=>sMap(s.sector,s.code)===settings.sector);
  out.sort((a,b)=>settings.sortDir*((b[settings.sort]||0)-(a[settings.sort]||0)));
  processed=out;
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTicker(){
  const el=document.getElementById('tickerBar');
  el.innerHTML=['æ—¥çµŒå¹³å‡ ğŸ‡¯ğŸ‡µ','NYãƒ€ã‚¦ ğŸ‡ºğŸ‡¸','ãƒ‰ãƒ«å††'].map(l=>`<div class="ticker-item"><div class="ticker-lbl">${l}</div><div class="ticker-val">â€”</div><div class="ticker-chg">â€”</div></div>`).join('');
}
function renderMarketMode(){
  const el=document.getElementById('marketMode');
  const d=window._stockData||{};
  const mode=d.market_mode;
  if(!mode){el.style.display='none';return;}
  el.style.display='block';
  el.className='market-mode '+mode;

  const signals=d.signals||[];
  const headlines=d.headlines||[];
  const ai=d.ai_summary;

  // ã‚·ã‚°ãƒŠãƒ«ãƒãƒƒã‚¸
  const sigHtml=signals.map(s=>{
    const cls=s.val>0?'pos':s.val<0?'neg':'neu';
    const icon=s.val>0?'âœ…':s.val<0?'âŒ':'âš ï¸';
    return `<span class="mm-sig ${cls}">${icon} ${s.text}</span>`;
  }).join('');

  // ãƒ‹ãƒ¥ãƒ¼ã‚¹
  let newsHtml='';
  if(headlines.length){
    newsHtml=`<div class="mm-news">
      <div class="mm-news-title">ğŸ“° ä»Šæ—¥ã®æ³¨ç›®ãƒ‹ãƒ¥ãƒ¼ã‚¹</div>
      ${headlines.slice(0,5).map(h=>`<div class="mm-news-item">â€¢ ${h.title} <span class="mm-news-src">${h.source||''}</span></div>`).join('')}
    </div>`;
  }

  // AIè¦ç´„
  let aiHtml='';
  if(ai&&ai.text){
    aiHtml=`<div class="mm-ai">
      <div class="mm-ai-header">ğŸ“ ã‹ã¶ã®ã™ã‘ã®è¦‹ç«‹ã¦</div>
      ${ai.text.replace(/\n/g,'<br>')}
    </div>`;
  }

  // ã‚¯ãƒªã‚¢ãƒ‘ã‚¹æ•°
  const pass=signals.filter(s=>s.val>=0).length;
  const total=signals.length;
  const scoreColor=mode==='aggressive'?'#059669':mode==='cautious'?'#EF4444':'#D97706';

  el.innerHTML=`
    <div class="mm-header">
      <div class="mm-label">${d.mode_label||'ğŸ“¡ ç›¸å ´ãƒã‚§ãƒƒã‚¯'}</div>
      <div class="mm-score" style="background:${scoreColor}20;color:${scoreColor}">${pass}/${total} ã‚¯ãƒªã‚¢</div>
    </div>
    <div class="mm-advice">${d.mode_advice||''}</div>
    <div class="mm-signals" id="mmSignals">${sigHtml}</div>
    <details open>
      <summary class="mm-toggle">ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨è¦‹ç«‹ã¦ã‚’è¦‹ã‚‹</summary>
      ${newsHtml}
      ${aiHtml}
    </details>
  `;
}
function renderHero(){
  const el=document.getElementById('heroBox');
  const all=processStocks();
  const buyN=all.filter(s=>s.zone==='buy').length;
  const topSc=all.length?Math.max(...all.map(s=>s.score)):0;
  const maxDiv=all.length?Math.max(...all.map(s=>s.dividend||0)).toFixed(1)+'%':'â€”';
  // ç‹™ã„ã‚»ã‚¯ã‚¿ãƒ¼è¨ˆç®— â€” ã‚»ã‚¯ã‚¿ãƒ¼ã‚¹ã‚³ã‚¢ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
  const dipStocks=all.filter(s=>(s.trend_type==='dip'||s.trend_type==='value_dip')&&s.score>=50);
  let topSecs=[];
  if(Object.keys(sectorScores).length>=3){
    topSecs=Object.keys(sectorScores).slice(0,3);
  } else {
    const secCount={};
    dipStocks.forEach(s=>{const k=sMap(s.sector,s.code);secCount[k]=(secCount[k]||0)+1;});
    topSecs=Object.entries(secCount).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);
  }
  // ã‚¹ã‚¿ãƒ³ã‚¹åˆ¤å®š
  const avgSc=all.length?all.reduce((s,x)=>s+x.score,0)/all.length:0;
  const dipRatio=all.length?dipStocks.length/all.length:0;
  let stanceClass='neutral',stanceText='ğŸ“Š æ§˜å­è¦‹';
  if(avgSc>=50&&dipRatio>=0.1){stanceClass='bull';stanceText='ğŸ“ˆ è²·ã„ãƒãƒ£ãƒ³ã‚¹å¤šã‚';}
  else if(avgSc>=40){stanceClass='neutral';stanceText='ğŸ“Š ã„ã¤ã‚‚é€šã‚Š';}
  else{stanceClass='bear';stanceText='ğŸ“‰ æ…é‡ã«';}
  const updated=window._updatedAt||'â€”';
  el.innerHTML=`
    <div class="hero-date">${updated} æ›´æ–°</div>
    <div class="hero-hl">æ³¨ç›®ã‚»ã‚¯ã‚¿ãƒ¼ï¼š<em>${topSecs.length?topSecs.join('ãƒ»'):'è§£æä¸­...'}</em>ãŒç‹™ã„ç›®</div>
    <span class="stance ${stanceClass}">${stanceText}</span>
    <div class="hero-chips">${topSecs.map(s=>`<span class="hero-chip">${s}</span>`).join('')}</div>
    <div class="hero-big"><b>${buyN}</b><span>éŠ˜æŸ„ãŒè²·ã„æ™‚</span></div>
    <div class="hero-sub">${stanceText.replace(/^[^ ]+ /,'')} Â· å…¨${all.length}éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿</div>
    <div class="hero-stats">
      <div class="hero-stat"><b>${topSc}</b> æœ€é«˜ã‚¹ã‚³ã‚¢</div>
      <div class="hero-stat"><b>${maxDiv}</b> æœ€é«˜é…å½“</div>
    </div>`;
}

function genReason(s){
  const parts=[];
  if(s.trend_type==='value_dip'){
    parts.push(`<strong>å¤§å‹æ ªã®é€†å¼µã‚Šãƒãƒ£ãƒ³ã‚¹</strong>`);
    if(s.ma75_dev<0)parts.push(`75æ—¥å¹³å‡ã‹ã‚‰${Math.abs(s.ma75_dev).toFixed(1)}%ä¸‹è½`);
    if(s.dividend>=3)parts.push(`é…å½“<strong>${s.dividend.toFixed(1)}%</strong>ã§å¾…ã¦ã‚‹`);
    else if(s.dividend>=2)parts.push(`é…å½“${s.dividend.toFixed(1)}%`);
    if(s.ret20<-3)parts.push(`çŸ­æœŸ${s.ret20.toFixed(0)}%ä¸‹è½ â†’ åç™ºæœŸå¾…`);
  }else if(s.trend_type==='momentum'){
    if(s.ret20>5)parts.push(`20æ—¥ã§<strong>+${s.ret20.toFixed(0)}%ä¸Šæ˜‡ä¸­</strong>`);
    else if(s.ret20>0)parts.push(`ã˜ã‚ã˜ã‚ä¸Šæ˜‡ä¸­`);
    if((s.vol_ratio_1d||1)>=2)parts.push(`å‡ºæ¥é«˜<strong>${(s.vol_ratio_1d||1).toFixed(1)}å€</strong>ã«æ€¥å¢—`);
    if(s.ret120>15)parts.push(`åŠå¹´ã§<strong>+${s.ret120.toFixed(0)}%</strong>ã®å‹¢ã„`);
    else if(s.ret120>5)parts.push(`åŠå¹´ã§å®‰å®šçš„ã«ä¸Šæ˜‡`);
  }else{
    if(s.ma75_dev!==undefined){
      if(s.ma75_dev>=0&&s.ma75_dev<=3)parts.push(`75æ—¥å¹³å‡ã«æ¥è¿‘ä¸­ã€<strong>è²·ã„ã®ãƒãƒ£ãƒ³ã‚¹</strong>`);
      else if(s.ma75_dev>3&&s.ma75_dev<=8)parts.push(`ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ç¶™ç¶šä¸­`);
      else if(s.ma75_dev>8)parts.push(`é«˜å€¤åœã§æ¨ç§»`);
      else parts.push(`75æ—¥å¹³å‡ã‚’ä¸‹å›ã‚Šæ³¨æ„`);
    }
    if(s.ret120>10)parts.push(`åŠå¹´ã§<strong>+${s.ret120.toFixed(0)}%æˆé•·</strong>`);
    else if(s.ret120>5)parts.push(`åŠå¹´ã§å®‰å®šä¸Šæ˜‡`);
  }
  if(s.dividend>=3)parts.push(`é…å½“<strong>${s.dividend.toFixed(1)}%</strong>`);
  if((s.vol_ratio_1d||1)>=2&&s.trend_type!=='momentum')parts.push(`å‡ºæ¥é«˜æ€¥å¢—ä¸­`);
  return parts.slice(0,3).join('ã€‚')||'åˆ†æä¸­â€¦';
}

function getScoreFeel(score){
  if(score>=70)return '<div class="score-feel great">ğŸ”¥ çµ¶å¥½ã®è²·ã„å ´</div>';
  if(score>=60)return '<div class="score-feel great">âœ¨ ã„ã„è²·ã„å ´</div>';
  if(score>=50)return '<div class="score-feel good">â˜€ ã¾ã‚ã¾ã‚ã®è²·ã„å ´</div>';
  if(score>=40)return '<div class="score-feel ok">ğŸŒ¤ ã‚‚ã†å°‘ã—å¾…ã¡ãŸã„</div>';
  return '<div class="score-feel ok">â˜ æ§˜å­è¦‹</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOP10 + INLINE DETAIL EXPAND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let expandedCode=null;

function getRankBadge(code,tab){
  if(!histYesterday||!histYesterday.version)return '';
  const key=tab==='dip'?'dip_top10':'mom_top10';
  const yList=histYesterday[key]||[];
  const yIdx=yList.findIndex(s=>s.code===code);
  if(yIdx<0)return '<span class="rank-chg new">ğŸ†•</span>';
  // ä»Šæ—¥ã®é †ä½ã‚’å–å¾—
  const todayList=processed.filter(s=>tab==='dip'?(s.trend_type==='dip'||s.trend_type==='value_dip'):(s.trend_type==='momentum'&&(s.market_cap_b||0)>=1000)).slice(0,10);
  const tIdx=todayList.findIndex(s=>s.code===code);
  if(tIdx<0)return '';
  const diff=yIdx-tIdx; // positive = moved up
  if(diff>0)return `<span class="rank-chg up">â†‘${diff} æ˜¨æ—¥${yIdx+1}ä½</span>`;
  if(diff<0)return `<span class="rank-chg dn">â†“${Math.abs(diff)} æ˜¨æ—¥${yIdx+1}ä½</span>`;
  return `<span class="rank-chg same">â†’ æ˜¨æ—¥ã‚‚${yIdx+1}ä½</span>`;
}

function getVolBadge(s){
  const vr=s.vol_ratio_1d||1;
  if(vr>=3)return `<span class="vol-badge high">ğŸ“Š å‡ºæ¥é«˜ ${vr.toFixed(1)}å€</span>`;
  if(vr>=1.8)return `<span class="vol-badge high">ğŸ“Š ${vr.toFixed(1)}å€</span>`;
  return '';
}

function renderSectorTrend(){
  const sec=document.getElementById('sectorSection');
  if(!sectorScores||!Object.keys(sectorScores).length){sec.style.display='none';return;}
  sec.style.display='';
  const bars=document.getElementById('sectorBars');
  const entries=Object.entries(sectorScores).slice(0,8);
  const maxSc=Math.max(...entries.map(e=>e[1].score));
  let html='';
  entries.forEach(([name,d],i)=>{
    const pct=Math.round(d.score/maxSc*100);
    const medal=i===0?'ğŸ†':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'';
    const barColor=d.score>=7?'var(--green)':d.score>=5?'var(--blue)':'var(--amber)';
    html+=`<div onclick="showSectorStocks('${name}')" style="display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer;padding:4px 0;border-radius:6px;transition:background .15s" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background='transparent'">
      <div style="width:14px;text-align:center;font-size:11px">${medal||i+1}</div>
      <div style="width:80px;font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden">${name}</div>
      <div style="flex:1;background:var(--border);border-radius:4px;height:18px;position:relative">
        <div style="width:${pct}%;background:${barColor};height:100%;border-radius:4px;transition:width .5s"></div>
        <span style="position:absolute;right:6px;top:1px;font-size:10px;font-weight:700;color:var(--text)">${d.score}</span>
      </div>
      <div style="width:55px;font-size:10px;color:var(--text3);text-align:right">é…å½“${d.avg_dividend}%</div>
      <div style="width:16px;font-size:10px;color:var(--text3)">â€º</div>
    </div>`;
  });
  bars.innerHTML=html;
  const top3=entries.slice(0,3).map(e=>e[0]);
  document.getElementById('sectorTheme').innerHTML=
    `<span style="color:var(--blue);font-weight:600">ğŸ“Œ æ³¨ç›®ã‚»ã‚¯ã‚¿ãƒ¼ï¼š</span>${top3.join('ã€')}<div style="margin-top:4px;font-size:10px;color:var(--text3)">ğŸ‘† ã‚»ã‚¯ã‚¿ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã§éŠ˜æŸ„ä¸€è¦§</div>`;
}

// ã‚»ã‚¯ã‚¿ãƒ¼åâ†’yfinanceã‚»ã‚¯ã‚¿ãƒ¼åã®é€†å¼•ã
const JP_TO_EN={"é‡‘è":"Financial Services","ç´ æ":"Basic Materials","ã‚¨ãƒãƒ«ã‚®ãƒ¼":"Energy",
  "ç”£æ¥­":"Industrials","ä¸å‹•ç”£":"Real Estate","æ¶ˆè²»ï¼ˆæ™¯æ°—æ•æ„Ÿï¼‰":"Consumer Cyclical",
  "æ¶ˆè²»ï¼ˆå®‰å®šï¼‰":"Consumer Defensive","åŒ»è–¬ãƒ»ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢":"Healthcare",
  "ãƒ†ãƒƒã‚¯":"Technology","é€šä¿¡ãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢":"Communication Services","é›»åŠ›ãƒ»ã‚¬ã‚¹":"Utilities"};

function showSectorStocks(secName){
  // è©²å½“ã‚»ã‚¯ã‚¿ãƒ¼ã®éŠ˜æŸ„ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const enName=JP_TO_EN[secName]||secName;
  const matches=processed.filter(s=>{
    const sSec=s.sector||'';
    const sDisp=sMap(sSec,s.code);
    // è‹±èªåãƒãƒƒãƒ or æ—¥æœ¬èªåéƒ¨åˆ†ãƒãƒƒãƒ
    return sSec===enName||sSec===secName||sDisp.includes(secName.replace('ï¼ˆæ™¯æ°—æ•æ„Ÿï¼‰','').replace('ï¼ˆå®‰å®šï¼‰',''));
  }).sort((a,b)=>b.score-a.score).slice(0,15);

  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  let html=`<div id="secModal" onclick="if(event.target.id==='secModal')this.remove()" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:999;display:flex;align-items:flex-end;justify-content:center">
    <div style="background:var(--bg);max-width:720px;width:100%;max-height:75vh;border-radius:16px 16px 0 0;overflow-y:auto;padding-bottom:env(safe-area-inset-bottom)">
      <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--bg);z-index:1">
        <div><div style="font-weight:700;font-size:16px">ğŸ“Š ${secName} ã‚»ã‚¯ã‚¿ãƒ¼</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">${matches.length}éŠ˜æŸ„ ãƒ» ã‚¹ã‚³ã‚¢é †</div></div>
        <div onclick="this.closest('#secModal').remove()" style="font-size:24px;cursor:pointer;padding:4px 8px;color:var(--text3)">âœ•</div>
      </div>`;

  if(!matches.length){
    html+='<div style="padding:32px;text-align:center;color:var(--text3)">è©²å½“éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    matches.forEach(s=>{
      const typeLabel=s.trend_type==='value_dip'?'ğŸ’ é€†å¼µã‚Š':s.trend_type==='dip'?'ğŸ“‰ å‰²å®‰':
        s.trend_type==='momentum'?'ğŸ“ˆ ä¸Šæ˜‡ä¸­':s.trend_type==='bounce'?'ğŸ”„ åç™º':'â€”';
      const typeColor=s.trend_type==='momentum'?'var(--green)':s.trend_type==='dip'||s.trend_type==='value_dip'?'var(--blue)':'var(--text3)';
      const divBadge=(s.dividend||0)>=2?`<span style="background:var(--green-bg);color:var(--green);padding:1px 6px;border-radius:8px;font-size:10px;font-weight:600">ğŸ’°${(s.dividend||0).toFixed(1)}%</span>`:'';
      const scoreColor=s.score>=60?'var(--green)':s.score>=40?'var(--amber)':'var(--red)';
      html+=`<div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px">
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.name}</div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px">${s.code} ${divBadge}</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:11px;color:${typeColor};font-weight:600">${typeLabel}</div>
        </div>
        <div style="text-align:right;min-width:50px">
          <div style="font-size:20px;font-weight:800;color:${scoreColor}">${s.score}</div>
          <div style="font-size:9px;color:var(--text3)">/100</div>
        </div>
      </div>`;
    });
  }
  html+='</div></div>';
  document.body.insertAdjacentHTML('beforeend',html);
}

function renderTop10(){
  const sec=document.getElementById('top5Section');
  sec.style.display='';
  const body=document.getElementById('top5Body');
  const tab=settings.top5tab;
  const items=processed.filter(s=>tab==='dip'?(s.trend_type==='dip'||s.trend_type==='value_dip'):(s.trend_type==='momentum'&&(s.market_cap_b||0)>=1000)).slice(0,10);
  if(!items.length){body.innerHTML='<div style="padding:24px;text-align:center;color:var(--text3);font-size:13px">è©²å½“ã™ã‚‹éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“</div>';return;}
  let html='<div class="t5-grid">';
  items.forEach((s,i)=>{
    const hasSpark=s.closes_60d&&s.closes_60d.length>10;
    const isOpen=expandedCode===s.code;
    const divBadge=(s.dividend||0)>=2?`<span class="div-badge">ğŸ’° ${(s.dividend||0).toFixed(1)}%</span>`:`é…å½“${(s.dividend||0).toFixed(1)}%`;
    const gaugeColor=s.score>=60?'var(--green)':s.score>=40?'var(--amber)':'var(--red)';
    const rankBadge=getRankBadge(s.code,tab);
    const volBadge=getVolBadge(s);
    html+=`<div class="t5-item${i===0?' first-place':''}" onclick="toggleExpand('${s.code}')" style="${isOpen?'background:var(--blue-l)':''}">
      <div class="t5-rank${i===0?' gold':i===1?' silver':i===2?' bronze':''}">${i===0?'ğŸ‘‘':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1}</div>
      <div class="t5-info">
        <div class="t5-nm">${s.name} ${rankBadge}</div>
        <div class="t5-meta">${s.code} Â· ${sMap(s.sector,s.code)} Â· ${divBadge} ${volBadge}</div>
        <div class="t5-reason">${genReason(s)}</div>
        ${getScoreFeel(s.score)}
      </div>
      ${hasSpark?`<svg class="t5-spark" viewBox="0 0 120 44" data-spark="${s.code}"></svg>`:''}
      <div class="t5-right">
        <div class="t5-sc">${s.score}<span>/<small>100</small></span></div>
        <div class="t5-gauge"><div class="t5-gauge-fill" style="width:${s.score}%;background:${gaugeColor}"></div></div>
        <div class="t5-type ${s.trend_type==='dip'||s.trend_type==='value_dip'?'dip':'mom'}">${TREND_LABEL[s.trend_type]||s.trend_type}</div>
        <div class="t5-tap">${isOpen?'â–² é–‰ã˜ã‚‹':'â–¼ è©³ç´°'}</div>
      </div>
    </div>`;
    if(isOpen) html+=buildExpand(s);
  });
  html+='</div>';
  body.innerHTML=html;
  // Draw sparklines
  items.forEach(s=>{
    if(s.closes_60d&&s.closes_60d.length>10){
      const el=body.querySelector(`[data-spark="${s.code}"]`);
      if(el)drawSpark(el,s.closes_60d,120,44);
    }
  });
  // Draw detail chart
  if(expandedCode){
    setTimeout(()=>{
      const s=items.find(x=>x.code===expandedCode);
      if(s&&s.closes_60d&&s.closes_60d.length>10){
        const el=document.querySelector(`[data-dchart="${expandedCode}"]`);
        if(el)drawDetailChart(el,s.closes_60d,s.ma25,s.ma75);
      }
    },50);
  }
}

function toggleExpand(code){
  expandedCode=expandedCode===code?null:code;
  renderTop10();
  if(expandedCode){
    setTimeout(()=>{
      const el=document.querySelector(`[data-dchart="${code}"]`)||document.querySelector('.t5-expand');
      if(el)el.scrollIntoView({behavior:'smooth',block:'nearest'});
    },100);
    gaEvent('detail_open',{code});
  }
}

function calcPercentile(val, arr){
  if(!arr.length)return 50;
  const sorted=[...arr].sort((a,b)=>a-b);
  let idx=sorted.findIndex(v=>v>=val);
  if(idx<0)idx=sorted.length;
  return Math.round((idx/sorted.length)*100);
}

function buildSafetyRating(s){
  // å…¨éŠ˜æŸ„ã®å€¤ã‚’é›†ã‚ã‚‹
  const allMcap=processed.map(x=>x.market_cap_b||0);
  const allAvgVol=processed.map(x=>x.avg_volume||0);
  const allVolR=processed.map(x=>x.vol_ratio_1d||1);

  // ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«è¨ˆç®—ï¼ˆä¸Šä½â—‹%ï¼‰
  const mcapPct=calcPercentile(s.market_cap_b||0, allMcap);
  const volAvgPct=calcPercentile(s.avg_volume||0, allAvgVol);
  const volRPct=calcPercentile(s.vol_ratio_1d||1, allVolR);

  // ä¼æ¥­è¦æ¨¡
  const mc=s.market_cap_b||0;
  let mcVal;
  if(mc>=10000)mcVal=`${(mc/10000).toFixed(1)}å…†å††`;
  else if(mc>=1000)mcVal=`${(mc/1000).toFixed(1)}åƒå„„å††`;
  else mcVal=`${Math.round(mc)}å„„å††`;

  // å¹³å‡å‡ºæ¥é«˜
  const avgVol=s.avg_volume||0;
  let volLabel;
  if(avgVol>=1000000)volLabel=`å¹³å‡${(avgVol/10000).toFixed(0)}ä¸‡æ ª/æ—¥`;
  else if(avgVol>=10000)volLabel=`å¹³å‡${(avgVol/10000).toFixed(1)}ä¸‡æ ª/æ—¥`;
  else volLabel=`å¹³å‡${avgVol.toLocaleString()}æ ª/æ—¥`;

  // ä»Šæ—¥ã®å‡ºæ¥é«˜æ¯”
  const vr=s.vol_ratio_1d||1;
  const vrLabel=`ã„ã¤ã‚‚ã®${vr.toFixed(1)}å€`;

  function bar(pct,label,icon,val,color){
    // pct = calcPercentileã®æˆ»ã‚Šå€¤ï¼ˆä½•%ã®éŠ˜æŸ„ãŒã“ã®å€¤ä»¥ä¸‹ã‹ï¼‰
    const rank=100-pct; // ä¸Šä½ä½•%ã‹ï¼ˆå°ã•ã„=è‰¯ã„ï¼‰
    let pctLabel,pctColor;
    if(rank<=50){
      pctLabel=`ä¸Šä½${rank}%`;
      pctColor=rank<=30?color:'var(--amber)';
    }else{
      pctLabel=`ä¸‹ä½${100-rank}%`;
      pctColor='var(--red)';
    }
    const barWidth=pct; // ãƒãƒ¼ã®é•·ã•=ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«
    const barColor=pct>=70?color:pct>=35?'var(--amber)':'var(--red)';
    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:11px">
      <div style="min-width:110px;color:var(--text2);font-weight:500">${icon} ${label}</div>
      <div style="flex:1;height:8px;background:var(--border-l);border-radius:4px;overflow:hidden;position:relative">
        <div style="width:${barWidth}%;height:100%;background:${barColor};border-radius:4px;transition:width .3s"></div>
      </div>
      <div style="min-width:70px;text-align:right;font-family:var(--fn);font-size:10px;font-weight:700;color:${pctColor}">${pctLabel}</div>
      <div style="min-width:80px;text-align:right;font-size:10px;color:var(--text3)">${val}</div>
    </div>`;
  }

  return `<div style="margin-bottom:10px;padding:10px;background:var(--card);border-radius:8px;border:1px solid var(--border)">
    <div style="font-size:10px;font-weight:700;color:var(--text2);margin-bottom:8px">ğŸ›¡ ã“ã®éŠ˜æŸ„ã®å®‰å¿ƒåº¦ï¼ˆå…¨${processed.length}éŠ˜æŸ„ä¸­ï¼‰</div>
    ${bar(mcapPct,'ä¼æ¥­è¦æ¨¡','ğŸ¢',mcVal,'var(--green)')}
    ${bar(volAvgPct,'å£²è²·ã®ã—ã‚„ã™ã•','ğŸ’§',volLabel,'var(--blue-m)')}
    ${bar(volRPct,'ä»Šæ—¥ã®æ³¨ç›®åº¦','ğŸ“Š',vrLabel,'var(--amber)')}
    <div style="font-size:9px;color:var(--text3);margin-top:4px;line-height:1.5">
      ãƒãƒ¼ãŒé•·ã„ï¼å…¨éŠ˜æŸ„ã®ä¸­ã§ä¸Šä½ã€‚åˆå¿ƒè€…ã¯è¦æ¨¡ãƒ»å£²è²·ã—ã‚„ã™ã•ãŒä¸Šä½30%ä»¥å†…ã®éŠ˜æŸ„ãŒãŠã™ã™ã‚
    </div>
  </div>`;
}

function buildExpand(s){
  const hasSpark=s.closes_60d&&s.closes_60d.length>10;
  const ma75pct=Math.max(5,Math.min(95,50+(s.ma75_dev||0)*3));
  const ma25pct=Math.max(5,Math.min(95,50+(s.ma25_dev||0)*3));
  const ma75col=(s.ma75_dev||0)>=0?'var(--green)':'var(--red)';
  const ma25col=(s.ma25_dev||0)>=0?'var(--green)':'var(--red)';
  // Signal (åˆå¿ƒè€…å‘ã‘)
  let signal='';
  if(s.trend_type==='value_dip'){
    signal=`<strong>ğŸ’ å¤§å‹é«˜é…å½“æ ªã®é€†å¼µã‚Šãƒãƒ£ãƒ³ã‚¹ã€‚</strong>ä¸€æ™‚çš„ãªä¸‹è½ã§å‰²å®‰ã«ã€‚é…å½“${(s.dividend||0).toFixed(1)}%ã‚’ã‚‚ã‚‰ã„ãªãŒã‚‰å›å¾©ã‚’å¾…ã¦ã‚‹å±€é¢ã€‚`;
    if(s.ma75_dev<0)signal+=`<br>75æ—¥å¹³å‡ï¼ˆÂ¥${(s.ma75||0).toLocaleString()}ï¼‰ã‚’${Math.abs(s.ma75_dev||0).toFixed(1)}%ä¸‹å›ã£ã¦ã„ã¾ã™ã€‚`;
  }else if(s.trend_type==='dip'){
    signal=`é•·æœŸã§ã¯ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ã€‚çŸ­æœŸçš„ã«èª¿æ•´ä¸­ã§<strong>è²·ã„ã‚„ã™ã„ä¾¡æ ¼å¸¯ã«æ¥è¿‘ä¸­</strong>ã€‚`;
    if(s.ma75_dev<=3)signal+=`<br>75æ—¥å¹³å‡ï¼ˆè²·ã„ãƒ©ã‚¤ãƒ³ Â¥${(s.ma75||0).toLocaleString()}ï¼‰ã¾ã§ã‚ã¨${(s.ma75_dev||0).toFixed(1)}%ã€‚ã“ã“ã¾ã§ä¸‹ãŒã‚Œã°çµ¶å¥½ã®ãƒãƒ£ãƒ³ã‚¹ã€‚`;
    else signal+=`<br>75æ—¥å¹³å‡ï¼ˆè²·ã„ãƒ©ã‚¤ãƒ³ï¼‰ã¾ã§ã¾ã è·é›¢ã‚ã‚Šï¼ˆ${(s.ma75_dev||0).toFixed(1)}%ï¼‰ã€‚ã‚‚ã†å°‘ã—ä¸‹ãŒã‚‹ã®ã‚’å¾…ã¤æ‰‹ã‚‚ã€‚`;
  }else if(s.trend_type==='momentum'){
    signal=`çŸ­æœŸãƒ»é•·æœŸã¨ã‚‚ã«ä¸Šæ˜‡ä¸­ã€‚<strong>å‹¢ã„ã«ä¹—ã£ã¦ã„ã‚‹çŠ¶æ…‹</strong>ã€‚é«˜å€¤æ´ã¿ã«æ³¨æ„ã—ã¤ã¤ã€æµã‚Œã«ä¹—ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚`;
  }else{
    signal=`ç¾åœ¨ã¯æ–¹å‘æ„ŸãŒèª­ã¿ã«ãã„çŠ¶æ³ã€‚ç„¡ç†ã›ãšæ§˜å­è¦‹ãŒãŠã™ã™ã‚ã€‚`;
  }
  // MA tag
  let ma75tag='';
  if(s.ma75_dev>=0&&s.ma75_dev<=3)ma75tag='<span class="d-ma-tag near">æ¥è¿‘ä¸­!</span>';

  return `<div class="t5-expand">
  <div class="d-grid">
    <!-- LEFT: ãƒãƒ£ãƒ¼ãƒˆ -->
    <div>
      <div class="d-sec-ttl">ğŸ“Š å€¤å‹•ããƒãƒ£ãƒ¼ãƒˆï¼ˆ60æ—¥ï¼‰</div>
      ${hasSpark?`<div class="d-chart-box">
        <svg class="d-chart-svg" viewBox="0 0 400 160" overflow="hidden" data-dchart="${s.code}"></svg>
      </div>
      <div style="display:flex;gap:14px;padding:10px 0 2px;flex-wrap:wrap;font-size:11px">
        <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;border-radius:50%;background:#1A1A1A"></div>ä»Šã®æ ªä¾¡ <b>Â¥${(s.price||0).toLocaleString()}</b></div>
        <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;border-radius:50%;background:#F59E0B"></div>25æ—¥å¹³å‡ <b style="color:#F59E0B">Â¥${(s.ma25||0).toLocaleString()}</b></div>
        <div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;border-radius:50%;background:#059669"></div>75æ—¥å¹³å‡ <b style="color:#059669">Â¥${(s.ma75||0).toLocaleString()}</b></div>
      </div>
      <div style="font-size:10px;color:var(--text3);padding:0 0 6px;line-height:1.6">ğŸŸ  25æ—¥å¹³å‡ã‚ˆã‚Šå®‰ã„ â†’ çŸ­æœŸçš„ã«å‰²å®‰ ï¼ ğŸŸ¢ 75æ—¥å¹³å‡ã«è¿‘ã„ â†’ åç™ºã—ã‚„ã™ã„ã€Œè²·ã„ãƒ©ã‚¤ãƒ³ã€</div>
      `:`<div style="padding:16px;text-align:center;background:var(--card);border-radius:8px;border:1px solid var(--border)">
        <div style="font-size:12px;color:var(--text)">ä»Šã®æ ªä¾¡ Â¥${(s.price||0).toLocaleString()} / 25æ—¥å¹³å‡ Â¥${(s.ma25||0).toLocaleString()} / 75æ—¥å¹³å‡ Â¥${(s.ma75||0).toLocaleString()}</div>
      </div>`}
      <div class="d-ma">
        <div style="font-size:10px;font-weight:700;color:var(--text2);margin-bottom:6px">ğŸ“ ä»Šã®æ ªä¾¡ã®ä½ç½®</div>
        <div class="d-ma-row">
          <div class="d-ma-lbl">25æ—¥å¹³å‡ã¨ã®å·®</div>
          <div class="d-ma-bar"><div class="d-ma-ctr"></div><div class="d-ma-dot" style="left:${ma25pct}%;background:${ma25col}"></div></div>
          <div class="d-ma-val ${(s.ma25_dev||0)>=0?'up':'dn'}">${(s.ma25_dev||0)>=0?'+':''}${(s.ma25_dev||0).toFixed(1)}%</div>
        </div>
        <div class="d-ma-row">
          <div class="d-ma-lbl">75æ—¥å¹³å‡ã¨ã®å·®</div>
          <div class="d-ma-bar"><div class="d-ma-ctr"></div><div class="d-ma-dot" style="left:${ma75pct}%;background:${ma75col}"></div></div>
          <div class="d-ma-val ${(s.ma75_dev||0)>=0?'up':'dn'}">${(s.ma75_dev||0)>=0?'+':''}${(s.ma75_dev||0).toFixed(1)}%</div>
          ${ma75tag}
        </div>
      </div>
    </div>
    <!-- RIGHT: æŒ‡æ¨™ -->
    <div>
      <div class="d-sec-ttl">ğŸ“ˆ ã“ã®éŠ˜æŸ„ã®ãƒã‚¤ãƒ³ãƒˆ</div>
      <div style="padding:10px 14px;margin-bottom:10px;background:linear-gradient(135deg,#F0FDF4,#ECFDF5);border-radius:10px;border:1px solid #BBF7D0;font-size:13px;color:#111">
        ğŸ’° ã“ã®æ ªã‚’è²·ã†ã«ã¯ â†’ <b style="font-size:16px;color:var(--green)">ç´„${((s.price||0)*100)>=10000?Math.round((s.price||0)*100/10000)+'ä¸‡':Math.round((s.price||0)*100/1000)+'åƒ'}å††</b><span style="font-size:10px;color:var(--text3)">ï¼ˆ100æ ª Ã— Â¥${(s.price||0).toLocaleString()}ï¼‰</span>
        ${((s.price||0)*100)<=2400000?`<div style="font-size:10px;color:var(--text3);margin-top:3px">ğŸ¯ NISAæˆé•·æŠ•è³‡æ ï¼ˆå¹´240ä¸‡å††ï¼‰ã®<b style="color:var(--green)">${Math.round((s.price||0)*100/24000)}%</b></div>`:''}
      </div>
      <div class="d-cards">
        <div class="d-card"><b>${(s.dividend||0).toFixed(1)}%</b><small>é…å½“åˆ©å›ã‚Š</small><div style="font-size:9px;color:${(s.dividend||0)>=3?'var(--green)':'var(--text3)'};font-weight:600;margin-top:2px">${(s.dividend||0)>=3?'3%â†‘å„ªç§€!':'å¹³å‡2.2%'}</div></div>
        <div class="d-card"><b>${(s.pbr||0).toFixed(2)}å€</b><small>PBR(å‰²å®‰åº¦)</small><div style="font-size:9px;color:${(s.pbr||0)<1&&(s.pbr||0)>0?'var(--green)':'var(--text3)'};font-weight:600;margin-top:2px">${(s.pbr||0)<1&&(s.pbr||0)>0?'1å€â†“å‰²å®‰!':'1å€â†“ã§å‰²å®‰'}</div></div>
        <div class="d-card"><b>${(s.roe||0)>0?(s.roe||0).toFixed(0)+'%':'â€”'}</b><small>ROE(ç¨¼ãåŠ›)</small><div style="font-size:9px;color:${(s.roe||0)>=10?'var(--green)':'var(--text3)'};font-weight:600;margin-top:2px">${(s.roe||0)>=10?'10%â†‘å„ªç§€!':(s.roe||0)>0?'10%â†‘ã§â—':'(éé–‹ç¤ºã®éŠ˜æŸ„)'}</div></div>
      </div>
      ${buildSafetyRating(s)}
      <div class="d-signal"><b>ğŸ“ ã‹ã¶ã®ã™ã‘ã®åˆ¤å®š</b><p>${signal}</p></div>
      <details style="margin-top:8px;font-size:11px;color:var(--text3)">
        <summary style="cursor:pointer;font-weight:600;color:var(--text2)">ğŸ“š ã‚‚ã£ã¨è©³ã—ãè¦‹ã‚‹</summary>
        <div style="padding:8px 0">
          ${(s.vol_ratio_1d||1)>=1.5?`<div style="margin-bottom:6px"><span class="vol-badge high">ğŸ“Š å‡ºæ¥é«˜: ã„ã¤ã‚‚ã®${(s.vol_ratio_1d||1).toFixed(1)}å€${(s.vol_ratio_1d||1)>=3?' ï¼ˆæ³¨ç›®åº¦ãŒéå¸¸ã«é«˜ã„ï¼‰':(s.vol_ratio_1d||1)>=2?' ï¼ˆæ³¨ç›®åº¦ãŒé«˜ã„ï¼‰':''}</span></div>`:''}
          <div style="line-height:1.6">ğŸ“ <strong>75æ—¥å¹³å‡</strong> = éå»75æ—¥é–“ã®å¹³å‡æ ªä¾¡ã€‚ã“ã“ã¾ã§ä¸‹ãŒã‚‹ã¨åç™ºã—ã‚„ã™ã„ã€Œè²·ã„ãƒ©ã‚¤ãƒ³ã€</div>
        </div>
      </details>
      <div class="d-btns">
        <a class="d-btn" href="https://finance.yahoo.co.jp/quote/${s.code}.T" target="_blank" rel="noopener">Yahoo!ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ â†’</a>
        <a class="d-btn" href="https://kabutan.jp/stock/?code=${s.code}" target="_blank" rel="noopener">æ ªæ¢ã§è©³ã—ã â†’</a>
      </div>
    </div>
  </div>
</div>`;
}

function setTop5Tab(tab){
  expandedCode=null;
  settings.top5tab=tab;
  document.getElementById('t5TabDip').classList.toggle('active',tab==='dip');
  document.getElementById('t5TabMom').classList.toggle('active',tab==='mom');
  document.getElementById('t5SubText').textContent=tab==='dip'
    ?'ğŸ“‰ å€¤ä¸‹ãŒã‚Šã—ãŸä»ŠãŒè²·ã„æ™‚ã®æ ªã€‚75æ—¥å¹³å‡ï¼ˆè²·ã„ãƒ©ã‚¤ãƒ³ï¼‰ã«è¿‘ã¥ã„ãŸå‰²å®‰éŠ˜æŸ„ã§ã™'
    :'ğŸ“ˆ å‹¢ã„ã‚ˆãä¸ŠãŒã£ã¦ã„ã‚‹æ ªã€‚æµã‚Œã«ä¹—ã£ã¦åˆ©ç›Šã‚’ç‹™ã†éŠ˜æŸ„ã§ã™';
  renderTop10();
  document.getElementById('top5Section').scrollIntoView({behavior:'smooth',block:'start'});
}

function renderDanger(){
  const sec=document.getElementById('dangerSection');
  const items=processed.filter(s=>s.trend_type==='falling'&&s.score<=30).slice(0,5);
  if(!items.length){sec.innerHTML='';return;}
  sec.innerHTML=`<div class="danger"><div class="danger-ttl">âš  ä»Šæ—¥ã¯æ‰‹ã‚’å‡ºã•ãªã„æ–¹ãŒã„ã„éŠ˜æŸ„</div>${items.map(s=>`
    <div class="danger-row">
      <div><div class="danger-nm">${s.name}</div><div class="danger-cd">${s.code} Â· ${sMap(s.sector,s.code)}</div></div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end">
        ${s.rsi>=75?`<span class="danger-badge">éç†± RSI${s.rsi}</span>`:''}
        ${(s.ret_1d||0)<=-3?`<span class="danger-badge">å‰æ—¥${s.ret_1d.toFixed(1)}%</span>`:''}
        ${(s.ma75_dev||0)<-5?`<span class="danger-badge">ä¸‹è½ãƒˆãƒ¬ãƒ³ãƒ‰</span>`:''}
        ${s.trend_type==='falling'?'<span class="danger-badge">75æ—¥å¹³å‡å‰²ã‚Œ</span>':''}
      </div>
    </div>`).join('')}</div>`;
}

// â”€â”€ SHARE â”€â”€
function shareX(){
  const top=processed.filter(s=>s.trend_type==='dip'||s.trend_type==='value_dip').slice(0,3);
  const text=`ğŸ“Š ã‹ã¶ã®ã™ã‘ ä»Šæ—¥ã®æŠ¼ã—ç›®TOP3\n${top.map((s,i)=>`${i+1}. ${s.name}ï¼ˆ${s.score}ptï¼‰`).join('\n')}\nhttps://oshime.vercel.app/app.html`;
  window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(text),'_blank');
  gaEvent('share',{platform:'x'});
}
function shareLine(){
  const text='ã‹ã¶ã®ã™ã‘ - ä»Šæ—¥ã®æŠ¼ã—ç›®ãƒã‚§ãƒƒã‚¯ https://oshime.vercel.app/app.html';
  window.open('https://line.me/R/msg/text/?'+encodeURIComponent(text),'_blank');
  gaEvent('share',{platform:'line'});
}
function copyLink(){
  navigator.clipboard.writeText('https://oshime.vercel.app/app.html').then(()=>alert('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
  gaEvent('share',{platform:'copy'});
}

// â”€â”€ MODALS â”€â”€
function openLogic(){document.getElementById('logicModal').classList.add('open');}

// â”€â”€ HISTORY â”€â”€
function toggleHistory(){
  const body=document.getElementById('histBody');
  const arrow=document.getElementById('histArrow');
  const isOpen=body.style.display!=='none';
  body.style.display=isOpen?'none':'';
  arrow.classList.toggle('open',!isOpen);
  if(!isOpen)renderHistory();
}
function renderHistory(){
  const body=document.getElementById('histBody');
  let html='';
  [histYesterday,histDayBefore].forEach(h=>{
    if(!h||!h.version)return;
    const dipList=h.dip_top10||[];
    const label=h===histYesterday?'æ˜¨æ—¥':'ä¸€æ˜¨æ—¥';
    html+=`<div class="hist-day"><div class="hist-day-ttl">ğŸ“… ${label}ï¼ˆ${h.date}ï¼‰ã®æŠ¼ã—ç›®TOP10</div>`;
    if(!dipList.length){html+=`<div style="padding:8px;font-size:11px;color:var(--text3)">ãƒ‡ãƒ¼ã‚¿ãªã—</div>`;}
    dipList.forEach((s,i)=>{
      html+=`<div class="hist-row">
        <div class="hist-rank">${i+1}</div>
        <div class="hist-nm">${s.name}</div>
        <div class="hist-sc">${s.score}pt</div>
      </div>`;
    });
    html+=`</div>`;
  });
  if(!html)html='<div style="padding:14px;font-size:12px;color:var(--text3);text-align:center">å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼ˆæ˜æ—¥ä»¥é™ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</div>';
  body.innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN & INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function run(){
  processStocks();
  renderMarketMode();
  renderHero();
  renderSectorTrend();
  renderTop10();
  renderDanger();
  // Show history section if data exists
  const histSec=document.getElementById('histSection');
  if(histYesterday&&histYesterday.version)histSec.style.display='';
  try{localStorage.setItem('kbn_settings',JSON.stringify({mindiv:settings.mindiv}));}catch(e){}
}

async function loadHistory(){
  // æ˜¨æ—¥ãƒ»ä¸€æ˜¨æ—¥ã®history JSONã‚’èª­ã¿è¾¼ã¿
  const today=new Date();
  for(let d=1;d<=7;d++){
    // åœŸæ—¥ã‚¹ã‚­ãƒƒãƒ—ã®ãŸã‚æœ€å¤§7æ—¥é¡ã‚‹
    const dt=new Date(today);dt.setDate(dt.getDate()-d);
    const ds=dt.toISOString().slice(0,10);
    try{
      const r=await fetch(`history/${ds}.json?t=${Date.now()}`);
      if(!r.ok)continue;
      const data=await r.json();
      if(!histYesterday){histYesterday=data;}
      else if(!histDayBefore){histDayBefore=data;break;}
    }catch(e){continue;}
  }
}

async function init(){
  renderTicker();
  try{
    const r=await fetch('stocks_data.json?t='+Date.now());
    const data=await r.json();
    RAW=data.stocks||[];
    window._updatedAt=data.updated_at||'â€”';
    window._stockData=data;
    sectorScores=data.sector_scores||{};
    buildSectorRankMap();
    // ãƒ†ã‚£ãƒƒã‚«ãƒ¼æ›´æ–°
    const tItems=document.querySelectorAll('.ticker-item');
    if(data.nikkei_price&&tItems[0]){
      tItems[0].querySelector('.ticker-val').textContent='Â¥'+data.nikkei_price.toLocaleString();
      const nc=data.nikkei_1d_chg||0;
      tItems[0].querySelector('.ticker-chg').textContent=(nc>=0?'+':'')+nc+'%';
      tItems[0].querySelector('.ticker-chg').style.color=nc>=0?'#6EE7B7':'#FCA5A5';
    }
    if(data.dow_price&&tItems[1]){
      tItems[1].querySelector('.ticker-val').textContent='$'+data.dow_price.toLocaleString();
      const dc=data.dow_1d_chg||0;
      tItems[1].querySelector('.ticker-chg').textContent=(dc>=0?'+':'')+dc+'%';
      tItems[1].querySelector('.ticker-chg').style.color=dc>=0?'#6EE7B7':'#FCA5A5';
    }
    if(data.usdjpy&&tItems[2]){
      tItems[2].querySelector('.ticker-val').textContent='Â¥'+data.usdjpy;
      const uc=data.usdjpy_chg||0;
      tItems[2].querySelector('.ticker-chg').textContent=(uc>=0?'+':'')+uc+'å††';
      tItems[2].querySelector('.ticker-chg').style.color=uc>=0?'#6EE7B7':'#FCA5A5';
    }
  }catch(e){
    RAW=SAMPLE_STOCKS;
    window._updatedAt='ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿';
    window._stockData={};
  }
  await loadHistory();
  run();
  gaEvent('page_view',{version:'v8.1'});
  console.log('ğŸŸ¢ ã‹ã¶ã®ã™ã‘ v8.1 loaded');
}

init();
</script>
</body>
</html>
