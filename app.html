<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‹ã¶ã®ã™ã‘ â€” é«˜é…å½“æ ªã®è²·ã„å ´ã‚’æ¯æ—¥ã‚¹ã‚­ãƒ£ãƒ³</title>
<meta name="description" content="æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ 1,600éŠ˜æŸ„ã‚’æ¯æœè‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³ã€‚å¤§å‹å®‰å®šæ ªã®è‡ªåˆ†æ¯”æŠ¼ã—ç›®åº¦ãƒ»ä¸‹è½ãƒˆãƒ¬ãƒ³ãƒ‰ã§ä»Šæ—¥ã®è²·ã„å ´ã‚’å³è¡¨ç¤ºã€‚">

<!-- OGP -->
<meta property="og:title" content="ã‹ã¶ã®ã™ã‘ â€” é«˜é…å½“æ ªã®è²·ã„å ´ã‚’æ¯æœã‚¹ã‚­ãƒ£ãƒ³">
<meta property="og:description" content="æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ 1,600éŠ˜æŸ„ã‚’æ¯æœ7:30ã«è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³ã€‚é…å½“Ã—æ™‚ä¾¡ç·é¡Ã—ä¸‹è½ãƒˆãƒ¬ãƒ³ãƒ‰ã§ä»Šæ—¥è²·ã„æ™‚ã®é«˜é…å½“æ ªTOP5ã‚’å³è¡¨ç¤ºã€‚">
<meta property="og:image" content="https://oshime.vercel.app/ogp.png">
<meta property="og:url" content="https://oshime.vercel.app/app.html">
<meta property="og:type" content="website">
<meta property="og:site_name" content="ã‹ã¶ã®ã™ã‘">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@kabunosuke_navi">
<meta name="twitter:title" content="ã‹ã¶ã®ã™ã‘ â€” é«˜é…å½“æ ªã®è²·ã„å ´ã‚’æ¯æœã‚¹ã‚­ãƒ£ãƒ³">
<meta name="twitter:description" content="æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ 1,600éŠ˜æŸ„ã‹ã‚‰ä»Šæ—¥è²·ã„æ™‚ã®é«˜é…å½“æ ªTOP5ã‚’æ¯æœè‡ªå‹•ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€‚">
<meta name="twitter:image" content="https://oshime.vercel.app/ogp.png">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DWW0W11P5T"></script>
<script>
  window.dataLayer=window.dataLayer||[];
  function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());
  gtag('config','G-DWW0W11P5T',{page_title:'ã‹ã¶ã®ã™ã‘'});
  function gaEvent(n,p){if(typeof gtag!=='undefined')gtag('event',n,p||{});}
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  /* â”€â”€ SBI-inspired Refined Palette â”€â”€ */
  --navy:#0f172a; --navy2:#1e293b; --navy3:#334155;
  --accent:#2563eb; --accent-hover:#1d4ed8; --accent-lt:#eff6ff;
  --up:#dc2626; --up-lt:#fef2f2;
  --dn:#2563eb;
  --green:#059669; --green-lt:#ecfdf5;
  --amber:#d97706; --amber-lt:#fffbeb;
  --orange:#ea580c;
  --bg:#f8fafc; --bg2:#ffffff; --bg3:#f1f5f9;
  --border:#e2e8f0; --border2:#cbd5e1;
  --text:#0f172a; --text2:#334155; --text3:#64748b;
  --r:10px; --r2:6px;
  --fn:'IBM Plex Mono','Noto Sans JP',monospace;
  --fh:'Plus Jakarta Sans','Noto Sans JP',sans-serif;
  --fb:'Noto Sans JP','Plus Jakarta Sans',sans-serif;
  --shadow-sm:0 1px 2px rgba(15,23,42,0.05);
  --shadow:0 1px 3px rgba(15,23,42,0.08),0 1px 2px rgba(15,23,42,0.04);
  --shadow-md:0 4px 6px -1px rgba(15,23,42,0.08),0 2px 4px -2px rgba(15,23,42,0.04);
  --shadow-lg:0 10px 15px -3px rgba(15,23,42,0.08),0 4px 6px -4px rgba(15,23,42,0.04);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{font-size:15px;}
body{background:var(--bg);color:var(--text);font-family:var(--fb);min-height:100vh;overflow-x:hidden;}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{
  position:sticky;top:0;z-index:300;
  background:linear-gradient(180deg,var(--navy) 0%,#162033 100%);
  border-bottom:1px solid rgba(37,99,235,0.3);
  height:56px;display:flex;align-items:center;padding:0 20px;
  box-shadow:0 1px 3px rgba(0,0,0,0.12);
}
.topbar-inner{width:100%;max-width:1300px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;}
.logo-name{font-family:var(--fh);font-size:17px;font-weight:800;color:#fff;letter-spacing:-0.5px;}
.logo-tag{font-size:9px;color:rgba(148,163,184,0.7);font-family:var(--fh);margin-left:8px;letter-spacing:0.3px;}
.topbar-right{display:flex;align-items:center;gap:8px;}
.btn-topbar{
  background:rgba(37,99,235,0.15);border:1px solid rgba(37,99,235,0.3);
  border-radius:var(--r2);padding:5px 12px;color:rgba(255,255,255,0.9);cursor:pointer;
  font-family:var(--fh);font-size:11px;font-weight:600;
  display:flex;align-items:center;gap:5px;transition:all 0.2s;
}
.btn-topbar:hover{background:rgba(37,99,235,0.25);border-color:rgba(37,99,235,0.5);}
.watch-count{
  background:var(--accent);color:#fff;border-radius:10px;
  padding:1px 5px;font-size:9px;font-weight:700;display:none;
}
.watch-count.show{display:inline-block;}

/* â”€â”€ LAYOUT â”€â”€ */
.page{max-width:1300px;margin:0 auto;padding:20px 20px 100px;}
@media(max-width:480px){.page{padding:12px 12px 90px;}}

/* â”€â”€ HERO (compact) â”€â”€ */
.hero{
  background:linear-gradient(135deg,var(--navy) 0%,#1e3a5f 50%,#1a365d 100%);
  border-radius:var(--r);padding:20px 24px;margin-bottom:14px;
  box-shadow:var(--shadow-lg);position:relative;overflow:hidden;
}
.hero::before{
  content:'';position:absolute;top:-50%;right:-30%;width:60%;height:200%;
  background:radial-gradient(circle,rgba(37,99,235,0.08) 0%,transparent 70%);
  pointer-events:none;
}
.hero-top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.hero-left{}
.hero-eyebrow{
  display:inline-flex;align-items:center;gap:6px;
  font-family:var(--fh);font-size:10px;color:rgba(255,255,255,0.5);
  margin-bottom:8px;
}
.hero-dot{width:6px;height:6px;border-radius:50%;background:var(--orange);flex-shrink:0;animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}
.hero-title{font-family:var(--fh);font-size:22px;font-weight:800;color:#fff;line-height:1.2;letter-spacing:-0.3px;}
.hero-title span{color:var(--orange2);}
@media(max-width:480px){.hero-title{font-size:18px;}}
.hero-stats{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;}
.hero-stat{
  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);
  border-radius:var(--r2);padding:8px 14px;
}
.hero-stat-val{font-family:var(--fn);font-size:20px;color:#fff;line-height:1;}
.hero-stat-val.buy{color:var(--orange2);}
.hero-stat-label{font-size:9px;color:rgba(255,255,255,0.4);font-family:var(--fh);margin-top:2px;}

/* â”€â”€ TRUST BAR â”€â”€ */
.trust-bar{
  background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--amber);
  border-radius:var(--r);padding:8px 14px;margin-bottom:12px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.trust-left{display:flex;align-items:center;gap:8px;}
.trust-dot{width:8px;height:8px;border-radius:50%;background:var(--amber);flex-shrink:0;}
.trust-text{font-size:11px;color:var(--text3);}
.trust-text .hi{color:var(--green);font-weight:700;}
.trust-text .warn{color:var(--amber);font-weight:700;}
.trust-badges{display:flex;gap:6px;flex-wrap:wrap;}
.tbadge{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:4px;padding:2px 8px;font-size:10px;color:var(--text3);
  font-family:var(--fh);
}
.tbadge.link{cursor:pointer;color:var(--navy);border-color:var(--navy);}
.tbadge.link:hover{background:var(--navy);color:#fff;}

/* â”€â”€ MARKET PULSE â”€â”€ */
.pulse{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);margin-bottom:12px;overflow:hidden;
  box-shadow:var(--shadow-sm);
}
.pulse-row{display:flex;overflow-x:auto;scrollbar-width:none;}
.pulse-row::-webkit-scrollbar{display:none;}
.pc{flex-shrink:0;padding:9px 14px;border-right:1px solid var(--border);min-width:88px;text-align:center;}
.pc:last-child{border-right:none;}
.pc-l{font-size:9px;color:var(--text3);font-family:var(--fh);margin-bottom:2px;}
.pc-v{font-family:var(--fn);font-size:13px;color:var(--text2);}
.pc-v.up{color:var(--up);}  .pc-v.dn{color:var(--dn);}
.pc-c{font-family:var(--fn);font-size:10px;color:var(--text3);}
.pc-c.up{color:var(--up);}  .pc-c.dn{color:var(--dn);}

/* â”€â”€ STANCE â”€â”€ */
.stance{
  background:var(--bg2);border:1px solid var(--border);border-left:4px solid var(--border);
  border-radius:var(--r);padding:16px 18px;margin-bottom:14px;
  box-shadow:var(--shadow);
}
.stance.bull{border-left-color:var(--green);}
.stance.neutral{border-left-color:var(--amber);}
.stance.bear{border-left-color:var(--up);}
.stance-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
.stance-title{font-family:var(--fh);font-size:16px;font-weight:800;color:var(--text);}
.stance-date{font-size:10px;color:var(--text3);font-family:var(--fh);margin-top:2px;}
.stance-badge{
  flex-shrink:0;padding:4px 12px;border-radius:20px;
  font-family:var(--fh);font-size:11px;font-weight:700;border:1px solid;
}
.stance-badge.bull{background:rgba(5,150,105,0.08);color:var(--green);border-color:rgba(5,150,105,0.25);}
.stance-badge.neutral{background:var(--amber-lt);color:var(--amber);border-color:rgba(217,119,6,0.25);}
.stance-badge.bear{background:rgba(220,38,38,0.07);color:var(--up);border-color:rgba(220,38,38,0.2);}
.stance-reason{font-size:12px;color:var(--text);line-height:1.85;margin-bottom:12px;}
.stance-reason strong{color:var(--accent);font-weight:700;}
.stance-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.stance-chip{
  border:1px solid var(--border);border-radius:var(--r2);
  padding:6px 10px;text-align:center;flex:1;min-width:70px;background:var(--bg3);
}
.stance-chip.buy{background:var(--green-lt);border-color:rgba(0,135,90,0.2);}
.stance-chip.warn{background:var(--amber-lt);border-color:rgba(148,101,0,0.2);}
.stance-chip-val{font-family:var(--fn);font-size:15px;color:var(--text2);}
.stance-chip-label{font-size:9px;color:var(--text3);}
.stance-axes{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;}
.axis-row{display:flex;align-items:center;gap:8px;font-size:11px;}
.axis-name{min-width:110px;color:var(--text3);}
.axis-bar{display:flex;gap:3px;}
.axis-seg{width:24px;height:6px;border-radius:3px;background:var(--border);}
.axis-seg.on.hi{background:var(--up);}
.axis-seg.on.mid{background:var(--amber);}
.axis-score{font-family:var(--fn);font-size:10px;color:var(--text3);}
.axis-total{font-size:11px;font-weight:700;color:var(--text3);padding-top:4px;border-top:1px solid var(--border);}
.stance-note{font-size:10px;color:var(--text3);background:var(--bg3);padding:6px 10px;border-radius:var(--r2);line-height:1.6;}

/* â”€â”€ SECTION HEADER â”€â”€ */
.sec-head{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;
}
.sec-head-title{font-family:var(--fh);font-size:13px;font-weight:700;color:var(--text2);}
.sec-head-sub{font-size:10px;color:var(--text3);}

/* â”€â”€ FILTER BAR â”€â”€ */
.filter-bar{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  padding:12px 14px;margin-bottom:12px;
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.filter-label{font-family:var(--fh);font-size:11px;color:var(--text3);font-weight:600;}
.filter-tabs{display:flex;gap:4px;flex-wrap:wrap;}
.filter-tab{
  border:1px solid var(--border);border-radius:4px;padding:4px 10px;
  font-family:var(--fh);font-size:11px;font-weight:600;color:var(--text3);
  cursor:pointer;background:var(--bg3);white-space:nowrap;
}
.filter-tab.active{background:var(--navy);color:#fff;border-color:var(--navy);}
.filter-sep{width:1px;height:20px;background:var(--border);}
.filter-count{font-family:var(--fn);font-size:11px;color:var(--text3);margin-left:auto;}

/* â”€â”€ EVENTS CALENDAR â”€â”€ */
.events-section{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  margin-bottom:14px;overflow:hidden;padding:10px 14px;
}
.events-header{font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px;}
.events-list{display:flex;flex-direction:column;gap:4px;}
.event-item{
  display:flex;align-items:center;gap:8px;font-size:12px;
  padding:5px 8px;border-radius:6px;background:var(--bg3);
}
.event-date{color:var(--amber);font-weight:600;white-space:nowrap;min-width:50px;}
.event-label{color:var(--text);flex:1;}
.event-days{color:var(--sub);font-size:11px;white-space:nowrap;}
.event-item.today{background:#2d1a00;border-left:3px solid var(--orange);}
.event-item.soon{background:#1a1a00;border-left:3px solid var(--amber);}
/* earnings badge in stock row */
.earnings-badge{
  display:inline-block;font-size:10px;padding:1px 5px;border-radius:3px;
  margin-left:4px;font-weight:600;
}
.earnings-badge.soon{background:#2d1a00;color:var(--orange);}
.earnings-badge.recent{background:#001a2d;color:#5bc0de;}

/* â”€â”€ TODAY'S TOP5 â”€â”€ */
/* â”€â”€ TODAY'S TOP5 DUAL â”€â”€ */
.top5-dual{
  display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;
}
@media(max-width:700px){
  .top5-dual{grid-template-columns:1fr;}
}
.top5-section{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  margin-bottom:14px;overflow:hidden;
  border-left:4px solid var(--orange);
}
.top5-header{
  padding:14px 16px 10px;border-bottom:1px solid var(--border);
  background:linear-gradient(135deg,var(--bg2),var(--bg3));
}
.top5-title{font-family:var(--fh);font-size:15px;font-weight:700;color:var(--text1);}
.top5-sub{font-size:10px;color:var(--text3);margin-top:2px;}
.top5-list{padding:0;}
.top5-item{
  display:flex;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);
  cursor:pointer;transition:background .15s;min-height:48px;
}
.top5-item:last-child{border-bottom:none;}
.top5-item:hover,.top5-item:active{background:var(--bg3);}
.top5-rank{
  font-family:var(--fn);font-size:20px;font-weight:700;color:var(--navy);
  min-width:28px;padding-top:2px;
}
.top5-rank.gold{color:#f59e0b;}
.top5-info{flex:1;min-width:0;}
.top5-name-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.top5-name{font-family:var(--fh);font-size:14px;font-weight:700;color:var(--text1);}
.top5-score{
  font-family:var(--fn);font-size:11px;font-weight:700;padding:2px 8px;
  border-radius:4px;background:var(--navy);color:#fff;
}
.top5-score.hi{background:var(--green);}
.top5-meta{font-size:11px;color:var(--text2);margin-top:4px;font-family:var(--fn);line-height:1.6;}
.top5-reason{
  font-size:11px;color:var(--text3);margin-top:5px;line-height:1.6;
  padding-left:12px;border-left:2px solid var(--orange);
}
@media(max-width:480px){
  .top5-name{font-size:13px;}
  .top5-meta{font-size:10px;}
  .top5-reason{font-size:10px;}
}

/* â”€â”€ SECTOR FILTER â”€â”€ */
.sector-filter-wrap{
  margin-bottom:12px;overflow-x:auto;-webkit-overflow-scrolling:touch;
  scrollbar-width:none;
}
.sector-filter-wrap::-webkit-scrollbar{display:none;}
.sector-filter-scroll{
  display:flex;gap:6px;padding:2px 0;white-space:nowrap;
}
.sector-chip{
  border:1px solid var(--border);border-radius:16px;padding:7px 14px;
  font-family:var(--fh);font-size:12px;font-weight:600;color:var(--text3);
  cursor:pointer;background:var(--bg3);flex-shrink:0;transition:all .15s;
  min-height:36px;display:flex;align-items:center;
}
.sector-chip.active{background:var(--navy);color:#fff;border-color:var(--navy);}
.sector-chip .sector-count{font-weight:400;opacity:.7;margin-left:3px;}

/* â”€â”€ STOCK TABLE â”€â”€ */
.stock-table-wrap{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);overflow:hidden;margin-bottom:14px;
  box-shadow:var(--shadow);
}
.stock-table{width:100%;border-collapse:collapse;}
.stock-table th{
  background:var(--bg3);padding:10px 10px;
  font-family:var(--fh);font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.3px;
  text-align:right;border-bottom:2px solid var(--border);
  white-space:nowrap;cursor:pointer;user-select:none;
}
.stock-table th:first-child{text-align:left;}
.stock-table th:hover{color:var(--accent);}
.stock-table th.sort-asc::after{content:' â–²';color:var(--accent);}
.stock-table th.sort-desc::after{content:' â–¼';color:var(--accent);}
.stock-table td{
  padding:9px 10px;border-bottom:1px solid var(--border);
  font-size:12px;text-align:right;color:var(--text);
  vertical-align:middle;
}
.stock-table td:first-child{text-align:left;}
.stock-table tr:last-child td{border-bottom:none;}
.stock-table tr.tbl-row{cursor:pointer;transition:background 0.15s;}
.stock-table tr.tbl-row:hover{background:var(--accent-lt);}
.stock-table tr.tbl-row.expanded{background:var(--accent-lt);}
.tbl-rank{
  font-family:var(--fn);font-size:11px;font-weight:700;
  width:28px;text-align:center;
}
.tbl-rank.top{color:var(--orange);}
.tbl-name{font-weight:600;color:var(--text2);font-size:12px;}
.tbl-name-link{font-weight:600;color:var(--text2);font-size:12px;text-decoration:none;display:block;}
.tbl-name-link:hover{color:var(--navy);text-decoration:underline;}
.tbl-code{font-family:var(--fn);font-size:10px;color:var(--text3);}
.tbl-zone{
  display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;
  font-family:var(--fh);font-size:10px;font-weight:700;white-space:nowrap;
}
.tbl-zone.buy{background:var(--green-lt);color:var(--green);}
.tbl-zone.watch{background:var(--amber-lt);color:var(--amber);}
.tbl-zone.hold{background:var(--bg3);color:var(--text3);}
.tbl-score{font-family:var(--fn);font-size:13px;font-weight:700;}
.tbl-score.hi{color:var(--up);}
.tbl-score.md{color:var(--amber);}
.tbl-score.lo{color:var(--text3);}
.tbl-num{font-family:var(--fn);font-size:12px;}
.tbl-num.dn{color:var(--up);}   /* ä¹–é›¢ãƒã‚¤ãƒŠã‚¹=èµ¤=è²·ã„å ´ */
.tbl-num.up{color:var(--dn);}
.tbl-prev{font-family:var(--fn);font-size:10px;}
.tbl-prev.up{color:var(--up);}
.tbl-prev.dn{color:var(--dn);}
/* å±•é–‹è©³ç´°è¡Œ */
.detail-row td{padding:0;background:#f0f7ff;}
.detail-box{padding:14px 16px;border-top:1px solid #d0e4f7;}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:600px){.detail-grid{grid-template-columns:1fr;}}
.detail-section-title{font-family:var(--fh);font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.5px;margin-bottom:8px;}
.why-items{display:flex;flex-direction:column;gap:6px;}
.why-item{
  background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--r2);
  padding:8px 12px;position:relative;
}
.why-item.strong{border-color:rgba(208,2,27,0.25);background:rgba(208,2,27,0.03);}
.why-item.mid{border-color:rgba(148,101,0,0.25);background:var(--amber-lt);}
.why-rank-badge{
  position:absolute;top:8px;right:8px;
  width:16px;height:16px;border-radius:50%;
  font-family:var(--fh);font-size:8px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
}
.why-rank-badge.strong{background:rgba(208,2,27,0.1);color:var(--up);}
.why-rank-badge.mid{background:rgba(148,101,0,0.1);color:var(--amber);}
.why-val{font-family:var(--fn);font-size:18px;color:var(--text2);}
.why-item.strong .why-val{color:var(--up);}
.why-item.mid .why-val{color:var(--amber);}
.why-label{font-size:9px;color:var(--text3);}
.why-note-text{font-size:11px;font-weight:700;margin-top:2px;}
.why-item.strong .why-note-text{color:var(--up);}
.why-item.mid .why-note-text{color:var(--amber);}
.why-desc{font-size:10px;color:var(--text3);line-height:1.6;margin-top:2px;}
.score-breakdown{display:flex;flex-direction:column;gap:5px;}
.bd-row{display:flex;align-items:center;gap:8px;}
.bd-l{font-size:10px;color:var(--text3);min-width:70px;}
.bd-bar{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.bd-fill{height:100%;border-radius:3px;transition:width 0.4s ease;}
.bd-v{font-family:var(--fn);font-size:10px;min-width:38px;text-align:right;}
.bd-v.pos{color:var(--green);}  .bd-v.neg{color:var(--up);}
.detail-fav-btn{
  padding:7px 16px;border-radius:var(--r2);
  font-family:var(--fh);font-size:11px;font-weight:700;cursor:pointer;
  border:1.5px solid var(--border);background:var(--bg2);color:var(--text2);
}
.detail-fav-btn.active{background:var(--orange);color:#fff;border-color:var(--orange);}
.detail-link-btn{
  padding:7px 14px;border-radius:var(--r2);
  font-family:var(--fh);font-size:11px;font-weight:700;
  border:1.5px solid var(--border);background:var(--bg3);color:var(--navy);
  text-decoration:none;display:inline-flex;align-items:center;
}
.detail-link-btn:hover{background:var(--navy);color:#fff;border-color:var(--navy);}
/* å¤‰åŒ–ãƒãƒƒã‚¸ */
.change-badge{
  display:inline-flex;align-items:center;padding:1px 6px;border-radius:3px;
  font-family:var(--fn);font-size:10px;font-weight:700;
}
.change-badge.up{background:rgba(208,2,27,0.07);color:var(--up);}
.change-badge.dn{background:rgba(0,85,204,0.07);color:var(--dn);}

/* â”€â”€ TREND BADGES â”€â”€ */
.trend-badge{
  display:inline-flex;align-items:center;
  padding:1px 6px;border-radius:3px;
  font-size:9px;font-weight:700;font-family:var(--fh);
  white-space:nowrap;cursor:default;
}
.trend-badge.hot{background:rgba(208,2,27,0.1);color:var(--up);border:1px solid rgba(208,2,27,0.2);}
.trend-badge.warm{background:rgba(148,101,0,0.08);color:var(--amber);border:1px solid rgba(148,101,0,0.15);}

/* â”€â”€ STYLE TABS â”€â”€ */
.style-tabs-wrap{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px;}
.style-tab{
  background:var(--bg2);border:2px solid var(--border);border-radius:var(--r);
  padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.15s;
}
.style-tab:hover{border-color:var(--navy);background:var(--bg3);}
.style-tab.active{border-color:var(--navy);background:var(--navy);}
.style-tab-ico{font-size:24px;flex-shrink:0;}
.style-tab-title{font-family:var(--fh);font-size:13px;font-weight:800;color:var(--text2);}
.style-tab.active .style-tab-title{color:#fff;}
.style-tab-desc{font-size:10px;color:var(--text3);margin-top:2px;}
.style-tab.active .style-tab-desc{color:rgba(255,255,255,0.6);}
@media(max-width:768px){
  .style-tabs-wrap{
    display:flex;overflow-x:auto;-webkit-overflow-scrolling:touch;
    scrollbar-width:none;gap:8px;padding-bottom:4px;
  }
  .style-tabs-wrap::-webkit-scrollbar{display:none;}
  .style-tab{min-width:160px;flex-shrink:0;padding:10px 12px;}
  .style-tab-ico{font-size:20px;}
  .style-tab-title{font-size:12px;}
}

/* â”€â”€ TREND WARNING â”€â”€ */
.trend-warning{
  background:rgba(208,2,27,0.06);border:1px solid rgba(208,2,27,0.2);
  border-radius:var(--r2);padding:8px 14px;margin-bottom:12px;
  font-size:11px;font-weight:700;color:var(--up);
}

/* â”€â”€ DANGER SECTION â”€â”€ */
.danger-section{
  background:var(--bg2);border:1px solid var(--border);border-left:4px solid var(--up);
  border-radius:var(--r);padding:14px 16px;margin-bottom:14px;
}
.danger-title{font-family:var(--fh);font-size:12px;font-weight:700;color:var(--up);margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.danger-rows{display:flex;flex-direction:column;gap:6px;}
.danger-row{
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  background:var(--bg3);border:1px solid var(--border);border-radius:var(--r2);
  padding:8px 12px;
}
.danger-name{font-size:12px;font-weight:600;color:var(--text2);}
.danger-code{font-family:var(--fn);font-size:10px;color:var(--text3);}
.danger-reason{font-size:10px;color:var(--up);font-weight:700;background:rgba(208,2,27,0.07);padding:2px 7px;border-radius:4px;}

/* â”€â”€ WATCHLIST / HISTORY â”€â”€ */
.watch-empty{padding:20px;text-align:center;font-size:12px;color:var(--text3);}
.watch-list{display:flex;flex-direction:column;gap:6px;}
.watch-row{
  display:flex;align-items:center;gap:10px;padding:10px 14px;
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;
}
.watch-row:hover{background:var(--bg3);}
.watch-code{font-family:var(--fn);font-size:11px;color:var(--text3);min-width:36px;}
.watch-name{flex:1;font-size:12px;font-weight:600;color:var(--text2);}
.watch-score{font-family:var(--fn);font-size:13px;font-weight:700;}
.watch-score.hi{color:var(--up);} .watch-score.md{color:var(--amber);} .watch-score.lo{color:var(--text3);}
.watch-remove{background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px;padding:4px;}
.hist-table{width:100%;border-collapse:collapse;font-size:11px;}
.hist-table th{background:var(--bg3);padding:6px 10px;text-align:left;font-family:var(--fh);font-size:10px;color:var(--text3);border-bottom:1px solid var(--border);}
.hist-table td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text);}
.hist-table tr:last-child td{border-bottom:none;}

/* â”€â”€ SETTINGS PANEL â”€â”€ */
.settings-overlay{
  position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.4);
  display:none;align-items:flex-end;justify-content:center;
}
.settings-overlay.open{display:flex;}
.settings-box{
  background:var(--bg2);border-radius:16px 16px 0 0;
  padding:20px;width:100%;max-width:600px;max-height:85vh;overflow-y:auto;
}
.settings-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.settings-title{font-family:var(--fh);font-size:15px;font-weight:800;color:var(--text2);margin-bottom:16px;}
.setting-row{margin-bottom:14px;}
.setting-label{font-family:var(--fh);font-size:11px;font-weight:700;color:var(--text3);margin-bottom:6px;letter-spacing:0.5px;}
.setting-opts{display:flex;gap:6px;flex-wrap:wrap;}
.setting-opt{
  border:1.5px solid var(--border);border-radius:var(--r2);padding:6px 12px;
  font-family:var(--fh);font-size:11px;font-weight:600;color:var(--text);
  cursor:pointer;background:var(--bg3);
}
.setting-opt.active{background:var(--navy);color:#fff;border-color:var(--navy);}
.settings-save{
  width:100%;padding:12px;margin-top:8px;
  background:var(--orange);color:#fff;border:none;border-radius:var(--r);
  font-family:var(--fh);font-size:13px;font-weight:700;cursor:pointer;
}
.settings-save:hover{background:var(--orange2);}

/* â”€â”€ NAV TABS â”€â”€ */
.nav-tabs{
  display:flex;background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);margin-bottom:14px;overflow:hidden;
}
.nav-tab{
  flex:1;padding:10px;text-align:center;cursor:pointer;
  font-family:var(--fh);font-size:11px;font-weight:700;color:var(--text3);
  border-right:1px solid var(--border);position:relative;
}
.nav-tab:last-child{border-right:none;}
.nav-tab.active{color:var(--navy);background:var(--navy);color:#fff;}

/* â”€â”€ BOTTOM NAV (mobile) â”€â”€ */
.bottom-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;z-index:200;
  background:var(--bg2);border-top:1px solid var(--border);
  padding:6px 0 8px;
}
@media(max-width:768px){.bottom-nav{display:flex;}}
.nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;
  background:none;border:none;cursor:pointer;color:var(--text3);padding:4px;
}
.nav-item.active{color:var(--navy);}
.nav-ico{font-size:18px;}
.nav-label{font-size:9px;font-family:var(--fh);font-weight:700;}

/* â”€â”€ PANELS â”€â”€ */
.panel{display:none;}
.panel.active{display:block;}

/* â”€â”€ SKELETON â”€â”€ */
.skeleton{background:var(--border);border-radius:4px;animation:shimmer 1.5s infinite linear;background:linear-gradient(90deg,var(--border) 25%,#e8edf2 50%,var(--border) 75%);background-size:200% 100%;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.skel-row{height:40px;margin-bottom:4px;border-radius:4px;}

/* â”€â”€ MISC â”€â”€ */
.fadein{animation:fi 0.3s ease;}
@keyframes fi{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}
.disclaimer{font-size:10px;color:var(--text3);text-align:center;padding:12px 0;line-height:1.8;}
.sec-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:14px;}
.empty-msg{text-align:center;padding:20px;font-size:12px;color:var(--text3);}

/* â”€â”€ LOGIC MODAL â”€â”€ */
.logic-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.4);display:none;align-items:flex-end;justify-content:center;}
.logic-overlay.open{display:flex;}
.logic-box{background:var(--bg2);border-radius:16px 16px 0 0;padding:20px;width:100%;max-width:600px;max-height:80vh;overflow-y:auto;}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.logic-title{font-family:var(--fh);font-size:15px;font-weight:800;color:var(--text2);margin-bottom:6px;}
.logic-sub{font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.7;}
.logic-tbl{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:14px;}
.logic-tbl th{background:var(--bg3);padding:7px 10px;text-align:left;font-family:var(--fh);font-size:10px;color:var(--text3);border-bottom:1px solid var(--border);}
.logic-tbl td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text);}
.logic-tbl .pts{text-align:right;font-family:var(--fn);font-weight:700;}
.logic-note{background:var(--bg3);border-radius:var(--r2);padding:12px;font-size:11px;color:var(--text);line-height:1.9;margin-bottom:14px;}
.btn-logic-close{width:100%;padding:10px;background:var(--navy);color:#fff;border:none;border-radius:var(--r);font-family:var(--fh);font-size:13px;font-weight:700;cursor:pointer;}

@media(max-width:600px){
  .stock-table th:nth-child(n+8),.stock-table td:nth-child(n+8){display:none;}
}
@media(max-width:480px){
  .stock-table th:nth-child(n+6),.stock-table td:nth-child(n+6){display:none;}
}

/* â”€â”€ 4è±¡é™ QUADRANT MAP â”€â”€ */
.quadrant-section{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  padding:20px;margin-bottom:14px;box-shadow:var(--shadow);
}
.quadrant-title{
  font-family:var(--fh);font-size:14px;font-weight:700;color:var(--text);
  margin-bottom:4px;display:flex;align-items:center;gap:8px;
}
.quadrant-sub{font-size:11px;color:var(--text3);margin-bottom:16px;}
.quadrant-wrap{position:relative;width:100%;max-width:460px;margin:0 auto;aspect-ratio:1/1;}
.quadrant-grid{
  position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;
  border:2px solid var(--border2);border-radius:8px;overflow:hidden;
}
.q-cell{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:12px 8px;position:relative;transition:background 0.2s;cursor:default;
}
.q-cell:nth-child(1){background:rgba(37,99,235,0.03);border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.q-cell:nth-child(2){background:rgba(5,150,105,0.03);border-bottom:1px solid var(--border);}
.q-cell:nth-child(3){background:rgba(100,116,139,0.03);border-right:1px solid var(--border);}
.q-cell:nth-child(4){background:rgba(234,88,12,0.03);}
.q-cell:hover{filter:brightness(0.97);}
.q-label{font-family:var(--fh);font-size:11px;font-weight:700;margin-bottom:4px;}
.q-desc{font-size:9px;color:var(--text3);text-align:center;line-height:1.4;}
.q-players{font-size:9px;color:var(--text3);margin-top:6px;opacity:0.7;}
.q-dot{
  position:absolute;width:18px;height:18px;border-radius:50%;
  background:var(--accent);border:3px solid var(--bg2);
  box-shadow:0 0 0 2px var(--accent),var(--shadow-md);
  transition:all 0.6s cubic-bezier(0.34,1.56,0.64,1);z-index:10;
}
.q-dot-label{
  position:absolute;font-family:var(--fh);font-size:9px;font-weight:700;
  color:var(--accent);white-space:nowrap;z-index:10;
  transition:all 0.6s cubic-bezier(0.34,1.56,0.64,1);
}
.q-dot.pulse{animation:qpulse 2s infinite;}
@keyframes qpulse{0%,100%{box-shadow:0 0 0 2px var(--accent),0 0 0 4px rgba(37,99,235,0.2)}50%{box-shadow:0 0 0 2px var(--accent),0 0 0 8px rgba(37,99,235,0.1)}}
.q-axis{position:absolute;font-family:var(--fh);font-size:9px;font-weight:600;color:var(--text3);}
.q-axis-x-l{left:4px;top:50%;transform:translateY(-50%) rotate(-90deg);transform-origin:center;}
.q-axis-x-r{right:4px;top:50%;transform:translateY(-50%) rotate(90deg);transform-origin:center;}
.q-axis-y-t{top:4px;left:50%;transform:translateX(-50%);}
.q-axis-y-b{bottom:4px;left:50%;transform:translateX(-50%);}

/* â”€â”€ AFFILIATE SLOT â”€â”€ */
.ad-slot{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  padding:14px 18px;margin-bottom:14px;
  display:flex;align-items:center;gap:14px;
  box-shadow:var(--shadow-sm);transition:border-color 0.2s;
}
.ad-slot:hover{border-color:var(--accent);}
.ad-slot-icon{
  width:44px;height:44px;border-radius:8px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,var(--navy),#1e3a5f);color:#fff;font-size:18px;
}
.ad-slot-body{flex:1;min-width:0;}
.ad-slot-title{font-family:var(--fh);font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;}
.ad-slot-desc{font-size:10px;color:var(--text3);line-height:1.4;}
.ad-slot-cta{
  flex-shrink:0;padding:7px 16px;border-radius:var(--r2);
  background:var(--accent);color:#fff;font-family:var(--fh);font-size:11px;font-weight:700;
  text-decoration:none;transition:background 0.2s;white-space:nowrap;
}
.ad-slot-cta:hover{background:var(--accent-hover);}
.ad-slot-tag{font-size:8px;color:var(--text3);opacity:0.5;margin-top:4px;}
@media(max-width:480px){
  .ad-slot{flex-wrap:wrap;}
  .ad-slot-cta{width:100%;text-align:center;}
}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-inner">
    <div>
      <span class="logo-name">ã‹ã¶ã®ã™ã‘</span>
      <span class="logo-tag">é«˜é…å½“æ ªã®è²·ã„å ´ã‚’æ¯æœã‚¹ã‚­ãƒ£ãƒ³</span>
    </div>
    <div class="topbar-right">
      <button class="btn-topbar" onclick="switchTab('watch')">
        â­ ã‚¦ã‚©ãƒƒãƒ <span class="watch-count" id="watchCount">0</span>
      </button>
      <button class="btn-topbar" onclick="openSettings()">âš™ è¨­å®š</button>
    </div>
  </div>
</div>

<div class="page">

  <!-- â•â• HOME PANEL â•â• -->
  <div class="panel active" id="panel-home">

    <!-- HERO -->
    <div class="hero">
      <div class="hero-eyebrow" id="heroEyebrow">
        <span class="hero-dot"></span>æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ 1,600éŠ˜æŸ„ â€” æ¯æœ7:30è‡ªå‹•æ›´æ–°
      </div>
      <div class="hero-top">
        <div class="hero-left">
          <div class="hero-title">ä»Šæ—¥ã®<span>è²·ã„å ´</span>ã‚’å³è¡¨ç¤º</div>
        </div>
      </div>
      <div class="hero-stats" id="heroStats">
        <div class="hero-stat"><div class="hero-stat-val buy" id="hsBuy">â€”</div><div class="hero-stat-label">è²·ã„åœã®éŠ˜æŸ„æ•°</div></div>
        <div class="hero-stat"><div class="hero-stat-val" id="hsTop">â€”</div><div class="hero-stat-label">æœ¬æ—¥1ä½ã‚¹ã‚³ã‚¢</div></div>
        <div class="hero-stat"><div class="hero-stat-val" id="hsDiv">â€”</div><div class="hero-stat-label">æœ€é«˜é…å½“åˆ©å›ã‚Š</div></div>
        <div class="hero-stat"><div class="hero-stat-val" id="hsTotal">â€”</div><div class="hero-stat-label">ã‚¹ã‚­ãƒ£ãƒ³éŠ˜æŸ„æ•°</div></div>
      </div>
    </div>

    <!-- TRUST BAR -->
    <div class="trust-bar" id="trustBanner">
      <div class="trust-left">
        <div class="trust-dot" id="trustDot"></div>
        <div class="trust-text" id="trustText">ãƒ‡ãƒ¼ã‚¿ç¢ºèªä¸­...</div>
      </div>
      <div class="trust-badges">
        <span class="tbadge" id="totalCountBadge">æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ </span>
        <span class="tbadge link" onclick="openLogicModal()">ã‚¹ã‚³ã‚¢è¨ˆç®—å¼ â–¶</span>
      </div>
    </div>

    <!-- MARKET PULSE -->
    <div class="pulse"><div class="pulse-row" id="pulseBar"></div></div>

    <!-- STANCE -->
    <div id="stanceBox"></div>

    <!-- UPCOMING EVENTS -->
    <div class="events-section" id="eventsSection" style="display:none">
      <div class="events-header">ğŸ“… ä»Šé€±ã€œæ¥é€±ã®é‡è¦ã‚¤ãƒ™ãƒ³ãƒˆ</div>
      <div class="events-list" id="eventsList"></div>
    </div>

    <!-- 4è±¡é™ POSITION MAP -->
    <div class="quadrant-section" id="quadrantSection">
      <div class="quadrant-title">ğŸ“Š ã‹ã¶ã®ã™ã‘ã®ãƒã‚¸ã‚·ãƒ§ãƒ³</div>
      <div class="quadrant-sub">ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æ Ã— çŸ­æœŸå£²è²·ã«ç‰¹åŒ–ã€‚6ãƒ¶æœˆãƒˆãƒ¬ãƒ³ãƒ‰ã§5æ—¥ã®å£²è²·ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ¤å®š</div>
      <div class="quadrant-wrap" id="quadrantWrap">
        <div class="q-axis q-axis-y-t" style="font-size:10px">ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«é‡è¦–</div>
        <div class="q-axis q-axis-y-b" style="font-size:10px">ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«é‡è¦–</div>
        <div class="q-axis" style="left:4px;bottom:50%;font-size:10px;transform:translateY(50%)">é•·æœŸ</div>
        <div class="q-axis" style="right:4px;bottom:50%;font-size:10px;transform:translateY(50%)">çŸ­æœŸ</div>
        <div class="quadrant-grid">
          <div class="q-cell">
            <div class="q-label" style="color:var(--accent)">ãƒãƒªãƒ¥ãƒ¼æŠ•è³‡</div>
            <div class="q-desc">ä¼æ¥­ä¾¡å€¤ã‚’åˆ†æã—<br>é•·æœŸä¿æœ‰ã§æˆé•·ã‚’å¾…ã¤</div>
            <div class="q-players">å››å­£å ±ãƒ»ãƒãƒ•ã‚§ãƒƒãƒˆæµ</div>
          </div>
          <div class="q-cell">
            <div class="q-label" style="color:var(--green)">æ±ºç®—ãƒ—ãƒ¬ã‚¤</div>
            <div class="q-desc">ãƒ•ã‚¡ãƒ³ãƒ€ã§éŠ˜æŸ„é¸å®šã—<br>æ±ºç®—ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å£²è²·</div>
            <div class="q-players">ãƒãƒãƒƒã‚¯ã‚¹ãƒ»SBI</div>
          </div>
          <div class="q-cell">
            <div class="q-label" style="color:var(--text3)">ãƒãƒ£ãƒ¼ãƒˆé•·æœŸ</div>
            <div class="q-desc">ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã§é•·æœŸ<br>ãƒˆãƒ¬ãƒ³ãƒ‰ã«ä¹—ã‚‹</div>
            <div class="q-players">ç©ºç™½åœ°å¸¯</div>
          </div>
          <div class="q-cell">
            <div class="q-label" style="color:var(--orange)">çŸ­æœŸãƒ†ã‚¯ãƒ‹ã‚«ãƒ«</div>
            <div class="q-desc">ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã§<br>çŸ­æœŸã®å£²è²·ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ¤å®š</div>
            <div class="q-players" style="font-weight:700;color:var(--accent)">â˜… ã‹ã¶ã®ã™ã‘</div>
          </div>
        </div>
        <div class="q-dot pulse" id="qDot"></div>
        <div class="q-dot-label" id="qDotLabel">ã‹ã¶ã®ã™ã‘</div>
      </div>
    </div>

    <!-- AFFILIATE SLOT 1 (TOP) -->
    <a class="ad-slot" id="adSlot1" href="https://www.sbisec.co.jp/" target="_blank" rel="noopener sponsored" onclick="gaEvent('click_ad',{slot:'top',name:'sbi'})">
      <div class="ad-slot-icon">ğŸ“ˆ</div>
      <div class="ad-slot-body">
        <div class="ad-slot-title">SBIè¨¼åˆ¸ â€” NISAå£åº§é–‹è¨­ã§æŠ•è³‡ãƒ‡ãƒ“ãƒ¥ãƒ¼</div>
        <div class="ad-slot-desc">ã‹ã¶ã®ã™ã‘ã§è¦‹ã¤ã‘ãŸéŠ˜æŸ„ã‚’ã™ãè³¼å…¥ã€‚æ¥­ç•Œæœ€å®‰æ°´æº–ã®æ‰‹æ•°æ–™ã§é«˜é…å½“æ ªæŠ•è³‡ã‚’å§‹ã‚ã‚ˆã†ã€‚</div>
        <div class="ad-slot-tag">PRãƒ»åºƒå‘Š</div>
      </div>
      <span class="ad-slot-cta">å£åº§é–‹è¨­ â†’</span>
    </a>

    <!-- TODAY'S TOP5 DUAL -->
    <div class="top5-dual" id="top5Section" style="display:none">
      <div class="top5-section" style="border-left:4px solid var(--green)">
        <div class="top5-header">
          <div class="top5-title">ğŸ›¡ æŠ¼ã—ç›® TOP5</div>
          <div class="top5-sub">ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ä¸­ã«çŸ­æœŸä¸‹è½ã—ãŸéŠ˜æŸ„</div>
        </div>
        <div class="top5-list" id="top5DipList"></div>
      </div>
      <div class="top5-section" style="border-left:4px solid #e040fb">
        <div class="top5-header">
          <div class="top5-title">ğŸš€ å‹¢ã„ TOP5</div>
          <div class="top5-sub">å…¨æœŸé–“ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ã®éŠ˜æŸ„</div>
        </div>
        <div class="top5-list" id="top5MomList"></div>
      </div>
    </div>

    <!-- FILTER BAR -->
    <div class="filter-bar">
      <span class="filter-label">è¡¨ç¤ºï¼š</span>
      <div class="filter-tabs">
        <div class="filter-tab active" id="disp-10" onclick="setDispCount(10,this)">TOP10</div>
        <div class="filter-tab" id="disp-30" onclick="setDispCount(30,this)">TOP30</div>
        <div class="filter-tab" id="disp-all" onclick="setDispCount(999,this)">å…¨ä»¶</div>
      </div>
      <div class="filter-count" id="filterCount"></div>
      <div id="styleNote" style="font-size:10px;color:var(--green);margin-left:auto;">ğŸ“ˆ æ™‚é–“åŠ é‡ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¹ã‚³ã‚¢ â€” 6ãƒ¶æœˆâ†’5æ—¥ã®åŠ é€Ÿåº¦ã§è©•ä¾¡</div>
    </div>

    <!-- SECTOR FILTER -->
    <div class="sector-filter-wrap" id="sectorFilterWrap">
      <div class="sector-filter-scroll" id="sectorFilterScroll"></div>
    </div>

    <!-- STOCK TABLE -->
    <div class="stock-table-wrap" id="tableWrap">
      <div style="padding:20px;text-align:center">
        <div class="skel-row skeleton"></div>
        <div class="skel-row skeleton"></div>
        <div class="skel-row skeleton"></div>
        <div style="font-size:11px;color:var(--text3);margin-top:8px">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <!-- DANGER SECTION -->
    <div id="dangerSection"></div>

    <!-- AFFILIATE SLOT 2 (BOTTOM) -->
    <a class="ad-slot" id="adSlot2" href="https://www.rakuten-sec.co.jp/" target="_blank" rel="noopener sponsored" onclick="gaEvent('click_ad',{slot:'bottom',name:'rakuten'})" style="margin-top:14px">
      <div class="ad-slot-icon">ğŸ’°</div>
      <div class="ad-slot-body">
        <div class="ad-slot-title">æ¥½å¤©è¨¼åˆ¸ â€” æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆã§æ ªã‚’è²·ãˆã‚‹</div>
        <div class="ad-slot-desc">ãƒã‚¤ãƒ³ãƒˆæŠ•è³‡ã§æ°—è»½ã«ã‚¹ã‚¿ãƒ¼ãƒˆã€‚NISAå¯¾å¿œãƒ»æ‰‹æ•°æ–™0å††ã§é«˜é…å½“æ ªæŠ•è³‡ã‚’å§‹ã‚ã‚ˆã†ã€‚</div>
        <div class="ad-slot-tag">PRãƒ»åºƒå‘Š</div>
      </div>
      <span class="ad-slot-cta">è©³ã—ãè¦‹ã‚‹ â†’</span>
    </a>

    <!-- DISCLAIMER -->
    <div class="disclaimer">âš ï¸ æœ¬ãƒ„ãƒ¼ãƒ«ã¯å‚è€ƒæƒ…å ±ã®æä¾›ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚æ ªå¼æŠ•è³‡ã«ã¯å…ƒæœ¬å‰²ã‚Œã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚</div>

  </div><!-- /panel-home -->

  <!-- â•â• WATCH PANEL â•â• -->
  <div class="panel" id="panel-watch">
    <div class="sec-wrap">
      <div class="sec-head">
        <div class="sec-head-title">â­ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ</div>
      </div>
      <div id="watchlistBody"></div>
    </div>
    <div class="sec-wrap">
      <div class="sec-head">
        <div class="sec-head-title">ğŸ• ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´</div>
      </div>
      <div id="historyBody"></div>
    </div>
  </div>

</div><!-- /page -->

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" id="nav-home" onclick="switchTab('home')">
    <span class="nav-ico">ğŸ </span><span class="nav-label">ãƒ›ãƒ¼ãƒ </span>
  </button>
  <button class="nav-item" id="nav-watch" onclick="switchTab('watch')">
    <span class="nav-ico">â­</span><span class="nav-label">ã‚¦ã‚©ãƒƒãƒ</span>
  </button>
</nav>

<!-- SETTINGS PANEL -->
<div class="settings-overlay" id="settingsOverlay" onclick="closeSettingsBg(event)">
  <div class="settings-box">
    <div class="settings-handle"></div>
    <div class="settings-title">âš™ è¡¨ç¤ºè¨­å®š</div>
    <div class="setting-row">
      <div class="setting-label">è¡¨ç¤ºä»¶æ•°</div>
      <div class="setting-opts" id="set-count">
        <div class="setting-opt" data-val="10" onclick="selectSettingOpt(this,'count')">TOP 10</div>
        <div class="setting-opt active" data-val="30" onclick="selectSettingOpt(this,'count')">TOP 30</div>
        <div class="setting-opt" data-val="999" onclick="selectSettingOpt(this,'count')">å…¨ä»¶è¡¨ç¤º</div>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">æœ€ä½é…å½“åˆ©å›ã‚Š</div>
      <div class="setting-opts" id="set-mindiv">
        <div class="setting-opt active" data-val="0" onclick="selectSettingOpt(this,'mindiv')">åˆ¶é™ãªã—</div>
        <div class="setting-opt" data-val="2" onclick="selectSettingOpt(this,'mindiv')">2%ä»¥ä¸Š</div>
        <div class="setting-opt" data-val="3" onclick="selectSettingOpt(this,'mindiv')">3%ä»¥ä¸Š</div>
        <div class="setting-opt" data-val="4" onclick="selectSettingOpt(this,'mindiv')">4%ä»¥ä¸Š</div>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">ã‚¾ãƒ¼ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
      <div class="setting-opts" id="set-zone">
        <div class="setting-opt active" data-val="all" onclick="selectSettingOpt(this,'zone')">å…¨ã¦</div>
        <div class="setting-opt" data-val="buy" onclick="selectSettingOpt(this,'zone')">è²·ã„åœã®ã¿</div>
        <div class="setting-opt" data-val="buywatch" onclick="selectSettingOpt(this,'zone')">è²·ã„åœï¼‹æ³¨æ„åœ</div>
      </div>
    </div>
    <button class="settings-save" onclick="saveSettings()">âœ“ ä¿å­˜ã—ã¦é©ç”¨</button>
  </div>
</div>

<!-- LOGIC MODAL -->
<div class="logic-overlay" id="logicModal" onclick="closeLogicModal(event)">
  <div class="logic-box">
    <div class="modal-handle"></div>
    <div class="logic-title">ã‚¹ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ v4ï¼ˆãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæœ€é©åŒ–æ¸ˆã¿ï¼‰</div>
    <div class="logic-sub">éå»1å¹´ãƒ»46é€±ã®ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼æ¸ˆã¿ã€‚ã‚¿ã‚¤ãƒŸãƒ³ã‚°æŒ‡æ¨™ãŒæœ€é‡è¦ã€‚é…å½“ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å°‚ç”¨ï¼ˆ2%ä»¥ä¸ŠãŒå¯¾è±¡ï¼‰ã€‚</div>
    <table class="logic-tbl">
      <tr><th>æŒ‡æ¨™</th><th>æ¡ä»¶</th><th style="text-align:right">æœ€å¤§ç‚¹</th></tr>
      <tr style="background:#1a2e1a"><td>å€‹åˆ¥vsã‚»ã‚¯ã‚¿ãƒ¼å·®åˆ†</td><td>-0.5%ã€œ-5%ä»¥ä¸‹</td><td class="pts">25pt</td></tr>
      <tr style="background:#1a2e1a"><td>å€‹åˆ¥5æ—¥ä¸‹è½</td><td>-0.5%ã€œ-5%ä»¥ä¸‹</td><td class="pts">25pt</td></tr>
      <tr style="background:#1a2e1a"><td>è‡ªåˆ†æ¯”æŠ¼ã—ç›®åº¦</td><td>-0.5Ïƒã€œ-3Ïƒä»¥ä¸‹</td><td class="pts">15pt</td></tr>
      <tr><td>10æ—¥ãƒªã‚¿ãƒ¼ãƒ³</td><td>-1%ã€œ-8%ä»¥ä¸‹</td><td class="pts">5pt</td></tr>
      <tr><td>æ™‚ä¾¡ç·é¡</td><td>500å„„ã€œ5å…†å††ä»¥ä¸Š</td><td class="pts">5pt</td></tr>
      <tr><td>é€£ç¶šå¢—é…</td><td>5å¹´ã€œ15å¹´ä»¥ä¸Š</td><td class="pts">6pt</td></tr>
      <tr><td>PBR</td><td>1.5å€ä»¥ä¸‹ã€œ0.7å€ä»¥ä¸‹</td><td class="pts">5pt</td></tr>
      <tr><td>å®‰å®šæ ªãƒœãƒ¼ãƒŠã‚¹</td><td>é»’å­—+é…å½“2%+å¤§å‹</td><td class="pts">5pt</td></tr>
      <tr><td>âš ã‚»ã‚¯ã‚¿ãƒ¼ä¸‹è½</td><td>ã‚»ã‚¯ã‚¿ãƒ¼å…¨ä½“-3%ä»¥ä¸‹</td><td class="pts">-5pt</td></tr>
    </table>
    <div class="logic-note">
      ğŸ”¬ éå»46é€±ã®ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã§æœ€é©åŒ–<br>
      â± ã‚¿ã‚¤ãƒŸãƒ³ã‚°æŒ‡æ¨™ï¼ˆ70ptï¼‰: ã‚»ã‚¯ã‚¿ãƒ¼å·®åˆ†+å€‹åˆ¥ä¸‹è½+è‡ªåˆ†æ¯”Ïƒ<br>
      ğŸ¦ éŠ˜æŸ„ã®è³ªï¼ˆ21ptï¼‰: æ™‚ä¾¡ç·é¡+å¢—é…+PBR<br>
      ğŸ“Š é…å½“åˆ©å›ã‚Šã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å°‚ç”¨ï¼ˆ2%ä»¥ä¸ŠãŒå¯¾è±¡ï¼‰
    </div>
    <button class="btn-logic-close" onclick="closeLogicModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SAMPLE_STOCKS=[
  {code:'8306',name:'ä¸‰è±UFJãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«',sector:'éŠ€è¡Œ',price:1423,ma25:1520,ma75:1580,rsi:32,dividend:3.8,pbr:0.7,per:9.2,vol_r:0.8},
  {code:'9432',name:'NTT',sector:'é€šä¿¡',price:163,ma25:168,ma75:172,rsi:38,dividend:3.2,pbr:1.1,per:11.5,vol_r:0.9},
  {code:'8058',name:'ä¸‰è±å•†äº‹',sector:'å•†ç¤¾',price:2890,ma25:3050,ma75:3200,rsi:29,dividend:4.1,pbr:0.9,per:8.7,vol_r:0.7},
  {code:'4502',name:'æ­¦ç”°è–¬å“å·¥æ¥­',sector:'åŒ»è–¬å“',price:3820,ma25:3960,ma75:4050,rsi:41,dividend:5.6,pbr:1.3,per:15.2,vol_r:1.1},
  {code:'8001',name:'ä¼Šè—¤å¿ å•†äº‹',sector:'å•†ç¤¾',price:6780,ma25:7050,ma75:7200,rsi:33,dividend:3.5,pbr:1.8,per:12.3,vol_r:0.6},
  {code:'7203',name:'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š',sector:'è‡ªå‹•è»Š',price:2650,ma25:2720,ma75:2800,rsi:36,dividend:3.0,pbr:1.1,per:10.4,vol_r:0.9},
  {code:'8316',name:'ä¸‰äº•ä½å‹FG',sector:'éŠ€è¡Œ',price:7100,ma25:7600,ma75:7800,rsi:28,dividend:4.2,pbr:0.8,per:9.0,vol_r:0.7},
  {code:'2914',name:'JTï¼ˆæ—¥æœ¬ãŸã°ã“ç”£æ¥­ï¼‰',sector:'é£Ÿå“',price:3680,ma25:3780,ma75:3820,rsi:35,dividend:6.2,pbr:1.6,per:13.8,vol_r:0.8},
  {code:'8411',name:'ã¿ãšã»FG',sector:'éŠ€è¡Œ',price:2680,ma25:2850,ma75:2950,rsi:31,dividend:3.9,pbr:0.7,per:8.5,vol_r:0.8},
  {code:'9433',name:'KDDI',sector:'é€šä¿¡',price:4350,ma25:4500,ma75:4600,rsi:37,dividend:3.3,pbr:1.9,per:13.5,vol_r:1.0},
  {code:'9503',name:'é–¢è¥¿é›»åŠ›',sector:'é›»åŠ›',price:2140,ma25:2250,ma75:2300,rsi:33,dividend:3.5,pbr:0.9,per:10.1,vol_r:0.7},
  {code:'5108',name:'ãƒ–ãƒªãƒ‚ã‚¹ãƒˆãƒ³',sector:'ã‚´ãƒ ',price:5100,ma25:5280,ma75:5350,rsi:40,dividend:3.8,pbr:1.2,per:11.8,vol_r:0.8},
];

let STOCKS=[...SAMPLE_STOCKS];
let processed=[];
let processedMomentum=[];
let dataSource='sample';
let currentMode='dividend';
let currentStyleTab='bluechip'; // 'bluechip', 'stable', 'growth'
let currentSector='all';
let dispCount=10;
let sortKey='score'; let sortDir='desc';
let expandedCode=null;
let watchlist=[];
let scanHistory=[];
let settings={mode:'dividend',count:10,mindiv:0,zone:'all'};
let trendRankingData=[];
let marketData={
  nikkei_price:null,nikkei_ma25:null,nikkei_1d_chg:null,
  nasdaq_1d_chg:null,vix:null,usdjpy:null,us10y:null,
  geo_risk:false,rate_cut_flag:false,prev_buy_count:null,
};

// â”€ localStorageã‹ã‚‰å¾©å…ƒ â”€
try{
  const sw=localStorage.getItem('kbs_watch');
  if(sw)watchlist=JSON.parse(sw);
  const sh=localStorage.getItem('kbs_history');
  if(sh)scanHistory=JSON.parse(sh);
  const ss=localStorage.getItem('kbs_settings');
  if(ss){
    settings=Object.assign(settings,JSON.parse(ss));
    currentMode=settings.mode||'dividend';
    dispCount=settings.count||10;
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–ã‚’å¾©å…ƒ
    document.querySelectorAll('.filter-tab[id^="mode-"]').forEach(t=>t.classList.remove('active'));
    const mt=document.getElementById('mode-'+currentMode);
    if(mt)mt.classList.add('active');
    document.querySelectorAll('.filter-tab[id^="disp-"]').forEach(t=>t.classList.remove('active'));
    const cnt=dispCount>=999?'all':String(dispCount);
    const dt=document.getElementById('disp-'+cnt);
    if(dt)dt.classList.add('active');
  }
}catch(e){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dv(p,m){return m?Math.round((p-m)/m*1000)/10:0;}

function calcScore(s){
  return calcScoreBluechip(s);
}
function calcScoreBluechip(s){
  const div=s.dividend||0;
  const mc=s.market_cap_b||0;
  if(div<2||mc<500) return 0;
  let score=0;
  // æ™‚ä¾¡ç·é¡ (max 5pt)
  score+=mc>=50000?5:mc>=10000?4:mc>=5000?3:mc>=1000?2:mc>=500?1:0;
  // å¢—é…ãƒœãƒ¼ãƒŠã‚¹ (max 6pt)
  const dgy=s.div_growth_years||0;
  score+=dgy>=15?6:dgy>=10?4:dgy>=7?3:dgy>=5?2:0;
  // PBR (max 5pt)
  const pbr=s.pbr||99;
  score+=pbr<=0.7?5:pbr<=0.9?4:pbr<=1.2?3:pbr<=1.5?1:0;
  // å€‹åˆ¥vsã‚»ã‚¯ã‚¿ãƒ¼å·®åˆ† (max 25pt)
  const diff5=s.ret5_vs_sector||0;
  score+=diff5<=-5?25:diff5<=-3?19:diff5<=-1.5?13:diff5<=-0.5?6:0;
  const secR5=s.sector_ret5||0;
  if(secR5<=-3) score-=5;
  // å€‹åˆ¥5æ—¥ä¸‹è½ (max 25pt) â† æœ€å¼·æŒ‡æ¨™
  const r5=s.ret5||0;
  score+=r5<=-5?25:r5<=-3?18:r5<=-1.5?10:r5<=-0.5?3:0;
  // è‡ªåˆ†æ¯”æŠ¼ã—ç›®åº¦ (max 15pt)
  const z=s.dip_zscore||0;
  score+=z<=-3.0?15:z<=-2.0?12:z<=-1.5?9:z<=-1.0?6:z<=-0.5?3:0;
  // 10æ—¥ãƒªã‚¿ãƒ¼ãƒ³ (max 5pt)
  const r10=s.ret10||0;
  score+=r10<=-8?5:r10<=-5?3:r10<=-2?2:r10<=-1?1:0;
  // å®‰å®šæ ªãƒœãƒ¼ãƒŠã‚¹ (max 5pt)
  if((s.per||0)>0&&div>=2&&mc>=5000) score+=5;
  else if((s.per||0)>0&&div>=2&&mc>=1000) score+=3;
  // æ€¥è½ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆè½ã¡ã‚‹ãƒŠã‚¤ãƒ•å›é¿ï¼‰
  const vr1d_b=s.vol_ratio_1d||1;
  if(vr1d_b>=3)score-=10;else if(vr1d_b>=2.5)score-=5;
  const ret1d_b=s.ret_1d||0;
  if(ret1d_b<=-5)score-=8;else if(ret1d_b<=-3)score-=4;
  const vol_b=s.volatility||2;
  if(vol_b>=4)score-=5;
  return Math.max(0,Math.min(score,100));
}
function calcScoreStable(s){
  const d25=dv(s.price,s.ma25);
  const div=s.dividend||0;
  if(div<2) return 0;
  let score=0;
  // é…å½“åˆ©å›ã‚Š (max 30pt) â€” 3%å°ã§ã‚‚ã—ã£ã‹ã‚ŠåŠ ç‚¹
  score+=div>=5?30:div>=4.5?25:div>=4?20:div>=3.5?16:div>=3?12:div>=2.5?6:0;
  // æ™‚ä¾¡ç·é¡ãƒœãƒ¼ãƒŠã‚¹ (max 15pt) â€” å¤§å‹å®‰å®šæ ªã‚’å„ªé‡
  const mc=s.market_cap_b||0;
  score+=mc>=10000?15:mc>=5000?11:mc>=1000?7:mc>=500?3:0;
  if(mc>0&&mc<300) score-=10;
  // 25MAä¹–é›¢ (max 22pt) â€” å¤§å‹æ ªå‘ã‘ã«-1.5%ã‹ã‚‰åŠ ç‚¹
  score+=d25<=-10?22:d25<=-7?18:d25<=-5?14:d25<=-3?9:d25<=-1.5?4:0;
  // RSI (max 18pt)
  const rsi=s.rsi||50;
  score+=rsi<=25?18:rsi<=30?14:rsi<=37?9:rsi<=43?4:0;
  // PBR (max 10pt)
  const pbr=s.pbr||99;
  score+=pbr<=0.7?10:pbr<=1.0?7:pbr<=1.5?3:0;
  // å®‰å®šæ ªãƒœãƒ¼ãƒŠã‚¹ (max 5pt) â€” é…å½“3%ä»¥ä¸Šãƒ»é»’å­—ãƒ»å¤§å‹
  if(div>=3&&(s.per||0)>0&&mc>=1000) score+=5;
  // å‡ºæ¥é«˜æ€¥å¢—ãƒšãƒŠãƒ«ãƒ†ã‚£
  if((s.vol_r||1)>=1.5) score-=15;
  if((s.vol_r||1)>=2.5) score-=10;
  return Math.max(0,Math.min(score,100));
}
function calcScoreGrowth(s){
  const d25=dv(s.price,s.ma25);
  let score=0;
  score+=d25<=-15?35:d25<=-10?28:d25<=-6?20:d25<=-3?10:d25<=-1?3:0;
  const rsi=s.rsi||50;
  score+=rsi<=20?30:rsi<=28?22:rsi<=35?14:rsi<=42?7:0;
  const pbr=s.pbr||99;
  score+=pbr<=0.8?15:pbr<=1.2?10:pbr<=2.0?5:0;
  const div=s.dividend||0;
  score+=div>=4?10:div>=2?6:div>=1?2:0;
  const per=s.per||99;
  score+=per<=10?10:per<=15?5:0;
  if((s.vol_r||1)>=2.0) score-=15;
  return Math.max(0,Math.min(score,100));
}

function dv(p,m){return m?Math.round((p-m)/m*1000)/10:0;}


function getZone(sc){
  return sc>=60?{label:'è²·ã„åœ',cls:'buy'}:sc>=35?{label:'æ³¨æ„åœ',cls:'watch'}:{label:'å¾…æ©Ÿåœ',cls:'hold'};
}

function buildReasons(s,d25){
  const r=[];
  if(d25<=-6)r.push({val:`${d25}%`,label:'25MAä¹–é›¢',note:'å¼·ã„æŠ¼ã—ç›®æ°´æº–',desc:'-6%ä»¥ä¸‹ã¯éå»ã®åç™ºå®Ÿç¸¾ãŒé«˜ã„æ°´æº–',cls:'strong',rank:'A'});
  else if(d25<=-3)r.push({val:`${d25}%`,label:'25MAä¹–é›¢',note:'æŠ¼ã—ç›®æ°´æº–',desc:'-3%ä»¥ä¸Šã®ä¸‹è½ã§åç™ºå€™è£œã«',cls:'mid',rank:'B'});
  if(s.rsi<=30)r.push({val:String(s.rsi),label:'RSI',note:'å¼·ã„å£²ã‚‰ã‚Œã™ã',desc:'30ä»¥ä¸‹ã¯è‡ªå¾‹åç™ºãŒæœŸå¾…ã§ãã‚‹æ°´æº–',cls:'strong',rank:'A'});
  else if(s.rsi<=38)r.push({val:String(s.rsi),label:'RSI',note:'å£²ã‚‰ã‚Œã™ãåœå†…',desc:'38ä»¥ä¸‹ã§å£²ã‚Šéå‰°ãŒå’Œã‚‰ãã‚¿ã‚¤ãƒŸãƒ³ã‚°',cls:'mid',rank:'B'});
  if(s.dividend>=4.5)r.push({val:`${s.dividend}%`,label:'é…å½“åˆ©å›ã‚Š',note:'é«˜é…å½“ãƒ»ä¸‹å€¤ã‚µãƒãƒ¼ãƒˆ',desc:'4.5%è¶…ã¯é…å½“ãŒæ ªä¾¡ã®ä¸‹å€¤ã‚’æ”¯ãˆã‚‹',cls:'strong',rank:'A'});
  else if(s.dividend>=3)r.push({val:`${s.dividend}%`,label:'é…å½“åˆ©å›ã‚Š',note:'ã‚¤ãƒ³ã‚«ãƒ æœŸå¾…',desc:'3%ä»¥ä¸Šã§é•·æœŸä¿æœ‰ã®ãƒªã‚¹ã‚¯ä½æ¸›ã«åŠ¹ã',cls:'mid',rank:'B'});
  if(s.pbr<=0.8)r.push({val:`${s.pbr}å€`,label:'PBR',note:'è§£æ•£ä¾¡å€¤ä»¥ä¸‹',desc:'1å€å‰²ã‚Œã¯ç†è«–ä¸Šã®ä¸‹å€¤ãŒå›ºã„æ°´æº–',cls:'strong',rank:'A'});
  else if(s.pbr<=1.1)r.push({val:`${s.pbr}å€`,label:'PBR',note:'å‰²å®‰åœ',desc:'1å€ä»˜è¿‘ã¯æ©Ÿé–¢æŠ•è³‡å®¶ãŒæ³¨ç›®ã™ã‚‹æ°´æº–',cls:'mid',rank:'B'});
  if(s.per<=10)r.push({val:`${s.per}å€`,label:'PER',note:'å‰²å®‰æ°´æº–',desc:'10å€ä»¥ä¸‹ã¯æ—¥æœ¬æ ªå¹³å‡ã‚’å¤§ããä¸‹å›ã‚‹',cls:'mid',rank:'B'});
  return r;
}

function calcBreakdown(s,mode){
  // ã‚¿ãƒ–ã«å¿œã˜ã¦å°‚ç”¨ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³
  return calcBreakdownBluechip(s);
  const d25=dv(s.price,s.ma25);
  const bd=[];
  let dp=s.dividend>=5?30:s.dividend>=4.5?25:s.dividend>=4?20:s.dividend>=3.5?15:s.dividend>=3?10:s.dividend>=2.5?5:0;
  if(mode==='dividend')dp=Math.min(Math.round(dp*1.4),40);
  if(dp>0)bd.push({l:'é…å½“åˆ©å›ã‚Š',v:dp,max:40,pos:true});
  let mp=d25<=-8?28:d25<=-6?22:d25<=-4?12:d25<=-2?5:0;
  if(mode==='rebound')mp=Math.min(Math.round(mp*1.5),35);
  if(mp>0)bd.push({l:'25MAä¹–é›¢',v:mp,max:35,pos:true});
  let rp=s.rsi<=28?22:s.rsi<=32?16:s.rsi<=38?10:s.rsi<=42?5:0;
  if(mode==='rebound')rp=Math.min(Math.round(rp*1.3),25);
  if(rp>0)bd.push({l:'RSI',v:rp,max:25,pos:true});
  let pp=s.pbr<=0.7?18:s.pbr<=0.9?13:s.pbr<=1.1?7:s.pbr<=1.5?3:0;
  if(mode==='value')pp=Math.min(Math.round(pp*1.6),25);
  if(pp>0)bd.push({l:'PBR',v:pp,max:25,pos:true});
  let ep=s.per<=9?12:s.per<=11?8:s.per<=13?5:s.per<=15?2:0;
  if(mode==='value')ep=Math.min(Math.round(ep*1.4),15);
  if(ep>0)bd.push({l:'PER',v:ep,max:15,pos:true});
  if(s.vol_r>=1.5)bd.push({l:'å‡ºæ¥é«˜æ€¥å¢—',v:-20,max:20,pos:false});
  return bd;
}
function calcBreakdownStable(s){
  const d25=dv(s.price,s.ma25);
  const div=s.dividend||0;
  const mc=s.market_cap_b||0;
  const bd=[];
  const dp=div>=5?30:div>=4.5?25:div>=4?20:div>=3.5?16:div>=3?12:div>=2.5?6:0;
  if(dp>0)bd.push({l:'é…å½“åˆ©å›ã‚Š',v:dp,max:30,pos:true});
  const mcp=mc>=10000?15:mc>=5000?11:mc>=1000?7:mc>=500?3:0;
  if(mcp>0)bd.push({l:'æ™‚ä¾¡ç·é¡',v:mcp,max:15,pos:true});
  const mp=d25<=-10?22:d25<=-7?18:d25<=-5?14:d25<=-3?9:d25<=-1.5?4:0;
  if(mp>0)bd.push({l:'25MAä¹–é›¢',v:mp,max:22,pos:true});
  const rsi=s.rsi||50;
  const rp=rsi<=25?18:rsi<=30?14:rsi<=37?9:rsi<=43?4:0;
  if(rp>0)bd.push({l:'RSI',v:rp,max:18,pos:true});
  const pbr=s.pbr||99;
  const pp=pbr<=0.7?10:pbr<=1.0?7:pbr<=1.5?3:0;
  if(pp>0)bd.push({l:'PBR',v:pp,max:10,pos:true});
  if(div>=3&&(s.per||0)>0&&mc>=1000) bd.push({l:'å®‰å®šæ ªãƒœãƒ¼ãƒŠã‚¹',v:5,max:5,pos:true});
  if(mc>0&&mc<300) bd.push({l:'å°å‹ãƒšãƒŠãƒ«ãƒ†ã‚£',v:-10,max:10,pos:false});
  if((s.vol_r||1)>=1.5) bd.push({l:'å‡ºæ¥é«˜æ€¥å¢—',v:-15,max:15,pos:false});
  if((s.vol_r||1)>=2.5) bd.push({l:'å‡ºæ¥é«˜éç†±',v:-10,max:10,pos:false});
  return bd;
}
function calcBreakdownBluechip(s){
  const div=s.dividend||0;
  const mc=s.market_cap_b||0;
  const z=s.dip_zscore||0;
  const r5=s.ret5||0;
  const r10=s.ret10||0;
  const diff5=s.ret5_vs_sector||0;
  const dgy=s.div_growth_years||0;
  const bd=[];
  // ã‚¿ã‚¤ãƒŸãƒ³ã‚°æŒ‡æ¨™ï¼ˆæœ€é‡è¦ï¼‰
  const d5p=diff5<=-5?25:diff5<=-3?19:diff5<=-1.5?13:diff5<=-0.5?6:0;
  if(d5p>0)bd.push({l:'å€‹åˆ¥vsã‚»ã‚¯ã‚¿ãƒ¼å·®åˆ†',v:d5p,max:25,pos:true});
  const secR5=s.sector_ret5||0;
  if(secR5<=-3)bd.push({l:'ã‚»ã‚¯ã‚¿ãƒ¼ä¸‹è½ãƒšãƒŠãƒ«ãƒ†ã‚£',v:-5,max:5,pos:false});
  const r5p=r5<=-5?25:r5<=-3?18:r5<=-1.5?10:r5<=-0.5?3:0;
  if(r5p>0)bd.push({l:'å€‹åˆ¥5æ—¥ä¸‹è½',v:r5p,max:25,pos:true});
  const zp=z<=-3.0?15:z<=-2.0?12:z<=-1.5?9:z<=-1.0?6:z<=-0.5?3:0;
  if(zp>0)bd.push({l:'è‡ªåˆ†æ¯”æŠ¼ã—ç›®åº¦',v:zp,max:15,pos:true});
  const r10p=r10<=-8?5:r10<=-5?3:r10<=-2?2:r10<=-1?1:0;
  if(r10p>0)bd.push({l:'10æ—¥ãƒªã‚¿ãƒ¼ãƒ³',v:r10p,max:5,pos:true});
  // éŠ˜æŸ„ã®è³ªï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼+è»½ã„åŠ ç‚¹ï¼‰
  const mcp=mc>=50000?5:mc>=10000?4:mc>=5000?3:mc>=1000?2:mc>=500?1:0;
  if(mcp>0)bd.push({l:'æ™‚ä¾¡ç·é¡',v:mcp,max:5,pos:true});
  const dgp=dgy>=15?6:dgy>=10?4:dgy>=7?3:dgy>=5?2:0;
  if(dgp>0)bd.push({l:'é€£ç¶šå¢—é…('+dgy+'å¹´)',v:dgp,max:6,pos:true});
  const pbr=s.pbr||99;
  const pp=pbr<=0.7?5:pbr<=0.9?4:pbr<=1.2?3:pbr<=1.5?1:0;
  if(pp>0)bd.push({l:'PBR',v:pp,max:5,pos:true});
  if((s.per||0)>0&&div>=2&&mc>=5000) bd.push({l:'å®‰å®šæ ªãƒœãƒ¼ãƒŠã‚¹',v:5,max:5,pos:true});
  else if((s.per||0)>0&&div>=2&&mc>=1000) bd.push({l:'å®‰å®šæ ªãƒœãƒ¼ãƒŠã‚¹',v:3,max:5,pos:true});
  // æ€¥è½ãƒšãƒŠãƒ«ãƒ†ã‚£
  const vr1d_bd=s.vol_ratio_1d||1;
  if(vr1d_bd>=3)bd.push({l:'å‡ºæ¥é«˜æ€¥å¢—ãƒšãƒŠãƒ«ãƒ†ã‚£(Ã—'+vr1d_bd.toFixed(1)+')',v:-10,max:10,pos:false});
  else if(vr1d_bd>=2.5)bd.push({l:'å‡ºæ¥é«˜å¢—ãƒšãƒŠãƒ«ãƒ†ã‚£(Ã—'+vr1d_bd.toFixed(1)+')',v:-5,max:5,pos:false});
  const ret1d_bd=s.ret_1d||0;
  if(ret1d_bd<=-5)bd.push({l:'æ€¥è½ãƒšãƒŠãƒ«ãƒ†ã‚£('+ret1d_bd.toFixed(1)+'%)',v:-8,max:8,pos:false});
  else if(ret1d_bd<=-3)bd.push({l:'ä¸‹è½ãƒšãƒŠãƒ«ãƒ†ã‚£('+ret1d_bd.toFixed(1)+'%)',v:-4,max:4,pos:false});
  const vol_bd=s.volatility||2;
  if(vol_bd>=4)bd.push({l:'é«˜ãƒœãƒ©ãƒšãƒŠãƒ«ãƒ†ã‚£('+vol_bd.toFixed(1)+'%)',v:-5,max:5,pos:false});
  return bd;
}

function calcScoreMomentum(s){
  const mc=s.market_cap_b||0;
  if(mc<300)return 0;
  let score=0;
  // ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ  (max 40pt)
  const r20=s.ret20||0;
  score+=r20>=15?20:r20>=10?16:r20>=5?12:r20>=2?6:0;
  const r60=s.ret60||0;
  score+=r60>=25?10:r60>=15?8:r60>=8?5:r60>=3?2:0;
  const r5=s.ret5||0;
  score+=r5>=5?10:r5>=3?7:r5>=1?4:r5>=0?1:0;
  // ã‚¯ã‚ªãƒªãƒ†ã‚£ (max 25pt)
  const roe=s.roe||0;
  score+=roe>=15?10:roe>=10?7:roe>=7?4:roe>=5?2:0;
  const eg=s.earnings_growth||0;
  score+=eg>=30?8:eg>=15?6:eg>=5?4:eg>=0?1:0;
  const rg=s.revenue_growth||0;
  score+=rg>=20?7:rg>=10?5:rg>=5?3:rg>=0?1:0;
  // å‡ºæ¥é«˜ (max 20pt)
  const vt=s.vol_trend||1;
  score+=vt>=2.5?12:vt>=1.8?9:vt>=1.3?6:vt>=1.1?3:0;
  const vr=s.vol_ratio_1d||1;
  score+=vr>=3?8:vr>=2?6:vr>=1.5?4:vr>=1.1?1:0;
  // ã‚»ã‚¯ã‚¿ãƒ¼è¿½ã„é¢¨ (max 10pt)
  const sr5=s.sector_ret5||0;
  score+=sr5>=3?10:sr5>=1.5?7:sr5>=0.5?4:0;
  // ãƒšãƒŠãƒ«ãƒ†ã‚£
  const pp=s.price_position||50;
  if(pp>=98)score-=5;
  // éç†±ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆé«˜å€¤æ´ã¿å›é¿ï¼‰
  const rsi_m=s.rsi||50;
  if(rsi_m>=80)score-=8;else if(rsi_m>=75)score-=4;
  const vr_m=s.vol_ratio_1d||1;
  if(vr_m>=3&&r5>=5)score-=5;
  const ret1d_m=s.ret_1d||0;
  if(ret1d_m>=7)score-=5;else if(ret1d_m>=5)score-=3;
  // ãƒœãƒ¼ãƒŠã‚¹
  const div=s.dividend||0;
  if(div>=2&&r20>=5)score+=5;
  return Math.max(0,Math.min(score,100));
}

function calcBreakdownMomentum(s){
  const bd=[];
  const r20=s.ret20||0;
  const r20p=r20>=15?20:r20>=10?16:r20>=5?12:r20>=2?6:0;
  if(r20p>0)bd.push({l:'20æ—¥ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ('+r20.toFixed(1)+'%)',v:r20p,max:20,pos:true});
  const r60=s.ret60||0;
  const r60p=r60>=25?10:r60>=15?8:r60>=8?5:r60>=3?2:0;
  if(r60p>0)bd.push({l:'60æ—¥ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ('+r60.toFixed(1)+'%)',v:r60p,max:10,pos:true});
  const r5=s.ret5||0;
  const r5p=r5>=5?10:r5>=3?7:r5>=1?4:r5>=0?1:0;
  if(r5p>0)bd.push({l:'5æ—¥ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ',v:r5p,max:10,pos:true});
  const roe=s.roe||0;
  const roep=roe>=15?10:roe>=10?7:roe>=7?4:roe>=5?2:0;
  if(roep>0)bd.push({l:'ROE('+roe+'%)',v:roep,max:10,pos:true});
  const eg=s.earnings_growth||0;
  const egp=eg>=30?8:eg>=15?6:eg>=5?4:eg>=0?1:0;
  if(egp>0)bd.push({l:'åˆ©ç›Šæˆé•·('+eg+'%)',v:egp,max:8,pos:true});
  const rg=s.revenue_growth||0;
  const rgp=rg>=20?7:rg>=10?5:rg>=5?3:rg>=0?1:0;
  if(rgp>0)bd.push({l:'å£²ä¸Šæˆé•·('+rg+'%)',v:rgp,max:7,pos:true});
  const vt=s.vol_trend||1;
  const vtp=vt>=2.5?12:vt>=1.8?9:vt>=1.3?6:vt>=1.1?3:0;
  if(vtp>0)bd.push({l:'å‡ºæ¥é«˜ãƒˆãƒ¬ãƒ³ãƒ‰(Ã—'+vt+')',v:vtp,max:12,pos:true});
  const sr5=s.sector_ret5||0;
  const srp=sr5>=3?10:sr5>=1.5?7:sr5>=0.5?4:0;
  if(srp>0)bd.push({l:'ã‚»ã‚¯ã‚¿ãƒ¼è¿½ã„é¢¨('+sr5.toFixed(1)+'%)',v:srp,max:10,pos:true});
  return bd;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNIFIED TREND SCORE (æ™‚é–“åŠ é‡ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¹ã‚³ã‚¢)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcScoreTrend(s){
  const mc=s.market_cap_b||0;
  if(mc<300)return{score:0,type:'avoid'};
  let score=0;
  const r120=s.ret120||0, r60=s.ret60||0, r20=s.ret20||0, r5=s.ret5||0;

  // 120æ—¥ (max 10pt)
  score+=r120>=30?10:r120>=15?8:r120>=5?5:r120>=0?2:r120>=-5?0:r120>=-15?-3:-5;
  // 60æ—¥ (max 15pt)
  score+=r60>=20?15:r60>=10?12:r60>=5?8:r60>=0?3:r60>=-5?0:r60>=-10?-3:-5;
  // 20æ—¥ (max 25pt) â€” æŠ¼ã—ç›®ã«ã‚‚åŠ ç‚¹
  if(r20>=15)score+=25;else if(r20>=8)score+=20;else if(r20>=3)score+=14;
  else if(r20>=0)score+=5;else if(r20>=-3)score+=0;
  else if(r20>=-5)score+=8;else if(r20>=-10)score+=14;else score+=5;
  // 5æ—¥ (max 35pt) â€” æŠ¼ã—ç›®ã«ã‚‚å‹¢ã„ã«ã‚‚åŠ ç‚¹
  if(r5<=-8)score+=15;else if(r5<=-5)score+=30;else if(r5<=-3)score+=25;
  else if(r5<=-1)score+=15;else if(r5<=1)score+=5;else if(r5<=3)score+=15;
  else if(r5<=5)score+=25;else if(r5<=8)score+=30;else score+=20;

  // ä¸€è²«æ€§ (Â±10pt)
  const periods=[r120,r60,r20];
  const posCount=periods.filter(r=>r>0).length;
  if(posCount===3)score+=10;else if(posCount===2)score+=5;else if(posCount===0)score-=5;

  // å‡ºæ¥é«˜
  const vt=s.vol_trend||1;
  if(vt>=2)score+=5;else if(vt>=1.3)score+=3;else if(vt>=1.1)score+=1;

  // ãƒšãƒŠãƒ«ãƒ†ã‚£
  const vr1d=s.vol_ratio_1d||1,ret1d=s.ret_1d||0;
  if(vr1d>=3&&ret1d<=-3)score-=10;
  if(vr1d>=3&&ret1d>=5)score-=8;
  if((s.rsi||50)>=80)score-=5;

  score=Math.max(0,Math.min(score,100));

  // ã‚¿ã‚¤ãƒ—åˆ¤å®š
  let type;
  if(posCount>=2&&r5<=-2)type='dip';
  else if(posCount>=2&&r5>0)type='momentum';
  else if(posCount<=1&&r5<=-2)type='falling';
  else if(posCount<=1&&r5>2)type='bounce';
  else type='neutral';

  return{score,type};
}

function calcBreakdownTrend(s){
  const bd=[];
  const r120=s.ret120||0, r60=s.ret60||0, r20=s.ret20||0, r5=s.ret5||0;
  // 120æ—¥
  const p120=r120>=30?10:r120>=15?8:r120>=5?5:r120>=0?2:r120>=-5?0:r120>=-15?-3:-5;
  bd.push({l:'120æ—¥('+r120.toFixed(1)+'%)',v:p120,max:10,pos:p120>=0});
  // 60æ—¥
  const p60=r60>=20?15:r60>=10?12:r60>=5?8:r60>=0?3:r60>=-5?0:r60>=-10?-3:-5;
  bd.push({l:'60æ—¥('+r60.toFixed(1)+'%)',v:p60,max:15,pos:p60>=0});
  // 20æ—¥
  let p20;
  if(r20>=15)p20=25;else if(r20>=8)p20=20;else if(r20>=3)p20=14;
  else if(r20>=0)p20=5;else if(r20>=-3)p20=0;
  else if(r20>=-5)p20=8;else if(r20>=-10)p20=14;else p20=5;
  bd.push({l:'20æ—¥('+r20.toFixed(1)+'%)',v:p20,max:25,pos:p20>=0});
  // 5æ—¥
  let p5;
  if(r5<=-8)p5=15;else if(r5<=-5)p5=30;else if(r5<=-3)p5=25;
  else if(r5<=-1)p5=15;else if(r5<=1)p5=5;else if(r5<=3)p5=15;
  else if(r5<=5)p5=25;else if(r5<=8)p5=30;else p5=20;
  bd.push({l:'5æ—¥('+r5.toFixed(1)+'%)',v:p5,max:35,pos:p5>=0});
  // ä¸€è²«æ€§
  const posCount=[r120,r60,r20].filter(r=>r>0).length;
  const cp=posCount===3?10:posCount===2?5:posCount===0?-5:0;
  if(cp!==0)bd.push({l:'ä¸€è²«æ€§('+posCount+'/3æœŸé–“â†‘)',v:cp,max:10,pos:cp>0});
  // å‡ºæ¥é«˜
  const vt=s.vol_trend||1;
  const vtp=vt>=2?5:vt>=1.3?3:vt>=1.1?1:0;
  if(vtp>0)bd.push({l:'å‡ºæ¥é«˜ãƒˆãƒ¬ãƒ³ãƒ‰(Ã—'+vt.toFixed(1)+')',v:vtp,max:5,pos:true});
  return bd;
}

const TREND_TYPE_LABEL={
  dip:{icon:'ğŸ›¡',label:'æŠ¼ã—ç›®',cls:'dip',color:'var(--green)'},
  momentum:{icon:'ğŸš€',label:'å‹¢ã„',cls:'momentum',color:'#e040fb'},
  falling:{icon:'âš ',label:'è½ã¡ã‚‹ãƒŠã‚¤ãƒ•',cls:'falling',color:'var(--up)'},
  bounce:{icon:'ğŸ”„',label:'åç™º',cls:'bounce',color:'var(--amber)'},
  neutral:{icon:'ğŸ˜',label:'æ–¹å‘æ„Ÿãªã—',cls:'neutral',color:'var(--text3)'},
  avoid:{icon:'ğŸš«',label:'å¯¾è±¡å¤–',cls:'avoid',color:'var(--text3)'},
};

function trendTypeBadge(type){
  const t=TREND_TYPE_LABEL[type]||TREND_TYPE_LABEL.neutral;
  return`<span style="font-size:10px;padding:1px 6px;border-radius:3px;background:${t.color}22;color:${t.color};font-weight:600">${t.icon}${t.label}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processStocks(){
  const minDiv=settings.mindiv||0;
  const zoneFilter=settings.zone||'all';

  // å®‰å®šé«˜é…å½“ã®ã¿ï¼šé…å½“2%+æ™‚ä¾¡ç·é¡500å„„ä»¥ä¸Š
  let list=STOCKS.filter(s=>{
    if((s.dividend||0)<2) return false;
    if((s.market_cap_b||0)<500) return false;
    if(minDiv>0&&(s.dividend||0)<minDiv) return false;
    return true;
  });

  // ã‚»ã‚¯ã‚¿ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  if(currentSector!=='all'){
    list=list.filter(s=>sectorMap(s.sector)===currentSector);
  }

  processed=list.map(s=>{
    const d25=dv(s.price,s.ma25);
    // çµ±åˆãƒˆãƒ¬ãƒ³ãƒ‰ã‚¹ã‚³ã‚¢ï¼ˆã‚µãƒ¼ãƒãƒ¼è¨ˆç®—æ¸ˆã¿ãªã‚‰ãã‚Œã‚’ä½¿ã†ï¼‰
    let scoreTrend,trendType;
    if(s.score_trend!=null&&s.trend_type){
      scoreTrend=s.score_trend;
      trendType=s.trend_type;
    }else{
      const t=calcScoreTrend(s);
      scoreTrend=t.score;
      trendType=t.type;
    }
    const score=scoreTrend;
    const zone=getZone(score);
    return{...s,d25,score,scoreTrend,trendType,zone};
  });

  // ğŸš€ å…¨éŠ˜æŸ„ç”¨ï¼ˆTOP5è¡¨ç¤ºç”¨ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—ï¼‰
  processedMomentum=STOCKS.filter(s=>(s.market_cap_b||0)>=300).map(s=>{
    const d25=dv(s.price,s.ma25);
    let scoreTrend,trendType;
    if(s.score_trend!=null&&s.trend_type){
      scoreTrend=s.score_trend;trendType=s.trend_type;
    }else{
      const t=calcScoreTrend(s);scoreTrend=t.score;trendType=t.type;
    }
    const score=scoreTrend;
    const zone=getZone(score);
    return{...s,d25,score,scoreTrend,trendType,zone};
  }).sort((a,b)=>b.scoreTrend-a.scoreTrend);

  if(zoneFilter==='buy')processed=processed.filter(s=>s.zone.cls==='buy');
  else if(zoneFilter==='buywatch')processed=processed.filter(s=>s.zone.cls!=='hold');

  // ã‚½ãƒ¼ãƒˆ
  processed.sort((a,b)=>{
    let av=a[sortKey]??0, bv=b[sortKey]??0;
    if(sortKey==='d25'){av=a.d25;bv=b.d25;}
    return sortDir==='asc'?av-bv:bv-av;
  });

  // å±¥æ­´è¨˜éŒ²ï¼ˆéåŒæœŸã§å¾Œå›ã—ï¼‰
  requestAnimationFrame(()=>{
    const now=new Date();
    const e={
      date:`${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
      mode:currentMode,count:processed.length,
      top:processed[0]?.name||'â€”',topScore:processed[0]?.score||0
    };
    scanHistory.unshift(e);
    scanHistory=scanHistory.slice(0,14);
    try{localStorage.setItem('kbs_history',JSON.stringify(scanHistory));}catch(e){}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: HERO STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHeroStats(){
  const buyN=processed.filter(s=>s.zone.cls==='buy').length;
  const topScore=processed.length?processed[0].score:'â€”';
  const maxDiv=processed.length?Math.max(...processed.map(s=>s.dividend)).toFixed(1)+'%':'â€”';
  document.getElementById('hsBuy').textContent=buyN+'ä»¶';
  document.getElementById('hsTop').textContent=topScore+'ç‚¹';
  document.getElementById('hsDiv').textContent=maxDiv;
  document.getElementById('hsTotal').textContent=STOCKS.length+'éŠ˜æŸ„';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: MARKET PULSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPulse(){
  const md=marketData;
  const sign=v=>v>0?'+':'';
  const dir=v=>v>0?'up':v<0?'dn':'neutral';
  const chips=[
    {l:'æ—¥çµŒå¹³å‡',v:md.nikkei_price?md.nikkei_price.toLocaleString():'â€”',c:md.nikkei_1d_chg!=null?sign(md.nikkei_1d_chg)+md.nikkei_1d_chg+'%':'â€”',d:dir(md.nikkei_1d_chg)},
    {l:'NASDAQ',v:md.nasdaq_1d_chg!=null?sign(md.nasdaq_1d_chg)+md.nasdaq_1d_chg+'%':'â€”',c:'å‰æ—¥æ¯”',d:dir(md.nasdaq_1d_chg)},
    {l:'ãƒ‰ãƒ«å††',v:md.usdjpy||'â€”',c:'',d:'neutral'},
    {l:'VIX',v:md.vix||'â€”',c:'',d:md.vix>25?'dn':md.vix<18?'up':'neutral'},
    {l:'ç±³10å¹´å‚µ',v:md.us10y?md.us10y+'%':'â€”',c:'',d:'neutral'},
  ];
  document.getElementById('pulseBar').innerHTML=chips.map(c=>`
    <div class="pc">
      <div class="pc-l">${c.l}</div>
      <div class="pc-v ${c.d}">${c.v}</div>
      <div class="pc-c ${c.d}">${c.c}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: STANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcStanceScore(){
  const md=marketData;
  const buyN=processed.filter(s=>s.zone.cls==='buy').length;
  const avgRsi=processed.length?(processed.reduce((a,s)=>a+s.rsi,0)/processed.length):50;
  const avgD25=processed.length?(processed.reduce((a,s)=>a+s.d25,0)/processed.length):0;
  const highDiv=processed.filter(s=>s.dividend>=4).length;
  let axes={tech:1,macro:1,scan:0};

  // è»¸â‘ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«
  let t=1;
  if(md.nikkei_price&&md.nikkei_ma25){
    if(md.nikkei_price>=md.nikkei_ma25)t++;else t--;
  }
  if(md.nikkei_1d_chg!=null){
    if(md.nikkei_1d_chg>-1)t++;else if(md.nikkei_1d_chg<-1.5)t--;
  }
  if(md.vix){if(md.vix<20)t++;else if(md.vix>25)t--;}
  if(md.usdjpy){if(md.usdjpy>=147)t++;else if(md.usdjpy<140)t--;}
  axes.tech=Math.max(0,Math.min(t,3));

  // è»¸â‘¡ãƒã‚¯ãƒ­
  let m=1;
  if(md.nasdaq_1d_chg!=null){
    if(md.nasdaq_1d_chg>0.5)m++;else if(md.nasdaq_1d_chg<-1.5)m-=2;else if(md.nasdaq_1d_chg<0)m--;
  }
  if(md.us10y){if(md.us10y>=3.5&&md.us10y<=4.5)m++;else if(md.us10y>5)m--;}
  if(md.geo_risk)m-=2;
  if(md.rate_cut_flag)m++;
  axes.macro=Math.max(0,Math.min(m,3));

  // è»¸â‘¢ã‚¹ã‚­ãƒ£ãƒ³
  let sc=0;
  if(buyN>=5)sc+=2;else if(buyN>=3)sc+=1;
  if(avgRsi<=35)sc++;else if(avgRsi<=42)sc+=0.5;
  if(avgD25<=-4)sc++;
  if(md.prev_buy_count!=null&&buyN>md.prev_buy_count)sc++;
  axes.scan=Math.max(0,Math.min(Math.round(sc),3));

  const total=axes.tech+axes.macro+axes.scan;
  return{total,axes,buyN,watchN:processed.filter(s=>s.zone.cls==='watch').length,
    avgRsi:avgRsi.toFixed(1),avgD25:avgD25.toFixed(1),highDiv};
}

function renderStance(){
  const{total,axes,buyN,watchN,avgRsi,avgD25,highDiv}=calcStanceScore();
  const now=new Date();
  const days=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const md=marketData;
  const hasMacro=dataSource==='real'&&md.nikkei_price;

  let stance,icon,label,title,reason;
  if(total>=7){
    stance='bull';icon='ğŸŸ¢';label='å¼·æ°— â€” ç©æ¥µçš„ã«ä»•è¾¼ã‚ã‚‹æ—¥';
    title='ä»Šæ—¥ã¯è²·ã„ã‚„ã™ã„åœ°åˆã„';
    reason=hasMacro
      ?`3è»¸ã‚¹ã‚³ã‚¢<strong>${total}/9ç‚¹</strong>ã€‚æ—¥çµŒ${md.nikkei_1d_chg>0?'+':''}${md.nikkei_1d_chg}%ãƒ»NASDAQ${md.nasdaq_1d_chg>0?'+':''}${md.nasdaq_1d_chg}%ã¨å¤–éƒ¨ç’°å¢ƒã‚‚å®‰å®šã€‚è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã€å¹³å‡RSI<strong>${avgRsi}</strong>ã§ç©æ¥µçš„ã«æ¤œè¨ã§ãã‚‹å±€é¢ã€‚`
      :`è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã€å¹³å‡RSI<strong>${avgRsi}</strong>ã€å¹³å‡25MAä¹–é›¢<strong>${avgD25}%</strong>ã€‚æ•°å€¤ãŒæƒã£ã¦ãŠã‚Šç©æ¥µçš„ã«æ¤œè¨ã§ãã‚‹å±€é¢ã§ã™ã€‚`;
  }else if(total>=4){
    stance='neutral';icon='ğŸŸ¡';label='ä¸­ç«‹ â€” å³é¸ã—ã¦ä»•è¾¼ã‚€æ—¥';
    title='ä»Šæ—¥ã¯éŠ˜æŸ„ã‚’é¸ã¶æ—¥';
    reason=hasMacro
      ?`3è»¸ã‚¹ã‚³ã‚¢<strong>${total}/9ç‚¹</strong>ã€‚è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã€æ³¨æ„åœ<strong>${watchN}éŠ˜æŸ„</strong>ã€‚ã‚¹ã‚³ã‚¢ä¸Šä½ã«çµã‚Œã°ä»•è¾¼ã¿ã‚„ã™ã„éŠ˜æŸ„ãŒå­˜åœ¨ã—ã¾ã™ã€‚`
      :`è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã€å¹³å‡RSI<strong>${avgRsi}</strong>ã€‚ã‚¹ã‚³ã‚¢60ç‚¹ä»¥ä¸Šã«çµã£ã¦æ…é‡ã«é¸åˆ¥ã‚’ã€‚`;
  }else{
    stance='bear';icon='ğŸ”´';label='å¼±æ°— â€” æ§˜å­è¦‹ãŒç„¡é›£ãªæ—¥';
    title='ä»Šæ—¥ã¯ç„¡ç†ã—ã¦è²·ã‚ãªã„æ—¥';
    reason=hasMacro
      ?`3è»¸ã‚¹ã‚³ã‚¢<strong>${total}/9ç‚¹</strong>ã€‚${md.nasdaq_1d_chg<-1?`NASDAQ${md.nasdaq_1d_chg}%ã¨ç±³å›½æ ªãŒè»Ÿèª¿ã€‚`:''}è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã¨å°‘ãªãã€ååˆ†ãªæŠ¼ã—ç›®ãŒå½¢æˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`
      :`è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã€å¹³å‡25MAä¹–é›¢<strong>${avgD25}%</strong>ã¨æŠ¼ã—ç›®ãŒæµ…ã„ã€‚æ¬¡ã®æ˜ç¢ºãªä¸‹è½å±€é¢ã‚’å¾…ã¤ã®ãŒè³¢æ˜ã§ã™ã€‚`;
  }

  const axisBar=(name,score,ico)=>`
    <div class="axis-row">
      <div class="axis-name">${ico} ${name}</div>
      <div class="axis-bar">
        ${[0,1,2].map(i=>`<div class="axis-seg ${i<score?'on':''} ${score===0?'zero':score>=2?'hi':'mid'}"></div>`).join('')}
      </div>
      <div class="axis-score">${score}/3</div>
    </div>`;

  const chips=[
    {label:'è²·ã„åœ',val:buyN+'éŠ˜æŸ„',cls:buyN>=5?'buy':buyN>=3?'warn':''},
    {label:'å¹³å‡RSI',val:avgRsi,cls:parseFloat(avgRsi)<=35?'buy':parseFloat(avgRsi)<=45?'warn':''},
    {label:'MAä¹–é›¢å¹³å‡',val:avgD25+'%',cls:parseFloat(avgD25)<=-4?'buy':parseFloat(avgD25)<=-2?'warn':''},
    {label:'é«˜é…å½“4%è¶…',val:highDiv+'ä»¶',cls:highDiv>=3?'buy':highDiv>=1?'warn':''},
  ];

  document.getElementById('stanceBox').innerHTML=`
    <div class="stance ${stance} fadein">
      <div class="stance-head">
        <div>
          <div class="stance-title">${title}</div>
          <div class="stance-date">${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼ˆ${days[now.getDay()]}ï¼‰</div>
        </div>
        <div class="stance-badge ${stance}">${icon} ${label}</div>
      </div>
      <div class="stance-reason">${reason}</div>
      <div class="stance-axes">
        ${axisBar('ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«',axes.tech,'ğŸ“Š')}
        ${axisBar('ãƒã‚¯ãƒ­',axes.macro,'ğŸŒ')}
        ${axisBar('ã‚¹ã‚­ãƒ£ãƒ³çµæœ',axes.scan,'ğŸ”')}
        <div class="axis-total">ç·åˆã‚¹ã‚³ã‚¢ ${total} / 9ç‚¹</div>
      </div>
      <div class="stance-chips">
        ${chips.map(c=>`<div class="stance-chip ${c.cls}"><div class="stance-chip-val">${c.val}</div><div class="stance-chip-label">${c.label}</div></div>`).join('')}
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ æ³¨ç›®åº¦ãƒãƒƒã‚¸ç”Ÿæˆ â”€â”€
function trendBadge(s){
  const vr = s.vol_ratio_1d;
  const ret= s.ret_1d;
  if(!vr || vr < 1.3) return '';
  const tag = vr>=3.0 ? 'ğŸ”¥ç¥­ã‚Š' : vr>=2.0 ? 'ğŸ”¥æµè¡Œã‚Š' : 'ğŸ“ˆæ³¨ç›®';
  const volTxt = `å‡ºæ¥é«˜${vr}x`;
  const retTxt = ret!=null && ret!==0 ? ` / ${ret>0?'+':''}${ret}%` : '';
  const cls = vr>=2.0 ? 'hot' : 'warm';
  return '<span class="trend-badge '+cls+'" title="'+volTxt+retTxt+'">'+tag+'</span>';
}

function renderTable(){
  const limit=dispCount;
  const list=processed.slice(0,limit);
  const total=processed.length;
  document.getElementById('filterCount').textContent=`${total}éŠ˜æŸ„ä¸­ ${list.length}ä»¶è¡¨ç¤º`;

  if(!list.length){
    document.getElementById('tableWrap').innerHTML='<div class="empty-msg">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  const thClick=(key,label)=>{
    const isCurrent=sortKey===key;
    const cls=isCurrent?(sortDir==='desc'?'sort-desc':'sort-asc'):'';
    return`<th class="${cls}" onclick="setSort('${key}')">${label}</th>`;
  };

  const rows=list.map((s,i)=>{
    const sc=s.score>=60?'hi':s.score>=35?'md':'lo';
    const d25cls=s.d25<0?'dn':'up';
    const isExpanded=expandedCode===s.code;
    const prevBadge=s.prev_score!=null
      ?`<span class="change-badge ${s.score>s.prev_score?'up':'dn'}">${s.score>s.prev_score?'â–²':'â–¼'}${Math.abs(s.score-s.prev_score)}</span>`:'';

    const detailRow=isExpanded?`
      <tr class="detail-row" id="detail-${s.code}">
        <td colspan="11">
          ${buildDetailBox(s)}
        </td>
      </tr>`:'';

    return`
      <tr class="tbl-row ${isExpanded?'expanded':''}" onclick="toggleDetail('${s.code}')">
        <td><span class="tbl-rank ${i<3?'top':''}">${i+1}</span></td>
        <td>
          <a class="tbl-name-link" href="https://finance.yahoo.co.jp/quote/${s.code}.T" target="_blank" rel="noopener" onclick="event.stopPropagation();gaEvent('click_yahoo',{code:s.code})">${s.name}</a>
          <div style="display:flex;align-items:center;gap:5px;margin-top:2px;flex-wrap:wrap">
            <div class="tbl-code">${s.code}ãƒ»${sectorMap(s.sector)}</div>
            ${prevBadge}
            ${trendBadge(s)}
            ${earningsBadge(s)}
          </div>
        </td>
        <td><span class="tbl-zone ${s.zone.cls}">${s.zone.label}</span></td>
        <td><span class="tbl-score ${sc}">${s.score}</span></td>
        <td style="text-align:center">${trendTypeBadge(s.trendType||'neutral')}</td>
        <td class="tbl-num">${s.dividend}%</td>
        <td class="tbl-num ${d25cls}">${s.d25>0?'+':''}${s.d25}%</td>
        <td class="tbl-num ${s.rsi<=30?'dn':''}">${s.rsi}</td>
        <td class="tbl-num">${s.turnover_avg5?s.turnover_avg5+'å„„':'â€”'}</td>
        <td class="tbl-num" style="white-space:nowrap">${s.market_cap_b>=10000?((s.market_cap_b/10000).toFixed(1)+'å…†'):(s.market_cap_b?Math.round(s.market_cap_b)+'å„„':'â€”')}</td>
        <td style="font-size:10px;color:var(--text3);text-align:right;white-space:nowrap">${sectorMap(s.sector)}</td>
      </tr>
      ${detailRow}`;
  }).join('');

  // DOMã¸ã®æ›¸ãè¾¼ã¿ã‚’1å›ã«ã¾ã¨ã‚ã‚‹ï¼ˆreflowæœ€å°åŒ–ï¼‰
  const wrap = document.getElementById('tableWrap');
  wrap.innerHTML=`
    <table class="stock-table">
      <thead>
        <tr>
          <th style="text-align:left;width:28px">#</th>
          ${thClick('name','éŠ˜æŸ„')}
          <th>ã‚¾ãƒ¼ãƒ³</th>
          ${thClick('score','ã‚¹ã‚³ã‚¢')}
          <th style="text-align:center">ã‚¿ã‚¤ãƒ—</th>
          ${thClick('dividend','é…å½“%')}
          ${thClick('d25','MAä¹–é›¢')}
          ${thClick('rsi','RSI')}
          ${thClick('turnover_avg5','å£²è²·ä»£é‡‘')}
          ${thClick('market_cap_b','æ™‚ä¾¡ç·é¡')}
          <th>ã‚»ã‚¯ã‚¿ãƒ¼</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function buildDetailBox(s){
  const d25=s.d25;
  const reasons=buildReasons(s,d25);
  const bdTrend=calcBreakdownTrend(s);
  const tType=s.trendType||'neutral';
  const tLabel=TREND_TYPE_LABEL[tType]||TREND_TYPE_LABEL.neutral;
  const isFav=watchlist.includes(s.code);

  const whyHtml=reasons.length?reasons.map(w=>`
    <div class="why-item ${w.cls}">
      <div class="why-rank-badge ${w.cls}">${w.rank}</div>
      <div class="why-val">${w.val}</div>
      <div class="why-label">${w.label}</div>
      <div class="why-note-text">${w.note}</div>
      <div class="why-desc">${w.desc}</div>
    </div>`).join('')
    :'<div style="font-size:11px;color:var(--text3)">ç¾æ™‚ç‚¹ã§æ˜ç¢ºãªè²·ã„ã‚·ã‚°ãƒŠãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>';

  const bdHtml=bdTrend.map(item=>`
    <div class="bd-row">
      <div class="bd-l">${item.l}</div>
      <div class="bd-bar"><div class="bd-fill" style="width:${Math.min(Math.abs(item.v)/item.max*100,100)}%;background:${item.pos?'var(--green)':'var(--up)'}"></div></div>
      <div class="bd-v ${item.pos?'pos':'neg'}">${item.v>0?'+':''}${item.v}ç‚¹</div>
    </div>`).join('');

  const r20=s.ret20||0;const r60=s.ret60||0;const r120=s.ret120||0;

  return`<div class="detail-box fadein">
    <div class="detail-grid">
      <div>
        <div class="detail-section-title">é¸ã°ã‚ŒãŸç†ç”±</div>
        <div class="why-items">${whyHtml}</div>
      </div>
      <div>
        <div class="detail-section-title">ğŸ“ˆ æ™‚é–“åŠ é‡ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¹ã‚³ã‚¢ï¼ˆ${s.score}ç‚¹ï¼‰ ${trendTypeBadge(tType)}</div>
        <div class="score-breakdown">${bdHtml}</div>
        <table style="width:100%;border-collapse:collapse;font-size:11px;margin-top:12px">
          <tr>
            <th style="background:var(--bg3);padding:5px 8px;text-align:left;font-size:10px;color:var(--text3)">æŒ‡æ¨™</th>
            <th style="background:var(--bg3);padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">å€¤</th>
            <th style="background:var(--bg3);padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">ç›®å®‰</th>
          </tr>
          <tr><td style="padding:5px 8px;font-size:11px">ç¾åœ¨å€¤</td><td style="padding:5px 8px;text-align:right;font-family:var(--fn);font-size:11px">Â¥${s.price.toLocaleString()}</td><td style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">â€”</td></tr>
          <tr><td style="padding:5px 8px;font-size:11px">æ™‚ä¾¡ç·é¡</td><td style="padding:5px 8px;text-align:right;font-family:var(--fn);font-size:11px">${s.market_cap_b>=10000?Math.round(s.market_cap_b/10000*10)/10+'å…†å††':s.market_cap_b?s.market_cap_b+'å„„å††':'â€”'}</td><td style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">1å…†å††ä»¥ä¸ŠãŒå¤§å‹</td></tr>
          <tr><td style="padding:5px 8px;font-size:11px">120æ—¥ãƒªã‚¿ãƒ¼ãƒ³</td><td style="padding:5px 8px;text-align:right;font-family:var(--fn);font-size:11px;color:${r120>0?'var(--green)':'var(--up)'}">${r120>0?'+':''}${r120.toFixed(1)}%</td><td style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">6ãƒ¶æœˆãƒˆãƒ¬ãƒ³ãƒ‰</td></tr>
          <tr><td style="padding:5px 8px;font-size:11px">60æ—¥ãƒªã‚¿ãƒ¼ãƒ³</td><td style="padding:5px 8px;text-align:right;font-family:var(--fn);font-size:11px;color:${r60>0?'var(--green)':'var(--up)'}">${r60>0?'+':''}${r60.toFixed(1)}%</td><td style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">3ãƒ¶æœˆãƒˆãƒ¬ãƒ³ãƒ‰</td></tr>
          <tr><td style="padding:5px 8px;font-size:11px">20æ—¥ãƒªã‚¿ãƒ¼ãƒ³</td><td style="padding:5px 8px;text-align:right;font-family:var(--fn);font-size:11px;color:${r20>0?'var(--green)':'var(--up)'}">${r20>0?'+':''}${r20.toFixed(1)}%</td><td style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">1ãƒ¶æœˆãƒˆãƒ¬ãƒ³ãƒ‰</td></tr>
          <tr><td style="padding:5px 8px;font-size:11px">ROE</td><td style="padding:5px 8px;text-align:right;font-family:var(--fn);font-size:11px;color:${(s.roe||0)>=10?'var(--green)':'var(--text)'}">${s.roe||0}%</td><td style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">10%ä»¥ä¸ŠãŒå„ªè‰¯</td></tr>
          <tr><td style="padding:5px 8px;font-size:11px">é…å½“åˆ©å›ã‚Š</td><td style="padding:5px 8px;text-align:right;font-family:var(--fn);font-size:11px">${s.dividend}%</td><td style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">3%ä»¥ä¸ŠãŒé«˜é…å½“</td></tr>
          <tr><td style="padding:5px 8px;font-size:11px">PBR</td><td style="padding:5px 8px;text-align:right;font-family:var(--fn);font-size:11px">${s.pbr}å€</td><td style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">1å€ä»¥ä¸‹ãŒå‰²å®‰</td></tr>
          ${s.days_to_next_earnings?`<tr><td style="padding:5px 8px;font-size:11px">ğŸ“Š æ¬¡å›æ±ºç®—</td><td style="padding:5px 8px;text-align:right;font-family:var(--fn);font-size:11px;color:${s.days_to_next_earnings<=14?'var(--orange)':'var(--text)'}">ç´„${s.days_to_next_earnings}æ—¥å¾Œ</td><td style="padding:5px 8px;text-align:right;font-size:10px;color:var(--text3)">${s.days_to_next_earnings<=14?'âš  æ±ºç®—å‰æ³¨æ„':'æ¨å®šå€¤'}</td></tr>`:''}
        </table>
        <div style="display:flex;gap:6px;margin-top:12px;flex-wrap:wrap">
          <button class="detail-fav-btn ${isFav?'active':''}" onclick="event.stopPropagation();toggleFav('${s.code}')">
            ${isFav?'â˜… ã‚¦ã‚©ãƒƒãƒæ¸ˆã¿':'â˜† ã‚¦ã‚©ãƒƒãƒè¿½åŠ '}
          </button>
          <a class="detail-link-btn" href="https://finance.yahoo.co.jp/quote/${s.code}.T" target="_blank" rel="noopener" onclick="event.stopPropagation();gaEvent('click_yahoo',{code:'${s.code}'})">Yahooæ ªä¾¡ â†—</a>
          <a class="detail-link-btn" href="https://kabutan.jp/stock/?code=${s.code}" target="_blank" rel="noopener" onclick="event.stopPropagation();gaEvent('click_kabutan',{code:'${s.code}'})">æ ªæ¢ â†—</a>
        </div>
      </div>
    </div>
  </div>`;
}

function toggleDetail(code){
  expandedCode=expandedCode===code?null:code;
  renderTable();
  if(expandedCode){
    gaEvent('open_stock_detail',{stock_code:code});
  }
}

function setSort(key){
  if(sortKey===key){sortDir=sortDir==='desc'?'asc':'desc';}
  else{sortKey=key;sortDir='desc';}
  processed.sort((a,b)=>{
    let av=a[key]??0,bv=b[key]??0;
    return sortDir==='asc'?av-bv:bv-av;
  });
  renderTable();
  gaEvent('sort_table',{key,dir:sortDir});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: DANGER SECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ è©±é¡Œæ ªã‚¿ãƒ–æç”» â”€â”€
function renderTrendTab(){
  const wrap = document.getElementById('tableWrap');
  const countEl = document.getElementById('filterCount');

  // trendRankingDataãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ã€ãªã‘ã‚Œã°STOCKSã‹ã‚‰è¨ˆç®—
  let trendList = [];
  if(trendRankingData && trendRankingData.length > 0){
    trendList = trendRankingData;
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼švol_ratio_1dã§è¨ˆç®—
    trendList = STOCKS
      .filter(s => (s.vol_ratio_1d||0) >= 1.5)
      .sort((a,b) => (b.trend_score||0) - (a.trend_score||0))
      .slice(0, 20);
  }

  if(!trendList.length){
    wrap.innerHTML = '<div class="empty-msg">æœ¬æ—¥ã¯å‡ºæ¥é«˜æ€¥å¢—éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    countEl.textContent = '';
    return;
  }

  countEl.textContent = trendList.length + 'éŠ˜æŸ„';

  const rows = trendList.map((s,i) => {
    const vr = s.vol_ratio_1d || 0;
    const ret = s.ret_1d || 0;
    const vrTag = vr>=3?'ğŸ”¥ç¥­ã‚Š':vr>=2?'ğŸ”¥æ€¥é¨°':'ğŸ“ˆæ³¨ç›®';
    const retColor = ret>=0 ? 'var(--up)' : 'var(--dn)';
    const retSign = ret>=0 ? '+' : '';
    // æŠ¼ã—ç›®Ã—é«˜é…å½“ã¨é‡è¤‡ã™ã‚‹ã‹ï¼ˆavoidãƒªã‚¹ãƒˆã¨ç…§åˆï¼‰
    const isAvoid = processed.some(p => p.code === s.code && p.zone && p.zone.cls === 'buy' && (s.vol_ratio_1d||0) >= 1.5);
    const warnBadge = isAvoid ? '<span style="color:var(--up);font-size:9px;font-weight:700">âš é¿ã‘ãŸã„</span>' : '';

    return `<tr>
      <td style="color:var(--text3);font-size:11px;text-align:left">${i+1}</td>
      <td>
        <a class="tbl-name-link" href="https://finance.yahoo.co.jp/quote/${s.code}.T" target="_blank" rel="noopener" onclick="event.stopPropagation()">${s.name||s.code}</a>
        <div style="display:flex;align-items:center;gap:5px;margin-top:2px;flex-wrap:wrap">
          <div class="tbl-code">${s.code}ãƒ»${s.sector||''}</div>
          ${warnBadge}
        </div>
      </td>
      <td><span style="font-size:13px">${vrTag}</span></td>
      <td class="tbl-num" style="font-weight:800;color:var(--navy)">${vr}x</td>
      <td class="tbl-num" style="color:${retColor};font-weight:700">${retSign}${ret}%</td>
      <td class="tbl-num">${s.range_pct||'â€”'}%</td>
      <td class="tbl-num">${s.dividend ? s.dividend+'%' : 'â€”'}</td>
    </tr>`;
  }).join('');

  wrap.innerHTML = `
    <div class="trend-warning">âš  çŸ­æœŸæŠ•æ©Ÿå‘ã‘ãƒ»æå¤±ãƒªã‚¹ã‚¯é«˜ãƒ»å‚è€ƒæƒ…å ±ã¨ã—ã¦åˆ©ç”¨ã—ã¦ãã ã•ã„</div>
    <table class="stock-table">
      <thead>
        <tr>
          <th style="text-align:left;width:28px">#</th>
          <th style="text-align:right">éŠ˜æŸ„</th>
          <th>æ³¨ç›®åº¦</th>
          <th class="tbl-num">å‡ºæ¥é«˜å€ç‡</th>
          <th class="tbl-num">å‰æ—¥æ¯”</th>
          <th class="tbl-num">å€¤å¹…%</th>
          <th class="tbl-num">é…å½“%</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function renderDanger(){
  // TOP5éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’åé›†ï¼ˆæŠ¼ã—ç›®+å‹¢ã„ä¸¡æ–¹ï¼‰
  const all=STOCKS.filter(s=>(s.market_cap_b||0)>=300).map(s=>{
    let st,tt;
    if(s.score_trend!=null&&s.trend_type){st=s.score_trend;tt=s.trend_type;}
    else{const t=calcScoreTrend(s);st=t.score;tt=t.type;}
    return{code:s.code,scoreTrend:st,trendType:tt};
  });
  const topDipCodes=new Set(all.filter(s=>s.trendType==='dip').sort((a,b)=>b.scoreTrend-a.scoreTrend).slice(0,5).map(s=>s.code));
  const topMomCodes=new Set(all.filter(s=>s.trendType==='momentum').sort((a,b)=>b.scoreTrend-a.scoreTrend).slice(0,5).map(s=>s.code));
  const excludeCodes=new Set([...topDipCodes,...topMomCodes]);

  const dangers=STOCKS.map(s=>{
    // TOP5ã«å…¥ã£ã¦ã„ã‚‹éŠ˜æŸ„ã¯é™¤å¤–
    if(excludeCodes.has(s.code))return null;
    const reasons=[];
    // æ¡ä»¶ã‚’å³æ ¼åŒ–ï¼ˆè¤‡æ•°æ¡ä»¶ãŒé‡ãªã£ãŸéŠ˜æŸ„ã®ã¿ï¼‰
    let dangerScore=0;
    if(s.vol_r>=2.0){reasons.push(`å‡ºæ¥é«˜${s.vol_r}å€æ€¥å¢—`);dangerScore+=2;}
    else if(s.vol_r>=1.5){reasons.push(`å‡ºæ¥é«˜${s.vol_r}å€å¢—`);dangerScore+=1;}
    const d25=dv(s.price,s.ma25);
    if(d25>=5){reasons.push(`25MAæ¯”+${d25}%ï¼ˆé«˜å€¤åœï¼‰`);dangerScore+=2;}
    if(s.rsi>=70){reasons.push(`RSI ${s.rsi}ï¼ˆè²·ã‚ã‚Œã™ãï¼‰`);dangerScore+=2;}
    const ret1d=s.ret_1d||0;
    if(ret1d<=-5){reasons.push(`å‰æ—¥${ret1d.toFixed(1)}%æ€¥è½`);dangerScore+=2;}
    if(dangerScore<2)return null; // 1ã¤ã ã‘ã§ã¯é¿ã‘ãŸã„ã¨ã¯è¨€ã‚ãªã„
    return{...s,d25,dangerReasons:reasons,dangerScore};
  }).filter(s=>s!==null)
    .sort((a,b)=>b.dangerScore-a.dangerScore)
    .slice(0,5);

  if(!dangers.length){
    document.getElementById('dangerSection').innerHTML='';
    return;
  }

  document.getElementById('dangerSection').innerHTML=`
    <div class="danger-section fadein">
      <div class="danger-title">âš  ä»Šæ—¥ã¯é¿ã‘ãŸã„éŠ˜æŸ„ï¼ˆTOP${dangers.length}ï¼‰</div>
      <div class="danger-rows">
        ${dangers.map(s=>`
          <div class="danger-row">
            <div>
              <div class="danger-name">${s.name}</div>
              <div class="danger-code">${s.code}ãƒ»${s.sector}</div>
            </div>
            <div style="display:flex;gap:5px;flex-wrap:wrap;justify-content:flex-end">
              ${s.dangerReasons.map(r=>`<span class="danger-reason">${r}</span>`).join('')}
            </div>
          </div>`).join('')}
      </div>
      <div style="font-size:10px;color:var(--text3);margin-top:8px">è¤‡æ•°ã®éç†±ãƒ»æ€¥è½ã‚·ã‚°ãƒŠãƒ«ãŒé‡ãªã£ãŸéŠ˜æŸ„ã€‚æŠ¼ã—ç›®è²·ã„ãƒ»å‹¢ã„è²·ã„ã®å¯¾è±¡ã‹ã‚‰ã¯å¤–ã™ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TODAY'S TOP5
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genReason(s){
  const parts=[];
  const div=s.dividend||0;
  const mc=s.market_cap_b||0;
  const r5=s.ret5||0;
  const r10=s.ret10||0;
  const z=s.dip_zscore||0;
  const pbr=s.pbr||99;
  const diff5=s.ret5_vs_sector||0;
  const dgy=s.div_growth_years||0;
  // é…å½“+å¢—é…
  if(div>=5) parts.push('è¶…é«˜é…å½“'+div+'%');
  else if(div>=4) parts.push('é«˜é…å½“'+div+'%');
  else if(div>=3) parts.push('é…å½“'+div+'%');
  else if(div>=2) parts.push('é…å½“'+div+'%ã®å¤§å‹å®‰å®šæ ª');
  if(dgy>=10) parts.push(dgy+'å¹´é€£ç¶šå¢—é…');
  else if(dgy>=5) parts.push(dgy+'å¹´é€£ç¶šå¢—é…ä¸­');
  // ã‚»ã‚¯ã‚¿ãƒ¼å·®åˆ†ï¼ˆæœ€é‡è¦ï¼‰
  if(diff5<=-3) parts.push('ã‚»ã‚¯ã‚¿ãƒ¼å†…ã§çªå‡ºã—ã¦å£²ã‚‰ã‚Œã¦ã„ã‚‹ï¼ˆå·®åˆ†'+diff5.toFixed(1)+'%ï¼‰');
  else if(diff5<=-1) parts.push('åŒã‚»ã‚¯ã‚¿ãƒ¼æ¯”ã§å€‹åˆ¥ã«å¼±ã„');
  // ä¸‹è½ãƒˆãƒ¬ãƒ³ãƒ‰
  if(r5<=-5) parts.push('5æ—¥ã§'+r5.toFixed(1)+'%æ€¥è½ä¸­');
  else if(r5<=-2) parts.push('5æ—¥ã§'+r5.toFixed(1)+'%ä¸‹è½');
  // è‡ªåˆ†æ¯”
  if(z<=-2) parts.push('è‡ªåˆ†æ¯”ã§ç•°ä¾‹ã®å®‰å€¤ï¼ˆ'+z.toFixed(1)+'Ïƒï¼‰');
  else if(z<=-1) parts.push('è‡ªåˆ†æ¯”ã§æŠ¼ã—ç›®æ°´æº–');
  // å‰²å®‰
  if(pbr<=0.7) parts.push('PBR'+pbr+'å€ã§è¶…å‰²å®‰');
  // çµè«–
  if(diff5<=-3&&div>=3) return parts.join('ã€‚')+'ã€‚å€‹åˆ¥è¦å› ã§ã®ä¸‹è½ã¯åç™ºã—ã‚„ã™ã„ã€‚ç‹™ã„ç›®ã€‚';
  if(r5<=-3&&div>=3) return parts.join('ã€‚')+'ã€‚åç™ºã™ã‚Œã°é…å½“ã¨å€¤ä¸ŠãŒã‚Šç›Šã®ä¸¡å–ã‚ŠãŒç‹™ãˆã‚‹ã€‚';
  if(z<=-1.5&&mc>=5000) return parts.join('ã€‚')+'ã€‚å¤§å‹å®‰å®šæ ªã®çã—ã„æŠ¼ã—ç›®ã€‚';
  if(dgy>=10&&div>=3) return parts.join('ã€‚')+'ã€‚å¢—é…éŠ˜æŸ„ã®æŠ¼ã—ç›®ã¯é•·æœŸæŠ•è³‡å®¶ã«å¥½æ©Ÿã€‚';
  return parts.join('ã€‚')+'ã€‚';
}
function renderTop5(){
  const sec=document.getElementById('top5Section');
  if(!sec||!STOCKS.length) return;
  // å…¨éŠ˜æŸ„ã«ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¹ã‚³ã‚¢è¨ˆç®—
  const all=STOCKS.filter(s=>(s.market_cap_b||0)>=300).map(s=>{
    let st,tt;
    if(s.score_trend!=null&&s.trend_type){st=s.score_trend;tt=s.trend_type;}
    else{const t=calcScoreTrend(s);st=t.score;tt=t.type;}
    return{...s,scoreTrend:st,trendType:tt};
  });
  // ğŸ›¡ æŠ¼ã—ç›®TOP5: trend_type=dip ã®ã¿
  const topDip=all.filter(s=>s.trendType==='dip'&&(s.dividend||0)>=2)
    .sort((a,b)=>b.scoreTrend-a.scoreTrend).slice(0,5);
  // ğŸš€ å‹¢ã„TOP5: trend_type=momentum ã®ã¿
  const topMom=all.filter(s=>s.trendType==='momentum')
    .sort((a,b)=>b.scoreTrend-a.scoreTrend).slice(0,5);
  if(!topDip.length&&!topMom.length){sec.style.display='none';return;}
  sec.style.display='grid';
  // æŠ¼ã—ç›®ãƒªã‚¹ãƒˆ
  const dipEl=document.getElementById('top5DipList');
  if(dipEl) dipEl.innerHTML=topDip.length?topDip.map((s,i)=>{
    const scCls=s.scoreTrend>=60?'hi':'';
    const rankCls=i===0?'gold':'';
    const r5=s.ret5||0;const r20=s.ret20||0;const r120=s.ret120||0;
    return`<div class="top5-item" onclick="expandedCode='${s.code}';run();document.getElementById('tableWrap').scrollIntoView({behavior:'smooth'})">
      <div class="top5-rank ${rankCls}">${i+1}</div>
      <div class="top5-info">
        <div class="top5-name-row">
          <span class="top5-name">${s.name}</span>
          <span class="top5-score ${scCls}">${s.scoreTrend}pt</span>
        </div>
        <div class="top5-meta">
          ${s.code} | é…å½“${s.dividend}% | 120æ—¥${r120>0?'+':''}${r120.toFixed(0)}% â†’ 5æ—¥${r5>0?'+':''}${r5.toFixed(1)}%
        </div>
        <div class="top5-reason">${genReasonTrend(s)}</div>
      </div>
    </div>`;
  }).join(''):'<div style="font-size:11px;color:var(--text3);padding:10px">è©²å½“éŠ˜æŸ„ãªã—ï¼ˆä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ä¸­ã®æŠ¼ã—ç›®ãŒç™ºç”Ÿã—ã¦ã„ã¾ã›ã‚“ï¼‰</div>';
  // å‹¢ã„ãƒªã‚¹ãƒˆ
  document.getElementById('top5MomList').innerHTML=topMom.length?topMom.map((s,i)=>{
    const scCls=s.scoreTrend>=60?'hi':'';
    const rankCls=i===0?'gold':'';
    const r20=s.ret20||0;const r60=s.ret60||0;const r120=s.ret120||0;
    return`<div class="top5-item" onclick="expandedCode='${s.code}';run();document.getElementById('tableWrap').scrollIntoView({behavior:'smooth'})">
      <div class="top5-rank ${rankCls}" style="background:${i===0?'#e040fb':'var(--bg3)'}">${i+1}</div>
      <div class="top5-info">
        <div class="top5-name-row">
          <span class="top5-name">${s.name}</span>
          <span class="top5-score ${scCls}" style="color:#e040fb">${s.scoreTrend}pt</span>
        </div>
        <div class="top5-meta">
          ${s.code} | 120æ—¥${r120>0?'+':''}${r120.toFixed(0)}% | 60æ—¥${r60>0?'+':''}${r60.toFixed(0)}% | 20æ—¥${r20>0?'+':''}${r20.toFixed(0)}%
        </div>
        <div class="top5-reason">${genReasonTrend(s)}</div>
      </div>
    </div>`;
  }).join(''):'<div style="font-size:11px;color:var(--text3);padding:10px">è©²å½“éŠ˜æŸ„ãªã—</div>';
}

function genReasonTrend(s){
  const parts=[];
  const r120=s.ret120||0,r60=s.ret60||0,r20=s.ret20||0,r5=s.ret5||0;
  const tt=s.trendType||'neutral';
  if(tt==='dip'){
    if(r120>=10)parts.push('6ãƒ¶æœˆã§+'+r120.toFixed(0)+'%ä¸Šæ˜‡ä¸­ã®éŠ˜æŸ„');
    parts.push('ç›´è¿‘5æ—¥ã§'+r5.toFixed(1)+'%ã®çŸ­æœŸèª¿æ•´');
    if((s.dividend||0)>=3)parts.push('é…å½“'+s.dividend+'%ã§ä¸‹å€¤ã‚‚å …ã„');
  }else if(tt==='momentum'){
    const posN=[r120,r60,r20].filter(r=>r>0).length;
    if(posN===3)parts.push('120æ—¥/60æ—¥/20æ—¥ã™ã¹ã¦ä¸Šæ˜‡ã®å®Œç’§ãªãƒˆãƒ¬ãƒ³ãƒ‰');
    if(r20>=10)parts.push('ç›´è¿‘20æ—¥ã§+'+r20.toFixed(0)+'%åŠ é€Ÿä¸­');
    if((s.vol_trend||1)>=1.5)parts.push('å‡ºæ¥é«˜ã‚‚å¢—åŠ ä¸­');
  }else if(tt==='bounce'){
    parts.push('åç™ºã®å…†ã—ï¼ˆæŒç¶šæ€§ã¯è¦ç¢ºèªï¼‰');
  }
  if((s.roe||0)>=10)parts.push('ROE'+s.roe+'%ã®é«˜åç›Š');
  return parts.slice(0,3).join('ã€‚')||'ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æä¸­';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECTOR FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SECTOR_MAP={
  'Financials':'é‡‘è','Financial Services':'é‡‘è',
  'Consumer Cyclical':'æ¶ˆè²»å¾ªç’°','Consumer Defensive':'ç”Ÿæ´»å¿…éœ€',
  'Industrials':'ç”£æ¥­','Technology':'ãƒ†ãƒƒã‚¯',
  'Communication Services':'é€šä¿¡','Real Estate':'ä¸å‹•ç”£',
  'Basic Materials':'ç´ æ','Energy':'ã‚¨ãƒãƒ«ã‚®ãƒ¼',
  'Healthcare':'åŒ»ç™‚','Utilities':'å…¬ç›Š',
};
function sectorMap(s){return SECTOR_MAP[s]||s||'ãã®ä»–';}
function buildSectorChips(){
  const wrap=document.getElementById('sectorFilterScroll');
  if(!wrap)return;
  // ç¾åœ¨ã®ã‚¿ãƒ–ã«è©²å½“ã™ã‚‹éŠ˜æŸ„ã®ã‚»ã‚¯ã‚¿ãƒ¼é›†è¨ˆ
  const counts={};
  STOCKS.forEach(s=>{
    if((s.dividend||0)<2||(s.market_cap_b||0)<500)return;
    const sec=sectorMap(s.sector);
    counts[sec]=(counts[sec]||0)+1;
  });
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  let html='<div class="sector-chip active" onclick="setSector(\'all\',this)">å…¨ã‚»ã‚¯ã‚¿ãƒ¼</div>';
  sorted.forEach(([sec,cnt])=>{
    const active=currentSector===sec?'active':'';
    html+=`<div class="sector-chip ${active}" onclick="setSector('${sec}',this)">${sec}<span class="sector-count">${cnt}</span></div>`;
  });
  wrap.innerHTML=html;
}
function setSector(sec,el){
  currentSector=sec;
  document.querySelectorAll('.sector-chip').forEach(c=>c.classList.remove('active'));
  if(el)el.classList.add('active');
  run();
  gaEvent('sector_filter',{sector:sec});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER & MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMode(m,el){
  currentMode=m;
  document.querySelectorAll('.filter-tab[id^="mode-"]').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
  document.querySelectorAll('#set-mode .setting-opt').forEach(o=>{
    o.classList.toggle('active',o.dataset.val===m);
  });
  run();
  gaEvent('mode_changed',{mode:m});
}

function setStyleTab(tab,el){
  // ã‚¿ãƒ–çµ±åˆæ¸ˆã¿ â€” bluechipã®ã¿
  currentStyleTab='bluechip';
  run();
}

function setDispCount(n,el){
  dispCount=n;
  document.querySelectorAll('.filter-tab[id^="disp-"]').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings(){
  // ç¾åœ¨ã®è¨­å®šã‚’åæ˜ 
  document.querySelectorAll('#set-mode .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===settings.mode));
  // set-mode removed from UI; keep for backward compat
  document.querySelectorAll('#set-count .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===String(settings.count)));
  document.querySelectorAll('#set-mindiv .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===String(settings.mindiv)));
  document.querySelectorAll('#set-zone .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===settings.zone));
  document.getElementById('settingsOverlay').classList.add('open');
  gaEvent('click_settings');
}
function closeSettingsBg(e){if(e.target===document.getElementById('settingsOverlay'))document.getElementById('settingsOverlay').classList.remove('open');}

function selectSettingOpt(el,group){
  document.querySelectorAll(`#set-${group} .setting-opt`).forEach(o=>o.classList.remove('active'));
  el.classList.add('active');
}

function saveSettings(){
  settings.mode=document.querySelector('#set-mode .setting-opt.active')?.dataset.val||'dividend';
  settings.count=parseInt(document.querySelector('#set-count .setting-opt.active')?.dataset.val||'30');
  settings.mindiv=parseFloat(document.querySelector('#set-mindiv .setting-opt.active')?.dataset.val||'0');
  settings.zone=document.querySelector('#set-zone .setting-opt.active')?.dataset.val||'all';
  try{localStorage.setItem('kbs_settings',JSON.stringify(settings));}catch(e){}

  currentMode=settings.mode;
  dispCount=settings.count;

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–åŒæœŸ
  document.querySelectorAll('.filter-tab[id^="mode-"]').forEach(t=>t.classList.remove('active'));
  const mt=document.getElementById('mode-'+currentMode);if(mt)mt.classList.add('active');
  document.querySelectorAll('.filter-tab[id^="disp-"]').forEach(t=>t.classList.remove('active'));
  const cnt=dispCount>=999?'all':String(dispCount);
  const dt=document.getElementById('disp-'+cnt);if(dt)dt.classList.add('active');

  document.getElementById('settingsOverlay').classList.remove('open');
  run();
  gaEvent('change_filter',settings);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WATCHLIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFav(code){
  const adding=!watchlist.includes(code);
  if(adding){
    watchlist.push(code);
    const s=processed.find(x=>x.code===code);
    gaEvent('watchlist_add',{stock_code:code,score:s?.score||0});
  }else{
    watchlist=watchlist.filter(c=>c!==code);
    gaEvent('watchlist_remove',{stock_code:code});
  }
  try{localStorage.setItem('kbs_watch',JSON.stringify(watchlist));}catch(e){}
  updateWatchCount();
  // å±•é–‹ä¸­ã®è©³ç´°ã‚’å†æç”»
  if(expandedCode)renderTable();
  renderWatchlist();
}

function updateWatchCount(){
  const el=document.getElementById('watchCount');
  el.textContent=watchlist.length;
  el.classList.toggle('show',watchlist.length>0);
}

function renderWatchlist(){
  updateWatchCount();
  const el=document.getElementById('watchlistBody');
  if(!watchlist.length){
    el.innerHTML='<div class="watch-empty">ã‚¦ã‚©ãƒƒãƒç™»éŒ²ã—ãŸéŠ˜æŸ„ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>éŠ˜æŸ„è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’é–‹ãã€Œã‚¦ã‚©ãƒƒãƒã«è¿½åŠ ã€ã‹ã‚‰ç™»éŒ²ã§ãã¾ã™ã€‚</div>';
    return;
  }
  el.innerHTML=`<div class="watch-list">${watchlist.map(code=>{
    const s=STOCKS.find(x=>x.code===code);if(!s)return'';
    const score=calcScore(s,currentMode);
    const sc=score>=60?'hi':score>=35?'md':'lo';
    const d25=dv(s.price,s.ma25);
    return`<div class="watch-row" onclick="switchTab('home');setTimeout(()=>{expandedCode='${code}';run();},100)">
      <div class="watch-code">${code}</div>
      <div class="watch-name">${s.name}</div>
      <div style="text-align:right">
        <div class="watch-score ${sc}">${score}ç‚¹</div>
        <div style="font-size:10px;color:var(--text3)">${d25>0?'+':''}${d25}%</div>
      </div>
      <button class="watch-remove" onclick="event.stopPropagation();toggleFav('${code}')">âœ•</button>
    </div>`;
  }).join('')}</div>`;
}

function renderHistory(){
  const el=document.getElementById('historyBody');
  const modeNames={dividend:'é«˜é…å½“',value:'ãƒãƒªãƒ¥ãƒ¼',rebound:'æŠ¼ã—ç›®'};
  if(!scanHistory.length){
    el.innerHTML='<div class="watch-empty">ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>';
    return;
  }
  el.innerHTML=`<table class="hist-table">
    <tr><th>æ—¥æ™‚</th><th>ãƒ¢ãƒ¼ãƒ‰</th><th>ä»¶æ•°</th><th>1ä½éŠ˜æŸ„</th></tr>
    ${scanHistory.slice(0,7).map(h=>`<tr>
      <td>${h.date}</td><td>${modeNames[h.mode]||h.mode}</td>
      <td>${h.count}ä»¶</td><td>${h.top}</td>
    </tr>`).join('')}
  </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
  const n=document.getElementById('nav-'+tab);if(n)n.classList.add('active');
  if(tab==='watch'){renderWatchlist();renderHistory();}
  gaEvent('tab_switched',{tab});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLogicModal(){document.getElementById('logicModal').classList.add('open');}
function closeLogicModal(e){if(!e||e.target===document.getElementById('logicModal'))document.getElementById('logicModal').classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRealData(){
  try{
    const r=await fetch('stocks_data.json?t='+Date.now());
    if(!r.ok)throw new Error('fetch failed');
    const j=await r.json();
    if(j.stocks&&j.stocks.length>0){
      STOCKS=j.stocks;
      dataSource='real';
      // å¸‚å ´ãƒ‡ãƒ¼ã‚¿
      const mFields=['nikkei_price','nikkei_ma25','nikkei_1d_chg','nasdaq_1d_chg',
                     'vix','usdjpy','us10y','geo_risk','rate_cut_flag','prev_buy_count'];
      mFields.forEach(k=>{if(j[k]!==undefined)marketData[k]=j[k];});
      if(j.vol_ranking&&j.vol_ranking.length)volRankingData=j.vol_ranking;
      if(j.trend_ranking&&j.trend_ranking.length)trendRankingData=j.trend_ranking;
      // ä¿¡é ¼ãƒãƒ¼
      document.getElementById('trustText').innerHTML=`<span class="hi">${j.updated_at}</span> æ›´æ–° Â· ${j.total}éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿`;
      document.getElementById('trustDot').style.background='var(--green)';
      document.getElementById('trustBanner').style.borderLeftColor='var(--green)';
      document.getElementById('totalCountBadge').textContent=j.total+'éŠ˜æŸ„';
      document.getElementById('heroEyebrow').innerHTML='<span class="hero-dot"></span>ğŸ“¡ å®Ÿãƒ‡ãƒ¼ã‚¿èª­è¾¼æ¸ˆã¿ â€” 1,600éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒ³ â€” æ¯æœ7:30è‡ªå‹•æ›´æ–°';
    }else throw new Error('no stocks');
  }catch{
    dataSource='sample';
    STOCKS=[...SAMPLE_STOCKS];
    document.getElementById('trustText').innerHTML='<span class="warn">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºä¸­</span> â€” å®Ÿãƒ‡ãƒ¼ã‚¿ã¯æ¯æœ8:30æ›´æ–°';
    document.getElementById('trustDot').style.background='var(--amber)';
    document.getElementById('trustBanner').style.borderLeftColor='var(--amber)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EARNINGS BADGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function earningsBadge(s){
  const d=s.days_to_next_earnings;
  if(!d)return'';
  if(d<=7)return'<span class="earnings-badge soon">æ±ºç®—'+d+'æ—¥å‰</span>';
  if(d<=14)return'<span class="earnings-badge soon">æ±ºç®—'+d+'æ—¥å‰</span>';
  const ds=s.days_since_earnings;
  if(ds&&ds<=7)return'<span class="earnings-badge recent">æ±ºç®—'+ds+'æ—¥å¾Œ</span>';
  return'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ECONOMIC EVENTS CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let EVENTS=[];
function loadEvents(){
  fetch('events.json').then(r=>r.json()).then(data=>{
    EVENTS=data;
    renderEvents();
  }).catch(()=>{});
}
function renderEvents(){
  const sec=document.getElementById('eventsSection');
  const list=document.getElementById('eventsList');
  if(!sec||!EVENTS.length)return;
  const today=new Date();
  today.setHours(0,0,0,0);
  const twoWeeks=new Date(today);
  twoWeeks.setDate(twoWeeks.getDate()+14);
  const upcoming=EVENTS.filter(e=>{
    const d=new Date(e.date+'T00:00:00');
    return d>=today&&d<=twoWeeks;
  }).sort((a,b)=>a.date.localeCompare(b.date));
  if(!upcoming.length){sec.style.display='none';return;}
  sec.style.display='block';
  list.innerHTML=upcoming.map(e=>{
    const d=new Date(e.date+'T00:00:00');
    const diff=Math.round((d-today)/(1000*60*60*24));
    const cls=diff===0?'today':diff<=3?'soon':'';
    const dayStr=diff===0?'ä»Šæ—¥':diff===1?'æ˜æ—¥':diff+'æ—¥å¾Œ';
    const mm=(d.getMonth()+1)+'/'+d.getDate();
    return`<div class="event-item ${cls}">
      <span class="event-date">${mm}</span>
      <span class="event-label">${e.label}</span>
      <span class="event-days">${dayStr}</span>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function run(){
  processStocks();
  buildSectorChips();
  renderTop5();
  renderHeroStats();
  renderPulse();
  // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æœ€å„ªå…ˆã§æç”»
  renderTable();
  // ã‚¹ã‚¿ãƒ³ã‚¹ãƒ»å±é™ºéŠ˜æŸ„ã¯å°‘ã—é…ã‚‰ã›ã¦ã‚‚OKï¼ˆä½“æ„Ÿé€Ÿåº¦æ”¹å–„ï¼‰
  requestAnimationFrame(()=>{
    renderStance();
    renderDanger();
  });
  gaEvent('scan_executed',{mode:currentMode,buy_count:processed.filter(s=>s.zone.cls==='buy').length,data_source:dataSource});
}

function renderQuadrant(){
  const wrap=document.getElementById('quadrantWrap');
  if(!wrap)return;
  const dot=document.getElementById('qDot');
  const label=document.getElementById('qDotLabel');
  if(!dot||!label)return;

  const w=wrap.offsetWidth;
  const h=wrap.offsetHeight;
  // ã‹ã¶ã®ã™ã‘ã®ä½ç½®: ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«(ä¸‹)Ã—çŸ­æœŸ(å³) â†’ å³ä¸‹
  // X: 0=å·¦(é•·æœŸ) 1=å³(çŸ­æœŸ), Y: 0=ä¸Š(ãƒ•ã‚¡ãƒ³ãƒ€) 1=ä¸‹(ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«)
  const posX=0.78, posY=0.78;
  const px=posX*w-9;
  const py=posY*h-9;

  dot.style.left=px+'px';
  dot.style.top=py+'px';
  label.style.left=(px+24)+'px';
  label.style.top=(py+2)+'px';

  // hover tooltips on cells
  const cells=wrap.querySelectorAll('.q-cell');
  cells.forEach((cell,i)=>{
    cell.addEventListener('mouseenter',()=>{
      cell.style.transform='scale(1.02)';
      cell.style.zIndex='5';
    });
    cell.addEventListener('mouseleave',()=>{
      cell.style.transform='scale(1)';
      cell.style.zIndex='1';
    });
  });
}

async function init(){
  updateWatchCount();
  await loadRealData();
  document.getElementById('sectorFilterWrap').style.display='block';
  loadEvents();
  renderQuadrant();
  run();
  gaEvent('view_app',{data_source:dataSource});
}

// resizeå¯¾å¿œ
window.addEventListener('resize',()=>{renderQuadrant();});

init();
</script>
</body>
</html>
