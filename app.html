<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‹ã¶ã®ã™ã‘ â€” ä»Šæ—¥ã®æŠ¼ã—ç›®å€™è£œ</title>
<meta name="description" content="æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ å…¨éŠ˜æŸ„ã‚’æ¯æœè‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³ã€‚åœ°åˆã„åˆ¤å®šÃ—é«˜é…å½“Ã—å‰²å®‰ã§ä»Šæ—¥ã®è²·ã„å ´ã‚’å³è¡¨ç¤ºã€‚">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DWW0W11P5T"></script>
<script>
  window.dataLayer=window.dataLayer||[];
  function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());
  gtag('config','G-DWW0W11P5T',{page_title:'ã‹ã¶ã®ã™ã‘'});
  function gaEvent(n,p){if(typeof gtag!=='undefined')gtag('event',n,p||{});}
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --navy:#0d1117; --navy2:#151b26;
  --orange:#ff6b00; --orange2:#ff8533; --orange-lt:rgba(255,107,0,0.1);
  --up:#ff4757; --dn:#4a9eff;
  --green:#00d68f; --green-lt:rgba(0,214,143,0.1);
  --amber:#f0a500; --amber-lt:rgba(240,165,0,0.1);
  --bg:#eef2f7; --bg2:#151b26; --bg3:#1a2233;
  --border:#2a3352; --border-lt:#d0d8e8;
  --text:#c9d1d9; --text2:#e6edf3; --text3:#6b7b8d;
  --text-page:#4a5568;
  --r:8px; --r2:5px;
  --fn:'JetBrains Mono','Outfit',monospace;
  --fh:'Outfit','Noto Sans JP',sans-serif;
  --fb:'Noto Sans JP',sans-serif;
  --shadow:0 2px 8px rgba(0,0,0,0.15),0 1px 3px rgba(0,0,0,0.1);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{font-size:15px;}
body{background:var(--bg);color:var(--text);font-family:var(--fb);min-height:100vh;overflow-x:hidden;}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{
  position:sticky;top:0;z-index:300;
  background:var(--navy);border-bottom:2px solid var(--orange);
  height:50px;display:flex;align-items:center;padding:0 20px;
  box-shadow:0 2px 12px rgba(0,0,0,0.2);
}
.topbar-inner{width:100%;max-width:1300px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;}
.logo-name{font-family:var(--fh);font-size:17px;font-weight:800;color:#fff;letter-spacing:-0.3px;}
.logo-tag{font-size:9px;color:rgba(255,255,255,0.4);font-family:var(--fh);margin-left:8px;}
.topbar-right{display:flex;align-items:center;gap:8px;}
.btn-topbar{
  background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);
  border-radius:var(--r2);padding:5px 12px;color:#fff;cursor:pointer;
  font-family:var(--fh);font-size:11px;font-weight:600;
  display:flex;align-items:center;gap:5px;
}
.btn-topbar:hover{background:rgba(255,255,255,0.18);}
.watch-count{
  background:var(--orange);color:#fff;border-radius:10px;
  padding:1px 5px;font-size:9px;font-weight:700;display:none;
}
.watch-count.show{display:inline-block;}

/* â”€â”€ LAYOUT â”€â”€ */
.page{max-width:1300px;margin:0 auto;padding:20px 20px 100px;}
@media(max-width:480px){.page{padding:12px 12px 90px;}}

/* â”€â”€ HERO (compact) â”€â”€ */
.hero{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);padding:12px 16px;margin-bottom:12px;
  box-shadow:var(--shadow);
}
.hero::before{display:none;}
.hero-top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.hero-left{}
.hero-eyebrow{
  display:inline-flex;align-items:center;gap:6px;
  font-family:var(--fh);font-size:10px;color:var(--text3);
  margin-bottom:4px;
}
.hero-dot{width:6px;height:6px;border-radius:50%;background:var(--orange);flex-shrink:0;animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}
.hero-title{font-family:var(--fh);font-size:15px;font-weight:800;color:var(--text2);line-height:1.2;letter-spacing:-0.3px;}
.hero-title span{color:var(--orange);}
@media(max-width:480px){.hero-title{font-size:13px;}}
.hero-stats{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;}
.hero-stat{
  background:rgba(255,255,255,0.05);border:1px solid var(--border);
  border-radius:var(--r2);padding:6px 12px;
}
.hero-stat-val{font-family:var(--fn);font-size:15px;color:var(--text2);line-height:1;}
.hero-stat-val.buy{color:var(--orange);}
.hero-stat-label{font-size:8px;color:var(--text3);font-family:var(--fh);margin-top:1px;}

/* â”€â”€ TRUST BAR â”€â”€ */
.trust-bar{
  background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--amber);
  border-radius:var(--r);padding:8px 14px;margin-bottom:12px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  box-shadow:var(--shadow);
}
.trust-left{display:flex;align-items:center;gap:8px;}
.trust-dot{width:8px;height:8px;border-radius:50%;background:var(--amber);flex-shrink:0;}
.trust-text{font-size:11px;color:var(--text3);}
.trust-text .hi{color:var(--green);font-weight:700;}
.trust-text .warn{color:var(--amber);font-weight:700;}
.trust-badges{display:flex;gap:6px;flex-wrap:wrap;}
.tbadge{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:4px;padding:2px 8px;font-size:10px;color:var(--text3);
  font-family:var(--fh);
}
.tbadge.link{cursor:pointer;color:var(--orange);border-color:var(--orange);}
.tbadge.link:hover{background:var(--orange);color:#fff;}

/* â”€â”€ MARKET PULSE â”€â”€ */
.pulse{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);margin-bottom:12px;overflow:hidden;
}
.pulse-row{display:flex;overflow-x:auto;scrollbar-width:none;}
.pulse-row::-webkit-scrollbar{display:none;}
.pc{flex-shrink:0;padding:9px 14px;border-right:1px solid var(--border);min-width:88px;text-align:center;}
.pc:last-child{border-right:none;}
.pc-l{font-size:9px;color:var(--text3);font-family:var(--fh);margin-bottom:2px;}
.pc-v{font-family:var(--fn);font-size:13px;color:var(--text2);}
.pc-v.up{color:var(--up);}  .pc-v.dn{color:var(--dn);}
.pc-c{font-family:var(--fn);font-size:10px;color:var(--text3);}
.pc-c.up{color:var(--up);}  .pc-c.dn{color:var(--dn);}

/* â”€â”€ STANCE â”€â”€ */
.stance{
  background:var(--bg2);border:1px solid var(--border);border-left:4px solid var(--border);
  border-radius:var(--r);padding:16px 18px;margin-bottom:14px;
  box-shadow:var(--shadow);
}
.stance.bull{border-left-color:var(--up);}
.stance.neutral{border-left-color:var(--amber);}
.stance.bear{border-left-color:var(--dn);}
.stance-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
.stance-title{font-family:var(--fh);font-size:16px;font-weight:800;color:var(--text2);}
.stance-date{font-size:10px;color:var(--text3);font-family:var(--fh);margin-top:2px;}
.stance-badge{
  flex-shrink:0;padding:4px 12px;border-radius:20px;
  font-family:var(--fh);font-size:11px;font-weight:700;border:1px solid;
}
.stance-badge.bull{background:rgba(208,2,27,0.07);color:var(--up);border-color:rgba(208,2,27,0.2);}
.stance-badge.neutral{background:var(--amber-lt);color:var(--amber);border-color:rgba(148,101,0,0.2);}
.stance-badge.bear{background:rgba(0,85,204,0.07);color:var(--dn);border-color:rgba(0,85,204,0.2);}
.stance-reason{font-size:12px;color:var(--text);line-height:1.85;margin-bottom:12px;}
.stance-reason strong{color:var(--orange);font-weight:700;}
.stance-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.stance-chip{
  border:1px solid var(--border);border-radius:var(--r2);
  padding:6px 10px;text-align:center;flex:1;min-width:70px;background:var(--bg3);
}
.stance-chip.buy{background:var(--green-lt);border-color:rgba(0,135,90,0.2);}
.stance-chip.warn{background:var(--amber-lt);border-color:rgba(148,101,0,0.2);}
.stance-chip-val{font-family:var(--fn);font-size:15px;color:var(--text2);}
.stance-chip-label{font-size:9px;color:var(--text3);}
.stance-axes{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;}
.axis-row{display:flex;align-items:center;gap:8px;font-size:11px;}
.axis-name{min-width:110px;color:var(--text3);}
.axis-bar{display:flex;gap:3px;}
.axis-seg{width:24px;height:6px;border-radius:3px;background:var(--border);}
.axis-seg.on.hi{background:var(--up);}
.axis-seg.on.mid{background:var(--amber);}
.axis-score{font-family:var(--fn);font-size:10px;color:var(--text3);}
.axis-total{font-size:11px;font-weight:700;color:var(--text3);padding-top:4px;border-top:1px solid var(--border);}
.stance-note{font-size:10px;color:var(--text3);background:var(--bg3);padding:6px 10px;border-radius:var(--r2);line-height:1.6;}

/* â”€â”€ SECTION HEADER â”€â”€ */
.sec-head{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;
}
.sec-head-title{font-family:var(--fh);font-size:13px;font-weight:700;color:var(--text2);}
.sec-head-sub{font-size:10px;color:var(--text3);}

/* â”€â”€ FILTER BAR â”€â”€ */
.filter-bar{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  padding:12px 14px;margin-bottom:12px;
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  box-shadow:var(--shadow);
}
.filter-label{font-family:var(--fh);font-size:11px;color:var(--text3);font-weight:600;}
.filter-tabs{display:flex;gap:4px;flex-wrap:wrap;}
.filter-tab{
  border:1px solid var(--border);border-radius:4px;padding:4px 10px;
  font-family:var(--fh);font-size:11px;font-weight:600;color:var(--text3);
  cursor:pointer;background:var(--bg3);white-space:nowrap;
}
.filter-tab.active{background:var(--orange);color:#fff;border-color:var(--orange);}
.filter-sep{width:1px;height:20px;background:var(--border);}
.filter-count{font-family:var(--fn);font-size:11px;color:var(--text3);margin-left:auto;}

/* â”€â”€ STOCK TABLE â”€â”€ */
.stock-table-wrap{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);overflow:hidden;margin-bottom:14px;
  box-shadow:var(--shadow);
}
.stock-table{width:100%;border-collapse:collapse;}
.stock-table th{
  background:var(--bg3);padding:8px 10px;
  font-family:var(--fh);font-size:10px;font-weight:700;color:var(--text3);
  text-align:right;border-bottom:2px solid var(--border);
  white-space:nowrap;cursor:pointer;user-select:none;
}
.stock-table th:first-child{text-align:left;}
.stock-table th:hover{color:var(--orange);}
.stock-table th.sort-asc::after{content:' â–²';}
.stock-table th.sort-desc::after{content:' â–¼';}
.stock-table td{
  padding:9px 10px;border-bottom:1px solid var(--border);
  font-size:12px;text-align:right;color:var(--text);
  vertical-align:middle;
}
.stock-table td:first-child{text-align:left;}
.stock-table tr:last-child td{border-bottom:none;}
.stock-table tr.tbl-row{cursor:pointer;transition:background 0.1s;}
.stock-table tr.tbl-row:hover{background:var(--bg3);}
.stock-table tr.tbl-row.expanded{background:rgba(255,107,0,0.05);}
.tbl-rank{
  font-family:var(--fn);font-size:11px;font-weight:700;
  width:28px;text-align:center;
}
.tbl-rank.top{color:var(--orange);}
.tbl-name{font-weight:600;color:var(--text2);font-size:12px;}
.tbl-name-link{font-weight:600;color:var(--text2);font-size:12px;text-decoration:none;display:block;}
.tbl-name-link:hover{color:var(--orange);text-decoration:underline;}
.tbl-code{font-family:var(--fn);font-size:10px;color:var(--text3);}
.tbl-zone{
  display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;
  font-family:var(--fh);font-size:10px;font-weight:700;white-space:nowrap;
}
.tbl-zone.buy{background:var(--green-lt);color:var(--green);}
.tbl-zone.watch{background:var(--amber-lt);color:var(--amber);}
.tbl-zone.hold{background:var(--bg3);color:var(--text3);}
.tbl-score{font-family:var(--fn);font-size:13px;font-weight:700;}
.tbl-score.hi{color:var(--up);}
.tbl-score.md{color:var(--amber);}
.tbl-score.lo{color:var(--text3);}
.tbl-num{font-family:var(--fn);font-size:12px;}
.tbl-num.dn{color:var(--up);}   /* ä¹–é›¢ãƒã‚¤ãƒŠã‚¹=èµ¤=è²·ã„å ´ */
.tbl-num.up{color:var(--dn);}
.tbl-prev{font-family:var(--fn);font-size:10px;}
.tbl-prev.up{color:var(--up);}
.tbl-prev.dn{color:var(--dn);}
/* å±•é–‹è©³ç´°è¡Œ */
.detail-row td{padding:0;background:rgba(255,107,0,0.03);}
.detail-box{padding:14px 16px;border-top:1px solid var(--border);}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:600px){.detail-grid{grid-template-columns:1fr;}}
.detail-section-title{font-family:var(--fh);font-size:10px;font-weight:700;color:var(--text3);letter-spacing:0.5px;margin-bottom:8px;}
.why-items{display:flex;flex-direction:column;gap:6px;}
.why-item{
  background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--r2);
  padding:8px 12px;position:relative;
}
.why-item.strong{border-color:rgba(255,71,87,0.4);background:rgba(255,71,87,0.08);}
.why-item.mid{border-color:rgba(240,165,0,0.4);background:rgba(240,165,0,0.08);}
.why-rank-badge{
  position:absolute;top:8px;right:8px;
  width:16px;height:16px;border-radius:50%;
  font-family:var(--fh);font-size:8px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
}
.why-rank-badge.strong{background:rgba(208,2,27,0.1);color:var(--up);}
.why-rank-badge.mid{background:rgba(148,101,0,0.1);color:var(--amber);}
.why-val{font-family:var(--fn);font-size:18px;color:var(--text2);}
.why-item.strong .why-val{color:var(--up);}
.why-item.mid .why-val{color:var(--amber);}
.why-label{font-size:9px;color:var(--text3);}
.why-note-text{font-size:11px;font-weight:700;margin-top:2px;}
.why-item.strong .why-note-text{color:var(--up);}
.why-item.mid .why-note-text{color:var(--amber);}
.why-desc{font-size:10px;color:var(--text3);line-height:1.6;margin-top:2px;}
.score-breakdown{display:flex;flex-direction:column;gap:5px;}
.bd-row{display:flex;align-items:center;gap:8px;}
.bd-l{font-size:10px;color:var(--text3);min-width:70px;}
.bd-bar{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.bd-fill{height:100%;border-radius:3px;transition:width 0.4s ease;}
.bd-v{font-family:var(--fn);font-size:10px;min-width:38px;text-align:right;}
.bd-v.pos{color:var(--green);}  .bd-v.neg{color:var(--up);}
.detail-fav-btn{
  padding:7px 16px;border-radius:var(--r2);
  font-family:var(--fh);font-size:11px;font-weight:700;cursor:pointer;
  border:1.5px solid var(--border);background:var(--bg2);color:var(--text2);
}
.detail-fav-btn.active{background:var(--orange);color:#fff;border-color:var(--orange);}
.detail-link-btn{
  padding:7px 14px;border-radius:var(--r2);
  font-family:var(--fh);font-size:11px;font-weight:700;
  border:1.5px solid var(--border);background:var(--bg3);color:var(--text2);
  text-decoration:none;display:inline-flex;align-items:center;
}
.detail-link-btn:hover{background:var(--orange);color:#fff;border-color:var(--orange);}

/* â”€â”€ TREND BADGES â”€â”€ */
.trend-badge{
  display:inline-flex;align-items:center;
  padding:1px 6px;border-radius:3px;
  font-size:9px;font-weight:700;font-family:var(--fh);
  white-space:nowrap;cursor:default;
}
.trend-badge.hot{background:rgba(208,2,27,0.1);color:var(--up);border:1px solid rgba(208,2,27,0.2);}
.trend-badge.warm{background:rgba(148,101,0,0.08);color:var(--amber);border:1px solid rgba(148,101,0,0.15);}

/* â”€â”€ 3 TABS (ã‚»ã‚¯ã‚¿ãƒ¼/ä¸Šæ˜‡/å‰²å®‰) â”€â”€ */
.t5-tabs{display:flex;gap:0;margin-bottom:14px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.t5-tab{
  flex:1;padding:10px 4px;text-align:center;cursor:pointer;
  font-family:var(--fh);font-size:12px;font-weight:700;color:var(--text3);
  border-right:1px solid var(--border);transition:all 0.15s;
}
.t5-tab:last-child{border-right:none;}
.t5-tab.active{color:#fff;background:var(--orange);}
.t5-tab:hover:not(.active){background:var(--bg3);}

/* â”€â”€ TOP10 CARDS â”€â”€ */
.top10-cards{display:flex;flex-direction:column;gap:8px;}
.top10-card{
  display:flex;align-items:center;gap:12px;
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  padding:12px 14px;cursor:pointer;transition:background 0.15s;
}
.top10-card:hover{background:var(--bg3);}
.top10-rank{font-family:var(--fn);font-size:16px;font-weight:800;color:var(--orange);min-width:22px;text-align:center;}
.top10-info{flex:1;min-width:0;}
.top10-name{font-size:13px;font-weight:700;color:var(--text1);}
.top10-meta{font-size:10px;color:var(--text3);margin-top:2px;}
.top10-right{text-align:right;min-width:55px;}
.top10-score{font-family:var(--fn);font-size:15px;font-weight:800;}
.top10-score.hi{color:var(--dn);} .top10-score.mid{color:var(--amber);}
.top10-badge{display:inline-block;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-top:2px;}
.top10-badge.div{background:rgba(78,170,135,0.12);color:var(--dn);}
.top10-badge.mom{background:rgba(74,158,255,0.12);color:var(--dn);}

/* â”€â”€ SECTOR GRID â”€â”€ */
.sec-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;}
@media(max-width:640px){.sec-grid{grid-template-columns:1fr 1fr;}}
.sec-tile{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.15s;
}
.sec-tile:hover{border-color:var(--orange);background:var(--bg3);}
.sec-tile-ico{font-size:22px;margin-bottom:4px;}
.sec-tile-name{font-family:var(--fh);font-size:11px;font-weight:700;color:var(--text2);}
.sec-tile-sub{font-family:var(--fn);font-size:10px;color:var(--text3);margin-top:2px;}
.sec-back-btn{
  display:inline-flex;align-items:center;gap:4px;padding:6px 12px;margin-bottom:10px;
  background:var(--bg3);border:1px solid var(--border);border-radius:var(--r2);
  font-size:11px;font-weight:700;color:var(--text3);cursor:pointer;
}
.sec-back-btn:hover{background:var(--border);}

/* â”€â”€ TREND WARNING â”€â”€ */
.trend-warning{
  background:rgba(208,2,27,0.06);border:1px solid rgba(208,2,27,0.2);
  border-radius:var(--r2);padding:8px 14px;margin-bottom:12px;
  font-size:11px;font-weight:700;color:var(--up);
}

/* â”€â”€ PORTFOLIO DIARY â”€â”€ */
.pf-hero{display:flex;align-items:baseline;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);margin-bottom:12px;}
.pf-nav{font-family:var(--fn);font-size:24px;font-weight:800;color:var(--text1);}
.pf-pnl{font-family:var(--fn);font-size:14px;font-weight:700;}
.pf-pnl.up{color:var(--dn);} .pf-pnl.dn{color:var(--up);}
.pf-day{font-size:11px;color:var(--text3);}
.pf-bars{display:flex;gap:4px;margin-bottom:10px;}
.pf-bar{flex:1;text-align:center;font-size:10px;padding:4px 0;border-radius:4px;}
.pf-bar.cash{background:rgba(74,158,255,0.12);color:var(--dn);}
.pf-bar.stock{background:rgba(78,170,135,0.08);color:var(--dn);}
.pf-holdings{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;}
.pf-hold{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);}
.pf-hold-name{flex:1;font-size:12px;font-weight:600;color:var(--text2);}
.pf-hold-pnl{font-family:var(--fn);font-size:13px;font-weight:700;min-width:50px;text-align:right;}
.pf-hold-pnl.up{color:var(--dn);} .pf-hold-pnl.dn{color:var(--up);}
.pf-note-link{display:block;text-align:center;padding:12px;background:var(--orange);color:#fff;border-radius:var(--r);font-size:13px;font-weight:700;text-decoration:none;margin-top:10px;transition:opacity 0.15s;}
.pf-note-link:hover{opacity:0.85;}

/* â”€â”€ WATCHLIST / HISTORY â”€â”€ */
.watch-empty{padding:20px;text-align:center;font-size:12px;color:var(--text3);}
.watch-list{display:flex;flex-direction:column;gap:6px;}
.watch-row{
  display:flex;align-items:center;gap:10px;padding:10px 14px;
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;
}
.watch-row:hover{background:var(--bg3);}
.watch-code{font-family:var(--fn);font-size:11px;color:var(--text3);min-width:36px;}
.watch-name{flex:1;font-size:12px;font-weight:600;color:var(--text2);}
.watch-score{font-family:var(--fn);font-size:13px;font-weight:700;}
.watch-score.hi{color:var(--up);} .watch-score.md{color:var(--amber);} .watch-score.lo{color:var(--text3);}
.watch-remove{background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px;padding:4px;}
.hist-table{width:100%;border-collapse:collapse;font-size:11px;}
.hist-table th{background:var(--bg3);padding:6px 10px;text-align:left;font-family:var(--fh);font-size:10px;color:var(--text3);border-bottom:1px solid var(--border);}
.hist-table td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text);}
.hist-table tr:last-child td{border-bottom:none;}

/* â”€â”€ SETTINGS PANEL â”€â”€ */
.settings-overlay{
  position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.4);
  display:none;align-items:flex-end;justify-content:center;
}
.settings-overlay.open{display:flex;}
.settings-box{
  background:var(--bg2);border-radius:16px 16px 0 0;
  padding:20px;width:100%;max-width:600px;max-height:85vh;overflow-y:auto;
}
.settings-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.settings-title{font-family:var(--fh);font-size:15px;font-weight:800;color:var(--text2);margin-bottom:16px;}
.setting-row{margin-bottom:14px;}
.setting-label{font-family:var(--fh);font-size:11px;font-weight:700;color:var(--text3);margin-bottom:6px;letter-spacing:0.5px;}
.setting-opts{display:flex;gap:6px;flex-wrap:wrap;}
.setting-opt{
  border:1.5px solid var(--border);border-radius:var(--r2);padding:6px 12px;
  font-family:var(--fh);font-size:11px;font-weight:600;color:var(--text);
  cursor:pointer;background:var(--bg3);
}
.setting-opt.active{background:var(--orange);color:#fff;border-color:var(--orange);}
.settings-save{
  width:100%;padding:12px;margin-top:8px;
  background:var(--orange);color:#fff;border:none;border-radius:var(--r);
  font-family:var(--fh);font-size:13px;font-weight:700;cursor:pointer;
}
.settings-save:hover{background:var(--orange2);}

/* â”€â”€ NAV TABS â”€â”€ */
.nav-tabs{
  display:flex;background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--r);margin-bottom:14px;overflow:hidden;
}
.nav-tab{
  flex:1;padding:10px;text-align:center;cursor:pointer;
  font-family:var(--fh);font-size:11px;font-weight:700;color:var(--text3);
  border-right:1px solid var(--border);position:relative;
}
.nav-tab:last-child{border-right:none;}
.nav-tab.active{background:var(--orange);color:#fff;}

/* â”€â”€ BOTTOM NAV (mobile) â”€â”€ */
.bottom-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;z-index:200;
  background:var(--bg2);border-top:1px solid var(--border);
  padding:6px 0 8px;
}
@media(max-width:768px){.bottom-nav{display:flex;}}
.nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;
  background:none;border:none;cursor:pointer;color:var(--text3);padding:4px;
}
.nav-item.active{color:var(--orange);}
.nav-ico{font-size:18px;}
.nav-label{font-size:9px;font-family:var(--fh);font-weight:700;}

/* â”€â”€ PANELS â”€â”€ */
.panel{display:none;}
.panel.active{display:block;}

/* â”€â”€ SKELETON â”€â”€ */
.skeleton{background:var(--border);border-radius:4px;animation:shimmer 1.5s infinite linear;background:linear-gradient(90deg,var(--border) 25%,#2a3352 50%,var(--border) 75%);background-size:200% 100%;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.skel-row{height:40px;margin-bottom:4px;border-radius:4px;}

/* â”€â”€ MISC â”€â”€ */
.fadein{animation:fi 0.3s ease;}
@keyframes fi{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}
.disclaimer{font-size:10px;color:#718096;text-align:center;padding:12px 0;line-height:1.8;}
.sec-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:14px;box-shadow:var(--shadow);}
.empty-msg{text-align:center;padding:20px;font-size:12px;color:var(--text3);}

/* â”€â”€ LOGIC MODAL â”€â”€ */
.logic-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.4);display:none;align-items:flex-end;justify-content:center;}
.logic-overlay.open{display:flex;}
.logic-box{background:var(--bg2);border-radius:16px 16px 0 0;padding:20px;width:100%;max-width:600px;max-height:80vh;overflow-y:auto;}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.logic-title{font-family:var(--fh);font-size:15px;font-weight:800;color:var(--text2);margin-bottom:6px;}
.logic-sub{font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.7;}
.logic-tbl{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:14px;}
.logic-tbl th{background:var(--bg3);padding:7px 10px;text-align:left;font-family:var(--fh);font-size:10px;color:var(--text3);border-bottom:1px solid var(--border);}
.logic-tbl td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text);}
.logic-tbl .pts{text-align:right;font-family:var(--fn);font-weight:700;}
.logic-note{background:var(--bg3);border-radius:var(--r2);padding:12px;font-size:11px;color:var(--text);line-height:1.9;margin-bottom:14px;}
.btn-logic-close{width:100%;padding:10px;background:var(--orange);color:#fff;border:none;border-radius:var(--r);font-family:var(--fh);font-size:13px;font-weight:700;cursor:pointer;}

/* â”€â”€ BRAIN SCANNER â”€â”€ */
.brain-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
@media(max-width:640px){.brain-grid{grid-template-columns:1fr;}}
.brain-col-title{font-family:var(--fn);font-size:10px;font-weight:700;letter-spacing:1px;padding:4px 0 6px;border-bottom:1px solid var(--border);margin-bottom:6px;}
.brain-col-title.macro{color:var(--dn);}
.brain-col-title.inst{color:var(--amber);}
.brain-col-title.retail{color:var(--green);}
.brain-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:11px;border-bottom:1px solid rgba(42,51,82,0.5);}
.brain-item:last-child{border-bottom:none;}
.brain-topic{color:var(--text);max-width:70%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.brain-score{font-family:var(--fn);font-size:11px;font-weight:700;min-width:36px;text-align:right;}
.brain-score.pos{color:var(--green);}.brain-score.neg{color:var(--up);}.brain-score.neu{color:var(--text3);}
.brain-overall{display:flex;align-items:center;gap:10px;padding:8px 10px;margin-bottom:8px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:var(--r2);}
.brain-overall-label{font-size:10px;color:var(--text3);}
.brain-overall-val{font-family:var(--fn);font-size:18px;font-weight:700;}
.brain-overall-val.pos{color:var(--green);}.brain-overall-val.neg{color:var(--up);}.brain-overall-val.neu{color:var(--amber);}
.brain-overall-bar{flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
.brain-overall-fill{height:100%;border-radius:2px;transition:width 0.5s;}
.brain-summary{margin-top:8px;padding:8px 10px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:var(--r2);font-size:11px;color:var(--text);line-height:1.6;}

@media(max-width:600px){
  .stock-table th:nth-child(n+7),.stock-table td:nth-child(n+7){display:none;}
}
@media(max-width:480px){
  .stock-table th:nth-child(n+6),.stock-table td:nth-child(n+6){display:none;}
}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-inner">
    <div>
      <span class="logo-name">ã‹ã¶ã®ã™ã‘</span>
      <span class="logo-tag">é«˜é…å½“ãƒ»å‰²å®‰æ ªã®è²·ã„å ´ã‚’æ¯æ—¥ã‚¹ã‚­ãƒ£ãƒ³</span>
    </div>
    <div class="topbar-right">
      <button class="btn-topbar" onclick="switchTab('watch')">
        â­ ã‚¦ã‚©ãƒƒãƒ <span class="watch-count" id="watchCount">0</span>
      </button>
      <button class="btn-topbar" onclick="openSettings()">âš™ è¨­å®š</button>
    </div>
  </div>
</div>

<div class="page">

  <!-- â•â• HOME PANEL â•â• -->
  <div class="panel active" id="panel-home">

    <!-- â‘  MARKET PULSE -->
    <div class="pulse" style="box-shadow:var(--shadow)"><div class="pulse-row" id="pulseBar"></div></div>

    <!-- â‘¡ STANCE -->
    <div id="stanceBox"></div>

    <!-- â‘¢ BRAIN SCANNER -->
    <div class="sec-wrap" id="brainSection" style="display:none">
      <div class="sec-head">
        <div class="sec-head-title">ğŸ“¡ BRAIN SCANNER</div>
        <div class="sec-head-sub">YouTube 7ch AIè§£æ</div>
      </div>
      <div id="brainBody"><div style="padding:12px;text-align:center;font-size:11px;color:var(--text3)">èª­ã¿è¾¼ã¿ä¸­...</div></div>
    </div>

    <!-- â‘£ 3 TABS -->
    <div class="t5-tabs" style="box-shadow:var(--shadow)">
      <div class="t5-tab active" id="t5TabSec" onclick="setTop5Tab('sector')">ğŸ“Š ã‚»ã‚¯ã‚¿ãƒ¼</div>
      <div class="t5-tab" id="t5TabMom" onclick="setTop5Tab('mom')">ğŸ“ˆ ä¸Šæ˜‡</div>
      <div class="t5-tab" id="t5TabDip" onclick="setTop5Tab('dip')">ğŸ“‰ å‰²å®‰</div>
    </div>

    <!-- TAB CONTENT -->
    <div id="top5Body">
      <div style="padding:20px;text-align:center">
        <div class="skel-row skeleton"></div>
        <div class="skel-row skeleton"></div>
        <div style="font-size:11px;color:var(--text3);margin-top:8px">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <!-- â‘¤ æŠ•è³‡æ—¥è¨˜ï¼ˆå·®åˆ¥åŒ–ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
    <div class="sec-wrap" id="portfolioSection" style="border-left:4px solid var(--orange);background:linear-gradient(135deg,#151b26,#1a1f2e);">
      <div class="sec-head">
        <div class="sec-head-title">ğŸ» ã‹ã¶ã®ã™ã‘ã®æŠ•è³‡æ—¥è¨˜</div>
        <div class="sec-head-sub">AI Ã— 1000ä¸‡å†† ï¼ 2026.2.24ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
      </div>
      <div id="portfolioBody">
        <div style="padding:16px;text-align:center;font-size:11px;color:var(--text3)">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <!-- â‘¥ HERO STATS (å°ã•ãä¸‹ã«) -->
    <div class="hero">
      <div class="hero-eyebrow" id="heroEyebrow">
        <span class="hero-dot"></span>æŠ¼ã—ç›® Ã— é«˜é…å½“ â€” æ¯æœ8:30è‡ªå‹•æ›´æ–°
      </div>
      <div class="hero-stats" id="heroStats">
        <div class="hero-stat"><div class="hero-stat-val buy" id="hsBuy">â€”</div><div class="hero-stat-label">è²·ã„åœ</div></div>
        <div class="hero-stat"><div class="hero-stat-val" id="hsTop">â€”</div><div class="hero-stat-label">1ä½ã‚¹ã‚³ã‚¢</div></div>
        <div class="hero-stat"><div class="hero-stat-val" id="hsDiv">â€”</div><div class="hero-stat-label">æœ€é«˜é…å½“</div></div>
        <div class="hero-stat"><div class="hero-stat-val" id="hsTotal">â€”</div><div class="hero-stat-label">ã‚¹ã‚­ãƒ£ãƒ³æ•°</div></div>
      </div>
    </div>

    <!-- â‘¦ TRUST BAR (å°ã•ãä¸‹ã«) -->
    <div class="trust-bar" id="trustBanner">
      <div class="trust-left">
        <div class="trust-dot" id="trustDot"></div>
        <div class="trust-text" id="trustText">ãƒ‡ãƒ¼ã‚¿ç¢ºèªä¸­...</div>
      </div>
      <div class="trust-badges">
        <span class="tbadge" id="totalCountBadge">æ±è¨¼ãƒ—ãƒ©ã‚¤ãƒ </span>
        <span class="tbadge link" onclick="openLogicModal()">ã‚¹ã‚³ã‚¢è¨ˆç®—å¼ â–¶</span>
      </div>
    </div>

    <!-- DISCLAIMER -->
    <div class="disclaimer">âš ï¸ æœ¬ãƒ„ãƒ¼ãƒ«ã¯å‚è€ƒæƒ…å ±ã®æä¾›ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã§ã€‚å…ƒæœ¬å‰²ã‚Œãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚</div>

  </div><!-- /panel-home -->

  <!-- â•â• WATCH PANEL â•â• -->
  <div class="panel" id="panel-watch">
    <div class="sec-wrap">
      <div class="sec-head">
        <div class="sec-head-title">â­ ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆ</div>
      </div>
      <div id="watchlistBody"></div>
    </div>
    <div class="sec-wrap">
      <div class="sec-head">
        <div class="sec-head-title">ğŸ• ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´</div>
      </div>
      <div id="historyBody"></div>
    </div>
  </div>

</div><!-- /page -->

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-item active" id="nav-home" onclick="switchTab('home')">
    <span class="nav-ico">ğŸ </span><span class="nav-label">ãƒ›ãƒ¼ãƒ </span>
  </button>
  <button class="nav-item" id="nav-watch" onclick="switchTab('watch')">
    <span class="nav-ico">â­</span><span class="nav-label">ã‚¦ã‚©ãƒƒãƒ</span>
  </button>
</nav>

<!-- SETTINGS PANEL -->
<div class="settings-overlay" id="settingsOverlay" onclick="closeSettingsBg(event)">
  <div class="settings-box">
    <div class="settings-handle"></div>
    <div class="settings-title">âš™ è¡¨ç¤ºè¨­å®š</div>
    <div class="setting-row">
      <div class="setting-label">ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰</div>
      <div class="setting-opts" id="set-mode">
        <div class="setting-opt active" data-val="dividend" onclick="selectSettingOpt(this,'mode')">ğŸ’° å®‰å®šé«˜é…å½“</div>
        <div class="setting-opt" data-val="value" onclick="selectSettingOpt(this,'mode')">ğŸ›¡ å‰²å®‰ãƒãƒªãƒ¥ãƒ¼</div>
        <div class="setting-opt" data-val="rebound" onclick="selectSettingOpt(this,'mode')">âš¡ å¼·æŠ¼ã—ç›®</div>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">è¡¨ç¤ºä»¶æ•°</div>
      <div class="setting-opts" id="set-count">
        <div class="setting-opt" data-val="10" onclick="selectSettingOpt(this,'count')">TOP 10</div>
        <div class="setting-opt active" data-val="30" onclick="selectSettingOpt(this,'count')">TOP 30</div>
        <div class="setting-opt" data-val="999" onclick="selectSettingOpt(this,'count')">å…¨ä»¶è¡¨ç¤º</div>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">æœ€ä½é…å½“åˆ©å›ã‚Š</div>
      <div class="setting-opts" id="set-mindiv">
        <div class="setting-opt active" data-val="0" onclick="selectSettingOpt(this,'mindiv')">åˆ¶é™ãªã—</div>
        <div class="setting-opt" data-val="2" onclick="selectSettingOpt(this,'mindiv')">2%ä»¥ä¸Š</div>
        <div class="setting-opt" data-val="3" onclick="selectSettingOpt(this,'mindiv')">3%ä»¥ä¸Š</div>
        <div class="setting-opt" data-val="4" onclick="selectSettingOpt(this,'mindiv')">4%ä»¥ä¸Š</div>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">ã‚¾ãƒ¼ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
      <div class="setting-opts" id="set-zone">
        <div class="setting-opt active" data-val="all" onclick="selectSettingOpt(this,'zone')">å…¨ã¦</div>
        <div class="setting-opt" data-val="buy" onclick="selectSettingOpt(this,'zone')">è²·ã„åœã®ã¿</div>
        <div class="setting-opt" data-val="buywatch" onclick="selectSettingOpt(this,'zone')">è²·ã„åœï¼‹æ³¨æ„åœ</div>
      </div>
    </div>
    <button class="settings-save" onclick="saveSettings()">âœ“ ä¿å­˜ã—ã¦é©ç”¨</button>
  </div>
</div>

<!-- LOGIC MODAL -->
<div class="logic-overlay" id="logicModal" onclick="closeLogicModal(event)">
  <div class="logic-box">
    <div class="modal-handle"></div>
    <div class="logic-title">ã‚¹ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰</div>
    <div class="logic-sub">5æŒ‡æ¨™ã‚’åˆè¨ˆã—ãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒœãƒ¼ãƒŠã‚¹ã‚’é©ç”¨ã€‚é«˜é…å½“ãƒ¢ãƒ¼ãƒ‰ã§ã¯é…å½“0.5%æœªæº€ã®éŠ˜æŸ„ã¯å®Ÿè³ªé™¤å¤–ã€‚</div>
    <table class="logic-tbl">
      <tr><th>æŒ‡æ¨™</th><th>æ¡ä»¶</th><th style="text-align:right">æœ€å¤§ç‚¹</th></tr>
      <tr><td>é…å½“åˆ©å›ã‚Š</td><td>2.5%ã€œ5%ä»¥ä¸Š</td><td class="pts">30pt</td></tr>
      <tr><td>25MAä¹–é›¢</td><td>-2%ã€œ-8%ä»¥ä¸‹</td><td class="pts">28pt</td></tr>
      <tr><td>RSI</td><td>42ä»¥ä¸‹ã€œ28ä»¥ä¸‹</td><td class="pts">22pt</td></tr>
      <tr><td>PBR</td><td>1.5å€ä»¥ä¸‹ã€œ0.7å€ä»¥ä¸‹</td><td class="pts">18pt</td></tr>
      <tr><td>PER</td><td>15å€ä»¥ä¸‹ã€œ9å€ä»¥ä¸‹</td><td class="pts">12pt</td></tr>
      <tr><td>âš ãƒšãƒŠãƒ«ãƒ†ã‚£</td><td>å‡ºæ¥é«˜1.5å€è¶… / é…å½“ãªã—æŠ•æ©Ÿæ ª</td><td class="pts" style="color:var(--up)">-20ã€œ-30pt</td></tr>
    </table>
    <div class="logic-note">
      ğŸ’° é«˜é…å½“ãƒ¢ãƒ¼ãƒ‰ â†’ é…å½“ç‚¹Ã—1.4å€<br>
      ğŸ›¡ ãƒãƒªãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ â†’ PBRãƒ»PERç‚¹Ã—1.6å€<br>
      âš¡ æŠ¼ã—ç›®ãƒ¢ãƒ¼ãƒ‰ â†’ MAä¹–é›¢ãƒ»RSIç‚¹Ã—1.5å€
    </div>
    <button class="btn-logic-close" onclick="closeLogicModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SAMPLE_STOCKS=[
  {code:'8306',name:'ä¸‰è±UFJãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«',sector:'éŠ€è¡Œ',price:1423,ma25:1520,ma75:1580,rsi:32,dividend:3.8,pbr:0.7,per:9.2,vol_r:0.8},
  {code:'9432',name:'NTT',sector:'é€šä¿¡',price:163,ma25:168,ma75:172,rsi:38,dividend:3.2,pbr:1.1,per:11.5,vol_r:0.9},
  {code:'8058',name:'ä¸‰è±å•†äº‹',sector:'å•†ç¤¾',price:2890,ma25:3050,ma75:3200,rsi:29,dividend:4.1,pbr:0.9,per:8.7,vol_r:0.7},
  {code:'4502',name:'æ­¦ç”°è–¬å“å·¥æ¥­',sector:'åŒ»è–¬å“',price:3820,ma25:3960,ma75:4050,rsi:41,dividend:5.6,pbr:1.3,per:15.2,vol_r:1.1},
  {code:'8001',name:'ä¼Šè—¤å¿ å•†äº‹',sector:'å•†ç¤¾',price:6780,ma25:7050,ma75:7200,rsi:33,dividend:3.5,pbr:1.8,per:12.3,vol_r:0.6},
  {code:'7203',name:'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š',sector:'è‡ªå‹•è»Š',price:2650,ma25:2720,ma75:2800,rsi:36,dividend:3.0,pbr:1.1,per:10.4,vol_r:0.9},
  {code:'8316',name:'ä¸‰äº•ä½å‹FG',sector:'éŠ€è¡Œ',price:7100,ma25:7600,ma75:7800,rsi:28,dividend:4.2,pbr:0.8,per:9.0,vol_r:0.7},
  {code:'2914',name:'JTï¼ˆæ—¥æœ¬ãŸã°ã“ç”£æ¥­ï¼‰',sector:'é£Ÿå“',price:3680,ma25:3780,ma75:3820,rsi:35,dividend:6.2,pbr:1.6,per:13.8,vol_r:0.8},
  {code:'8411',name:'ã¿ãšã»FG',sector:'éŠ€è¡Œ',price:2680,ma25:2850,ma75:2950,rsi:31,dividend:3.9,pbr:0.7,per:8.5,vol_r:0.8},
  {code:'9433',name:'KDDI',sector:'é€šä¿¡',price:4350,ma25:4500,ma75:4600,rsi:37,dividend:3.3,pbr:1.9,per:13.5,vol_r:1.0},
  {code:'9503',name:'é–¢è¥¿é›»åŠ›',sector:'é›»åŠ›',price:2140,ma25:2250,ma75:2300,rsi:33,dividend:3.5,pbr:0.9,per:10.1,vol_r:0.7},
  {code:'5108',name:'ãƒ–ãƒªãƒ‚ã‚¹ãƒˆãƒ³',sector:'ã‚´ãƒ ',price:5100,ma25:5280,ma75:5350,rsi:40,dividend:3.8,pbr:1.2,per:11.8,vol_r:0.8},
];

let STOCKS=[...SAMPLE_STOCKS];
let processed=[];
let dataSource='sample';
let currentMode='dividend';
let currentTab='sector'; // 'sector','mom','dip'
let activeSector=null;
let sectorScoresData={};
let sortKey='score'; let sortDir='desc';
let expandedCode=null;
let watchlist=[];
let scanHistory=[];
let settings={mode:'dividend',count:10,mindiv:0,zone:'all'};
let trendRankingData=[];
let portfolioData=null;
let marketData={
  nikkei_price:null,nikkei_ma25:null,nikkei_1d_chg:null,
  nasdaq_1d_chg:null,vix:null,usdjpy:null,us10y:null,
  geo_risk:false,rate_cut_flag:false,prev_buy_count:null,
};

// â”€ localStorageã‹ã‚‰å¾©å…ƒ â”€
try{
  const sw=localStorage.getItem('kbs_watch');
  if(sw)watchlist=JSON.parse(sw);
  const sh=localStorage.getItem('kbs_history');
  if(sh)scanHistory=JSON.parse(sh);
  const ss=localStorage.getItem('kbs_settings');
  if(ss){
    settings=Object.assign(settings,JSON.parse(ss));
    currentMode=settings.mode||'dividend';
    dispCount=settings.count||10;
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–ã‚’å¾©å…ƒ
    document.querySelectorAll('.filter-tab[id^="mode-"]').forEach(t=>t.classList.remove('active'));
    const mt=document.getElementById('mode-'+currentMode);
    if(mt)mt.classList.add('active');
    document.querySelectorAll('.filter-tab[id^="disp-"]').forEach(t=>t.classList.remove('active'));
    const cnt=dispCount>=999?'all':String(dispCount);
    const dt=document.getElementById('disp-'+cnt);
    if(dt)dt.classList.add('active');
  }
}catch(e){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dv(p,m){return m?Math.round((p-m)/m*1000)/10:0;}

function calcScore(s){
  // Pythonå´ã§è¨ˆç®—æ¸ˆã¿ã®scoreã‚’å„ªå…ˆä½¿ç”¨ï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰
  if(dataSource==='real' && s.score!=null) return s.score;
  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  return calcScoreStable(s);
}
function calcScoreStable(s){
  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç®—
  const d25=dv(s.price,s.ma25);
  const div=s.dividend||0;
  let score=0;
  score+=div>=5?40:div>=4.5?32:div>=4?25:div>=3.5?18:div>=3?10:0;
  const pbr=s.pbr||99;
  score+=pbr<=0.7?20:pbr<=0.9?15:pbr<=1.1?8:pbr<=1.5?3:0;
  score+=d25<=-8?20:d25<=-5?14:d25<=-3?8:d25<=-1?3:0;
  const rsi=s.rsi||50;
  score+=rsi<=30?15:rsi<=38?10:rsi<=45?5:0;
  const per=s.per||99;
  score+=per<=10?10:per<=13?6:per<=16?3:0;
  if((s.vol_r||1)>=1.5) score-=20;
  if(div<0.5) score=Math.min(score,5);
  const mc=s.market_cap_b||9999;
  if(mc>0&&mc<300) score-=20;
  else if(mc>0&&mc<500) score-=10;
  return Math.max(0,Math.min(score,100));
}
function calcScoreGrowth(s){
  const d25=dv(s.price,s.ma25);
  let score=0;
  score+=d25<=-15?35:d25<=-10?28:d25<=-6?20:d25<=-3?10:d25<=-1?3:0;
  const rsi=s.rsi||50;
  score+=rsi<=20?30:rsi<=28?22:rsi<=35?14:rsi<=42?7:0;
  const pbr=s.pbr||99;
  score+=pbr<=0.8?15:pbr<=1.2?10:pbr<=2.0?5:0;
  const div=s.dividend||0;
  score+=div>=4?10:div>=2?6:div>=1?2:0;
  const per=s.per||99;
  score+=per<=10?10:per<=15?5:0;
  if((s.vol_r||1)>=2.0) score-=15;
  return Math.max(0,Math.min(score,100));
}

function dv(p,m){return m?Math.round((p-m)/m*1000)/10:0;}


function getZone(sc){
  return sc>=60?{label:'è²·ã„åœ',cls:'buy'}:sc>=35?{label:'æ³¨æ„åœ',cls:'watch'}:{label:'å¾…æ©Ÿåœ',cls:'hold'};
}

function buildReasons(s,d25){
  const r=[];
  if(d25<=-6)r.push({val:`${d25}%`,label:'25MAä¹–é›¢',note:'å¼·ã„æŠ¼ã—ç›®æ°´æº–',desc:'-6%ä»¥ä¸‹ã¯éå»ã®åç™ºå®Ÿç¸¾ãŒé«˜ã„æ°´æº–',cls:'strong',rank:'A'});
  else if(d25<=-3)r.push({val:`${d25}%`,label:'25MAä¹–é›¢',note:'æŠ¼ã—ç›®æ°´æº–',desc:'-3%ä»¥ä¸Šã®ä¸‹è½ã§åç™ºå€™è£œã«',cls:'mid',rank:'B'});
  if(s.rsi<=30)r.push({val:String(s.rsi),label:'RSI',note:'å¼·ã„å£²ã‚‰ã‚Œã™ã',desc:'30ä»¥ä¸‹ã¯è‡ªå¾‹åç™ºãŒæœŸå¾…ã§ãã‚‹æ°´æº–',cls:'strong',rank:'A'});
  else if(s.rsi<=38)r.push({val:String(s.rsi),label:'RSI',note:'å£²ã‚‰ã‚Œã™ãåœå†…',desc:'38ä»¥ä¸‹ã§å£²ã‚Šéå‰°ãŒå’Œã‚‰ãã‚¿ã‚¤ãƒŸãƒ³ã‚°',cls:'mid',rank:'B'});
  if(s.dividend>=4.5)r.push({val:`${s.dividend}%`,label:'é…å½“åˆ©å›ã‚Š',note:'é«˜é…å½“ãƒ»ä¸‹å€¤ã‚µãƒãƒ¼ãƒˆ',desc:'4.5%è¶…ã¯é…å½“ãŒæ ªä¾¡ã®ä¸‹å€¤ã‚’æ”¯ãˆã‚‹',cls:'strong',rank:'A'});
  else if(s.dividend>=3)r.push({val:`${s.dividend}%`,label:'é…å½“åˆ©å›ã‚Š',note:'ã‚¤ãƒ³ã‚«ãƒ æœŸå¾…',desc:'3%ä»¥ä¸Šã§é•·æœŸä¿æœ‰ã®ãƒªã‚¹ã‚¯ä½æ¸›ã«åŠ¹ã',cls:'mid',rank:'B'});
  if(s.pbr<=0.8)r.push({val:`${s.pbr}å€`,label:'PBR',note:'è§£æ•£ä¾¡å€¤ä»¥ä¸‹',desc:'1å€å‰²ã‚Œã¯ç†è«–ä¸Šã®ä¸‹å€¤ãŒå›ºã„æ°´æº–',cls:'strong',rank:'A'});
  else if(s.pbr<=1.1)r.push({val:`${s.pbr}å€`,label:'PBR',note:'å‰²å®‰åœ',desc:'1å€ä»˜è¿‘ã¯æ©Ÿé–¢æŠ•è³‡å®¶ãŒæ³¨ç›®ã™ã‚‹æ°´æº–',cls:'mid',rank:'B'});
  if(s.per<=10)r.push({val:`${s.per}å€`,label:'PER',note:'å‰²å®‰æ°´æº–',desc:'10å€ä»¥ä¸‹ã¯æ—¥æœ¬æ ªå¹³å‡ã‚’å¤§ããä¸‹å›ã‚‹',cls:'mid',rank:'B'});
  return r;
}

function calcBreakdown(s,mode){
  const d25=dv(s.price,s.ma25);
  const bd=[];
  let dp=s.dividend>=5?30:s.dividend>=4.5?25:s.dividend>=4?20:s.dividend>=3.5?15:s.dividend>=3?10:s.dividend>=2.5?5:0;
  if(mode==='dividend')dp=Math.min(Math.round(dp*1.4),40);
  if(dp>0)bd.push({l:'é…å½“åˆ©å›ã‚Š',v:dp,max:40,pos:true});
  let mp=d25<=-8?28:d25<=-6?22:d25<=-4?12:d25<=-2?5:0;
  if(mode==='rebound')mp=Math.min(Math.round(mp*1.5),35);
  if(mp>0)bd.push({l:'25MAä¹–é›¢',v:mp,max:35,pos:true});
  let rp=s.rsi<=28?22:s.rsi<=32?16:s.rsi<=38?10:s.rsi<=42?5:0;
  if(mode==='rebound')rp=Math.min(Math.round(rp*1.3),25);
  if(rp>0)bd.push({l:'RSI',v:rp,max:25,pos:true});
  let pp=s.pbr<=0.7?18:s.pbr<=0.9?13:s.pbr<=1.1?7:s.pbr<=1.5?3:0;
  if(mode==='value')pp=Math.min(Math.round(pp*1.6),25);
  if(pp>0)bd.push({l:'PBR',v:pp,max:25,pos:true});
  let ep=s.per<=9?12:s.per<=11?8:s.per<=13?5:s.per<=15?2:0;
  if(mode==='value')ep=Math.min(Math.round(ep*1.4),15);
  if(ep>0)bd.push({l:'PER',v:ep,max:15,pos:true});
  if(s.vol_r>=1.5)bd.push({l:'å‡ºæ¥é«˜æ€¥å¢—',v:-20,max:20,pos:false});
  return bd;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processStocks(){
  const minDiv=settings.mindiv||0;
  const zoneFilter=settings.zone||'all';

  let list=STOCKS.filter(s=>{
    if(minDiv>0&&(s.dividend||0)<minDiv) return false;
    return true;
  });

  processed=list.map(s=>{
    const d25=dv(s.price,s.ma25);
    const score = calcScore(s);
    const zone=getZone(score);
    const ma75d = s.ma75 ? dv(s.price, s.ma75) : 0;
    const mc = s.market_cap_b||0;
    const div = s.dividend||0;
    let _type='neutral';
    if(ma75d < -8) _type='falling';
    else if(ma75d < -2 && mc >= 3000 && div >= 2.5) _type='value_dip';
    else if(-5 <= ma75d && ma75d <= 3 && d25 < -1) _type='dip';
    else if(ma75d > 0 && d25 > 0 && mc >= 1000) _type='momentum';
    else if(ma75d >= -2 && d25 > 0) _type='bounce';
    return{...s,d25,score,zone,_type,ma75d};
  });

  if(zoneFilter==='buy')processed=processed.filter(s=>s.zone.cls==='buy');
  else if(zoneFilter==='buywatch')processed=processed.filter(s=>s.zone.cls!=='hold');

  // ã‚½ãƒ¼ãƒˆ
  processed.sort((a,b)=>{
    let av=a[sortKey]??0, bv=b[sortKey]??0;
    if(sortKey==='d25'){av=a.d25;bv=b.d25;}
    return sortDir==='asc'?av-bv:bv-av;
  });

  // å±¥æ­´è¨˜éŒ²ï¼ˆéåŒæœŸã§å¾Œå›ã—ï¼‰
  requestAnimationFrame(()=>{
    const now=new Date();
    const e={
      date:`${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
      mode:currentMode,count:processed.length,
      top:processed[0]?.name||'â€”',topScore:processed[0]?.score||0
    };
    scanHistory.unshift(e);
    scanHistory=scanHistory.slice(0,14);
    try{localStorage.setItem('kbs_history',JSON.stringify(scanHistory));}catch(e){}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: HERO STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHeroStats(){
  const buyN=processed.filter(s=>s.zone.cls==='buy').length;
  const topScore=processed.length?processed[0].score:'â€”';
  const maxDiv=processed.length?Math.max(...processed.map(s=>s.dividend)).toFixed(1)+'%':'â€”';
  document.getElementById('hsBuy').textContent=buyN+'ä»¶';
  document.getElementById('hsTop').textContent=topScore+'ç‚¹';
  document.getElementById('hsDiv').textContent=maxDiv;
  document.getElementById('hsTotal').textContent=STOCKS.length+'éŠ˜æŸ„';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: MARKET PULSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPulse(){
  const md=marketData;
  const sign=v=>v>0?'+':'';
  const dir=v=>v>0?'up':v<0?'dn':'neutral';
  const chips=[
    {l:'æ—¥çµŒå¹³å‡',v:md.nikkei_price?md.nikkei_price.toLocaleString():'â€”',c:md.nikkei_1d_chg!=null?sign(md.nikkei_1d_chg)+md.nikkei_1d_chg+'%':'â€”',d:dir(md.nikkei_1d_chg)},
    {l:'NASDAQ',v:md.nasdaq_1d_chg!=null?sign(md.nasdaq_1d_chg)+md.nasdaq_1d_chg+'%':'â€”',c:'å‰æ—¥æ¯”',d:dir(md.nasdaq_1d_chg)},
    {l:'ãƒ‰ãƒ«å††',v:md.usdjpy||'â€”',c:'',d:'neutral'},
    {l:'VIX',v:md.vix||'â€”',c:'',d:md.vix>25?'dn':md.vix<18?'up':'neutral'},
    {l:'ç±³10å¹´å‚µ',v:md.us10y?md.us10y+'%':'â€”',c:'',d:'neutral'},
  ];
  document.getElementById('pulseBar').innerHTML=chips.map(c=>`
    <div class="pc">
      <div class="pc-l">${c.l}</div>
      <div class="pc-v ${c.d}">${c.v}</div>
      <div class="pc-c ${c.d}">${c.c}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: STANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcStanceScore(){
  const md=marketData;
  const buyN=processed.filter(s=>s.zone.cls==='buy').length;
  const avgRsi=processed.length?(processed.reduce((a,s)=>a+s.rsi,0)/processed.length):50;
  const avgD25=processed.length?(processed.reduce((a,s)=>a+s.d25,0)/processed.length):0;
  const highDiv=processed.filter(s=>s.dividend>=4).length;
  let axes={tech:1,macro:1,scan:0};

  // è»¸â‘ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«
  let t=1;
  if(md.nikkei_price&&md.nikkei_ma25){
    if(md.nikkei_price>=md.nikkei_ma25)t++;else t--;
  }
  if(md.nikkei_1d_chg!=null){
    if(md.nikkei_1d_chg>-1)t++;else if(md.nikkei_1d_chg<-1.5)t--;
  }
  if(md.vix){if(md.vix<20)t++;else if(md.vix>25)t--;}
  if(md.usdjpy){if(md.usdjpy>=147)t++;else if(md.usdjpy<140)t--;}
  axes.tech=Math.max(0,Math.min(t,3));

  // è»¸â‘¡ãƒã‚¯ãƒ­
  let m=1;
  if(md.nasdaq_1d_chg!=null){
    if(md.nasdaq_1d_chg>0.5)m++;else if(md.nasdaq_1d_chg<-1.5)m-=2;else if(md.nasdaq_1d_chg<0)m--;
  }
  if(md.us10y){if(md.us10y>=3.5&&md.us10y<=4.5)m++;else if(md.us10y>5)m--;}
  if(md.geo_risk)m-=2;
  if(md.rate_cut_flag)m++;
  axes.macro=Math.max(0,Math.min(m,3));

  // è»¸â‘¢ã‚¹ã‚­ãƒ£ãƒ³
  let sc=0;
  if(buyN>=5)sc+=2;else if(buyN>=3)sc+=1;
  if(avgRsi<=35)sc++;else if(avgRsi<=42)sc+=0.5;
  if(avgD25<=-4)sc++;
  if(md.prev_buy_count!=null&&buyN>md.prev_buy_count)sc++;
  axes.scan=Math.max(0,Math.min(Math.round(sc),3));

  const total=axes.tech+axes.macro+axes.scan;
  return{total,axes,buyN,watchN:processed.filter(s=>s.zone.cls==='watch').length,
    avgRsi:avgRsi.toFixed(1),avgD25:avgD25.toFixed(1),highDiv};
}

function renderStance(){
  const{total,axes,buyN,watchN,avgRsi,avgD25,highDiv}=calcStanceScore();
  const now=new Date();
  const days=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  const md=marketData;
  const hasMacro=dataSource==='real'&&md.nikkei_price;

  let stance,icon,label,title,reason;
  if(total>=7){
    stance='bull';icon='ğŸŸ¢';label='å¼·æ°— â€” ç©æ¥µçš„ã«ä»•è¾¼ã‚ã‚‹æ—¥';
    title='ä»Šæ—¥ã¯è²·ã„ã‚„ã™ã„åœ°åˆã„';
    reason=hasMacro
      ?`3è»¸ã‚¹ã‚³ã‚¢<strong>${total}/9ç‚¹</strong>ã€‚æ—¥çµŒ${md.nikkei_1d_chg>0?'+':''}${md.nikkei_1d_chg}%ãƒ»NASDAQ${md.nasdaq_1d_chg>0?'+':''}${md.nasdaq_1d_chg}%ã¨å¤–éƒ¨ç’°å¢ƒã‚‚å®‰å®šã€‚è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã€å¹³å‡RSI<strong>${avgRsi}</strong>ã§ç©æ¥µçš„ã«æ¤œè¨ã§ãã‚‹å±€é¢ã€‚`
      :`è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã€å¹³å‡RSI<strong>${avgRsi}</strong>ã€å¹³å‡25MAä¹–é›¢<strong>${avgD25}%</strong>ã€‚æ•°å€¤ãŒæƒã£ã¦ãŠã‚Šç©æ¥µçš„ã«æ¤œè¨ã§ãã‚‹å±€é¢ã§ã™ã€‚`;
  }else if(total>=4){
    stance='neutral';icon='ğŸŸ¡';label='ä¸­ç«‹ â€” å³é¸ã—ã¦ä»•è¾¼ã‚€æ—¥';
    title='ä»Šæ—¥ã¯éŠ˜æŸ„ã‚’é¸ã¶æ—¥';
    reason=hasMacro
      ?`3è»¸ã‚¹ã‚³ã‚¢<strong>${total}/9ç‚¹</strong>ã€‚è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã€æ³¨æ„åœ<strong>${watchN}éŠ˜æŸ„</strong>ã€‚ã‚¹ã‚³ã‚¢ä¸Šä½ã«çµã‚Œã°ä»•è¾¼ã¿ã‚„ã™ã„éŠ˜æŸ„ãŒå­˜åœ¨ã—ã¾ã™ã€‚`
      :`è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã€å¹³å‡RSI<strong>${avgRsi}</strong>ã€‚ã‚¹ã‚³ã‚¢60ç‚¹ä»¥ä¸Šã«çµã£ã¦æ…é‡ã«é¸åˆ¥ã‚’ã€‚`;
  }else{
    stance='bear';icon='ğŸ”´';label='å¼±æ°— â€” æ§˜å­è¦‹ãŒç„¡é›£ãªæ—¥';
    title='ä»Šæ—¥ã¯ç„¡ç†ã—ã¦è²·ã‚ãªã„æ—¥';
    reason=hasMacro
      ?`3è»¸ã‚¹ã‚³ã‚¢<strong>${total}/9ç‚¹</strong>ã€‚${md.nasdaq_1d_chg<-1?`NASDAQ${md.nasdaq_1d_chg}%ã¨ç±³å›½æ ªãŒè»Ÿèª¿ã€‚`:''}è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã¨å°‘ãªãã€ååˆ†ãªæŠ¼ã—ç›®ãŒå½¢æˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`
      :`è²·ã„åœ<strong>${buyN}éŠ˜æŸ„</strong>ã€å¹³å‡25MAä¹–é›¢<strong>${avgD25}%</strong>ã¨æŠ¼ã—ç›®ãŒæµ…ã„ã€‚æ¬¡ã®æ˜ç¢ºãªä¸‹è½å±€é¢ã‚’å¾…ã¤ã®ãŒè³¢æ˜ã§ã™ã€‚`;
  }

  const axisBar=(name,score,ico)=>`
    <div class="axis-row">
      <div class="axis-name">${ico} ${name}</div>
      <div class="axis-bar">
        ${[0,1,2].map(i=>`<div class="axis-seg ${i<score?'on':''} ${score===0?'zero':score>=2?'hi':'mid'}"></div>`).join('')}
      </div>
      <div class="axis-score">${score}/3</div>
    </div>`;

  const chips=[
    {label:'è²·ã„åœ',val:buyN+'éŠ˜æŸ„',cls:buyN>=5?'buy':buyN>=3?'warn':''},
    {label:'å¹³å‡RSI',val:avgRsi,cls:parseFloat(avgRsi)<=35?'buy':parseFloat(avgRsi)<=45?'warn':''},
    {label:'MAä¹–é›¢å¹³å‡',val:avgD25+'%',cls:parseFloat(avgD25)<=-4?'buy':parseFloat(avgD25)<=-2?'warn':''},
    {label:'é«˜é…å½“4%è¶…',val:highDiv+'ä»¶',cls:highDiv>=3?'buy':highDiv>=1?'warn':''},
  ];

  document.getElementById('stanceBox').innerHTML=`
    <div class="stance ${stance} fadein">
      <div class="stance-head">
        <div>
          <div class="stance-title">${title}</div>
          <div class="stance-date">${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼ˆ${days[now.getDay()]}ï¼‰</div>
        </div>
        <div class="stance-badge ${stance}">${icon} ${label}</div>
      </div>
      <div class="stance-reason">${reason}</div>
      <div class="stance-axes">
        ${axisBar('ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«',axes.tech,'ğŸ“Š')}
        ${axisBar('ãƒã‚¯ãƒ­',axes.macro,'ğŸŒ')}
        ${axisBar('ã‚¹ã‚­ãƒ£ãƒ³çµæœ',axes.scan,'ğŸ”')}
        <div class="axis-total">ç·åˆã‚¹ã‚³ã‚¢ ${total} / 9ç‚¹</div>
      </div>
      <div class="stance-chips">
        ${chips.map(c=>`<div class="stance-chip ${c.cls}"><div class="stance-chip-val">${c.val}</div><div class="stance-chip-label">${c.label}</div></div>`).join('')}
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3-TAB SYSTEM: ã‚»ã‚¯ã‚¿ãƒ¼ / ä¸Šæ˜‡ / å‰²å®‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTop5Tab(tab){
  currentTab=tab;
  activeSector=null;
  document.querySelectorAll('.t5-tab').forEach(t=>t.classList.remove('active'));
  const tabEl={sector:'t5TabSec',mom:'t5TabMom',dip:'t5TabDip'}[tab];
  if(tabEl)document.getElementById(tabEl).classList.add('active');
  // ã‚»ã‚¯ã‚¿ãƒ¼ã‚¿ãƒ–ãƒ©ãƒ™ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('t5TabSec').textContent='ğŸ“Š ã‚»ã‚¯ã‚¿ãƒ¼';
  renderTop10();
  gaEvent('tab_changed',{tab});
}

function renderTop10(){
  if(currentTab==='sector'){
    if(activeSector) showSectorStocks(activeSector);
    else renderSectorTrend();
  } else if(currentTab==='mom'){
    // ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ or 75æ—¥ç·šä¸Šã®å¤§å‹æ ª
    const moms=processed.filter(s=>{
      const m75=s.ma75d||0;
      return (m75 > -2 && s.d25 > -2 && (s.market_cap_b||0)>=500 && s.score>=20);
    }).sort((a,b)=>b.score-a.score).slice(0,10);
    renderTop10Items(moms,'ä¸Šæ˜‡ä¸­ TOP10');
  } else {
    // å‰²å®‰ï¼šé…å½“2%ä»¥ä¸Šã®æŠ¼ã—ç›®éŠ˜æŸ„
    const dips=processed.filter(s=>{
      return (s.d25 < -2 && (s.dividend||0)>=2.0 && (s.market_cap_b||0)>=500 && s.score>=20);
    }).sort((a,b)=>b.score-a.score).slice(0,10);
    renderTop10Items(dips,'å‰²å®‰ãƒãƒ£ãƒ³ã‚¹ TOP10');
  }
}

function renderSectorTrend(){
  const body=document.getElementById('top5Body');
  const SEC_MAP={
    'Technology':       {jp:'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼',ico:'ğŸ’»'},
    'Financial Services':{jp:'é‡‘è',ico:'ğŸ¦'},
    'Communication Services':{jp:'é€šä¿¡',ico:'ğŸ“¡'},
    'Consumer Cyclical': {jp:'æ¶ˆè²»ï¼ˆæ™¯æ°—æ•æ„Ÿï¼‰',ico:'ğŸ›’'},
    'Industrials':       {jp:'ç”£æ¥­ãƒ»è³‡æœ¬è²¡',ico:'ğŸ­'},
    'Consumer Defensive':{jp:'æ¶ˆè²»ï¼ˆå®‰å®šï¼‰',ico:'ğŸ™'},
    'Energy':            {jp:'ã‚¨ãƒãƒ«ã‚®ãƒ¼',ico:'â›½'},
    'Basic Materials':   {jp:'ç´ æ',ico:'ğŸ§±'},
    'Healthcare':        {jp:'ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢',ico:'ğŸ’Š'},
    'Utilities':         {jp:'å…¬ç›Š',ico:'ğŸ’¡'},
    'Real Estate':       {jp:'ä¸å‹•ç”£',ico:'ğŸ '},
  };

  // ã‚»ã‚¯ã‚¿ãƒ¼é›†è¨ˆï¼šè²·ã„åœã®éŠ˜æŸ„æ•°ã§ä¸¦ã¹ã‚‹
  const secMap={};
  processed.forEach(s=>{
    const sec=s.sector||'ãã®ä»–';
    if(!secMap[sec])secMap[sec]={count:0,buyCount:0,topScore:0,topName:''};
    secMap[sec].count++;
    if(s.zone&&s.zone.cls==='buy')secMap[sec].buyCount++;
    if(s.score>secMap[sec].topScore){secMap[sec].topScore=s.score;secMap[sec].topName=s.name||'';}
  });

  const sorted=Object.entries(secMap)
    .map(([name,data])=>({name,...data,
      jp:(SEC_MAP[name]||{}).jp||name,
      ico:(SEC_MAP[name]||{}).ico||'ğŸ“Š'
    }))
    .filter(d=>d.count>=3)
    .sort((a,b)=>b.buyCount-a.buyCount || b.topScore-a.topScore);

  if(!sorted.length){
    body.innerHTML='<div style="padding:20px;text-align:center;font-size:12px;color:var(--text3)">ã‚»ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    return;
  }

  body.innerHTML=`<div class="sec-grid fadein">${sorted.map(d=>{
    const sub=d.buyCount>0?`${d.buyCount}éŠ˜æŸ„ãŒè²·ã„åœ`:`${d.count}éŠ˜æŸ„`;
    return`<div class="sec-tile" onclick="showSectorStocks('${d.name}')">
      <div class="sec-tile-ico">${d.ico}</div>
      <div class="sec-tile-name">${d.jp}</div>
      <div class="sec-tile-sub">${sub}</div>
    </div>`;
  }).join('')}</div>`;
}

function showSectorStocks(secName){
  activeSector=secName;
  const SEC_JP={'Technology':'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼','Financial Services':'é‡‘è','Communication Services':'é€šä¿¡',
    'Consumer Cyclical':'æ¶ˆè²»ï¼ˆæ™¯æ°—æ•æ„Ÿï¼‰','Industrials':'ç”£æ¥­ãƒ»è³‡æœ¬è²¡','Consumer Defensive':'æ¶ˆè²»ï¼ˆå®‰å®šï¼‰',
    'Energy':'ã‚¨ãƒãƒ«ã‚®ãƒ¼','Basic Materials':'ç´ æ','Healthcare':'ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢','Utilities':'å…¬ç›Š',
    'Real Estate':'ä¸å‹•ç”£'};
  const jpName=SEC_JP[secName]||secName;
  document.getElementById('t5TabSec').textContent=jpName+' âœ•';
  const stocks=processed.filter(s=>(s.sector||'')==secName).sort((a,b)=>b.score-a.score).slice(0,10);
  const body=document.getElementById('top5Body');
  const backBtn=`<div class="sec-back-btn" onclick="activeSector=null;setTop5Tab('sector')">â† ã‚»ã‚¯ã‚¿ãƒ¼ä¸€è¦§ã«æˆ»ã‚‹</div>`;
  if(!stocks.length){
    body.innerHTML=backBtn+'<div style="padding:16px;text-align:center;font-size:11px;color:var(--text3)">è©²å½“ãªã—</div>';
    return;
  }
  body.innerHTML=backBtn+`<div class="top10-cards fadein">${stocks.map((s,i)=>renderCard(s,i+1)).join('')}</div>`;
}

function toggleDetail(code,evt){
  if(evt)evt.stopPropagation();
  const el=document.getElementById('detail-'+code);
  if(!el)return;
  const row=el.previousElementSibling;
  if(el.style.display==='none'||!el.style.display){
    // close others
    document.querySelectorAll('.card-detail').forEach(d=>{d.style.display='none';d.previousElementSibling?.classList.remove('expanded');});
    el.style.display='block';
    row?.classList.add('expanded');
    expandedCode=code;
    gaEvent('stock_expand',{code});
  }else{
    el.style.display='none';
    row?.classList.remove('expanded');
    expandedCode=null;
  }
}

function miniSvgChart(s){
  // ç°¡æ˜“ãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¤ºï¼ˆd25ã¨ma75dã‹ã‚‰ãƒˆãƒ¬ãƒ³ãƒ‰æ¨å®šï¼‰
  const d25=s.d25||0;
  const d75=s.ma75d||0;
  const isDown=d25<-2;
  const color=isDown?'var(--up)':'var(--green)';
  // SVGã§ç°¡æ˜“ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³
  const pts=[];
  const base=50;
  // éå»5ãƒã‚¤ãƒ³ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆd75â†’d25â†’ç¾åœ¨ã®æµã‚Œï¼‰
  const p0=base-(d75||d25)*2;
  const p1=base-(d75||d25)*1.5;
  const p2=base-((d75||0)+(d25||0))/2*1.2;
  const p3=base-d25*1;
  const p4=base-d25*0.5;
  [p0,p1,p2,p3,p4].forEach((y,i)=>{
    pts.push(`${i*25},${Math.max(5,Math.min(55,y))}`);
  });
  return `<svg width="100" height="36" viewBox="0 0 100 60" style="display:block">
    <polyline points="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="100" cy="${Math.max(5,Math.min(55,base-d25*0.5))}" r="3" fill="${color}"/>
  </svg>`;
}

function renderCard(s,rank){
  const sc=s.score>=60?'hi':s.score>=40?'mid':'lo';
  const divBadge=(s.dividend||0)>=2.5?`<span class="top10-badge div">ğŸ’°${s.dividend}%</span>`:'';
  const momBadge=s._type==='momentum'?`<span class="top10-badge mom">â†—ä¸Šæ˜‡</span>`:'';
  const mc=s.market_cap_b?(s.market_cap_b>=10000?(s.market_cap_b/10000).toFixed(1)+'å…†':Math.round(s.market_cap_b)+'å„„'):'';
  const d75=s.ma75d!=null?`75æ—¥ç·š${s.ma75d>0?'+':''}${s.ma75d.toFixed(1)}%`:'';
  const d25=s.d25||0;
  const trendColor=d25<-2?'var(--up)':d25>2?'var(--green)':'var(--text3)';
  const trendArrow=d25<-2?'â–¼':d25>2?'â–²':'â€”';
  
  // â”€â”€ ã‚¹ã‚³ã‚¢å†…è¨³ã‚’è¨ˆç®— â”€â”€
  const divPt=Math.min(30,(s.dividend||0)>=5?30:(s.dividend||0)>=4?25:(s.dividend||0)>=3?15:(s.dividend||0)>=2?8:0);
  const maPt=Math.min(28,d25<=-8?28:d25<=-5?20:d25<=-3?12:d25<=-1?5:0);
  const rsiPt=Math.min(22,(s.rsi||50)<=28?22:(s.rsi||50)<=35?16:(s.rsi||50)<=42?8:0);
  const pbrPt=Math.min(18,(s.pbr||99)<=0.7?18:(s.pbr||99)<=1.0?12:(s.pbr||99)<=1.5?6:0);
  const perPt=Math.min(12,(s.per||99)<=9?12:(s.per||99)<=13?8:(s.per||99)<=16?4:0);
  
  // â”€â”€ è²·ã„ç†ç”±ç”Ÿæˆ â”€â”€
  const reasons=[];
  if((s.dividend||0)>=4) reasons.push({str:'strong',text:`é…å½“${s.dividend}%ã¯é«˜æ°´æº–`,val:`${s.dividend}%`,label:'é…å½“åˆ©å›ã‚Š'});
  else if((s.dividend||0)>=3) reasons.push({str:'mid',text:`é…å½“${s.dividend}%`,val:`${s.dividend}%`,label:'é…å½“åˆ©å›ã‚Š'});
  if(d25<=-5) reasons.push({str:'strong',text:`25MAä¹–é›¢${d25.toFixed(1)}%ã§å¼·ã„æŠ¼ã—ç›®æ°´æº–`,val:`${d25.toFixed(1)}%`,label:'25MAä¹–é›¢'});
  else if(d25<=-2) reasons.push({str:'mid',text:`25MAä¹–é›¢${d25.toFixed(1)}%ã§æŠ¼ã—ç›®`,val:`${d25.toFixed(1)}%`,label:'25MAä¹–é›¢'});
  if((s.rsi||50)<=30) reasons.push({str:'strong',text:`RSI${(s.rsi||0).toFixed(0)}ã§å£²ã‚‰ã‚Œã™ãåœ`,val:`${(s.rsi||0).toFixed(0)}`,label:'RSI'});
  else if((s.rsi||50)<=42) reasons.push({str:'mid',text:`RSI${(s.rsi||0).toFixed(0)}ã§å¼±ã‚`,val:`${(s.rsi||0).toFixed(0)}`,label:'RSI'});
  if((s.pbr||99)<=0.8) reasons.push({str:'strong',text:`PBR${s.pbr}å€ã¯å‰²å®‰`,val:`${s.pbr}å€`,label:'PBR'});
  else if((s.pbr||99)<=1.2) reasons.push({str:'mid',text:`PBR${s.pbr}å€`,val:`${s.pbr}å€`,label:'PBR'});

  const zone=s.zone||{cls:'hold',label:'æ§˜å­è¦‹'};
  const zoneCls=zone.cls||'hold';
  
  const detailHtml=`
    <div class="detail-grid">
      <div>
        <div class="detail-section-title">ğŸ“Š ãƒˆãƒ¬ãƒ³ãƒ‰ & ã‚¹ã‚³ã‚¢å†…è¨³</div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
          ${miniSvgChart(s)}
          <div>
            <div style="font-family:var(--fn);font-size:13px;color:${trendColor}">${trendArrow} 25MA ${d25>0?'+':''}${d25.toFixed(1)}%</div>
            ${s.ma75d!=null?`<div style="font-size:10px;color:var(--text3)">75MA ${s.ma75d>0?'+':''}${s.ma75d.toFixed(1)}%</div>`:''}
            <div style="font-size:10px;color:var(--text3)">RSI ${(s.rsi||0).toFixed(0)}</div>
          </div>
        </div>
        <div class="score-breakdown">
          <div class="bd-row"><div class="bd-l">é…å½“</div><div class="bd-bar"><div class="bd-fill" style="width:${divPt/30*100}%;background:var(--orange)"></div></div><div class="bd-v ${divPt>=15?'pos':''}">${divPt}/30</div></div>
          <div class="bd-row"><div class="bd-l">MAä¹–é›¢</div><div class="bd-bar"><div class="bd-fill" style="width:${maPt/28*100}%;background:var(--up)"></div></div><div class="bd-v ${maPt>=12?'pos':''}">${maPt}/28</div></div>
          <div class="bd-row"><div class="bd-l">RSI</div><div class="bd-bar"><div class="bd-fill" style="width:${rsiPt/22*100}%;background:var(--dn)"></div></div><div class="bd-v ${rsiPt>=8?'pos':''}">${rsiPt}/22</div></div>
          <div class="bd-row"><div class="bd-l">PBR</div><div class="bd-bar"><div class="bd-fill" style="width:${pbrPt/18*100}%;background:var(--green)"></div></div><div class="bd-v ${pbrPt>=6?'pos':''}">${pbrPt}/18</div></div>
          <div class="bd-row"><div class="bd-l">PER</div><div class="bd-bar"><div class="bd-fill" style="width:${perPt/12*100}%;background:var(--amber)"></div></div><div class="bd-v ${perPt>=4?'pos':''}">${perPt}/12</div></div>
        </div>
      </div>
      <div>
        <div class="detail-section-title">ğŸ’¡ æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆ</div>
        <div class="why-items">
          ${reasons.length?reasons.map(r=>`
            <div class="why-item ${r.str}">
              <div class="why-val">${r.val}</div>
              <div class="why-label">${r.label}</div>
              <div class="why-note-text">${r.text}</div>
            </div>`).join(''):`<div style="font-size:11px;color:var(--text3);padding:8px">ç‰¹ç­†ã™ã¹ãã‚·ã‚°ãƒŠãƒ«ãªã—</div>`}
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button class="detail-fav-btn ${watchlist.includes(s.code)?'active':''}" onclick="event.stopPropagation();toggleFav('${s.code}')">${watchlist.includes(s.code)?'â˜… ã‚¦ã‚©ãƒƒãƒä¸­':'â˜† ã‚¦ã‚©ãƒƒãƒè¿½åŠ '}</button>
          <a class="detail-link-btn" href="https://finance.yahoo.co.jp/quote/${s.code}.T" target="_blank" rel="noopener" onclick="event.stopPropagation()">Yahoo!ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚¹ â†’</a>
        </div>
      </div>
    </div>`;

  return`<div class="top10-card${expandedCode===s.code?' expanded':''}" onclick="toggleDetail('${s.code}',event)">
    <div class="top10-rank">${rank}</div>
    <div class="top10-info">
      <div class="top10-name">${s.name} <span class="tbl-zone ${zoneCls}" style="font-size:9px;padding:1px 5px;margin-left:4px">${zone.label||zoneCls}</span></div>
      <div class="top10-meta">${s.code} ãƒ» ${s.sector||''} ãƒ» ${mc}${d75?' ãƒ» '+d75:''}</div>
    </div>
    <div class="top10-right" style="display:flex;align-items:center;gap:8px">
      <div style="color:${trendColor};font-size:14px">${trendArrow}</div>
      <div>
        <div class="top10-score ${sc}">${s.score}pt</div>
        ${divBadge}${momBadge}
      </div>
    </div>
  </div>
  <div class="card-detail" id="detail-${s.code}" style="display:${expandedCode===s.code?'block':'none'};background:var(--bg3);border:1px solid var(--border);border-top:none;border-radius:0 0 var(--r) var(--r);padding:14px 16px;margin-top:-8px;margin-bottom:8px;box-shadow:var(--shadow)">
    ${detailHtml}
  </div>`;
}

function renderTop10Items(items,title){
  const body=document.getElementById('top5Body');
  if(!items.length){
    body.innerHTML=`<div style="padding:20px;text-align:center;font-size:12px;color:var(--text3)">è©²å½“ã™ã‚‹éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }
  body.innerHTML=`<div class="top10-cards fadein">${items.map((s,i)=>renderCard(s,i+1)).join('')}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PORTFOLIO DIARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPortfolio(){
  try{
    const res=await fetch('portfolio.json?t='+Date.now());
    if(res.ok)portfolioData=await res.json();
  }catch(e){console.log('portfolio.json not found');}
  renderPortfolio();
}

function renderPortfolio(){
  const body=document.getElementById('portfolioBody');
  if(!body)return;
  if(!portfolioData||!portfolioData.daily_nav||portfolioData.daily_nav.length<=1){
    body.innerHTML=`<div style="padding:20px;text-align:center">
      <div style="font-size:32px;margin-bottom:8px">ğŸš€</div>
      <div style="font-size:13px;font-weight:700;color:var(--text1);margin-bottom:4px">1000ä¸‡å††ã§é‹ç”¨é–‹å§‹</div>
      <div style="font-size:11px;color:var(--text3);margin-bottom:12px">AIãŒã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦è‡ªå‹•å£²è²·ã€‚æ¯æ—¥æ›´æ–°ã—ã¾ã™ã€‚</div>
      <a class="pf-note-link" href="https://note.com/kabunosuke_navi" target="_blank" rel="noopener">ğŸ“ æŠ•è³‡æ—¥è¨˜ã‚’noteã§èª­ã‚€ â†’</a>
    </div>`;
    return;
  }
  const pf=portfolioData;
  const nav=pf.daily_nav[pf.daily_nav.length-1];
  const currentNav=nav.nav;
  const pnl=currentNav-pf.initial_capital;
  const pnlPct=(pnl/pf.initial_capital*100).toFixed(2);
  const dayCount=pf.daily_nav.length;
  const posCount=(pf.positions||[]).length;
  const cashPct=Math.round(pf.cash/currentNav*100);
  const stockPct=100-cashPct;
  const pnlCls=pnl>=0?'up':'dn';
  const pnlSign=pnl>=0?'+':'';

  const holdingsHtml=posCount
    ?(pf.positions||[]).map(p=>{
        const pc=(p.pnl_pct||0)>=0?'up':'dn';
        const ps=(p.pnl_pct||0)>=0?'+':'';
        return`<div class="pf-hold">
          <div style="flex:1"><div class="pf-hold-name">${p.name}</div><div style="font-size:10px;color:var(--text3)">${p.code} ãƒ» ${p.shares}æ ª</div></div>
          <div class="pf-hold-pnl ${pc}">${ps}${(p.pnl_pct||0).toFixed(1)}%</div>
        </div>`;}).join('')
    :'<div style="font-size:11px;color:var(--text3);padding:4px 0">ç¾é‡‘å¾…æ©Ÿä¸­ ğŸ”</div>';

  let chartHtml='';
  if(pf.daily_nav.length>=3){
    const vals=pf.daily_nav.map(d=>d.nav);
    const mn=Math.min(...vals),mx=Math.max(...vals),rng=mx-mn||1;
    const w=280,h=40;
    const pts=vals.map((v,i)=>`${(i/(vals.length-1))*w},${h-((v-mn)/rng)*h*0.8-h*0.1}`).join(' ');
    const clr=vals[vals.length-1]>=pf.initial_capital?'var(--dn)':'var(--up)';
    chartHtml=`<svg viewBox="0 0 ${w} ${h}" style="width:100%;height:40px;margin:6px 0">
      <line x1="0" y1="${h-((pf.initial_capital-mn)/rng)*h*0.8-h*0.1}" x2="${w}" y2="${h-((pf.initial_capital-mn)/rng)*h*0.8-h*0.1}" stroke="var(--text3)" stroke-dasharray="3,3" stroke-width="0.5" opacity="0.5"/>
      <polyline points="${pts}" fill="none" stroke="${clr}" stroke-width="1.5"/>
    </svg>`;
  }

  body.innerHTML=`
    <div class="pf-hero"><div class="pf-nav">Â¥${currentNav.toLocaleString()}</div><div class="pf-pnl ${pnlCls}">${pnlSign}${pnlPct}%</div><div class="pf-day">Day ${dayCount}</div></div>
    <div class="pf-bars"><div class="pf-bar cash" style="flex:${cashPct}">ğŸ’´ ç¾é‡‘ ${cashPct}%</div>${posCount?`<div class="pf-bar stock" style="flex:${stockPct}">ğŸ“ˆ æ ªå¼ ${stockPct}%</div>`:''}</div>
    ${chartHtml}
    <div style="font-size:11px;font-weight:700;color:var(--text2);margin:8px 0 4px">ğŸ“‹ ä¿æœ‰ ${posCount}éŠ˜æŸ„</div>
    <div class="pf-holdings">${holdingsHtml}</div>
    <a class="pf-note-link" href="https://note.com/kabunosuke_navi" target="_blank" rel="noopener">ğŸ“ æŠ•è³‡æ—¥è¨˜ã‚’noteã§èª­ã‚€ â†’</a>
    <div style="font-size:9px;color:var(--text3);margin-top:8px;text-align:center">â€»ä»®æƒ³æŠ•è³‡ã§ã™ã€‚å®Ÿéš›ã®å£²è²·ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER & MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMode(m,el){
  currentMode=m;
  document.querySelectorAll('.filter-tab[id^="mode-"]').forEach(t=>t.classList.remove('active'));
  if(el)el.classList.add('active');
  document.querySelectorAll('#set-mode .setting-opt').forEach(o=>{
    o.classList.toggle('active',o.dataset.val===m);
  });
  run();
  gaEvent('mode_changed',{mode:m});
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings(){
  // ç¾åœ¨ã®è¨­å®šã‚’åæ˜ 
  document.querySelectorAll('#set-mode .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===settings.mode));
  document.querySelectorAll('#set-count .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===String(settings.count)));
  document.querySelectorAll('#set-mindiv .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===String(settings.mindiv)));
  document.querySelectorAll('#set-zone .setting-opt').forEach(o=>o.classList.toggle('active',o.dataset.val===settings.zone));
  document.getElementById('settingsOverlay').classList.add('open');
  gaEvent('click_settings');
}
function closeSettingsBg(e){if(e.target===document.getElementById('settingsOverlay'))document.getElementById('settingsOverlay').classList.remove('open');}

function selectSettingOpt(el,group){
  document.querySelectorAll(`#set-${group} .setting-opt`).forEach(o=>o.classList.remove('active'));
  el.classList.add('active');
}

function saveSettings(){
  settings.mode=document.querySelector('#set-mode .setting-opt.active')?.dataset.val||'dividend';
  settings.count=parseInt(document.querySelector('#set-count .setting-opt.active')?.dataset.val||'30');
  settings.mindiv=parseFloat(document.querySelector('#set-mindiv .setting-opt.active')?.dataset.val||'0');
  settings.zone=document.querySelector('#set-zone .setting-opt.active')?.dataset.val||'all';
  try{localStorage.setItem('kbs_settings',JSON.stringify(settings));}catch(e){}

  currentMode=settings.mode;
  dispCount=settings.count;

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–åŒæœŸ
  document.querySelectorAll('.filter-tab[id^="mode-"]').forEach(t=>t.classList.remove('active'));
  const mt=document.getElementById('mode-'+currentMode);if(mt)mt.classList.add('active');
  document.querySelectorAll('.filter-tab[id^="disp-"]').forEach(t=>t.classList.remove('active'));
  const cnt=dispCount>=999?'all':String(dispCount);
  const dt=document.getElementById('disp-'+cnt);if(dt)dt.classList.add('active');

  document.getElementById('settingsOverlay').classList.remove('open');
  run();
  gaEvent('change_filter',settings);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WATCHLIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFav(code){
  const adding=!watchlist.includes(code);
  if(adding){
    watchlist.push(code);
    const s=processed.find(x=>x.code===code);
    gaEvent('watchlist_add',{stock_code:code,score:s?.score||0});
  }else{
    watchlist=watchlist.filter(c=>c!==code);
    gaEvent('watchlist_remove',{stock_code:code});
  }
  try{localStorage.setItem('kbs_watch',JSON.stringify(watchlist));}catch(e){}
  updateWatchCount();
  // å†æç”»
  renderWatchlist();
}

function updateWatchCount(){
  const el=document.getElementById('watchCount');
  el.textContent=watchlist.length;
  el.classList.toggle('show',watchlist.length>0);
}

function renderWatchlist(){
  updateWatchCount();
  const el=document.getElementById('watchlistBody');
  if(!watchlist.length){
    el.innerHTML='<div class="watch-empty">ã‚¦ã‚©ãƒƒãƒç™»éŒ²ã—ãŸéŠ˜æŸ„ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>éŠ˜æŸ„è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’é–‹ãã€Œã‚¦ã‚©ãƒƒãƒã«è¿½åŠ ã€ã‹ã‚‰ç™»éŒ²ã§ãã¾ã™ã€‚</div>';
    return;
  }
  el.innerHTML=`<div class="watch-list">${watchlist.map(code=>{
    const s=STOCKS.find(x=>x.code===code);if(!s)return'';
    const score=calcScore(s);
    const sc=score>=60?'hi':score>=35?'md':'lo';
    const d25=dv(s.price,s.ma25);
    return`<div class="watch-row" onclick="window.open('https://finance.yahoo.co.jp/quote/${code}.T','_blank')">
      <div class="watch-code">${code}</div>
      <div class="watch-name">${s.name}</div>
      <div style="text-align:right">
        <div class="watch-score ${sc}">${score}ç‚¹</div>
        <div style="font-size:10px;color:var(--text3)">${d25>0?'+':''}${d25}%</div>
      </div>
      <button class="watch-remove" onclick="event.stopPropagation();toggleFav('${code}')">âœ•</button>
    </div>`;
  }).join('')}</div>`;
}

function renderHistory(){
  const el=document.getElementById('historyBody');
  const modeNames={dividend:'é«˜é…å½“',value:'ãƒãƒªãƒ¥ãƒ¼',rebound:'æŠ¼ã—ç›®'};
  if(!scanHistory.length){
    el.innerHTML='<div class="watch-empty">ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>';
    return;
  }
  el.innerHTML=`<table class="hist-table">
    <tr><th>æ—¥æ™‚</th><th>ãƒ¢ãƒ¼ãƒ‰</th><th>ä»¶æ•°</th><th>1ä½éŠ˜æŸ„</th></tr>
    ${scanHistory.slice(0,7).map(h=>`<tr>
      <td>${h.date}</td><td>${modeNames[h.mode]||h.mode}</td>
      <td>${h.count}ä»¶</td><td>${h.top}</td>
    </tr>`).join('')}
  </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
  const n=document.getElementById('nav-'+tab);if(n)n.classList.add('active');
  if(tab==='watch'){renderWatchlist();renderHistory();}
  gaEvent('tab_switched',{tab});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLogicModal(){document.getElementById('logicModal').classList.add('open');}
function closeLogicModal(e){if(!e||e.target===document.getElementById('logicModal'))document.getElementById('logicModal').classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRealData(){
  try{
    const r=await fetch('stocks_data.json?t='+Date.now());
    if(!r.ok)throw new Error('fetch failed');
    const j=await r.json();
    if(j.stocks&&j.stocks.length>0){
      STOCKS=j.stocks;
      dataSource='real';
      // å¸‚å ´ãƒ‡ãƒ¼ã‚¿
      const mFields=['nikkei_price','nikkei_ma25','nikkei_1d_chg','nasdaq_1d_chg',
                     'vix','usdjpy','us10y','geo_risk','rate_cut_flag','prev_buy_count'];
      mFields.forEach(k=>{if(j[k]!==undefined)marketData[k]=j[k];});
      if(j.vol_ranking&&j.vol_ranking.length)volRankingData=j.vol_ranking;
      if(j.trend_ranking&&j.trend_ranking.length)trendRankingData=j.trend_ranking;
      if(j.sector_scores)sectorScoresData=j.sector_scores;
      // ä¿¡é ¼ãƒãƒ¼
      document.getElementById('trustText').innerHTML=`<span class="hi">${j.updated_at}</span> æ›´æ–° Â· ${j.total}éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿`;
      document.getElementById('trustDot').style.background='var(--green)';
      document.getElementById('trustBanner').style.borderLeftColor='var(--green)';
      document.getElementById('totalCountBadge').textContent=j.total+'éŠ˜æŸ„';
      document.getElementById('heroEyebrow').innerHTML='<span class="hero-dot"></span>ğŸ“¡ å®Ÿãƒ‡ãƒ¼ã‚¿èª­è¾¼æ¸ˆã¿ â€” æŠ¼ã—ç›® Ã— é«˜é…å½“ â€” æ¯æœ8:30è‡ªå‹•æ›´æ–°';
    }else throw new Error('no stocks');
  }catch{
    dataSource='sample';
    STOCKS=[...SAMPLE_STOCKS];
    document.getElementById('trustText').innerHTML='<span class="warn">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºä¸­</span> â€” å®Ÿãƒ‡ãƒ¼ã‚¿ã¯æ¯æœ8:30æ›´æ–°';
    document.getElementById('trustDot').style.background='var(--amber)';
    document.getElementById('trustBanner').style.borderLeftColor='var(--amber)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function run(){
  processStocks();
  renderHeroStats();
  renderPulse();
  renderTop10();
  requestAnimationFrame(()=>{
    renderStance();
  });
  gaEvent('scan_executed',{mode:currentMode,data_source:dataSource});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BRAIN SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadBrainScanner(){
  try{
    const res=await fetch('https://raw.githubusercontent.com/maemura/oshime/main/sentiment_latest.json');
    if(!res.ok) throw new Error('not found');
    const data=await res.json();
    document.getElementById('brainSection').style.display='';
    
    const overall=data.overall_sentiment||0;
    const cls=overall>0.15?'pos':overall<-0.15?'neg':'neu';
    const pct=Math.round((overall+1)/2*100);
    const barColor=cls==='pos'?'var(--green)':cls==='neg'?'var(--up)':'var(--amber)';
    
    const cats={macro:[],institutional:[],retail:[]};
    (data.topics||[]).forEach(t=>{
      const cat=t.category||'retail';
      if(cats[cat])cats[cat].push(t);
    });
    
    const renderItems=(items)=>items.slice(0,5).map(t=>{
      const s=t.sentiment||0;
      const sc=s>0.15?'pos':s<-0.15?'neg':'neu';
      const val=s>0?'+'+s.toFixed(2):s.toFixed(2);
      return `<div class="brain-item"><span class="brain-topic">${t.topic||''}</span><span class="brain-score ${sc}">${val}</span></div>`;
    }).join('');
    
    let html=`
      <div class="brain-overall">
        <div class="brain-overall-label">ç·åˆ<br>ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆ</div>
        <div class="brain-overall-val ${cls}">${overall>0?'+':''}${overall.toFixed(2)}</div>
        <div class="brain-overall-bar"><div class="brain-overall-fill" style="width:${pct}%;background:${barColor}"></div></div>
      </div>
      <div class="brain-grid">
        <div><div class="brain-col-title macro">ğŸŒ MACRO</div>${renderItems(cats.macro)}</div>
        <div><div class="brain-col-title inst">ğŸ¦ INSTITUTIONAL</div>${renderItems(cats.institutional)}</div>
        <div><div class="brain-col-title retail">ğŸ‘¥ RETAIL</div>${renderItems(cats.retail)}</div>
      </div>`;
    
    if(data.summary){
      html+=`<div class="brain-summary">ğŸ’¬ ${data.summary}</div>`;
    }
    if(data.generated_at){
      html+=`<div style="text-align:right;font-size:9px;color:var(--text3);margin-top:4px">æ›´æ–°: ${new Date(data.generated_at).toLocaleString('ja-JP')}</div>`;
    }
    
    document.getElementById('brainBody').innerHTML=html;
  }catch(e){
    console.log('Brain Scanner data not available:',e);
    document.getElementById('brainSection').style.display='none';
  }
}

async function init(){
  updateWatchCount();
  await loadRealData();
  run();
  loadPortfolio();
  loadBrainScanner();
  gaEvent('view_app',{data_source:dataSource});
}

init();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ON-SCREEN DEBUG CONSOLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const div=document.createElement('div');
  div.id='dbgConsole';
  div.style.cssText='position:fixed;bottom:60px;left:0;right:0;max-height:40vh;overflow-y:auto;background:rgba(0,0,0,0.92);color:#0f0;font-family:monospace;font-size:11px;z-index:9999;padding:8px 10px;display:none;border-top:2px solid #ff6b00;';
  document.body.appendChild(div);

  const btn=document.createElement('button');
  btn.textContent='ğŸ–¥ Console';
  btn.style.cssText='position:fixed;bottom:60px;right:8px;z-index:10000;background:#ff6b00;color:#fff;border:none;border-radius:6px;padding:5px 10px;font-size:10px;font-weight:700;cursor:pointer;opacity:0.8;';
  btn.onclick=()=>{div.style.display=div.style.display==='none'?'block':'none';};
  document.body.appendChild(btn);

  const clearBtn=document.createElement('button');
  clearBtn.textContent='âœ• Clear';
  clearBtn.style.cssText='position:sticky;top:0;float:right;background:#333;color:#fff;border:1px solid #555;border-radius:3px;padding:2px 8px;font-size:10px;cursor:pointer;margin-bottom:4px;';
  clearBtn.onclick=()=>{div.innerHTML='';div.appendChild(clearBtn);};
  div.appendChild(clearBtn);

  function addLine(msg,color){
    const t=new Date();
    const ts=String(t.getHours()).padStart(2,'0')+':'+String(t.getMinutes()).padStart(2,'0')+':'+String(t.getSeconds()).padStart(2,'0');
    const line=document.createElement('div');
    line.style.cssText='border-bottom:1px solid #222;padding:2px 0;word-break:break-all;color:'+color;
    line.textContent='['+ts+'] '+msg;
    div.appendChild(line);
    div.scrollTop=div.scrollHeight;
  }

  const origLog=console.log, origErr=console.error, origWarn=console.warn, origInfo=console.info;
  console.log=function(){origLog.apply(console,arguments);addLine(Array.from(arguments).map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' '),'#0f0');};
  console.error=function(){origErr.apply(console,arguments);addLine('âŒ '+Array.from(arguments).map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' '),'#ff4757');};
  console.warn=function(){origWarn.apply(console,arguments);addLine('âš ï¸ '+Array.from(arguments).map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' '),'#f0a500');};
  console.info=function(){origInfo.apply(console,arguments);addLine('â„¹ï¸ '+Array.from(arguments).map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' '),'#4a9eff');};

  window.addEventListener('error',function(e){
    addLine('âŒ UNCAUGHT: '+e.message+' @ '+e.filename+':'+e.lineno,'#ff4757');
  });
  window.addEventListener('unhandledrejection',function(e){
    addLine('âŒ PROMISE: '+(e.reason?.message||e.reason||'unknown'),'#ff4757');
  });

  console.log('ğŸ–¥ Debug console ready');
})();
</script>
</body>
</html>
