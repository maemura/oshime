name: ã‹ã¶ã®ã™ã‘ è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³

on:
  schedule:
    # æ¯æœ 7:30 JST = UTC 22:30ï¼ˆå‰æ—¥ï¼‰æœˆã€œé‡‘
    - cron: '30 22 * * 0-4'
    # å¤§å¼•ã‘å¾Œ 16:00 JST = UTC 7:00 æœˆã€œé‡‘
    - cron: '0 7 * * 1-5'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    permissions:
      contents: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python 3.11 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install yfinance pandas numpy requests xlrd openpyxl

      - name: fetch_stocks.py ã‚’å®Ÿè¡Œ
        run: python3 fetch_stocks.py
        env:
          TZ: Asia/Tokyo

      - name: stocks_data.json ã‚’ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git config user.name  "ã‹ã¶ã®ã™ã‘Bot"
          git config user.email "bot@kabunosuke.app"
          git add stocks_data.json
          if git diff --cached --quiet; then
            echo "ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ãªã—ã€‚ã‚¹ã‚­ãƒƒãƒ—ã€‚"
          else
            git commit -m "ğŸ“Š è‡ªå‹•æ›´æ–° $(TZ=Asia/Tokyo date '+%Y/%m/%d %H:%M JST')"
            git push
          fi

      - name: ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªè‡ªå‹•å£²è²·
        if: success()
        run: python3 manage_portfolio.py
        env:
          TZ: Asia/Tokyo

      - name: portfolio.json ã‚’ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
        if: success()
        run: |
          git add portfolio.json
          if git diff --cached --quiet; then
            echo "ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå¤‰æ›´ãªã—ã€‚"
          else
            git commit -m "ğŸ“Š æŠ•è³‡æ—¥è¨˜æ›´æ–° $(TZ=Asia/Tokyo date '+%Y/%m/%d %H:%M JST')"
            git push
          fi

      - name: Xï¼ˆTwitterï¼‰ã«è‡ªå‹•æŠ•ç¨¿
        if: success()
        run: python3 post_x.py
        env:
          TZ: Asia/Tokyo
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
