name: ã‹ã¶ã®ã™ã‘ è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³

on:
  schedule:
    # æ¯æœ 7:30 JST = UTC 22:30ï¼ˆå‰æ—¥ï¼‰æœˆã€œé‡‘
    - cron: '30 22 * * 0-4'
    # å¾Œå ´å¾Œ 16:00 JST = UTC 7:00 æœˆã€œé‡‘
    - cron: '0 7 * * 1-5'
  workflow_dispatch:  # GitHubã®UIã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œã§ãã‚‹ãƒœã‚¿ãƒ³

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # æœ€å¤§90åˆ†ï¼ˆ2,000éŠ˜æŸ„ã§ç´„40åˆ†ï¼‰

    permissions:
      contents: write   # stocks_data.json ã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãŸã‚ã«å¿…è¦

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python 3.11 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install yfinance pandas numpy requests xlrd openpyxl

      - name: fetch_stocks.py ã‚’å®Ÿè¡Œ
        run: python3 fetch_stocks.py
        env:
          TZ: Asia/Tokyo

      - name: validate.py ã‚’å®Ÿè¡Œï¼ˆæ¨è–¦æ¤œè¨¼ï¼‰
        run: python3 validate.py || echo "æ¤œè¨¼ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼‰"
        env:
          TZ: Asia/Tokyo

      - name: stocks_data.json + å±¥æ­´ã‚’ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git config user.name  "ã‹ã¶ã®ã™ã‘Bot"
          git config user.email "bot@kabunosuke.app"
          git add stocks_data.json
          git add history/ || true
          git add weights.json || true
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã ã‘ã‚³ãƒŸãƒƒãƒˆï¼ˆå¤‰æ›´ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          if git diff --cached --quiet; then
            echo "ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ãªã—ã€‚ã‚¹ã‚­ãƒƒãƒ—ã€‚"
          else
            git commit -m "ğŸ“Š è‡ªå‹•æ›´æ–° $(TZ=Asia/Tokyo date '+%Y/%m/%d %H:%M JST')"
            git push
          fi
