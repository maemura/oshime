<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>æŠ¼ã—ç›®ãƒãƒ³ã‚¿ãƒ¼ï½œä»Šæ—¥ã®è²·ã„å ´ã‚’æ¢ã™</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0d1117;
  --ink2: #1c2330;
  --ink3: #253040;
  --gold: #c8a850;
  --gold2: #e8c870;
  --gold-dim: rgba(200,168,80,0.12);
  --gold-glow: rgba(200,168,80,0.25);
  --green: #3ecf8e;
  --green-dim: rgba(62,207,142,0.12);
  --red: #e05c6a;
  --red-dim: rgba(224,92,106,0.12);
  --text: #8899aa;
  --text2: #aabbc8;
  --text-bright: #e8f0f8;
  --border: rgba(255,255,255,0.06);
  --border2: rgba(255,255,255,0.1);
  --surface: rgba(255,255,255,0.03);
  --surface2: rgba(255,255,255,0.06);
}

* { margin:0; padding:0; box-sizing:border-box; }

html, body {
  background: var(--ink);
  color: var(--text2);
  font-family: 'DM Mono', monospace;
  min-height: 100%;
  overflow-x: hidden;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
}

/* Grain overlay */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
  opacity: 0.5;
}

/* ===== OVERLAY ===== */
.overlay {
  position: fixed;
  inset: 0;
  z-index: 500;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  background: var(--ink);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 32px 16px 60px;
}
.overlay.hidden { display: none; }

/* ===== MARKET SUMMARY SCREEN ===== */
.ms-wrap { max-width: 680px; width: 100%; }

.ms-eyebrow {
  display: flex; align-items: center; gap: 10px;
  font-size: 10px; letter-spacing: 3px; color: var(--gold);
  text-transform: uppercase; margin-bottom: 20px;
}
.ms-eyebrow::before {
  content: ''; display: block; width: 28px; height: 1px; background: var(--gold);
}

.ms-headline {
  font-family: 'Shippori Mincho', serif;
  font-size: clamp(28px, 6vw, 42px);
  color: var(--text-bright);
  line-height: 1.3;
  margin-bottom: 8px;
}
.ms-sub { font-size: 12px; color: var(--text); margin-bottom: 36px; }

/* Vibe card */
.vibe-card {
  border-radius: 16px;
  padding: 20px 24px;
  margin-bottom: 28px;
  display: flex; gap: 16px; align-items: center;
  border: 1px solid;
  position: relative; overflow: hidden;
}
.vibe-card::before {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(circle at 80% 50%, rgba(255,255,255,0.03), transparent 60%);
}
.vibe-card.neutral { background: rgba(200,168,80,0.06); border-color: rgba(200,168,80,0.2); }
.vibe-card.bearish { background: rgba(224,92,106,0.06); border-color: rgba(224,92,106,0.2); }
.vibe-card.bullish { background: rgba(62,207,142,0.06); border-color: rgba(62,207,142,0.2); }
.vibe-emoji { font-size: 32px; flex-shrink: 0; }
.vibe-label { font-family: 'Shippori Mincho', serif; font-size: 16px; color: var(--text-bright); margin-bottom: 4px; }
.vibe-desc { font-size: 11px; color: var(--text); line-height: 1.7; }

/* Index grid */
.idx-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 16px;
}
@media(max-width: 480px) { .idx-grid { grid-template-columns: repeat(2, 1fr); } }

.idx-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  transition: border-color 0.2s;
}
.idx-card:hover { border-color: var(--border2); }
.idx-name { font-size: 9px; letter-spacing: 1.5px; color: var(--text); text-transform: uppercase; margin-bottom: 8px; }
.idx-val { font-size: 20px; font-weight: 500; color: var(--text-bright); margin-bottom: 4px; letter-spacing: -0.5px; }
.idx-chg { font-size: 11px; font-weight: 500; }
.idx-chg.up { color: var(--green); }
.idx-chg.dn { color: var(--red); }
.idx-spark { display: flex; align-items: flex-end; gap: 2px; height: 20px; margin-top: 8px; }
.spark-b { flex: 1; border-radius: 1px; min-height: 2px; }

/* Stats strip */
.stats-strip {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 8px; margin-bottom: 28px;
}
@media(max-width: 480px) { .stats-strip { grid-template-columns: repeat(2, 1fr); } }
.stat-tile {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
}
.stat-l { font-size: 9px; letter-spacing: 1px; color: var(--text); text-transform: uppercase; margin-bottom: 6px; }
.stat-v { font-size: 18px; font-weight: 500; color: var(--text-bright); }
.stat-v.g { color: var(--green); }
.stat-v.w { color: var(--gold); }

/* AI comment */
.ai-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px 20px;
  margin-bottom: 32px;
  position: relative;
}
.ai-box-label {
  display: flex; align-items: center; gap: 8px;
  font-size: 9px; letter-spacing: 2px; color: var(--gold);
  text-transform: uppercase; margin-bottom: 12px;
}
.ai-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--gold); animation: pulse 2s infinite; }
.ai-text { font-size: 12px; color: var(--text2); line-height: 1.9; }
.ai-text strong { color: var(--text-bright); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

.btn-start {
  width: 100%;
  background: var(--gold);
  color: var(--ink);
  border: none;
  border-radius: 12px;
  padding: 18px;
  font-family: 'Shippori Mincho', serif;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.5px;
}
.btn-start:hover { background: var(--gold2); transform: translateY(-2px); box-shadow: 0 12px 32px rgba(200,168,80,0.3); }

/* ===== QUIZ SCREEN ===== */
.qz-wrap {
  max-width: 540px; width: 100%;
  background: var(--ink2);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 40px 32px;
  margin: auto;
  box-shadow: 0 40px 80px rgba(0,0,0,0.6);
}
@media(max-width: 480px) { .qz-wrap { padding: 28px 20px; } }
.qz-step { font-size: 10px; letter-spacing: 2px; color: var(--gold); text-transform: uppercase; margin-bottom: 12px; }
.qz-bar { display: flex; gap: 5px; margin-bottom: 28px; }
.qz-seg { flex: 1; height: 2px; border-radius: 1px; background: var(--border2); transition: background 0.3s; }
.qz-seg.done, .qz-seg.active { background: var(--gold); }
.qz-seg.active { opacity: 0.5; }
.qz-q { font-family: 'Shippori Mincho', serif; font-size: clamp(18px, 4vw, 22px); color: var(--text-bright); line-height: 1.5; margin-bottom: 6px; }
.qz-hint { font-size: 11px; color: var(--text); margin-bottom: 24px; line-height: 1.6; }
.qz-opts { display: flex; flex-direction: column; gap: 10px; }
.qz-opt {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 18px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex; align-items: center; gap: 14px;
}
.qz-opt:hover { border-color: var(--gold); background: var(--gold-dim); transform: translateX(4px); }
.qz-opt.sel { border-color: var(--gold); background: var(--gold-dim); }
.qz-opt-ico { font-size: 22px; flex-shrink: 0; }
.qz-opt-t { font-size: 13px; color: var(--text-bright); font-weight: 500; margin-bottom: 2px; }
.qz-opt-d { font-size: 10px; color: var(--text); line-height: 1.5; }
.qz-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 24px; }
.btn-back { background: none; border: 1px solid var(--border); border-radius: 8px; padding: 9px 16px; color: var(--text); font-family: 'DM Mono'; font-size: 12px; cursor: pointer; transition: all 0.2s; }
.btn-back:hover { border-color: var(--text); color: var(--text-bright); }
.btn-next { background: var(--gold); border: none; border-radius: 8px; padding: 10px 24px; color: var(--ink); font-family: 'DM Mono'; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.btn-next:hover { background: var(--gold2); }
.btn-next:disabled { opacity: 0.3; cursor: not-allowed; }

/* ===== MAIN APP ===== */
.app { max-width: 1200px; margin: 0 auto; padding: 28px 16px 80px; }

/* Header */
.app-header { margin-bottom: 28px; }
.app-logo { font-family: 'Shippori Mincho', serif; font-size: 22px; color: var(--text-bright); margin-bottom: 4px; }
.app-logo span { color: var(--gold); }
.app-meta { font-size: 10px; color: var(--text); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.live-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }

/* Badges */
.badges { display: none; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
.badges.show { display: flex; align-items: center; }
.badge { background: var(--gold-dim); border: 1px solid rgba(200,168,80,0.2); color: var(--gold); border-radius: 20px; padding: 3px 12px; font-size: 10px; }
.btn-redo { background: none; border: 1px solid var(--border); border-radius: 20px; padding: 3px 12px; font-size: 10px; color: var(--text); cursor: pointer; font-family: 'DM Mono'; transition: all 0.2s; }
.btn-redo:hover { border-color: var(--gold); color: var(--gold); }

/* Controls */
.controls {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 18px 20px;
  margin-bottom: 20px;
  display: flex; flex-wrap: wrap; gap: 14px; align-items: flex-end;
}
.ctrl { display: flex; flex-direction: column; gap: 6px; min-width: 130px; }
.ctrl label { font-size: 9px; letter-spacing: 1.5px; color: var(--text); text-transform: uppercase; }
.ctrl input, .ctrl select {
  background: var(--ink2);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 8px 12px;
  color: var(--text-bright);
  font-family: 'DM Mono';
  font-size: 12px;
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}
.ctrl input:focus, .ctrl select:focus { border-color: var(--gold); }
.btn-scan {
  background: var(--gold);
  color: var(--ink);
  border: none;
  border-radius: 8px;
  padding: 9px 20px;
  font-family: 'DM Mono';
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  height: 36px;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn-scan:hover { background: var(--gold2); }

/* KPI row */
.kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
@media(max-width: 600px) { .kpi-row { grid-template-columns: repeat(2, 1fr); } }
.kpi {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
}
.kpi-l { font-size: 9px; letter-spacing: 1px; color: var(--text); text-transform: uppercase; margin-bottom: 8px; }
.kpi-v { font-size: 28px; font-weight: 500; color: var(--text-bright); letter-spacing: -1px; }
.kpi-v.g { color: var(--green); }
.kpi-v.w { color: var(--gold); }

/* Results */
.results-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
.results-head {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;
}
.results-title { font-size: 10px; letter-spacing: 2px; color: var(--text); text-transform: uppercase; }
.ftags { display: flex; gap: 6px; }
.ftag { padding: 4px 12px; border-radius: 20px; font-size: 10px; cursor: pointer; border: 1px solid var(--border); color: var(--text); transition: all 0.2s; }
.ftag.active { background: var(--gold-dim); border-color: rgba(200,168,80,0.3); color: var(--gold); }

/* Stock cards */
.cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1px; background: var(--border); }

.stock-card {
  background: var(--ink);
  padding: 20px;
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}
.stock-card:hover { background: var(--ink2); }
.sc-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
.sc-code { font-size: 10px; color: var(--gold); letter-spacing: 1px; margin-bottom: 3px; }
.sc-name { font-family: 'Shippori Mincho', serif; font-size: 16px; color: var(--text-bright); margin-bottom: 3px; }
.sc-sector { font-size: 10px; color: var(--text); }
.sc-price { font-size: 22px; font-weight: 500; color: var(--text-bright); letter-spacing: -0.5px; text-align: right; }

/* Signal */
.sig { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 500; margin-top: 4px; }
.sig.buy { background: var(--green-dim); color: var(--green); border: 1px solid rgba(62,207,142,0.25); }
.sig.buy::before { content: 'â–²'; font-size: 8px; }
.sig.watch { background: var(--gold-dim); color: var(--gold); border: 1px solid rgba(200,168,80,0.25); }
.sig.watch::before { content: 'â—†'; font-size: 8px; }
.sig.hold { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.sig.hold::before { content: 'â€”'; }

/* Metric pills */
.metrics { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
.mp {
  background: var(--ink2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 10px;
  display: flex; flex-direction: column; align-items: center;
  min-width: 58px;
  position: relative;
  cursor: help;
}
.mp-l { font-size: 8px; letter-spacing: 1px; color: var(--text); text-transform: uppercase; margin-bottom: 3px; }
.mp-v { font-size: 13px; font-weight: 500; color: var(--text-bright); }
.mp-v.g { color: var(--green); }
.mp-v.r { color: var(--red); }
.mp-v.w { color: var(--gold); }

/* Tooltip */
.mp[data-tip]:hover::after {
  content: attr(data-tip);
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--ink3);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 10px;
  color: var(--text2);
  line-height: 1.6;
  white-space: nowrap;
  max-width: 220px;
  white-space: normal;
  width: max-content;
  max-width: 200px;
  z-index: 100;
  pointer-events: none;
}
.mp[data-tip]:hover::before {
  content: '';
  position: absolute;
  bottom: calc(100% + 2px);
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: var(--border2);
  z-index: 101;
}

/* Score */
.score-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.score-l { font-size: 9px; letter-spacing: 1px; color: var(--text); text-transform: uppercase; white-space: nowrap; }
.score-track { flex: 1; height: 4px; background: var(--ink3); border-radius: 2px; overflow: hidden; }
.score-fill { height: 100%; border-radius: 2px; transition: width 0.8s ease; }
.score-fill.hi { background: linear-gradient(90deg, var(--green), #50e8a0); }
.score-fill.md { background: linear-gradient(90deg, var(--gold), var(--gold2)); }
.score-fill.lo { background: var(--ink3); }
.score-n { font-size: 12px; font-weight: 500; color: var(--text-bright); width: 28px; text-align: right; }

/* Reasons */
.reasons { display: flex; flex-wrap: wrap; gap: 4px; }
.rtag { font-size: 9px; padding: 2px 8px; border-radius: 4px; font-weight: 500; }
.rtag.ok { background: var(--green-dim); color: var(--green); }
.rtag.ng { background: var(--red-dim); color: var(--red); }

/* Empty/Loading */
.empty { text-align: center; padding: 60px 20px; color: var(--text); font-size: 12px; }
.spinner { display: inline-block; width: 24px; height: 24px; border: 2px solid var(--border2); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Detail panel */
.detail-panel {
  display: none;
  position: fixed; right: 0; top: 0; bottom: 0;
  width: 360px;
  background: var(--ink2);
  border-left: 1px solid var(--border);
  z-index: 300;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 28px;
  animation: slideIn 0.2s ease;
}
@keyframes slideIn { from{transform:translateX(100%)} to{transform:translateX(0)} }
@media(max-width: 600px) { .detail-panel { width: 100%; } }
.detail-panel.open { display: block; }
.d-close { position: absolute; top: 18px; right: 18px; background: none; border: none; color: var(--text); font-size: 18px; cursor: pointer; transition: color 0.2s; line-height: 1; }
.d-close:hover { color: var(--text-bright); }
.d-code { font-size: 10px; color: var(--gold); letter-spacing: 1px; margin-bottom: 3px; }
.d-name { font-family: 'Shippori Mincho', serif; font-size: 22px; color: var(--text-bright); margin-bottom: 4px; }
.d-sec { font-size: 11px; color: var(--text); margin-bottom: 20px; }
.d-kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
.d-kpi { background: var(--ink); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
.d-kpi-l { font-size: 8px; letter-spacing: 1.5px; color: var(--text); text-transform: uppercase; margin-bottom: 5px; }
.d-kpi-v { font-size: 22px; font-weight: 500; color: var(--text-bright); }
.d-kpi-v.g { color: var(--green); }
.d-kpi-v.w { color: var(--gold); }
.d-section { background: var(--ink); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 8px; }
.d-section-title { font-size: 9px; letter-spacing: 1.5px; color: var(--text); text-transform: uppercase; margin-bottom: 10px; }
.d-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 12px; }
.d-row:last-child { margin-bottom: 0; }
.d-row-l { color: var(--text); }
.d-note { font-size: 10px; color: var(--text); line-height: 1.8; border-top: 1px solid var(--border); padding-top: 12px; margin-top: 8px; }

/* Disclaimer */
.disclaimer { margin-top: 20px; padding: 14px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; font-size: 10px; color: var(--text); line-height: 1.8; }

/* Mobile-friendly scrolling for overlay content */
@media(max-width: 600px) {
  .qz-wrap { border-radius: 16px; }
  .idx-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<!-- ===== MARKET SUMMARY ===== -->
<div class="overlay" id="summaryOverlay">
  <div class="ms-wrap">
    <div class="ms-eyebrow">å¸‚å ´ã‚µãƒãƒªãƒ¼</div>
    <div class="ms-headline">ä»Šæ—¥ã¯è²·ã„å ´ãŒ<br>æ¥ã¦ã„ã‚‹ã®ã‹ï¼Ÿ</div>
    <div class="ms-sub" id="todayDate"></div>

    <div class="vibe-card neutral" id="vibeCard">
      <div class="vibe-emoji" id="vibeEmoji">âš ï¸</div>
      <div>
        <div class="vibe-label" id="vibeLabel">ã‚„ã‚„è»Ÿèª¿ â€” æŠ¼ã—ç›®ãƒãƒ£ãƒ³ã‚¹å¢—åŠ ä¸­</div>
        <div class="vibe-desc" id="vibeDesc">æ—¥çµŒå¹³å‡ãŒ25æ—¥ç§»å‹•å¹³å‡ç·šä»˜è¿‘ã§æ¨ç§»ä¸­ã€‚å€‹åˆ¥éŠ˜æŸ„ã®é¸åˆ¥ãŒå¤§åˆ‡ãªå±€é¢ã§ã™ã€‚</div>
      </div>
    </div>

    <div class="idx-grid">
      <div class="idx-card">
        <div class="idx-name">æ—¥çµŒå¹³å‡</div>
        <div class="idx-val">38,240</div>
        <div class="idx-chg dn">â–¼ -312 (-0.81%)</div>
        <div class="idx-spark" id="sp0"></div>
      </div>
      <div class="idx-card">
        <div class="idx-name">TOPIX</div>
        <div class="idx-val">2,718</div>
        <div class="idx-chg dn">â–¼ -18 (-0.66%)</div>
        <div class="idx-spark" id="sp1"></div>
      </div>
      <div class="idx-card">
        <div class="idx-name">ãƒ‰ãƒ«å††</div>
        <div class="idx-val">149.82</div>
        <div class="idx-chg up">â–² +0.34</div>
        <div class="idx-spark" id="sp2"></div>
      </div>
      <div class="idx-card">
        <div class="idx-name">VIX <span style="font-size:9px;color:var(--text)">(ææ€–æŒ‡æ•°)</span></div>
        <div class="idx-val">18.4</div>
        <div class="idx-chg dn">â–² +1.2 <span style="color:var(--text);font-size:9px">é«˜ã„ã»ã©ä¸å®‰å®š</span></div>
        <div class="idx-spark" id="sp3"></div>
      </div>
      <div class="idx-card">
        <div class="idx-name">10å¹´å‚µåˆ©å›ã‚Š</div>
        <div class="idx-val">1.08%</div>
        <div class="idx-chg up">â–² +0.02%</div>
        <div class="idx-spark" id="sp4"></div>
      </div>
      <div class="idx-card">
        <div class="idx-name">æ±è¨¼ å£²è²·ä»£é‡‘</div>
        <div class="idx-val">3.8å…†å††</div>
        <div class="idx-chg dn">â–¼ å‰æ—¥æ¯” -0.4å…†</div>
        <div class="idx-spark" id="sp5"></div>
      </div>
    </div>

    <div class="stats-strip">
      <div class="stat-tile"><div class="stat-l">æŠ¼ã—ç›®å€™è£œ</div><div class="stat-v g">12éŠ˜æŸ„</div></div>
      <div class="stat-tile"><div class="stat-l">å‰æ—¥æ¯”å¤‰åŒ–</div><div class="stat-v w">+3å¢—åŠ </div></div>
      <div class="stat-tile"><div class="stat-l">é«˜é…å½“4%è¶…</div><div class="stat-v g">8éŠ˜æŸ„</div></div>
      <div class="stat-tile"><div class="stat-l">å£²ã‚‰ã‚Œã™ã</div><div class="stat-v w">5éŠ˜æŸ„</div></div>
    </div>

    <div class="ai-box">
      <div class="ai-box-label"><div class="ai-dot"></div>AI ã‚³ãƒ¡ãƒ³ãƒˆ</div>
      <div class="ai-text" id="aiText"></div>
    </div>

    <button class="btn-start" onclick="startQuiz()">ã“ã®çŠ¶æ³ã‚’è¸ã¾ãˆã¦è³ªå•ã«ç­”ãˆã‚‹ â†’</button>
  </div>
</div>

<!-- ===== QUIZ ===== -->
<div class="overlay hidden" id="quizOverlay">
  <div class="qz-wrap">
    <div class="qz-step" id="qzStep">STEP 1 / 3</div>
    <div class="qz-bar" id="qzBar"></div>
    <div class="qz-q" id="qzQ"></div>
    <div class="qz-hint" id="qzHint"></div>
    <div class="qz-opts" id="qzOpts"></div>
    <div class="qz-nav">
      <button class="btn-back" id="qzBack" onclick="quizBack()">â† æˆ»ã‚‹</button>
      <button class="btn-next" id="qzNext" onclick="quizNext()" disabled>æ¬¡ã¸ â†’</button>
    </div>
  </div>
</div>

<!-- ===== MAIN APP ===== -->
<div class="app">
  <div class="app-header">
    <div class="app-logo">æŠ¼ã—ç›®<span>ãƒãƒ³ã‚¿ãƒ¼</span></div>
    <div class="app-meta">
      <div class="live-dot"></div>
      <span id="lastUpdate">æº–å‚™å®Œäº†</span>
      <span>|</span>
      <span id="dataSource" style="color:var(--text)">ãƒ‡ãƒ¼ã‚¿ç¢ºèªä¸­...</span>
    </div>
  </div>

  <div class="badges" id="badges">
    <span style="font-size:9px;color:var(--text);letter-spacing:1px">è¨­å®š:</span>
  </div>

  <div class="controls">
    <div class="ctrl">
      <label>MAä¹–é›¢ ã—ãã„å€¤</label>
      <input type="number" id="maThreshold" value="-5" max="0" step="0.5">
    </div>
    <div class="ctrl">
      <label>æœ€ä½é…å½“åˆ©å›ã‚Š</label>
      <input type="number" id="minDividend" value="2.5" min="0" step="0.1">
    </div>
    <div class="ctrl">
      <label>RSI ä¸Šé™</label>
      <input type="number" id="maxRsi" value="40" min="10" max="60">
    </div>
    <div class="ctrl">
      <label>ä¸¦ã³æ›¿ãˆ</label>
      <select id="sortBy">
        <option value="score">ç·åˆã‚¹ã‚³ã‚¢é †</option>
        <option value="deviation">ä¹–é›¢ç‡é †</option>
        <option value="dividend">é…å½“åˆ©å›ã‚Šé †</option>
        <option value="rsi">RSIé †</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;align-items:flex-end;">
      <button class="btn-scan" id="scanBtn" onclick="runScan()">â–¶ ã‚¹ã‚­ãƒ£ãƒ³</button>
      <button class="btn-redo" onclick="resetToSummary()">â†º æœ€åˆã‹ã‚‰</button>
    </div>
  </div>

  <div class="kpi-row">
    <div class="kpi"><div class="kpi-l">ã‚¹ã‚­ãƒ£ãƒ³éŠ˜æŸ„</div><div class="kpi-v" id="kpiTotal">â€”</div></div>
    <div class="kpi"><div class="kpi-l">æŠ¼ã—ç›®è²·ã„å€™è£œ</div><div class="kpi-v g" id="kpiBuy">â€”</div></div>
    <div class="kpi"><div class="kpi-l">è¦æ³¨ç›®</div><div class="kpi-v w" id="kpiWatch">â€”</div></div>
    <div class="kpi"><div class="kpi-l">å¹³å‡é…å½“åˆ©å›ã‚Š</div><div class="kpi-v" id="kpiDiv">â€”</div></div>
  </div>

  <div class="results-wrap">
    <div class="results-head">
      <div class="results-title">ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°çµæœ</div>
      <div class="ftags">
        <div class="ftag active" onclick="setFilter('all',this)">ã™ã¹ã¦</div>
        <div class="ftag" onclick="setFilter('buy',this)">æŠ¼ã—ç›®è²·ã„</div>
        <div class="ftag" onclick="setFilter('watch',this)">è¦æ³¨ç›®</div>
      </div>
    </div>
    <div id="resultsBody"><div class="empty">ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div></div>
  </div>

  <div class="disclaimer">
    âš ï¸ ãƒ‡ãƒ¢ç‰ˆ â€” æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã¯ã‚µãƒ³ãƒ—ãƒ«å€¤ã§ã™ã€‚å®Ÿé‹ç”¨ã«ã¯ fetch_stocks.py ã«ã‚ˆã‚‹å®Ÿãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå¿…è¦ã§ã™ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚
  </div>
</div>

<!-- Detail Panel -->
<div class="detail-panel" id="detailPanel">
  <button class="d-close" onclick="closeDetail()">âœ•</button>
  <div id="detailContent"></div>
</div>

<script>
// ===== SPARKS =====
function buildSpark(elId, data, dir) {
  const el = document.getElementById(elId);
  if(!el) return;
  const mx=Math.max(...data), mn=Math.min(...data);
  el.innerHTML = data.map((v,i)=>{
    const h = mn===mx ? 10 : 3+((v-mn)/(mx-mn))*15;
    const isLast = i===data.length-1;
    const col = isLast ? (dir==='up'?'var(--green)':'var(--red)') : 'rgba(255,255,255,0.1)';
    return `<div class="spark-b" style="height:${h}px;background:${col}"></div>`;
  }).join('');
}
const SPARKS = [
  [[41,38,36,39,37,35,34,36,35,33],'dn'],
  [[42,40,39,40,38,37,36,38,37,35],'dn'],
  [[30,31,33,30,32,34,33,35,34,36],'up'],
  [[28,26,25,27,26,30,31,29,32,33],'dn'],
  [[30,31,31,32,31,33,34,33,35,36],'up'],
  [[38,42,40,44,38,36,40,38,35,32],'dn'],
];
SPARKS.forEach(([d,dir],i) => buildSpark('sp'+i, d, dir));

// Date
const d = new Date();
const days=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
document.getElementById('todayDate').textContent =
  `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${days[d.getDay()]}ï¼‰`;

// AI comments
const AI = [
  'æ˜¨æ—¥ãƒ»ä¸€æ˜¨æ—¥ã¨æ—¥çµŒå¹³å‡ãŒç¶šè½ã—ã€<strong>25æ—¥ç§»å‹•å¹³å‡ç·šã‚’å‰²ã‚Šè¾¼ã‚“ã </strong>çŠ¶æ…‹ã§ã™ã€‚éŠ€è¡Œãƒ»å•†ç¤¾ã‚’ä¸­å¿ƒã«RSI30ä»¥ä¸‹ã®éŠ˜æŸ„ãŒå¢—ãˆã¦ãŠã‚Šã€é«˜é…å½“ã®å®‰å®šæ ªã«ã¯æŠ¼ã—ç›®å½¢æˆã®ãƒãƒ£ãƒ³ã‚¹ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚',
  'VIXãŒ18å°ã«ä¸Šæ˜‡ã—ã€å¸‚å ´ã®ã‚„ã‚„ä¸å®‰å®šæ„ŸãŒå¢—ã—ã¦ã„ã¾ã™ã€‚ãŸã ã—<strong>çŸ­æœŸç­‹ã®ãƒã‚¸ã‚·ãƒ§ãƒ³èª¿æ•´</strong>ã®å¯èƒ½æ€§ãŒé«˜ãã€ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ã‚ºãŒè‰¯å¥½ãªé«˜é…å½“éŠ˜æŸ„ã¯ä¸‹å€¤ãŒé™å®šçš„ã¨è¦‹ã‚‰ã‚Œã¾ã™ã€‚',
  'å‡ºæ¥é«˜ã¯å‰æ—¥æ¯”ã‚„ã‚„æ¸›å°‘ã—ã¦ãŠã‚Šã€<strong>ä»•æ‰‹çš„ãªå‹•ãã¯å°‘ãªã„ç’°å¢ƒ</strong>ã§ã™ã€‚å®‰å®šå¿—å‘ã®æŠ¼ã—ç›®è²·ã„æˆ¦ç•¥ã«ã¯é©ã—ãŸåœ°åˆã„ã¨åˆ¤æ–­ã—ã¾ã™ã€‚',
];
document.getElementById('aiText').innerHTML = AI[Math.floor(Math.random()*AI.length)];

// ===== QUIZ =====
const QUIZ = [
  {
    id:'market', q:'ä»Šæ—¥ã®ç›¸å ´ã‚’ã©ã†æ„Ÿã˜ã¦ã„ã¾ã™ã‹ï¼Ÿ',
    hint:'å¸‚å ´ã‚µãƒãƒªãƒ¼ã‚’è¦‹ã¦ã€ä»Šã®åœ°åˆã„ã«ã¤ã„ã¦ã©ã†æ€ã„ã¾ã™ã‹ï¼Ÿç›´æ„Ÿã§OKã§ã™ã€‚',
    opts:[
      {ico:'ğŸ“ˆ', t:'ã¾ã ä¸ŠãŒã‚Šãã†', d:'åœ°åˆã„ã¯æ‚ªããªã„ã€‚æŠ¼ã—ã‚’ã—ã£ã‹ã‚Šæ‹¾ã„ãŸã„', v:'bull'},
      {ico:'ğŸ“‰', t:'ä¸‹ãŒã‚Šãã†ã§æ€–ã„', d:'è»Ÿèª¿ãªåœ°åˆã„ã€‚æ·±ã„æŠ¼ã—ã‚’ã‚‚ã†å°‘ã—å¾…ã¡ãŸã„', v:'bear'},
      {ico:'â¡ï¸', t:'æ§˜å­ã‚’è¦‹ãŸã„', d:'æ–¹å‘æ„ŸãŒå‡ºã‚‹ã¾ã§æ…é‡ã«ã€‚å®‰å®šå¿—å‘ã§è¡Œã', v:'flat'},
      {ico:'ğŸ¯', t:'æ„Ÿè¦šã‚ˆã‚Šæ•°å­—ã§æ±ºã‚ãŸã„', d:'ç›¸å ´è¦³ã‚ˆã‚Šæ¡ä»¶ã ã‘ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹', v:'neutral'},
    ]
  },
  {
    id:'priority', q:'ä»Šå›ã€ä½•ã‚’ä¸€ç•ªé‡è¦–ã—ã¾ã™ã‹ï¼Ÿ',
    hint:'ã‚ãªãŸã®ã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ã¦ã‚¹ã‚³ã‚¢ã®é‡ã¿ä»˜ã‘ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚',
    opts:[
      {ico:'ğŸ’°', t:'é…å½“ã‚’ãŸãã•ã‚“ã‚‚ã‚‰ã„ãŸã„', d:'æ¯å¹´ã®é…å½“åå…¥ã‚’æœ€å¤§åŒ–ã—ãŸã„ï¼ˆã‚¤ãƒ³ã‚«ãƒ ã‚²ã‚¤ãƒ³é‡è¦–ï¼‰', v:'dividend'},
      {ico:'ğŸ“Š', t:'å¤§ããä¸‹ãŒã£ãŸæ ªã‚’æ‹¾ã„ãŸã„', d:'ç§»å‹•å¹³å‡ã‹ã‚‰å¤§ããé›¢ã‚ŒãŸéŠ˜æŸ„ã‚’åº•å€¤åœã§ä»•è¾¼ã‚€', v:'deviation'},
      {ico:'ğŸ›¡ï¸', t:'æœ¬è³ªçš„ã«å®‰ã„æ ªã‚’è²·ã„ãŸã„', d:'PBRãƒ»PERã§å‰²å®‰ãªéŠ˜æŸ„ã‚’æ¢ã™ï¼ˆãƒãƒªãƒ¥ãƒ¼æŠ•è³‡ï¼‰', v:'value'},
      {ico:'âš–ï¸', t:'ãƒãƒ©ãƒ³ã‚¹ã‚ˆãåˆ¤æ–­ã—ãŸã„', d:'å…¨æŒ‡æ¨™ã‚’ã¾ã‚“ã¹ã‚“ãªãè¦‹ã¦ç·åˆçš„ã«æ±ºã‚ã‚‹', v:'balance'},
    ]
  },
  {
    id:'horizon', q:'ã©ã®ãã‚‰ã„ã®æœŸé–“ æŒã¤ã¤ã‚‚ã‚Šã§ã™ã‹ï¼Ÿ',
    hint:'ä¿æœ‰æœŸé–“ã«ã‚ˆã£ã¦ã€å‚ç…§ã™ã‚‹ç§»å‹•å¹³å‡ç·šã®ã—ãã„å€¤ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚',
    opts:[
      {ico:'âš¡', t:'æ•°æ—¥ã€œ1é€±é–“ãã‚‰ã„', d:'25æ—¥ç§»å‹•å¹³å‡ç·šã‚’é‡è¦–ã€‚çŸ­æœŸã®åç™ºã‚’ç‹™ã†', v:'short'},
      {ico:'ğŸ“…', t:'æ•°é€±é–“ã€œ1ãƒ¶æœˆãã‚‰ã„', d:'25æ—¥ãƒ»75æ—¥ã®ä¸¡æ–¹ã‚’å‚ç…§ã€‚ä¸­çŸ­æœŸã®ã‚¹ã‚¦ã‚£ãƒ³ã‚°', v:'mid'},
      {ico:'ğŸŒ±', t:'æ•°ãƒ¶æœˆä»¥ä¸Š', d:'é…å½“ã¨75æ—¥ç§»å‹•å¹³å‡ã‚’é‡è¦–ã€‚è…°ã‚’æ®ãˆãŸä¸­æœŸä¿æœ‰', v:'long'},
    ]
  }
];

let qStep=0, qAnswers={};

function startQuiz() {
  document.getElementById('summaryOverlay').classList.add('hidden');
  document.getElementById('quizOverlay').classList.remove('hidden');
  qStep=0; qAnswers={};
  renderQuiz();
}

function renderQuiz() {
  const q=QUIZ[qStep];
  document.getElementById('qzStep').textContent=`STEP ${qStep+1} / ${QUIZ.length}`;
  document.getElementById('qzBar').innerHTML=QUIZ.map((_,i)=>
    `<div class="qz-seg ${i<qStep?'done':i===qStep?'active':''}"></div>`).join('');
  document.getElementById('qzQ').textContent=q.q;
  document.getElementById('qzHint').textContent=q.hint;
  const sel=qAnswers[q.id];
  document.getElementById('qzOpts').innerHTML=q.opts.map(o=>`
    <div class="qz-opt ${sel===o.v?'sel':''}" onclick="selectOpt('${o.v}',this)">
      <div class="qz-opt-ico">${o.ico}</div>
      <div>
        <div class="qz-opt-t">${o.t}</div>
        <div class="qz-opt-d">${o.d}</div>
      </div>
    </div>`).join('');
  document.getElementById('qzBack').style.visibility=qStep===0?'hidden':'visible';
  document.getElementById('qzNext').textContent=qStep===QUIZ.length-1?'ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ â–¶':'æ¬¡ã¸ â†’';
  document.getElementById('qzNext').disabled=!sel;
}

function selectOpt(val, el) {
  qAnswers[QUIZ[qStep].id]=val;
  document.querySelectorAll('.qz-opt').forEach(o=>o.classList.remove('sel'));
  el.classList.add('sel');
  document.getElementById('qzNext').disabled=false;
}
function quizBack() { if(qStep>0){qStep--;renderQuiz();} }
function quizNext() {
  if(qStep<QUIZ.length-1){qStep++;renderQuiz();}
  else {
    document.getElementById('quizOverlay').classList.add('hidden');
    applyAnswers(); showBadges(); runScan();
  }
}

function applyAnswers() {
  const {market,priority,horizon}=qAnswers;
  document.getElementById('maxRsi').value={bull:35,bear:45,flat:40,neutral:40}[market]||40;
  document.getElementById('sortBy').value={dividend:'dividend',deviation:'deviation',value:'score',balance:'score'}[priority]||'score';
  document.getElementById('maThreshold').value={short:-4,mid:-5,long:-6}[horizon]||-5;
}

function showBadges() {
  const L={
    market:{bull:'ğŸ“ˆ ä¸Šæ˜‡ä½™åœ°ã‚ã‚Š',bear:'ğŸ“‰ ä¸‹è½è­¦æˆ’',flat:'â¡ï¸ æ§˜å­è¦‹',neutral:'ğŸ¯ æ•°å­—ã§åˆ¤æ–­'},
    priority:{dividend:'ğŸ’° é…å½“é‡è¦–',deviation:'ğŸ“Š ä¹–é›¢é‡è¦–',value:'ğŸ›¡ï¸ å‰²å®‰é‡è¦–',balance:'âš–ï¸ ãƒãƒ©ãƒ³ã‚¹'},
    horizon:{short:'âš¡ æ•°æ—¥',mid:'ğŸ“… æ•°é€±é–“',long:'ğŸŒ± æ•°ãƒ¶æœˆ'},
  };
  const el=document.getElementById('badges');
  el.querySelectorAll('.badge').forEach(e=>e.remove());
  Object.entries(qAnswers).forEach(([k,v])=>{
    const b=document.createElement('span');
    b.className='badge'; b.textContent=L[k]?.[v]||v; el.appendChild(b);
  });
  el.classList.add('show');
}

function resetToSummary() {
  document.getElementById('summaryOverlay').classList.remove('hidden');
}

// ===== STOCK DATA =====
const DEMO=[
  {code:'8306',name:'ä¸‰è±UFJãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«',sector:'éŠ€è¡Œ',price:1423,ma25:1520,ma75:1580,rsi:32,dividend:3.8,pbr:0.7,per:9.2,vol_r:0.8},
  {code:'9432',name:'NTT',sector:'é€šä¿¡',price:163,ma25:168,ma75:172,rsi:38,dividend:3.2,pbr:1.1,per:11.5,vol_r:0.9},
  {code:'8058',name:'ä¸‰è±å•†äº‹',sector:'å•†ç¤¾',price:2890,ma25:3050,ma75:3200,rsi:29,dividend:4.1,pbr:0.9,per:8.7,vol_r:0.7},
  {code:'4502',name:'æ­¦ç”°è–¬å“å·¥æ¥­',sector:'åŒ»è–¬å“',price:3820,ma25:3960,ma75:4050,rsi:41,dividend:5.6,pbr:1.3,per:15.2,vol_r:1.1},
  {code:'8001',name:'ä¼Šè—¤å¿ å•†äº‹',sector:'å•†ç¤¾',price:6780,ma25:7050,ma75:7200,rsi:33,dividend:3.5,pbr:1.8,per:12.3,vol_r:0.6},
  {code:'7203',name:'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š',sector:'è‡ªå‹•è»Š',price:2650,ma25:2720,ma75:2800,rsi:36,dividend:3.0,pbr:1.1,per:10.4,vol_r:0.9},
  {code:'8316',name:'ä¸‰äº•ä½å‹FG',sector:'éŠ€è¡Œ',price:7100,ma25:7600,ma75:7800,rsi:28,dividend:4.2,pbr:0.8,per:9.0,vol_r:0.7},
  {code:'2914',name:'JTï¼ˆæ—¥æœ¬ãŸã°ã“ï¼‰',sector:'é£Ÿå“',price:3680,ma25:3780,ma75:3820,rsi:35,dividend:6.2,pbr:1.6,per:13.8,vol_r:0.8},
  {code:'9020',name:'JRæ±æ—¥æœ¬',sector:'é‰„é“',price:8150,ma25:8300,ma75:8450,rsi:42,dividend:2.1,pbr:1.4,per:14.2,vol_r:0.9},
  {code:'8411',name:'ã¿ãšã»FG',sector:'éŠ€è¡Œ',price:2680,ma25:2850,ma75:2950,rsi:31,dividend:3.9,pbr:0.7,per:8.5,vol_r:0.8},
  {code:'9433',name:'KDDI',sector:'é€šä¿¡',price:4350,ma25:4500,ma75:4600,rsi:37,dividend:3.3,pbr:1.9,per:13.5,vol_r:1.0},
  {code:'5108',name:'ãƒ–ãƒªãƒ‚ã‚¹ãƒˆãƒ³',sector:'ã‚´ãƒ ',price:5100,ma25:5280,ma75:5350,rsi:40,dividend:3.8,pbr:1.2,per:11.8,vol_r:0.8},
];
let STOCKS=[...DEMO];

async function loadData() {
  try {
    const r=await fetch('stocks_data.json');
    if(!r.ok) throw new Error();
    const j=await r.json();
    if(j.stocks?.length>0){
      STOCKS=j.stocks;
      document.getElementById('dataSource').textContent=`ğŸ“¡ å®Ÿãƒ‡ãƒ¼ã‚¿ (${j.updated_at})`;
      document.getElementById('dataSource').style.color='var(--green)';
    }
  } catch{
    document.getElementById('dataSource').textContent='âš ï¸ ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼ˆfetch_stocks.py ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼‰';
    document.getElementById('dataSource').style.color='var(--gold)';
  }
}
loadData();

// ===== SCORING =====
function dv(p,m){return +((p-m)/m*100).toFixed(1);}

function calcScore(s){
  let sc=0;
  const p=qAnswers.priority||'balance';
  const d25=dv(s.price,s.ma25);
  const db=p==='dividend'?10:0, devb=p==='deviation'?10:0, valb=p==='value'?10:0;
  if(s.dividend>=5.0)sc+=30+db;
  else if(s.dividend>=4.5)sc+=25+db;
  else if(s.dividend>=4.0)sc+=20+db;
  else if(s.dividend>=3.5)sc+=15+db;
  else if(s.dividend>=3.0)sc+=10+db;
  else if(s.dividend>=2.5)sc+=5;
  if(d25<=-7)sc+=25+devb;
  else if(d25<=-5)sc+=18+devb;
  else if(d25<=-3)sc+=8;
  if(s.rsi<=30)sc+=20;
  else if(s.rsi<=35)sc+=14;
  else if(s.rsi<=40)sc+=8;
  if(s.pbr<=0.8)sc+=15+valb;
  else if(s.pbr<=1.0)sc+=10+valb;
  else if(s.pbr<=1.5)sc+=4;
  if(s.per<=10)sc+=10;
  else if(s.per<=13)sc+=7;
  else if(s.per<=15)sc+=4;
  if(s.vol_r>=1.5)sc-=20;
  if(qAnswers.market==='bear'&&d25<=-7)sc+=5;
  return Math.max(0,Math.min(sc,100));
}

function getSig(sc){
  if(sc>=55)return{label:'æŠ¼ã—ç›®è²·ã„',cls:'buy'};
  if(sc>=30)return{label:'è¦æ³¨ç›®',cls:'watch'};
  return{label:'æ§˜å­è¦‹',cls:'hold'};
}

let processed=[], currentFilter='all';

function runScan(){
  const btn=document.getElementById('scanBtn');
  btn.disabled=true; btn.textContent='âŸ³ åˆ†æä¸­...';
  document.getElementById('resultsBody').innerHTML=`<div class="empty"><div class="spinner"></div><div>éŠ˜æŸ„ã‚’åˆ†æã—ã¦ã„ã¾ã™...</div></div>`;
  setTimeout(()=>{
    const cfg={
      ma:parseFloat(document.getElementById('maThreshold').value),
      div:parseFloat(document.getElementById('minDividend').value),
      rsi:parseFloat(document.getElementById('maxRsi').value),
      sort:document.getElementById('sortBy').value,
    };
    processed=STOCKS.map(s=>{
      const d25=dv(s.price,s.ma25),d75=dv(s.price,s.ma75);
      const score=calcScore(s);
      return{...s,d25,d75,score,sig:getSig(score)};
    }).filter(s=>s.d25<=cfg.ma&&s.dividend>=cfg.div&&s.rsi<=cfg.rsi);
    const sf={score:(a,b)=>b.score-a.score,deviation:(a,b)=>a.d25-b.d25,dividend:(a,b)=>b.dividend-a.dividend,rsi:(a,b)=>a.rsi-b.rsi};
    processed.sort(sf[cfg.sort]||sf.score);
    const buyN=processed.filter(s=>s.sig.cls==='buy').length;
    const watchN=processed.filter(s=>s.sig.cls==='watch').length;
    const avgDiv=processed.length>0?(processed.reduce((a,s)=>a+s.dividend,0)/processed.length).toFixed(1):'â€”';
    document.getElementById('kpiTotal').textContent=STOCKS.length;
    document.getElementById('kpiBuy').textContent=buyN;
    document.getElementById('kpiWatch').textContent=watchN;
    document.getElementById('kpiDiv').textContent=processed.length>0?avgDiv+'%':'â€”';
    const now=new Date();
    document.getElementById('lastUpdate').textContent=
      `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')} æ›´æ–° â€” ${STOCKS.length}éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†`;
    renderResults();
    btn.disabled=false; btn.textContent='â–¶ ã‚¹ã‚­ãƒ£ãƒ³';
  },900);
}

// Tooltip labels
const TIPS={
  'd25':'25æ—¥ç§»å‹•å¹³å‡ç·šã‹ã‚‰ã®ä¹–é›¢ç‡ã€‚ãƒã‚¤ãƒŠã‚¹ã»ã©ã€Œå¹³å‡ã‚ˆã‚Šå®‰ã„ã€çŠ¶æ…‹ã€‚-5%ä»¥ä¸‹ã§æŠ¼ã—ç›®ã®ç›®å®‰ã€‚',
  'rsi':'RSIï¼ˆç›¸å¯¾åŠ›æŒ‡æ•°ï¼‰ã€‚30ä»¥ä¸‹ã§ã€Œå£²ã‚‰ã‚Œã™ãã€ã®ã‚·ã‚°ãƒŠãƒ«ã€‚åç™ºã—ã‚„ã™ã„æ°´æº–ã€‚',
  'div':'é…å½“åˆ©å›ã‚Šã€‚æ ªä¾¡ã«å¯¾ã—ã¦å¹´é–“ã„ãã‚‰é…å½“ã‚’ã‚‚ã‚‰ãˆã‚‹ã‹ã®å‰²åˆã€‚é«˜ã„ã»ã©åå…¥ã«ãªã‚‹ã€‚',
  'pbr':'PBRï¼ˆæ ªä¾¡ç´”è³‡ç”£å€ç‡ï¼‰ã€‚1å€ä»¥ä¸‹ã¯ã€Œå¸³ç°¿ä¸Šã®ä¾¡å€¤ã‚ˆã‚Šå®‰ã„ã€= å‰²å®‰ã®ã‚µã‚¤ãƒ³ã€‚',
  'per':'PERï¼ˆæ ªä¾¡åç›Šç‡ï¼‰ã€‚ä¼šç¤¾ã®ç¨¼ãã«å¯¾ã—ã¦æ ªä¾¡ãŒä½•å€ã‹ã‚’ç¤ºã™ã€‚ä½ã„ã»ã©å‰²å®‰ã€‚',
};

function renderResults(){
  const list=currentFilter==='all'?processed:processed.filter(s=>s.sig.cls===currentFilter);
  if(list.length===0){
    document.getElementById('resultsBody').innerHTML=`<div class="empty">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“<br><span style="font-size:10px;margin-top:6px;display:block;color:var(--text)">æ¡ä»¶ã‚’ç·©ã‚ã‚‹ã‹ã€Œæœ€åˆã‹ã‚‰ã€ã§ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„</span></div>`;
    return;
  }
  const cards=list.map(s=>{
    const sc=s.score>=55?'hi':s.score>=30?'md':'lo';
    const d25c=s.d25<0?'g':'r';
    const reasons=[];
    if(s.d25<=-7)reasons.push({t:'å¼·ã„æŠ¼ã—ç›®',ok:true});
    else if(s.d25<=-5)reasons.push({t:'æŠ¼ã—ç›®ã‚ã‚Š',ok:true});
    if(s.rsi<=30)reasons.push({t:'å¼·ã„å£²ã‚‰ã‚Œã™ã',ok:true});
    else if(s.rsi<=40)reasons.push({t:'å£²ã‚‰ã‚Œã™ã',ok:true});
    if(s.dividend>=4.5)reasons.push({t:'é«˜é…å½“ â—',ok:true});
    else if(s.dividend>=2.5)reasons.push({t:'é«˜é…å½“',ok:true});
    if(s.pbr<=0.8)reasons.push({t:'å‰²å®‰ â—',ok:true});
    else if(s.pbr<=1.0)reasons.push({t:'å‰²å®‰',ok:true});
    if(s.per<=13)reasons.push({t:'PERå‰²å®‰',ok:true});
    if(s.vol_r>=1.5)reasons.push({t:'âš  å‡ºæ¥é«˜æ€¥å¢—',ok:false});
    return `
    <div class="stock-card" onclick="showDetail('${s.code}')">
      <div class="sc-top">
        <div>
          <div class="sc-code">${s.code}</div>
          <div class="sc-name">${s.name}</div>
          <div class="sc-sector">${s.sector}</div>
        </div>
        <div style="text-align:right">
          <div class="sc-price">Â¥${s.price.toLocaleString()}</div>
          <div style="margin-top:4px"><span class="sig ${s.sig.cls}">${s.sig.label}</span></div>
        </div>
      </div>
      <div class="metrics">
        <div class="mp" data-tip="${TIPS.d25}"><div class="mp-l">25MAä¹–é›¢</div><div class="mp-v ${d25c}">${s.d25>0?'+':''}${s.d25}%</div></div>
        <div class="mp" data-tip="${TIPS.rsi}"><div class="mp-l">RSI</div><div class="mp-v ${s.rsi<=30?'g':s.rsi>=50?'r':''}">${s.rsi}</div></div>
        <div class="mp" data-tip="${TIPS.div}"><div class="mp-l">é…å½“</div><div class="mp-v w">${s.dividend}%</div></div>
        <div class="mp" data-tip="${TIPS.pbr}"><div class="mp-l">PBR</div><div class="mp-v ${s.pbr<=1.0?'g':''}">${s.pbr}å€</div></div>
        <div class="mp" data-tip="${TIPS.per}"><div class="mp-l">PER</div><div class="mp-v ${s.per<=13?'g':''}">${s.per}å€</div></div>
      </div>
      <div class="score-row">
        <div class="score-l">ã‚¹ã‚³ã‚¢</div>
        <div class="score-track"><div class="score-fill ${sc}" style="width:${s.score}%"></div></div>
        <div class="score-n">${s.score}</div>
      </div>
      <div class="reasons">
        ${reasons.map(r=>`<span class="rtag ${r.ok?'ok':'ng'}">${r.t}</span>`).join('')}
      </div>
    </div>`;
  }).join('');
  document.getElementById('resultsBody').innerHTML=`<div class="cards-grid">${cards}</div>`;
}

function setFilter(f,el){
  currentFilter=f;
  document.querySelectorAll('.ftag').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  if(processed.length>0)renderResults();
}

// ===== DETAIL =====
function showDetail(code){
  const s=processed.find(x=>x.code===code);
  if(!s)return;
  const bars=Array.from({length:20},(_,i)=>{
    const h=24+Math.random()*40;
    const col=i>14?'rgba(200,168,80,0.4)':'rgba(255,255,255,0.06)';
    return `<div style="flex:1;height:${h}px;background:${col};border-radius:1px 1px 0 0;min-height:3px"></div>`;
  }).join('');

  const ri=[];
  if(s.d25<=-7)ri.push({l:'25MAä¹–é›¢ï¼ˆå¼·ã„æŠ¼ã—ç›®ï¼‰',v:s.d25+'%',ok:true});
  else if(s.d25<=-5)ri.push({l:'25MAä¹–é›¢ï¼ˆæŠ¼ã—ç›®ã‚ã‚Šï¼‰',v:s.d25+'%',ok:true});
  if(s.rsi<=30)ri.push({l:'RSI å¼·ã„å£²ã‚‰ã‚Œã™ã',v:s.rsi,ok:true});
  else if(s.rsi<=40)ri.push({l:'RSI å£²ã‚‰ã‚Œã™ã',v:s.rsi,ok:true});
  if(s.dividend>=4.5)ri.push({l:'é«˜é…å½“ï¼ˆå„ªç§€ï¼‰',v:s.dividend+'%',ok:true});
  else if(s.dividend>=2.5)ri.push({l:'é«˜é…å½“',v:s.dividend+'%',ok:true});
  if(s.pbr<=0.8)ri.push({l:'PBR å¼·ã„å‰²å®‰',v:s.pbr+'å€',ok:true});
  else if(s.pbr<=1.0)ri.push({l:'PBR å‰²å®‰',v:s.pbr+'å€',ok:true});
  if(s.per<=13)ri.push({l:'PER å‰²å®‰',v:s.per+'å€',ok:true});
  if(s.vol_r>=1.5)ri.push({l:'âš  å‡ºæ¥é«˜ãŒæ€¥å¢—ä¸­',v:'x'+s.vol_r,ok:false});

  document.getElementById('detailContent').innerHTML=`
    <div style="margin-bottom:24px">
      <div class="d-code">${s.code} | ${s.sector}</div>
      <div class="d-name">${s.name}</div>
      <div class="d-sec">ã‚·ã‚°ãƒŠãƒ«: <span class="sig ${s.sig.cls}" style="font-size:10px">${s.sig.label}</span></div>
    </div>
    <div class="d-kpi-grid">
      <div class="d-kpi"><div class="d-kpi-l">ç¾åœ¨å€¤</div><div class="d-kpi-v">Â¥${s.price.toLocaleString()}</div></div>
      <div class="d-kpi"><div class="d-kpi-l">é…å½“åˆ©å›ã‚Š</div><div class="d-kpi-v g">${s.dividend}%</div></div>
      <div class="d-kpi"><div class="d-kpi-l">RSI</div><div class="d-kpi-v ${s.rsi<=35?'g':''}">${s.rsi}</div></div>
      <div class="d-kpi"><div class="d-kpi-l">ç·åˆã‚¹ã‚³ã‚¢</div><div class="d-kpi-v w">${s.score}/100</div></div>
    </div>
    <div style="display:flex;align-items:flex-end;gap:2px;height:60px;background:var(--ink);border:1px solid var(--border);border-radius:8px;padding:6px;margin-bottom:8px;overflow:hidden">${bars}</div>
    <div class="d-section">
      <div class="d-section-title">ç§»å‹•å¹³å‡ç·šã¨ã®æ¯”è¼ƒ</div>
      <div class="d-row"><span class="d-row-l">25æ—¥MAï¼ˆçŸ­æœŸã®ç›®å®‰ï¼‰</span><span>Â¥${s.ma25.toLocaleString()} <strong style="color:${s.d25<0?'var(--green)':'var(--red)'}">${s.d25>0?'+':''}${s.d25}%</strong></span></div>
      <div class="d-row"><span class="d-row-l">75æ—¥MAï¼ˆä¸­æœŸã®ç›®å®‰ï¼‰</span><span>Â¥${s.ma75.toLocaleString()} <strong style="color:${s.d75<0?'var(--green)':'var(--red)'}">${s.d75>0?'+':''}${s.d75}%</strong></span></div>
    </div>
    <div class="d-section">
      <div class="d-section-title">å‰²å®‰åº¦ã®æŒ‡æ¨™</div>
      <div class="d-row"><span class="d-row-l">PBRï¼ˆ1å€ä»¥ä¸‹ = å‰²å®‰ï¼‰</span><span style="color:${s.pbr<=1?'var(--green)':'inherit'}">${s.pbr}å€</span></div>
      <div class="d-row"><span class="d-row-l">PERï¼ˆä½ã„ã»ã©å‰²å®‰ï¼‰</span><span style="color:${s.per<=13?'var(--green)':'inherit'}">${s.per}å€</span></div>
      <div class="d-row"><span class="d-row-l">å‡ºæ¥é«˜æ¯”ç‡</span><span style="color:${s.vol_r>=1.5?'var(--red)':'inherit'}">${s.vol_r}x</span></div>
    </div>
    <div class="d-section">
      <div class="d-section-title">ã“ã®éŠ˜æŸ„ã‚’é¸ã¶ç†ç”±</div>
      ${ri.map(r=>`<div class="d-row"><span class="d-row-l">${r.l}</span><span style="color:${r.ok?'var(--green)':'var(--red)'}">${r.ok?'âœ“':'âœ•'} ${r.v}</span></div>`).join('')}
    </div>
    <div class="d-note">â€» ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚å®Ÿéš›ã®å–å¼•ã®éš›ã¯æœ€æ–°ã®æ ªä¾¡ãƒ»è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’ã”ç¢ºèªãã ã•ã„ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚</div>
  `;
  document.getElementById('detailPanel').classList.add('open');
}

function closeDetail(){document.getElementById('detailPanel').classList.remove('open');}
</script>
</body>
</html>
