<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æŠ¼ã—ç›®ãƒãƒ³ã‚¿ãƒ¼ï½œå®‰å®šæ—¥æœ¬æ ªã‚¹ã‚¯ãƒªãƒ¼ãƒŠãƒ¼</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080c12;
  --surface: #0f1620;
  --surface2: #162030;
  --surface3: #1c2a3e;
  --border: #1e2d42;
  --border2: #263648;
  --accent: #00c896;
  --accent-dim: rgba(0,200,150,0.12);
  --accent2: #f0a830;
  --accent2-dim: rgba(240,168,48,0.12);
  --danger: #e85060;
  --danger-dim: rgba(232,80,96,0.12);
  --blue: #4a9eff;
  --blue-dim: rgba(74,158,255,0.12);
  --text: #b8cce0;
  --text-muted: #4a6880;
  --text-bright: #e8f4ff;
  --text-mid: #7898b8;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,200,150,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,200,150,0.025) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0;}

/* ========== OVERLAY BASE ========== */
.overlay{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;background:rgba(8,12,18,0.96);}
.overlay.hidden{display:none;}

/* ========== MARKET SUMMARY SCREEN ========== */
.summary-screen{max-width:760px;width:100%;}
.screen-eyebrow{font-size:10px;letter-spacing:3px;color:var(--accent);text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.screen-eyebrow::before{content:'';display:inline-block;width:20px;height:1px;background:var(--accent);}
.screen-title{font-family:'Noto Serif JP',serif;font-size:26px;color:var(--text-bright);margin-bottom:6px;line-height:1.4;}
.screen-date{font-size:11px;color:var(--text-muted);margin-bottom:32px;}

/* Market sentiment banner */
.sentiment-banner{border-radius:12px;padding:16px 20px;margin-bottom:24px;display:flex;align-items:center;gap:16px;border:1px solid;}
.sentiment-banner.bearish{background:var(--danger-dim);border-color:rgba(232,80,96,0.3);}
.sentiment-banner.neutral{background:var(--accent2-dim);border-color:rgba(240,168,48,0.3);}
.sentiment-banner.bullish{background:var(--accent-dim);border-color:rgba(0,200,150,0.3);}
.sentiment-icon{font-size:28px;}
.sentiment-text{flex:1;}
.sentiment-label{font-size:13px;font-weight:700;color:var(--text-bright);margin-bottom:2px;}
.sentiment-desc{font-size:11px;color:var(--text-muted);line-height:1.5;}

/* Index grid */
.index-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;}
@media(max-width:500px){.index-grid{grid-template-columns:repeat(2,1fr);}}
.index-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;}
.index-name{font-size:9px;letter-spacing:1.5px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px;}
.index-value{font-size:18px;font-weight:700;color:var(--text-bright);margin-bottom:4px;}
.index-change{font-size:11px;font-weight:600;}
.index-change.up{color:var(--accent);}
.index-change.down{color:var(--danger);}
.index-sparkline{display:flex;align-items:flex-end;gap:2px;height:24px;margin-top:8px;}
.spark-bar{flex:1;border-radius:1px;min-height:2px;transition:height 0.3s;}

/* Key stats */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:24px;}
@media(max-width:600px){.stats-row{grid-template-columns:repeat(2,1fr);}}
.stat-item{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;}
.stat-label{font-size:9px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px;}
.stat-value{font-size:15px;font-weight:700;color:var(--text-bright);}
.stat-value.up{color:var(--accent);}
.stat-value.down{color:var(--danger);}
.stat-value.warn{color:var(--accent2);}

/* AI Commentary */
.ai-comment{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:16px 20px;margin-bottom:28px;position:relative;overflow:hidden;}
.ai-comment::before{content:'AI';position:absolute;top:14px;right:16px;font-size:9px;letter-spacing:2px;color:var(--accent);opacity:0.6;}
.ai-comment-title{font-size:10px;letter-spacing:1.5px;color:var(--accent);text-transform:uppercase;margin-bottom:10px;}
.ai-comment-text{font-size:12px;color:var(--text);line-height:1.8;}
.ai-comment-text strong{color:var(--text-bright);}

.btn-to-quiz{background:var(--accent);color:#000;border:none;border-radius:10px;padding:14px 32px;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;cursor:pointer;width:100%;letter-spacing:0.5px;transition:all 0.2s;}
.btn-to-quiz:hover{background:#00e0aa;transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,200,150,0.3);}

/* ========== QUIZ SCREEN ========== */
.quiz-screen{max-width:560px;width:100%;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;box-shadow:0 40px 80px rgba(0,0,0,0.5);}
.quiz-step-label{font-size:10px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;margin-bottom:12px;}
.quiz-progress{display:flex;gap:6px;margin-bottom:28px;}
.quiz-progress-dot{flex:1;height:3px;border-radius:2px;background:var(--border);transition:background 0.3s;}
.quiz-progress-dot.done{background:var(--accent);}
.quiz-progress-dot.active{background:rgba(0,200,150,0.5);}
.quiz-question{font-family:'Noto Serif JP',serif;font-size:20px;color:var(--text-bright);line-height:1.6;margin-bottom:6px;}
.quiz-sub{font-size:11px;color:var(--text-muted);margin-bottom:24px;line-height:1.6;}
.quiz-options{display:flex;flex-direction:column;gap:10px;}
.quiz-option{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px 18px;cursor:pointer;transition:all 0.18s;display:flex;align-items:center;gap:14px;}
.quiz-option:hover{border-color:var(--accent);background:var(--accent-dim);transform:translateX(4px);}
.quiz-option.selected{border-color:var(--accent);background:var(--accent-dim);}
.quiz-option-icon{font-size:22px;line-height:1;flex-shrink:0;}
.quiz-option-title{font-size:13px;color:var(--text-bright);font-weight:700;margin-bottom:2px;}
.quiz-option-desc{font-size:10px;color:var(--text-muted);}
.quiz-nav{display:flex;justify-content:space-between;align-items:center;margin-top:24px;}
.btn-back{background:none;border:1px solid var(--border);border-radius:8px;padding:9px 18px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;font-size:12px;cursor:pointer;transition:all 0.2s;}
.btn-back:hover{border-color:var(--text-muted);color:var(--text);}
.btn-next{background:var(--accent);border:none;border-radius:8px;padding:10px 24px;color:#000;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;}
.btn-next:hover{background:#00e0aa;}
.btn-next:disabled{opacity:0.3;cursor:not-allowed;}

/* ========== MAIN APP ========== */
.container{position:relative;z-index:1;max-width:1280px;margin:0 auto;padding:24px 20px;}
header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;}
.logo{font-family:'Noto Serif JP',serif;font-size:24px;color:var(--text-bright);}
.logo span{color:var(--accent);font-size:11px;font-family:'JetBrains Mono',monospace;display:block;margin-top:3px;letter-spacing:2px;}
.status-bar{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-muted);margin-top:6px;}
.dot{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}

/* quiz badge strip */
.quiz-badges{display:none;gap:8px;flex-wrap:wrap;margin-bottom:16px;align-items:center;}
.quiz-badges.show{display:flex;}
.qbadge{background:var(--accent-dim);border:1px solid rgba(0,200,150,0.25);color:var(--accent);border-radius:20px;padding:3px 12px;font-size:10px;}
.btn-redo{background:none;border:1px solid var(--border);border-radius:20px;padding:3px 12px;font-size:10px;color:var(--text-muted);cursor:pointer;font-family:'JetBrains Mono',monospace;transition:all 0.2s;}
.btn-redo:hover{border-color:var(--accent);color:var(--accent);}

/* controls */
.controls{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:20px;display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;}
.ctrl{display:flex;flex-direction:column;gap:6px;min-width:140px;}
.ctrl label{font-size:9px;letter-spacing:1.5px;color:var(--text-muted);text-transform:uppercase;}
.ctrl input,.ctrl select{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text-bright);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;transition:border-color 0.2s;width:100%;}
.ctrl input:focus,.ctrl select:focus{border-color:var(--accent);}
.btn-scan{background:var(--accent);color:#000;border:none;border-radius:8px;padding:8px 20px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s;height:34px;white-space:nowrap;}
.btn-scan:hover{background:#00e0aa;}
.btn-scan:disabled{opacity:0.5;cursor:not-allowed;}

/* summary cards */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
@media(max-width:700px){.kpi-row{grid-template-columns:repeat(2,1fr);}}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;}
.kpi-label{font-size:9px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px;}
.kpi-value{font-size:26px;font-weight:700;color:var(--text-bright);}
.kpi-value.g{color:var(--accent);}
.kpi-value.w{color:var(--accent2);}

/* ========== RESULTS TABLE (improved) ========== */
.results-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.results-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
.results-title{font-size:11px;letter-spacing:2px;color:var(--text-muted);text-transform:uppercase;}
.filter-tags{display:flex;gap:6px;}
.ftag{padding:4px 12px;border-radius:20px;font-size:10px;cursor:pointer;border:1px solid var(--border);color:var(--text-muted);transition:all 0.2s;}
.ftag.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent);}

/* Card-based results (instead of dense table) */
.results-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1px;background:var(--border);}
.stock-card{background:var(--surface);padding:18px 20px;cursor:pointer;transition:background 0.15s;position:relative;}
.stock-card:hover{background:var(--surface2);}
.stock-card-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;}
.stock-meta{flex:1;}
.stock-code{font-size:11px;color:var(--accent2);font-weight:700;letter-spacing:1px;margin-bottom:2px;}
.stock-name{font-family:'Noto Serif JP',serif;font-size:15px;color:var(--text-bright);margin-bottom:3px;}
.stock-sector{font-size:10px;color:var(--text-muted);}
.stock-price-block{text-align:right;}
.stock-price{font-size:20px;font-weight:700;color:var(--text-bright);}
.stock-price-change{font-size:11px;margin-top:2px;}

/* Signal badge */
.signal-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:700;letter-spacing:0.5px;}
.signal-badge.buy{background:var(--accent-dim);color:var(--accent);border:1px solid rgba(0,200,150,0.3);}
.signal-badge.buy::before{content:'â–²';font-size:8px;}
.signal-badge.watch{background:var(--accent2-dim);color:var(--accent2);border:1px solid rgba(240,168,48,0.3);}
.signal-badge.watch::before{content:'â—†';font-size:8px;}
.signal-badge.hold{background:var(--surface3);color:var(--text-muted);border:1px solid var(--border);}
.signal-badge.hold::before{content:'â€“';font-size:10px;}

/* Metric pills row */
.metric-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.mpill{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:5px 10px;display:flex;flex-direction:column;align-items:center;min-width:60px;}
.mpill-label{font-size:8px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;margin-bottom:2px;}
.mpill-value{font-size:12px;font-weight:700;color:var(--text-bright);}
.mpill-value.g{color:var(--accent);}
.mpill-value.r{color:var(--danger);}
.mpill-value.w{color:var(--accent2);}

/* Score bar */
.score-row{display:flex;align-items:center;gap:10px;}
.score-label{font-size:9px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;white-space:nowrap;}
.score-track{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.score-fill{height:100%;border-radius:3px;transition:width 0.6s ease;}
.score-fill.high{background:linear-gradient(90deg,var(--accent),#00e8b0);}
.score-fill.mid{background:linear-gradient(90deg,var(--accent2),#ffc850);}
.score-fill.low{background:var(--surface3);}
.score-num{font-size:12px;font-weight:700;color:var(--text-bright);width:30px;text-align:right;}

/* reasons */
.reason-list{display:flex;flex-wrap:wrap;gap:4px;margin-top:10px;}
.reason-tag{font-size:9px;padding:2px 7px;border-radius:4px;font-weight:600;}
.reason-tag.ok{background:var(--accent-dim);color:var(--accent);}
.reason-tag.ng{background:var(--danger-dim);color:var(--danger);}

/* Loading / empty */
.loading{text-align:center;padding:60px 20px;color:var(--text-muted);}
.loading-spinner{display:inline-block;width:28px;height:28px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:12px;}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 20px;color:var(--text-muted);font-size:12px;}

/* ========== DETAIL PANEL ========== */
.detail-panel{display:none;position:fixed;right:0;top:0;bottom:0;width:380px;background:var(--surface);border-left:1px solid var(--border);z-index:150;overflow-y:auto;padding:28px;animation:slideIn 0.2s ease;}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
.detail-panel.open{display:block;}
.detail-close{position:absolute;top:18px;right:18px;background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer;line-height:1;transition:color 0.2s;}
.detail-close:hover{color:var(--text-bright);}
.d-code{color:var(--accent2);font-size:11px;letter-spacing:1px;margin-bottom:3px;}
.d-name{font-family:'Noto Serif JP',serif;font-size:22px;color:var(--text-bright);margin-bottom:4px;}
.d-sector{font-size:11px;color:var(--text-muted);margin-bottom:20px;}
.d-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.d-item{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;}
.d-item-label{font-size:8px;letter-spacing:1.5px;color:var(--text-muted);text-transform:uppercase;margin-bottom:5px;}
.d-item-value{font-size:20px;font-weight:700;color:var(--text-bright);}
.d-item-value.g{color:var(--accent);}
.d-item-value.w{color:var(--accent2);}
.d-section{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px;}
.d-section-title{font-size:9px;letter-spacing:1.5px;color:var(--text-muted);text-transform:uppercase;margin-bottom:10px;}
.d-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;font-size:12px;}
.d-row:last-child{margin-bottom:0;}
.mini-chart{width:100%;height:72px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:10px;display:flex;align-items:flex-end;padding:6px;gap:2px;overflow:hidden;}
.mcbar{flex:1;border-radius:1px 1px 0 0;min-height:3px;}
.d-note{font-size:10px;color:var(--text-muted);line-height:1.7;border-top:1px solid var(--border);padding-top:12px;margin-top:4px;}
</style>
</head>
<body>

<!-- ===== SCREEN 1: MARKET SUMMARY ===== -->
<div class="overlay" id="summaryOverlay">
  <div class="summary-screen">
    <div class="screen-eyebrow">å¸‚å ´ã‚µãƒãƒªãƒ¼</div>
    <div class="screen-title">ä»Šæ—¥ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’å§‹ã‚ã‚‹å‰ã«ã€<br>å¸‚å ´ã®çŠ¶æ³ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†</div>
    <div class="screen-date" id="todayDate"></div>

    <!-- Sentiment banner -->
    <div class="sentiment-banner neutral" id="sentimentBanner">
      <div class="sentiment-icon" id="sentimentIcon">âš ï¸</div>
      <div class="sentiment-text">
        <div class="sentiment-label" id="sentimentLabel">ã‚„ã‚„è»Ÿèª¿ â€” æŠ¼ã—ç›®ãƒãƒ£ãƒ³ã‚¹å¢—åŠ ä¸­</div>
        <div class="sentiment-desc" id="sentimentDesc">æ—¥çµŒå¹³å‡ãŒ25MAä»˜è¿‘ã§æ¨ç§»ã€‚å€‹åˆ¥éŠ˜æŸ„ã®é¸åˆ¥ãŒé‡è¦ãªå±€é¢ã§ã™ã€‚</div>
      </div>
    </div>

    <!-- Index cards -->
    <div class="index-grid">
      <div class="index-card">
        <div class="index-name">æ—¥çµŒå¹³å‡</div>
        <div class="index-value" id="nikkeiVal">38,240</div>
        <div class="index-change down" id="nikkeiChg">â–¼ -312 (-0.81%)</div>
        <div class="index-sparkline" id="nikkeiSpark"></div>
      </div>
      <div class="index-card">
        <div class="index-name">TOPIX</div>
        <div class="index-value" id="topixVal">2,718</div>
        <div class="index-change down" id="topixChg">â–¼ -18 (-0.66%)</div>
        <div class="index-sparkline" id="topixSpark"></div>
      </div>
      <div class="index-card">
        <div class="index-name">ãƒ‰ãƒ«å††</div>
        <div class="index-value" id="usdjpyVal">149.82</div>
        <div class="index-change up" id="usdjpyChg">â–² +0.34 (+0.23%)</div>
        <div class="index-sparkline" id="usdjpySpark"></div>
      </div>
      <div class="index-card">
        <div class="index-name">VIXï¼ˆææ€–æŒ‡æ•°ï¼‰</div>
        <div class="index-value" id="vixVal">18.4</div>
        <div class="index-change up" id="vixChg">â–² +1.2</div>
        <div class="index-sparkline" id="vixSpark"></div>
      </div>
      <div class="index-card">
        <div class="index-name">æ—¥æœ¬10å¹´å‚µåˆ©å›ã‚Š</div>
        <div class="index-value" id="bondVal">1.08%</div>
        <div class="index-change up" id="bondChg">â–² +0.02%</div>
        <div class="index-sparkline" id="bondSpark"></div>
      </div>
      <div class="index-card">
        <div class="index-name">æ±è¨¼å£²è²·ä»£é‡‘</div>
        <div class="index-value" id="volVal">3.8å…†å††</div>
        <div class="index-change down" id="volChg">â–¼ å‰æ—¥æ¯” -0.4å…†</div>
        <div class="index-sparkline" id="volSpark"></div>
      </div>
    </div>

    <!-- Key stats row -->
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-label">å‰æ—¥ æŠ¼ã—ç›®å€™è£œ</div>
        <div class="stat-value up">12éŠ˜æŸ„</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">2æ—¥å‰æ¯” å¤‰åŒ–</div>
        <div class="stat-value warn">+3éŠ˜æŸ„å¢—åŠ </div>
      </div>
      <div class="stat-item">
        <div class="stat-label">é«˜é…å½“4%è¶…</div>
        <div class="stat-value up">8éŠ˜æŸ„</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">RSI30ä»¥ä¸‹</div>
        <div class="stat-value warn">5éŠ˜æŸ„</div>
      </div>
    </div>

    <!-- AI Commentary -->
    <div class="ai-comment">
      <div class="ai-comment-title">AI ã‚³ãƒ¡ãƒ³ãƒˆ</div>
      <div class="ai-comment-text" id="aiComment"></div>
    </div>

    <button class="btn-to-quiz" onclick="startQuiz()">ã“ã®çŠ¶æ³ã‚’è¸ã¾ãˆã¦ã€è³ªå•ã«ç­”ãˆã‚‹ â†’</button>
  </div>
</div>

<!-- ===== SCREEN 2: QUIZ ===== -->
<div class="overlay hidden" id="quizOverlay">
  <div class="quiz-screen">
    <div class="quiz-step-label" id="quizStepLabel">STEP 1 / 3</div>
    <div class="quiz-progress" id="quizProgress"></div>
    <div class="quiz-question" id="quizQuestion"></div>
    <div class="quiz-sub" id="quizSub"></div>
    <div class="quiz-options" id="quizOptions"></div>
    <div class="quiz-nav">
      <button class="btn-back" id="quizBackBtn" onclick="quizBack()">â† æˆ»ã‚‹</button>
      <button class="btn-next" id="quizNextBtn" onclick="quizNext()" disabled>æ¬¡ã¸ â†’</button>
    </div>
  </div>
</div>

<!-- ===== MAIN APP ===== -->
<div class="container">
  <header>
    <div>
      <div class="logo">æŠ¼ã—ç›®ãƒãƒ³ã‚¿ãƒ¼<span>OSHI-ME HUNTER / JP STOCK SCREENER</span></div>
      <div class="status-bar"><div class="dot"></div><span id="lastUpdate">æº–å‚™å®Œäº†</span></div>
      <div class="status-bar" style="margin-top:4px"><span id="dataSourceBadge" style="font-size:10px;color:var(--text-muted)">ãƒ‡ãƒ¼ã‚¿ç¢ºèªä¸­...</span></div>
    </div>
    <div class="quiz-badges" id="quizBadges">
      <span style="font-size:9px;color:var(--text-muted);letter-spacing:1px;">ä»Šæ—¥ã®è¨­å®š:</span>
    </div>
  </header>

  <div class="controls">
    <div class="ctrl"><label>MAä¹–é›¢ ã—ãã„å€¤</label><input type="number" id="maThreshold" value="-5" max="0" step="0.5"></div>
    <div class="ctrl"><label>æœ€ä½é…å½“åˆ©å›ã‚Š</label><input type="number" id="minDividend" value="2.5" min="0" step="0.1"></div>
    <div class="ctrl"><label>RSI ä¸Šé™</label><input type="number" id="maxRsi" value="40" min="10" max="60"></div>
    <div class="ctrl"><label>ä¸¦ã³æ›¿ãˆ</label>
      <select id="sortBy">
        <option value="score">ç·åˆã‚¹ã‚³ã‚¢é †</option>
        <option value="deviation">ä¹–é›¢ç‡é †</option>
        <option value="dividend">é…å½“åˆ©å›ã‚Šé †</option>
        <option value="rsi">RSIé †</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;align-items:flex-end;">
      <button class="btn-scan" id="scanBtn" onclick="runScan()">â–¶ ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ</button>
      <button class="btn-redo" onclick="resetToSummary()">â†º æœ€åˆã‹ã‚‰</button>
    </div>
  </div>

  <div class="kpi-row">
    <div class="kpi"><div class="kpi-label">ã‚¹ã‚­ãƒ£ãƒ³éŠ˜æŸ„æ•°</div><div class="kpi-value" id="kpiTotal">â€”</div></div>
    <div class="kpi"><div class="kpi-label">æŠ¼ã—ç›®è²·ã„å€™è£œ</div><div class="kpi-value g" id="kpiBuy">â€”</div></div>
    <div class="kpi"><div class="kpi-label">è¦æ³¨ç›®</div><div class="kpi-value w" id="kpiWatch">â€”</div></div>
    <div class="kpi"><div class="kpi-label">å¹³å‡é…å½“åˆ©å›ã‚Š</div><div class="kpi-value" id="kpiDiv">â€”</div></div>
  </div>

  <div class="results-wrap">
    <div class="results-header">
      <div class="results-title">ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°çµæœ</div>
      <div class="filter-tags">
        <div class="ftag active" onclick="setFilter('all',this)">ALL</div>
        <div class="ftag" onclick="setFilter('buy',this)">æŠ¼ã—ç›®è²·ã„</div>
        <div class="ftag" onclick="setFilter('watch',this)">è¦æ³¨ç›®</div>
      </div>
    </div>
    <div id="resultsBody"><div class="empty">ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div></div>
  </div>

  <div style="margin-top:16px;padding:12px 16px;background:var(--surface);border-radius:8px;border:1px solid var(--border);font-size:10px;color:var(--text-muted);line-height:1.8;">
    âš ï¸ ãƒ‡ãƒ¢ç‰ˆ â€” æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤ã§ã™ã€‚å®Ÿé‹ç”¨ã«ã¯ yfinance ç­‰ã®APIã¨ã®é€£æºãŒå¿…è¦ã§ã™ã€‚æŠ•è³‡åˆ¤æ–­ã¯ã”è‡ªèº«ã®è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚
  </div>
</div>

<!-- Detail Panel -->
<div class="detail-panel" id="detailPanel">
  <button class="detail-close" onclick="closeDetail()">âœ•</button>
  <div id="detailContent"></div>
</div>

<script>
// ===================================================
// MARKET DATA (demo/simulated)
// ===================================================
const MARKET = {
  nikkei:  { val:'38,240', chg:'-312', pct:'-0.81', dir:'down', spark:[41,38,36,39,37,35,34,36,35,33] },
  topix:   { val:'2,718',  chg:'-18',  pct:'-0.66', dir:'down', spark:[42,40,39,40,38,37,36,38,37,35] },
  usdjpy:  { val:'149.82', chg:'+0.34',pct:'+0.23', dir:'up',   spark:[30,31,33,30,32,34,33,35,34,36] },
  vix:     { val:'18.4',   chg:'+1.2', pct:'',      dir:'up',   spark:[28,26,25,27,26,30,31,29,32,33] },
  bond:    { val:'1.08%',  chg:'+0.02',pct:'',      dir:'up',   spark:[30,31,31,32,31,33,34,33,35,36] },
  vol:     { val:'3.8å…†å††',chg:'-0.4å…†',pct:'',     dir:'down', spark:[38,42,40,44,38,36,40,38,35,32] },
};

const AI_COMMENTS = [
  'æ˜¨æ—¥ãƒ»ä¸€æ˜¨æ—¥ã¨æ—¥çµŒå¹³å‡ãŒç¶šè½ã—ã€<strong>25æ—¥ç§»å‹•å¹³å‡ç·šï¼ˆç´„38,500å††ï¼‰ã‚’å‰²ã‚Šè¾¼ã‚“ã </strong>çŠ¶æ…‹ã§ã™ã€‚éŠ€è¡Œãƒ»å•†ç¤¾ã‚»ã‚¯ã‚¿ãƒ¼ã‚’ä¸­å¿ƒã«RSI30ä»¥ä¸‹ã®éŠ˜æŸ„ãŒå¢—åŠ ã—ã¦ãŠã‚Šã€é«˜é…å½“ã®å®‰å®šæ ªã«ã¯æŠ¼ã—ç›®å½¢æˆã®ãƒãƒ£ãƒ³ã‚¹ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚',
  'VIXãŒ18å°ã«ä¸Šæ˜‡ã—ã€å¸‚å ´ã®ã‚„ã‚„ä¸å®‰å®šæ„ŸãŒå¢—ã—ã¦ã„ã¾ã™ã€‚ãŸã ã—<strong>å®Ÿéœ€ã®å£²ã‚Šã§ã¯ãªãçŸ­æœŸç­‹ã®ãƒã‚¸ã‚·ãƒ§ãƒ³èª¿æ•´</strong>ã®å¯èƒ½æ€§ãŒé«˜ãã€ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ã‚ºãŒè‰¯å¥½ãªé«˜é…å½“éŠ˜æŸ„ã¯ä¸‹å€¤ãŒé™å®šçš„ã¨è¦‹ã‚‰ã‚Œã¾ã™ã€‚',
  'å‡ºæ¥é«˜ã¯å‰æ—¥æ¯”ã‚„ã‚„æ¸›å°‘ã—ã¦ãŠã‚Šã€<strong>ä»•æ‰‹çš„ãªå‹•ãã¯å°‘ãªã„ç’°å¢ƒ</strong>ã§ã™ã€‚å®‰å®šå¿—å‘ã®æŠ¼ã—ç›®è²·ã„æˆ¦ç•¥ã«ã¯é©ã—ãŸåœ°åˆã„ã¨åˆ¤æ–­ã—ã¾ã™ã€‚ä»Šæ—¥ã®è³ªå•ã§ã”è‡ªèº«ã®å„ªå…ˆäº‹é …ã‚’ç¢ºèªã—ã€æœ€é©ãªå€™è£œã‚’çµã‚Šè¾¼ã¿ã¾ã—ã‚‡ã†ã€‚',
];

function buildSparks() {
  const maps = { nikkei:'nikkeiSpark', topix:'topixSpark', usdjpy:'usdjpySpark', vix:'vixSpark', bond:'bondSpark', vol:'volSpark' };
  const dirs = { nikkei:'down', topix:'down', usdjpy:'up', vix:'up', bond:'up', vol:'down' };
  Object.entries(maps).forEach(([key, id]) => {
    const el = document.getElementById(id);
    const data = MARKET[key].spark;
    const mx = Math.max(...data), mn = Math.min(...data);
    el.innerHTML = data.map((v,i) => {
      const h = mn === mx ? 12 : 4 + ((v - mn) / (mx - mn)) * 18;
      const isUp = dirs[key] === 'up';
      const col = i === data.length-1 ? (isUp ? 'var(--accent)' : 'var(--danger)') : 'var(--surface3)';
      return `<div class="spark-bar" style="height:${h}px;background:${col};"></div>`;
    }).join('');
  });
}

function initSummaryScreen() {
  // Date
  const d = new Date();
  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  document.getElementById('todayDate').textContent =
    `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${days[d.getDay()]}ï¼‰â€” å‰æ—¥ãƒ»å‰ã€…æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§`;

  buildSparks();

  // AI comment (cycle through)
  const idx = Math.floor(Math.random() * AI_COMMENTS.length);
  document.getElementById('aiComment').innerHTML = AI_COMMENTS[idx];
}

// ===================================================
// QUIZ
// ===================================================
const QUIZ = [
  {
    id: 'market',
    question: 'ä»Šæ—¥ã®ç›¸å ´ã€ã©ã†æ„Ÿã˜ã¦ã„ã¾ã™ã‹ï¼Ÿ',
    sub: 'å¸‚å ´ã‚µãƒãƒªãƒ¼ã‚’è¸ã¾ãˆã¦ã€ã‚ãªãŸã®ç›¸å ´è¦³ã‚’æ•™ãˆã¦ãã ã•ã„',
    options: [
      { icon:'ğŸ“ˆ', title:'ã¾ã ä¸Šæ˜‡ä½™åœ°ã‚ã‚Š', desc:'åœ°åˆã„ã¯æ‚ªããªã„ã€‚å€‹åˆ¥ã®æŠ¼ã—ã‚’ã—ã£ã‹ã‚Šæ‹¾ã„ãŸã„', value:'bull' },
      { icon:'ğŸ“‰', title:'ä¸‹è½ãŒæ€–ã„', desc:'è»Ÿèª¿ãªåœ°åˆã„ã€‚æ·±ã„æŠ¼ã—ã‚’ã‚‚ã†å°‘ã—å¾…ã¡ãŸã„', value:'bear' },
      { icon:'â¡ï¸', title:'æ§˜å­è¦‹ã—ãŸã„', desc:'æ–¹å‘æ„ŸãŒå‡ºã‚‹ã¾ã§æ…é‡ã«ã€‚å®‰å®šå¿—å‘ã§è¡Œã', value:'flat' },
      { icon:'ğŸ¯', title:'æ¡ä»¶ã ã‘ã§æ©Ÿæ¢°çš„ã«åˆ¤æ–­', desc:'ç›¸å ´æ„Ÿã‚ˆã‚Šæ•°å­—ã‚’å„ªå…ˆã€‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ¡ä»¶ã ã‘ã§æ±ºã‚ã‚‹', value:'neutral' },
    ]
  },
  {
    id: 'priority',
    question: 'ä»Šæ—¥ã®ã‚¹ã‚­ãƒ£ãƒ³ã§ä¸€ç•ªé‡è¦–ã™ã‚‹ã“ã¨ã¯ï¼Ÿ',
    sub: 'é¸æŠã«ã‚ˆã£ã¦ã‚¹ã‚³ã‚¢ã®é‡ã¿ä»˜ã‘ãŒè‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™',
    options: [
      { icon:'ğŸ’°', title:'é…å½“åˆ©å›ã‚Š', desc:'ã‚¤ãƒ³ã‚«ãƒ ã‚²ã‚¤ãƒ³é‡è¦–ã€‚é«˜é…å½“ã‚’ã¨ã«ã‹ãå„ªå…ˆ', value:'dividend' },
      { icon:'ğŸ“Š', title:'MAä¹–é›¢ã®æ·±ã•', desc:'å¤§ããä¸‹ãŒã£ãŸå®‰å®šæ ªã‚’åº•å€¤åœã§ä»•è¾¼ã¿ãŸã„', value:'deviation' },
      { icon:'ğŸ›¡ï¸', title:'å‰²å®‰åº¦ï¼ˆPBRãƒ»PERï¼‰', desc:'æœ¬è³ªçš„ã«å®‰ã„éŠ˜æŸ„ã€‚ãƒãƒªãƒ¥ãƒ¼æ ªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ', value:'value' },
      { icon:'âš–ï¸', title:'ãƒãƒ©ãƒ³ã‚¹é‡è¦–', desc:'å…¨æŒ‡æ¨™ã‚’ã¾ã‚“ã¹ã‚“ãªãè¦‹ã¦ç·åˆçš„ã«åˆ¤æ–­', value:'balance' },
    ]
  },
  {
    id: 'horizon',
    question: 'ä»Šå›ã®ä¿æœ‰æœŸé–“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ï¼Ÿ',
    sub: 'æœŸé–“ã«ã‚ˆã£ã¦MAã®ã—ãã„å€¤ã¨ã‚¹ã‚³ã‚¢ã®è¨ˆç®—ãŒå¤‰ã‚ã‚Šã¾ã™',
    options: [
      { icon:'âš¡', title:'æ•°æ—¥ï¼ˆãƒ‡ã‚¤ã€œã‚¹ã‚¦ã‚£ãƒ³ã‚°ï¼‰', desc:'25MAä¹–é›¢ã‚’é‡è¦–ã€‚çŸ­æœŸã®åç™ºç‹™ã„', value:'short' },
      { icon:'ğŸ“…', title:'æ•°é€±é–“', desc:'25MAãƒ»75MAã®ä¸¡æ–¹ã‚’å‚ç…§ã€‚ä¸­çŸ­æœŸã®ã‚¹ã‚¦ã‚£ãƒ³ã‚°', value:'mid' },
      { icon:'ğŸŒ±', title:'æ•°ãƒ¶æœˆä»¥ä¸Š', desc:'é…å½“ã¨75MAé‡è¦–ã€‚è½ã¡ç€ã„ãŸä¸­æœŸä¿æœ‰', value:'long' },
    ]
  }
];

let quizStep = 0;
let quizAnswers = {};

function startQuiz() {
  document.getElementById('summaryOverlay').classList.add('hidden');
  document.getElementById('quizOverlay').classList.remove('hidden');
  quizStep = 0;
  quizAnswers = {};
  renderQuiz();
}

function renderQuiz() {
  const q = QUIZ[quizStep];
  document.getElementById('quizStepLabel').textContent = `STEP ${quizStep+1} / ${QUIZ.length}`;
  document.getElementById('quizProgress').innerHTML = QUIZ.map((_,i) =>
    `<div class="quiz-progress-dot ${i<quizStep?'done':i===quizStep?'active':''}"></div>`).join('');
  document.getElementById('quizQuestion').textContent = q.question;
  document.getElementById('quizSub').textContent = q.sub;

  const sel = quizAnswers[q.id];
  document.getElementById('quizOptions').innerHTML = q.options.map(o => `
    <div class="quiz-option ${sel===o.value?'selected':''}" onclick="selectOpt('${o.value}',this)">
      <div class="quiz-option-icon">${o.icon}</div>
      <div>
        <div class="quiz-option-title">${o.title}</div>
        <div class="quiz-option-desc">${o.desc}</div>
      </div>
    </div>`).join('');

  document.getElementById('quizBackBtn').style.visibility = quizStep===0?'hidden':'visible';
  document.getElementById('quizNextBtn').textContent = quizStep===QUIZ.length-1?'ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ â–¶':'æ¬¡ã¸ â†’';
  document.getElementById('quizNextBtn').disabled = !sel;
}

function selectOpt(val, el) {
  quizAnswers[QUIZ[quizStep].id] = val;
  document.querySelectorAll('.quiz-option').forEach(o=>o.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('quizNextBtn').disabled = false;
}

function quizNext() {
  if (quizStep < QUIZ.length-1) { quizStep++; renderQuiz(); }
  else {
    document.getElementById('quizOverlay').classList.add('hidden');
    applyAnswers();
    showBadges();
    runScan();
  }
}

function quizBack() { if(quizStep>0){quizStep--;renderQuiz();} }

function applyAnswers() {
  const {market, priority, horizon} = quizAnswers;
  document.getElementById('maxRsi').value = {bull:35,bear:45,flat:40,neutral:40}[market]||40;
  document.getElementById('sortBy').value = {dividend:'dividend',deviation:'deviation',value:'score',balance:'score'}[priority]||'score';
  document.getElementById('maThreshold').value = {short:-4,mid:-5,long:-6}[horizon]||-5;
}

function showBadges() {
  const L = {
    market:{bull:'ğŸ“ˆ ä¸Šæ˜‡ä½™åœ°ã‚ã‚Š',bear:'ğŸ“‰ ä¸‹è½è­¦æˆ’',flat:'â¡ï¸ æ§˜å­è¦‹',neutral:'ğŸ¯ æ©Ÿæ¢°åˆ¤æ–­'},
    priority:{dividend:'ğŸ’° é…å½“é‡è¦–',deviation:'ğŸ“Š ä¹–é›¢é‡è¦–',value:'ğŸ›¡ï¸ å‰²å®‰é‡è¦–',balance:'âš–ï¸ ãƒãƒ©ãƒ³ã‚¹'},
    horizon:{short:'âš¡ æ•°æ—¥',mid:'ğŸ“… æ•°é€±é–“',long:'ğŸŒ± æ•°ãƒ¶æœˆ'},
  };
  const el = document.getElementById('quizBadges');
  const existing = el.querySelectorAll('.qbadge');
  existing.forEach(e=>e.remove());
  Object.entries(quizAnswers).forEach(([k,v]) => {
    const b = document.createElement('span');
    b.className = 'qbadge';
    b.textContent = L[k]?.[v]||v;
    el.appendChild(b);
  });
  el.classList.add('show');
}

function resetToSummary() {
  document.getElementById('summaryOverlay').classList.remove('hidden');
}

// ===================================================
// STOCK DATA â€” JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‹•çš„èª­ã¿è¾¼ã¿
// ===================================================
// ãƒ‡ãƒ¢ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆstocks_data.json ãŒãªã„å ´åˆã«ä½¿ç”¨ï¼‰
const DEMO_STOCKS = [
  {code:'8306',name:'ä¸‰è±UFJãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«',sector:'éŠ€è¡Œ',price:1423,ma25:1520,ma75:1580,rsi:32,dividend:3.8,pbr:0.7,per:9.2,vol_r:0.8},
  {code:'9432',name:'NTT',sector:'é€šä¿¡',price:163,ma25:168,ma75:172,rsi:38,dividend:3.2,pbr:1.1,per:11.5,vol_r:0.9},
  {code:'8058',name:'ä¸‰è±å•†äº‹',sector:'å•†ç¤¾',price:2890,ma25:3050,ma75:3200,rsi:29,dividend:4.1,pbr:0.9,per:8.7,vol_r:0.7},
  {code:'4502',name:'æ­¦ç”°è–¬å“å·¥æ¥­',sector:'åŒ»è–¬å“',price:3820,ma25:3960,ma75:4050,rsi:41,dividend:5.6,pbr:1.3,per:15.2,vol_r:1.1},
  {code:'8001',name:'ä¼Šè—¤å¿ å•†äº‹',sector:'å•†ç¤¾',price:6780,ma25:7050,ma75:7200,rsi:33,dividend:3.5,pbr:1.8,per:12.3,vol_r:0.6},
  {code:'7203',name:'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š',sector:'è‡ªå‹•è»Š',price:2650,ma25:2720,ma75:2800,rsi:36,dividend:3.0,pbr:1.1,per:10.4,vol_r:0.9},
  {code:'8316',name:'ä¸‰äº•ä½å‹FG',sector:'éŠ€è¡Œ',price:7100,ma25:7600,ma75:7800,rsi:28,dividend:4.2,pbr:0.8,per:9.0,vol_r:0.7},
  {code:'2914',name:'JTï¼ˆæ—¥æœ¬ãŸã°ã“ï¼‰',sector:'é£Ÿå“',price:3680,ma25:3780,ma75:3820,rsi:35,dividend:6.2,pbr:1.6,per:13.8,vol_r:0.8},
  {code:'9020',name:'JRæ±æ—¥æœ¬',sector:'é‰„é“',price:8150,ma25:8300,ma75:8450,rsi:42,dividend:2.1,pbr:1.4,per:14.2,vol_r:0.9},
  {code:'8411',name:'ã¿ãšã»FG',sector:'éŠ€è¡Œ',price:2680,ma25:2850,ma75:2950,rsi:31,dividend:3.9,pbr:0.7,per:8.5,vol_r:0.8},
  {code:'9433',name:'KDDI',sector:'é€šä¿¡',price:4350,ma25:4500,ma75:4600,rsi:37,dividend:3.3,pbr:1.9,per:13.5,vol_r:1.0},
  {code:'5108',name:'ãƒ–ãƒªãƒ‚ã‚¹ãƒˆãƒ³',sector:'ã‚´ãƒ ',price:5100,ma25:5280,ma75:5350,rsi:40,dividend:3.8,pbr:1.2,per:11.8,vol_r:0.8},
];

let STOCKS = [...DEMO_STOCKS];
let dataSource = 'demo'; // 'demo' or 'live'

// stocks_data.json ã®èª­ã¿è¾¼ã¿ã‚’è©¦ã¿ã‚‹
async function loadStocksData() {
  try {
    const res = await fetch('stocks_data.json');
    if (!res.ok) throw new Error('not found');
    const json = await res.json();
    if (json.stocks && json.stocks.length > 0) {
      STOCKS = json.stocks;
      dataSource = 'live';
      document.getElementById('dataSourceBadge').textContent = `ğŸ“¡ å®Ÿãƒ‡ãƒ¼ã‚¿ (${json.updated_at})`;
      document.getElementById('dataSourceBadge').style.color = 'var(--accent)';
      console.log(`âœ… å®Ÿãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${STOCKS.length}éŠ˜æŸ„`);
    }
  } catch(e) {
    // JSONãªã— â†’ ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®ã¾ã¾
    document.getElementById('dataSourceBadge').textContent = 'âš ï¸ ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ä¸­ï¼ˆfetch_stocks.py ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼‰';
    document.getElementById('dataSourceBadge').style.color = 'var(--accent2)';
  }
}

// èµ·å‹•æ™‚ã«èª­ã¿è¾¼ã¿
loadStocksData();

let currentFilter = 'all';
let processedStocks = [];

function dv(price, ma) { return +((price-ma)/ma*100).toFixed(1); }

function calcScore(s) {
  let sc = 0;
  const p = quizAnswers.priority||'balance';
  const d25 = dv(s.price, s.ma25);
  const db = p==='dividend'?10:0, devb=p==='deviation'?10:0, valb=p==='value'?10:0;

  if(s.dividend>=5.0) sc+=30+db;
  else if(s.dividend>=4.5) sc+=25+db;
  else if(s.dividend>=4.0) sc+=20+db;
  else if(s.dividend>=3.5) sc+=15+db;
  else if(s.dividend>=3.0) sc+=10+db;
  else if(s.dividend>=2.5) sc+=5;

  if(d25<=-7) sc+=25+devb;
  else if(d25<=-5) sc+=18+devb;
  else if(d25<=-3) sc+=8;

  if(s.rsi<=30) sc+=20;
  else if(s.rsi<=35) sc+=14;
  else if(s.rsi<=40) sc+=8;

  if(s.pbr<=0.8) sc+=15+valb;
  else if(s.pbr<=1.0) sc+=10+valb;
  else if(s.pbr<=1.5) sc+=4;

  if(s.per<=10) sc+=10;
  else if(s.per<=13) sc+=7;
  else if(s.per<=15) sc+=4;

  if(s.vol_r>=1.5) sc-=20;
  if(quizAnswers.market==='bear'&&d25<=-7) sc+=5;

  return Math.max(0,Math.min(sc,100));
}

function getSignal(sc) {
  if(sc>=55) return {label:'æŠ¼ã—ç›®è²·ã„',cls:'buy'};
  if(sc>=30) return {label:'è¦æ³¨ç›®',cls:'watch'};
  return {label:'æ§˜å­è¦‹',cls:'hold'};
}

function runScan() {
  const btn = document.getElementById('scanBtn');
  btn.disabled=true; btn.textContent='âŸ³ ã‚¹ã‚­ãƒ£ãƒ³ä¸­...';
  document.getElementById('resultsBody').innerHTML = `<div class="loading"><div class="loading-spinner"></div><div style="font-size:12px;margin-top:4px">éŠ˜æŸ„ã‚’åˆ†æã—ã¦ã„ã¾ã™...</div></div>`;

  setTimeout(() => {
    const cfg = {
      ma: parseFloat(document.getElementById('maThreshold').value),
      div: parseFloat(document.getElementById('minDividend').value),
      rsi: parseFloat(document.getElementById('maxRsi').value),
      sort: document.getElementById('sortBy').value,
    };

    processedStocks = STOCKS.map(s => {
      const d25=dv(s.price,s.ma25), d75=dv(s.price,s.ma75);
      const score=calcScore(s);
      return {...s, d25, d75, score, signal:getSignal(score)};
    }).filter(s => s.d25<=cfg.ma && s.dividend>=cfg.div && s.rsi<=cfg.rsi);

    const sf = {score:(a,b)=>b.score-a.score,deviation:(a,b)=>a.d25-b.d25,dividend:(a,b)=>b.dividend-a.dividend,rsi:(a,b)=>a.rsi-b.rsi};
    processedStocks.sort(sf[cfg.sort]||sf.score);

    const buyN = processedStocks.filter(s=>s.signal.cls==='buy').length;
    const watchN = processedStocks.filter(s=>s.signal.cls==='watch').length;
    const avgDiv = processedStocks.length>0
      ? (processedStocks.reduce((a,s)=>a+s.dividend,0)/processedStocks.length).toFixed(1) : 'â€”';

    document.getElementById('kpiTotal').textContent = STOCKS.length;
    document.getElementById('kpiBuy').textContent = buyN;
    document.getElementById('kpiWatch').textContent = watchN;
    document.getElementById('kpiDiv').textContent = processedStocks.length>0 ? avgDiv+'%' : 'â€”';

    const now = new Date();
    document.getElementById('lastUpdate').textContent =
      `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')} â€” ${STOCKS.length}éŠ˜æŸ„ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†`;

    renderResults();
    btn.disabled=false; btn.textContent='â–¶ ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ';
  }, 900);
}

function renderResults() {
  const list = currentFilter==='all' ? processedStocks : processedStocks.filter(s=>s.signal.cls===currentFilter);

  if(list.length===0) {
    document.getElementById('resultsBody').innerHTML = `<div class="empty">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“<br><span style="font-size:10px;color:var(--text-muted);margin-top:6px;display:block">æ¡ä»¶ã‚’ç·©ã‚ã‚‹ã‹ã€Œæœ€åˆã‹ã‚‰ã€ã§ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„</span></div>`;
    return;
  }

  const cards = list.map(s => {
    const scoreCls = s.score>=55?'high':s.score>=30?'mid':'low';
    const d25col = s.d25<0?'g':'r';

    // Build reason tags
    const reasons = [];
    if(s.d25<=-7) reasons.push({t:'MAä¹–é›¢ å¼·',ok:true});
    else if(s.d25<=-5) reasons.push({t:'MAä¹–é›¢',ok:true});
    if(s.rsi<=30) reasons.push({t:'RSI å¼·éå£²',ok:true});
    else if(s.rsi<=40) reasons.push({t:'RSI éå£²',ok:true});
    if(s.dividend>=4.5) reasons.push({t:'é…å½“ å„ªç§€',ok:true});
    else if(s.dividend>=2.5) reasons.push({t:'é«˜é…å½“',ok:true});
    if(s.pbr<=0.8) reasons.push({t:'PBR å¼·å‰²å®‰',ok:true});
    else if(s.pbr<=1.0) reasons.push({t:'PBR å‰²å®‰',ok:true});
    if(s.per<=13) reasons.push({t:'PER å‰²å®‰',ok:true});
    if(s.vol_r>=1.5) reasons.push({t:'âš  å‡ºæ¥é«˜æ€¥å¢—',ok:false});

    return `
    <div class="stock-card" onclick="showDetail('${s.code}')">
      <div class="stock-card-top">
        <div class="stock-meta">
          <div class="stock-code">${s.code}</div>
          <div class="stock-name">${s.name}</div>
          <div class="stock-sector">${s.sector}</div>
        </div>
        <div class="stock-price-block">
          <div class="stock-price">Â¥${s.price.toLocaleString()}</div>
          <div style="margin-top:6px;text-align:right;"><span class="signal-badge ${s.signal.cls}">${s.signal.label}</span></div>
        </div>
      </div>

      <div class="metric-row">
        <div class="mpill">
          <div class="mpill-label">25MAä¹–é›¢</div>
          <div class="mpill-value ${d25col}">${s.d25>0?'+':''}${s.d25}%</div>
        </div>
        <div class="mpill">
          <div class="mpill-label">RSI</div>
          <div class="mpill-value ${s.rsi<=30?'g':s.rsi>=50?'r':''}">${s.rsi}</div>
        </div>
        <div class="mpill">
          <div class="mpill-label">é…å½“</div>
          <div class="mpill-value w">${s.dividend}%</div>
        </div>
        <div class="mpill">
          <div class="mpill-label">PBR</div>
          <div class="mpill-value ${s.pbr<=1.0?'g':''}">${s.pbr}å€</div>
        </div>
        <div class="mpill">
          <div class="mpill-label">PER</div>
          <div class="mpill-value ${s.per<=13?'g':''}">${s.per}å€</div>
        </div>
      </div>

      <div class="score-row">
        <div class="score-label">ã‚¹ã‚³ã‚¢</div>
        <div class="score-track"><div class="score-fill ${scoreCls}" style="width:${s.score}%"></div></div>
        <div class="score-num">${s.score}</div>
      </div>

      <div class="reason-list">
        ${reasons.map(r=>`<span class="reason-tag ${r.ok?'ok':'ng'}">${r.t}</span>`).join('')}
      </div>
    </div>`;
  }).join('');

  document.getElementById('resultsBody').innerHTML = `<div class="results-grid">${cards}</div>`;
}

function setFilter(f, el) {
  currentFilter=f;
  document.querySelectorAll('.ftag').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  if(processedStocks.length>0) renderResults();
}

// ===== DETAIL PANEL =====
function showDetail(code) {
  const s = processedStocks.find(x=>x.code===code);
  if(!s) return;

  const bars = Array.from({length:20},(_,i)=>{
    const h=28+Math.random()*40;
    const c=i>14?'rgba(0,200,150,0.5)':'rgba(255,255,255,0.07)';
    return `<div class="mcbar" style="height:${h}px;background:${c}"></div>`;
  }).join('');

  const ri = [];
  if(s.d25<=-7) ri.push({l:'25MAä¹–é›¢ï¼ˆå¼·ï¼‰',v:s.d25+'%',ok:true});
  else if(s.d25<=-5) ri.push({l:'25MAä¹–é›¢',v:s.d25+'%',ok:true});
  if(s.rsi<=30) ri.push({l:'RSIéå£²ã‚Šï¼ˆå¼·ï¼‰',v:s.rsi,ok:true});
  else if(s.rsi<=40) ri.push({l:'RSIéå£²ã‚Š',v:s.rsi,ok:true});
  if(s.dividend>=4.5) ri.push({l:'é«˜é…å½“ï¼ˆå„ªç§€ï¼‰',v:s.dividend+'%',ok:true});
  else if(s.dividend>=2.5) ri.push({l:'é«˜é…å½“',v:s.dividend+'%',ok:true});
  if(s.pbr<=0.8) ri.push({l:'PBRå‰²å®‰ï¼ˆå¼·ï¼‰',v:s.pbr+'å€',ok:true});
  else if(s.pbr<=1.0) ri.push({l:'PBRå‰²å®‰',v:s.pbr+'å€',ok:true});
  if(s.per<=13) ri.push({l:'PERå‰²å®‰',v:s.per+'å€',ok:true});
  if(s.vol_r>=1.5) ri.push({l:'âš  å‡ºæ¥é«˜æ€¥å¢—',v:'x'+s.vol_r,ok:false});

  document.getElementById('detailContent').innerHTML = `
    <div class="d-code">${s.code} ï½œ ${s.sector}</div>
    <div class="d-name">${s.name}</div>
    <div class="d-sector">ã‚·ã‚°ãƒŠãƒ«: <span class="signal-badge ${s.signal.cls}" style="font-size:10px">${s.signal.label}</span></div>
    <div class="d-grid">
      <div class="d-item"><div class="d-item-label">ç¾åœ¨å€¤</div><div class="d-item-value">Â¥${s.price.toLocaleString()}</div></div>
      <div class="d-item"><div class="d-item-label">é…å½“åˆ©å›ã‚Š</div><div class="d-item-value g">${s.dividend}%</div></div>
      <div class="d-item"><div class="d-item-label">RSI</div><div class="d-item-value ${s.rsi<=35?'g':''}">${s.rsi}</div></div>
      <div class="d-item"><div class="d-item-label">ç·åˆã‚¹ã‚³ã‚¢</div><div class="d-item-value w">${s.score}/100</div></div>
    </div>
    <div class="mini-chart">${bars}</div>
    <div class="d-section">
      <div class="d-section-title">ç§»å‹•å¹³å‡ç·š</div>
      <div class="d-row"><span style="color:var(--text-muted)">25æ—¥MA</span><span>Â¥${s.ma25.toLocaleString()} <strong style="color:${s.d25<0?'var(--accent)':'var(--danger)'}">${s.d25>0?'+':''}${s.d25}%</strong></span></div>
      <div class="d-row"><span style="color:var(--text-muted)">75æ—¥MA</span><span>Â¥${s.ma75.toLocaleString()} <strong style="color:${s.d75<0?'var(--accent)':'var(--danger)'}">${s.d75>0?'+':''}${s.d75}%</strong></span></div>
      <div class="d-row"><span style="color:var(--text-muted)">PBR</span><span>${s.pbr}å€</span></div>
      <div class="d-row"><span style="color:var(--text-muted)">PER</span><span>${s.per}å€</span></div>
      <div class="d-row"><span style="color:var(--text-muted)">å‡ºæ¥é«˜æ¯”ç‡</span><span style="color:${s.vol_r>=1.5?'var(--danger)':'inherit'}">${s.vol_r}x</span></div>
    </div>
    <div class="d-section">
      <div class="d-section-title">è²·ã„æ ¹æ‹ </div>
      ${ri.map(r=>`<div class="d-row"><span style="color:var(--text-muted)">${r.l}</span><span style="color:${r.ok?'var(--accent)':'var(--danger)'}">${r.ok?'âœ“':'âœ•'} ${r.v}</span></div>`).join('')}
    </div>
    <div class="d-note">â€» ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚å®Ÿéš›ã®å–å¼•ã®éš›ã¯æœ€æ–°ã®æ ªä¾¡ãƒ»è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</div>
  `;
  document.getElementById('detailPanel').classList.add('open');
}

function closeDetail() { document.getElementById('detailPanel').classList.remove('open'); }

// Init
initSummaryScreen();
</script>
</body>
</html>
